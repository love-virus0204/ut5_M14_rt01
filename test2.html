<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</title>
<style>
  :root{--maxw:520px; --labelw:92px;}
  body{margin:0;background:#f5f5f5;font-family:"Comic Sans MS",sans-serif}
  .wrap{max-width:var(--maxw);margin:8px auto;padding:10px 14px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .toolbar{display:grid;grid-template-columns:36px auto 36px;align-items:center;margin-bottom:6px}
  .tool-left{justify-self:start}
  .tool-right{justify-self:end}
  .tool-btn{background:none;border:0;font-size:18px;line-height:1;padding:2px 6px;cursor:pointer}
  .title{font-family:"æ¨™æ¥·é«”",serif;text-align:center;font-weight:700;margin:0;font-size:1.35rem}
  .ds-line{font-weight:700;margin:10px 0 12px}
  .row{display:grid;grid-template-columns:var(--labelw) 1fr;align-items:center;gap:8px;padding:8px 0;border-top:1px dashed #ddd}
  .row:first-child{border-top:0}
  .label{letter-spacing:2px;color:#444}
  .ctrl>input,.ctrl>select{width:100%;font-size:16px;padding:10px 12px;border:1px solid #ddd;border-radius:8px;outline:none;background:#fff}
  .ctrl>input::placeholder{color:#aaa}
  .field-error{display:none;color:#c00;font-size:13px}
  .input-error{border-color:#c00}
  .submit{display:flex;justify-content:flex-start;align-items:center;gap:10px;padding-top:12px}
  .btn{padding:10px 14px;font-size:16px;border-radius:10px;border:1px solid #ddd;background:#f7f7f7}
  .ok-msg{display:none;color:#0a0}
  .dots{display:none;color:#666}
  .ver-left{color:#666;font-size:12px}
  .list{margin-top:10px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left}
  th{background:#fafafa}
  .muted{color:#888;font-size:12px;text-align:center;padding:12px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="tool-left"><button id="langBtn" class="tool-btn" title="èªè¨€">ğŸŒ</button></div>
    <h1 class="title">RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</h1>
    <div class="tool-right"><button id="backBtn" class="tool-btn" title="è¿”å›">â†©ï¸</button></div>
  </div>

  <div id="dsView" class="ds-line"></div>

  <div class="row">
    <div class="label">æª¢é©—å“¡ï¼š</div>
    <div class="ctrl">
      <input id="inspector" placeholder="è¼¸å…¥ 5ç¢¼å·¥è™Ÿ"/>
      <div id="err-inspector" class="field-error"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ–™ã€€è™Ÿï¼š</div>
    <div class="ctrl">
      <input id="part" placeholder="è¼¸å…¥ 7ç¢¼æ–™è™Ÿ"/>
      <div id="err-part" class="field-error"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">å‹ã€€æ…‹ï¼š</div>
    <div class="ctrl">
      <select id="type"><option value=""></option></select>
    </div>
  </div>

  <div class="row">
    <div class="label">æ‰¹ã€€è™Ÿï¼š</div>
    <div class="ctrl">
      <input id="lot" placeholder="æ¯æ‰¹(3ç¢¼) or æ¯æ‰¹-å­æ‰¹(3-2)ï¼›ç¦ I/O"/>
      <div id="err-lot" class="field-error"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ•¸ã€€é‡ï¼š</div>
    <div class="ctrl">
      <input id="qty" type="number" inputmode="numeric" min="1" step="1" placeholder="è¼¸å…¥ æ‰¹é‡"/>
      <div id="err-qty" class="field-error"></div>
    </div>
  </div>

  <div class="submit" id="submit-row">
    <div class="submit-center">
      <div id="okMsg" class="ok-msg"></div>
      <div id="loadingDots" class="dots">å‚³é€ä¸­<span>.</span><span>.</span><span>.</span></div>
    </div>
    <button id="sendBtn" class="btn">é€å‡º</button>
  </div>

  <hr>

  <div class="post">
    <div class="bottom-info">
      <div id="versionTag" class="ver-left">ç‰ˆæœ¬ï¼šv17.10.5</div>
      <div id="clock" class="ver-left" style="float:right"></div>
      <div style="clear:both"></div>
    </div>

    <div class="list">
      <table>
        <thead><tr><th>æ–™ã€€è™Ÿ</th><th>æ‰¹ã€€è™Ÿ</th><th>æ•¸ã€€é‡</th></tr></thead>
        <tbody id="recentBody"><tr><td colspan="3" class="muted">(ç•¶ç­ç„¡è‰ç¨¿)</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ===== ç‰ˆæœ¬èˆ‡ API ===== */
const FORM_VERSION="v17.10.5";
const API_BASE="https://script.google.com/macros/s/AKfycbw81dgU8...8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const API_BASE_FALLBACK = (window.API_URL || window.scriptURL || API_BASE);

/* ===== å¯èª¿åƒæ•¸ ===== */
const ENABLE_RECENT_KEY2_PROTECT = true;
const RECENT_KEY2_TTL_MS = 5000;
const POLL_INTERVAL_MS    = 15000;
const PING_INTERVAL_MS    = 240000;

/* ===== å°å·¥å…· ===== */
const $=s=>document.querySelector(s);
function fw2hw(s){return String(s||"").replace(/[\uFF01-\uFF5E]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0));}
function hw(s){return String(s||"").replace(/\s+/g," ").trim();}
function isTPE(){ try{ return Intl.DateTimeFormat().resolvedOptions().timeZone==='Asia/Taipei'; }catch{ return false; } }

/* ===== pingï¼ˆç›¸å®¹æ¥µç°¡/JSONï¼‰ ===== */
async function pingNow(){
  try{
    const r=await fetch(`${API_BASE_FALLBACK}?action=ping&t=${Date.now()}`,{cache:'no-store'});
    const txt=await r.text();
    const m = txt.match(/^(\d{4})\/(\d{2})\/(\d{2})\s+(\d{2}):(\d{2}):(\d{2})$/);
    if(m){
      const srv = new Date(+m[1],+m[2]-1,+m[3],+m[4],+m[5],+m[6]).getTime();
      return srv;
    }
    const j = JSON.parse(txt);
    if(j && j.ts) return +j.ts;
    return Date.now();
  }catch{ return Date.now(); }
}

/* ===== API åŒ…è£ï¼ˆGET-onlyï¼‰ ===== */
function apiGet(obj){
  const params=new URLSearchParams();
  Object.entries(obj||{}).forEach(([k,v])=>{ if(v!==undefined&&v!==null) params.append(k,String(v)); });
  params.append("t",Date.now());
  const url=`${API_BASE_FALLBACK}?${params.toString()}`;
  return fetch(url,{method:"GET",mode:"cors",cache:"no-store"})
    .then(async r=>{
      const txt=await r.text();
      try{ return JSON.parse(txt); }catch{ return txt; }
    });
}
function submitData(p){ return apiGet({action:"submit",...p}); }
function listRecent(){ return apiGet({action:'list_recent'}); }

/* ===== è‰ç¨¿å„²å­˜ ===== */
function dsStorageKey(ds){ return `draft_${ds.ymdSlash}_${ds.shift}`; }
function getDraftList(ds){ try{ return JSON.parse(localStorage.getItem(dsStorageKey(ds))||'[]'); }catch{ return []; } }
function saveDraftList(ds,list){ localStorage.setItem(dsStorageKey(ds), JSON.stringify(list||[])); }
function makeKey(mmdd,shift,part,lot){ return `${mmdd}|${shift}|${part}|${lot}`; }
function makeKey2(mmdd,shift,lot,qty,ok){ const [m,b='']=String(lot||'').split('-'); return `${mmdd}|${shift}|${m||''}|${b||''}|${ok?'TRUE':'FALSE'}`; }

/* ===== ç•¶ç­èˆ‡æ™‚é–“ ===== */
let tzDelta=0;
async function ensureTZ(){
  tzDelta=0;
  if(isTPE()) return;
  try{
    const r=await fetch("https://worldtimeapi.org/api/timezone/Asia/Taipei",{cache:"no-store"});
    if(!r.ok) return;
    const j=await r.json();
    tzDelta = j.unixtime*1000 - Date.now();
  }catch{}
}
function now(){ return new Date(Date.now()+tzDelta); }
function ymd(d){ return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`; }
function mmdd(d){ return `${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`; }
function parseShift(d){
  const m=d.getHours()*60+d.getMinutes();
  if(m>=520 && m<=999) return "A";
  if(m>=1000 || m<=39) return "B";
  return "C";
}
function currentDS(){
  const n=now();
  const shift=parseShift(n);
  const base=new Date(n);
  if(shift==="C") base.setDate(base.getDate()-1);
  const ymd_ = ymd(base);
  return { ymd: ymd_, ymdSlash: ymd_, md: mmdd(base), shift };
}

/* ===== é©—è­‰ï¼ˆæ²¿ç”¨ï¼‰ ===== */
function vInspector(s){ return (!s||hw(s).length<1)?"æª¢é©—å“¡å¿…å¡«":""; }
function vPart(s){
  s=hw(s).toUpperCase();
  if(s.length!==7) return "æ–™è™Ÿ 7 ç¢¼";
  if(!/^[A-Z]\d{2}[A-Z]\d{3}$/.test(s)) return "æ ¼å¼ A12B345";
  return "";
}
function vLot(s){
  s=hw(s).toUpperCase();
  if(!s) return "æ‰¹è™Ÿå¿…å¡«";
  if(!/^[A-Z0-9]{3}(-[A-Z0-9]{2})?$/.test(s)) return "æ¯æ‰¹(3) æˆ– æ¯æ‰¹-å­æ‰¹(3-2)";
  if(/[IO]/.test(s)) return "ç¦ I/O";
  return "";
}
function vQty(v){
  const n=+v; if(!Number.isInteger(n)||n<=0) return "æ­£æ•´æ•¸";
  return "";
}
function validateAll(){
  const e1=vInspector($('#inspector').value);
  const e2=vPart($('#part').value);
  const e3=vLot($('#lot').value);
  const e4=vQty($('#qty').value);
  $('#err-inspector').textContent=e1; $('#err-inspector').style.display=e1?"block":"none"; $('#inspector').classList.toggle('input-error',!!e1);
  $('#err-part').textContent=e2; $('#err-part').style.display=e2?"block":"none"; $('#part').classList.toggle('input-error',!!e2);
  $('#err-lot').textContent=e3; $('#err-lot').style.display=e3?"block":"none"; $('#lot').classList.toggle('input-error',!!e3);
  $('#err-qty').textContent=e4; $('#err-qty').style.display=e4?"block":"none"; $('#qty').classList.toggle('input-error',!!e4);
  return !(e1||e2||e3||e4);
}

/* ===== UI å°ä»¶ ===== */
function showCenter(t){ $('#loadingDots').style.display='inline-block'; if(t) $('#okMsg').textContent=t; }
function hideCenter(){ $('#loadingDots').style.display='none'; }
function repaintList(ds){
  const list=getDraftList(ds);
  const tb=$('#recentBody');
  tb.innerHTML=list.length? list.map(r=>`<tr><td>${r.part||''}</td><td>${r.lot||''}</td><td>${r.qty||''}</td></tr>`).join("") : `<tr><td colspan="3" class="muted">(ç•¶ç­ç„¡è‰ç¨¿)</td></tr>`;
}

/* ===== å¿«å–æ¯”å°ï¼ˆkey2ï¼‰ ===== */
function readKey2Cache(ds){
  try{ return new Set(JSON.parse(localStorage.getItem('cache_'+ds.ymdSlash+'_'+ds.shift)||'[]')); }catch{ return new Set(); }
}
function writeKey2Cache(ds,set){ localStorage.setItem('cache_'+ds.ymdSlash+'_'+ds.shift, JSON.stringify(Array.from(set||[]))); }
function markOldDraftsStrikeWithCache(ds){
  const s=readKey2Cache(ds);
  const list=getDraftList(ds);
  const t=Date.now();
  for(const it of list){
    if(ENABLE_RECENT_KEY2_PROTECT && t-(it.savedAt||0)<RECENT_KEY2_TTL_MS) { it.strike=false; continue; }
    it.strike = !s.has(String(it.key2||""));
  }
  saveDraftList(ds,list);
  repaintList(ds);
}

/* ===== é€å‡ºæµç¨‹ ===== */
async function handleSubmitSuccess(payload){
  markOldDraftsStrikeWithCache(currentDS()); // å…ˆç”¨èˆŠå¿«å–æ¨™è¨˜
  const ds=currentDS();
  const key = makeKey(ds.md, ds.shift, payload.part_no, payload.lot);
  const key2= makeKey2(ds.md, ds.shift, payload.lot, payload.qty, true);
  const list=getDraftList(ds);
  list.unshift({part:payload.part_no, lot:payload.lot, qty:payload.qty, key, key2, strike:false, savedAt:Date.now()});
  saveDraftList(ds,list.slice(0,50));
  repaintList(ds);
  $('#okMsg').textContent='å·²å¯«å…¥'; $('#okMsg').style.display='inline-block';
  setTimeout(()=>{ $('#okMsg').style.display='none'; },1500);
}

async function submitFlow(){
  if(!validateAll()) return;

  const ds=currentDS();
  const payload={
    inspector: hw($('#inspector').value),
    part_no :  hw($('#part').value).toUpperCase(),
    lot     :  hw($('#lot').value).toUpperCase(),
    qty     :  String($('#qty').value).trim(),
    date    :  ds.ymdSlash,
    shift   :  ds.shift,
    submitted_at: '' // ç”± GAS ç«¯æ±ºå®šæ™‚é–“
  };

  const btn=$('#sendBtn'); btn.disabled=true; showCenter('è³‡æ–™å‚³é€ä¸­â€¦');
  try{
    const data=await submitData({
      ...payload,
      // å¦‚ GAS å›å‚³æ¥µç°¡ {ok:1,mode:'add|update'} ä¹Ÿèƒ½ç›¸å®¹
    });
    const ok = (data && (data.status==='ok' || data.ok===1 || data.ok===true));
    if(!ok){
      hideCenter(); showCenter('âŒ å¾Œç«¯ï¼š'+(data && (data.msg||data.error)||'unknown')); setTimeout(hideCenter,1600); return;
    }
    await handleSubmitSuccess(payload);
  }catch(err){
    hideCenter(); showCenter('âŒ é€£ç·šå¤±æ•—ï¼š'+(err&&err.message||'fetch')); setTimeout(hideCenter,1600);
  }finally{
    btn.disabled=false;
  }
}

function startPolling(){
  setInterval(refreshCacheAndRepaint, POLL_INTERVAL_MS);
}

/* å®šæ™‚ï¼šæŠ“å¾Œç«¯ list_recent â†’ æ›´æ–°å¿«å– â†’ é‡æ¨™ strike â†’ é‡ç¹ªï¼ˆç›¸å®¹æ¥µç°¡å›å‚³ï¼‰ */
let __polling=false;
async function refreshCacheAndRepaint(){
  if(__polling) return;
  __polling=true;
  try{
    const j=await listRecent();
    let arr=[];
    if(Array.isArray(j)) arr=j;
    else if(j && (j.status==='ok' || j.ok===true) && Array.isArray(j.data)) arr=j.data;
    const set=new Set(arr.map(r=> String((r.key2||""))));
    writeKey2Cache(currentDS(),set);
    markOldDraftsStrikeWithCache(currentDS());
    await repaintList(currentDS());
  }catch{} finally{ __polling=false; }
}

/* ===== åˆå§‹åŒ– ===== */
(async function(){
  try{ await ensureTZ(); }catch{}
  const ds=currentDS();
  document.getElementById('dsView').textContent = `${ds.md}-${ds.shift}`;
  document.getElementById('versionTag').textContent = `ç‰ˆæœ¬ï¼š${FORM_VERSION}`;
  repaintList(ds);

  document.getElementById('sendBtn').addEventListener('click', (e)=>{ e.preventDefault(); submitFlow(); });

  // ç«‹å³åŒæ­¥ä¸€æ¬¡
  refreshCacheAndRepaint();

  // GAS ä¿æº«
  setInterval(()=>{ fetch(`${API_BASE_FALLBACK}?action=ping&t=${Date.now()}`,{cache:'no-store'}).catch(()=>{}); }, PING_INTERVAL_MS);
})();
</script>
</body>
</html>