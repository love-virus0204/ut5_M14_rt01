<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>外觀抽驗記錄表</title>
<style>
:root { --fg:#111; --muted:#666; --err:#c00; --ok:#0a0; --bd:#ddd; --bg:#fff; --hint:#888; }
* { box-sizing: border-box; }
body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,PingFang TC,Microsoft JhengHei,sans-serif; color:var(--fg); background:var(--bg); }
.wrap { max-width: 960px; margin: 0 auto; padding: 12px; }
.title { font-size:18px; font-weight:700; text-align:center; margin:8px 0 12px; }
.ds-line { font-weight:700; margin: 6px 0 10px; }
.row { display:grid; grid-template-columns: 110px 1fr; align-items:center; gap:8px; padding:6px 0; border-top:1px dashed var(--bd); }
.row:first-child { border-top:none; }
label { color:var(--muted); font-size:14px; letter-spacing:1px; }
input[type="text"], input[type="number"] { width:100%; font-size:16px; padding:10px 12px; border:1px solid var(--bd); border-radius:8px; outline:none; }
input::placeholder { color:var(--hint); }
.input-error { border-color: var(--err); }
.field-error { display:none; color:var(--err); font-size:13px; grid-column: 2 / span 1; }
.actions { display:flex; gap:8px; align-items:center; padding-top:12px; }
button { padding:10px 14px; font-size:16px; border-radius:10px; border:1px solid var(--bd); background:#f7f7f7; }
.status { color:var(--muted); font-size:14px; }
.ok { color:var(--ok); }
.err { color:var(--err); }
.table { width:100%; border-collapse: collapse; margin-top:12px; }
.table th,.table td { border-bottom:1px solid var(--bd); padding:8px 6px; font-size:14px; text-align:left; }
.table th { background:#fafafa; }
.draft-stale { text-decoration: line-through; opacity:.7; }
</style>
</head>
<body>
<div class="wrap">
  <div class="title">外觀抽驗記錄表</div>
  <div class="ds-line" id="ds-line"></div>

  <form id="form" autocomplete="off" novalidate>
    <div class="row">
      <label for="inspector">檢　驗</label>
      <div>
        <input id="inspector" type="text" placeholder="請輸入檢驗員" />
        <div class="field-error" id="err-inspector"></div>
      </div>
    </div>

    <div class="row">
      <label for="part">料　號</label>
      <div>
        <input id="part" type="text" inputmode="latin" placeholder="如 A12B345" />
        <div class="field-error" id="err-part"></div>
      </div>
    </div>

    <div class="row">
      <label for="lot">批　號</label>
      <div>
        <input id="lot" type="text" placeholder="批號" />
        <div class="field-error" id="err-lot"></div>
      </div>
    </div>

    <div class="row">
      <label for="qty">數　量</label>
      <div>
        <input id="qty" type="number" inputmode="numeric" step="1" min="1" placeholder="正整數" />
        <div class="field-error" id="err-qty"></div>
      </div>
    </div>

    <!-- 一次性鎖定用 -->
    <input id="date" type="hidden" />
    <input id="shift" type="hidden" />

    <div class="actions">
      <button id="submitBtn" type="submit">送出</button>
      <div class="status" id="status"></div>
    </div>
  </form>

  <!-- 若你有清單就保留這區；沒有也不影響 -->
  <table class="table" id="recentTable" style="display:none">
    <thead><tr><th>日期</th><th>班別</th><th>檢驗員</th><th>料號</th><th>批號</th><th>數量</th></tr></thead>
    <tbody id="recentBody"><tr><td colspan="6">無資料</td></tr></tbody>
  </table>
</div>

<script>
/* ===== 基本設定 ===== */
const API_BASE = (window.API_URL || window.scriptURL || ""); // 直接沿用你既有設定
const SEND_KEYS = { action:"upsert", inspector:"inspector", part:"part_no", lot:"lot", qty:"qty", date:"date", shift:"shift" };
const DS_KEY="ds_ymd_once", SHIFT_KEY="ds_shift_once";
const DRAFT = { inspector:"draft_inspector", part:"draft_part", lot:"draft_lot", qty:"draft_qty" };
const TZ_DELTA_KEY="tzTWDeltaMs";

const $ = (id)=>document.getElementById(id);
const setErr = (id,msg)=>{ const el=$(id); if(!el) return; el.textContent=msg||""; el.style.display=msg?"block":"none"; };
const setStatus = (msg, ok=null)=>{ const el=$("status"); if(!el) return; el.textContent=msg||""; el.classList.remove("ok","err"); if(ok===true) el.classList.add("ok"); if(ok===false) el.classList.add("err"); };

/* ===== 驗證：沿用你專案規則 ===== */
function vInspector(s){ return (!s || s.trim().length<1) ? "請輸入檢驗員" : ""; }
function vPart(p){
  if (typeof p!=="string") return "料號需文字";
  p=p.trim();
  if (p.length!==7) return "料號需 7 碼";
  const L=c=>/[A-Za-z]/.test(c), D=s=>/^\d+$/.test(s);
  if (!L(p[0])) return "第1碼需英文";
  if (!L(p[3])) return "第4碼需英文";
  if (!D(p.slice(1,3)+p.slice(4))) return "其餘需數字";
  return "";
}
function vLot(s){ return (!s || !s.trim()) ? "批號不可空白" : ""; }
function vQty(q){
  if (q===""||q===null||q===undefined) return "數量不可空白";
  const n=Number(q);
  if (!Number.isFinite(n) || n<=0) return "數量需為正數";
  if (!Number.isInteger(n)) return "需為整數";
  return "";
}
function validateAll(){
  const ins=$("inspector"), part=$("part"), lot=$("lot"), qty=$("qty");
  const e1=vInspector(ins.value); setErr("err-inspector",e1); ins.classList.toggle("input-error",!!e1);
  const e2=vPart(part.value);     setErr("err-part",e2);     part.classList.toggle("input-error",!!e2);
  const e3=vLot(lot.value);       setErr("err-lot",e3);      lot.classList.toggle("input-error",!!e3);
  const e4=vQty(qty.value);       setErr("err-qty",e4);      qty.classList.toggle("input-error",!!e4);
  return !(e1||e2||e3||e4);
}

/* ===== 台北時區校正（每次載入一次） ===== */
let tzDelta = Number(localStorage.getItem(TZ_DELTA_KEY)||0)||0;
function inTPE(){ try { return Intl.DateTimeFormat().resolvedOptions().timeZone==="Asia/Taipei"; } catch { return false; } }
async function ensureTZ(){
  if (inTPE()){ tzDelta=0; localStorage.setItem(TZ_DELTA_KEY,"0"); return; }
  try{
    const r=await fetch("https://worldtimeapi.org/api/timezone/Asia/Taipei",{cache:"no-store"});
    if (r.ok){ const j=await r.json(); tzDelta=j.unixtime*1000 - Date.now(); localStorage.setItem(TZ_DELTA_KEY,String(tzDelta)); }
  }catch{}
}
function tpeNow(){ return new Date(Date.now()+tzDelta); }
function ymd(d){ return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`; }

/* ===== 當班解析（A:08:40–16:39, B:16:40–00:39, C:00:40–08:39→前一日） ===== */
function computeDS(now){
  const m=now.getHours()*60+now.getMinutes();
  let shift="A";
  if (m>=520 && m<=999) shift="A";
  else if (m>=1000 || m<=39) shift="B";
  else shift="C";
  const d=new Date(now);
  if (shift==="C") d.setDate(d.getDate()-1);
  return { ymd:ymd(d), md:ymd(d).slice(5), shift };
}

/* ===== 載入：校時→算班別→鎖定 DS→草稿處理 ===== */
async function initDS(){
  await ensureTZ();
  const ds=computeDS(tpeNow());
  const lastDS=localStorage.getItem(DS_KEY)||"", lastSH=localStorage.getItem(SHIFT_KEY)||"";

  // 寫入鎖定值
  localStorage.setItem(DS_KEY,ds.ymd);
  localStorage.setItem(SHIFT_KEY,ds.shift);
  const dsView=document.getElementById("ds-line");
  if (dsView) dsView.textContent = `${ds.md}-${ds.shift}`;
  const dEl=$("date"), sEl=$("shift");
  if (dEl) dEl.value=ds.ymd; if (sEl) sEl.value=ds.shift;

  // 換班：清空料號/批號/數量草稿；檢驗員獨立
  if (lastDS && (lastDS!==ds.ymd || lastSH!==ds.shift)){
    localStorage.removeItem(DRAFT.part);
    localStorage.removeItem(DRAFT.lot);
    localStorage.removeItem(DRAFT.qty);
    $("part").value=""; $("lot").value=""; $("qty").value="";
  }else{
    // 同班：套用草稿
    $("part").value = localStorage.getItem(DRAFT.part)||"";
    $("lot").value  = localStorage.getItem(DRAFT.lot)||"";
    $("qty").value  = localStorage.getItem(DRAFT.qty)||"";
  }
  // 檢驗員草稿
  const insDraft=localStorage.getItem(DRAFT.inspector)||"";
  if (!$("inspector").value && insDraft) $("inspector").value=insDraft;
}

/* ===== 送出 ===== */
function buildParams(){
  const ds = { date: localStorage.getItem(DS_KEY)||$("date").value||"", shift: localStorage.getItem(SHIFT_KEY)||$("shift").value||"" };
  const p = new URLSearchParams();
  p.set("action", SEND_KEYS.action);
  p.set(SEND_KEYS.inspector, $("inspector").value.trim());
  p.set(SEND_KEYS.part, $("part").value.trim());
  p.set(SEND_KEYS.lot, $("lot").value.trim());
  p.set(SEND_KEYS.qty, String($("qty").value).trim());
  p.set(SEND_KEYS.date, ds.date);
  p.set(SEND_KEYS.shift, ds.shift);
  return p;
}
async function sendGET(params){
  const base = String(API_BASE||"").replace(/^http:\/\//i,"https://");
  if (!/^https?:\/\//i.test(base)) throw new Error("未設定 API_URL/scriptURL");
  const url = base + "?" + params.toString();
  const r = await fetch(url, { method:"GET", cache:"no-store" });
  const text = await r.text();
  let j=null; try{ j=JSON.parse(text); }catch{}
  return j;
}

/* ===== 綁定 ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  initDS().catch(()=>{});
  $("inspector").addEventListener("change", ()=>{ const v=$("inspector").value.trim(); if(!vInspector(v)) localStorage.setItem(DRAFT.inspector, v); });
  $("part").addEventListener("input", ()=>{ localStorage.setItem(DRAFT.part, $("part").value); });
  $("lot").addEventListener("input",  ()=>{ localStorage.setItem(DRAFT.lot,  $("lot").value);  });
  $("qty").addEventListener("input",  ()=>{ localStorage.setItem(DRAFT.qty,  $("qty").value);  });

  const form=$("form");
  const btn=$("submitBtn");
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if (!validateAll()){ setStatus("請先修正欄位錯誤", false); return; }
    setStatus("送出中…", null); btn.disabled=true;

    try{
      const res = await sendGET(buildParams());
      const ok = !!(res && (res.status==="ok" || res.ok===1 || res.ok===true));
      if (ok){
        setStatus("已寫入", true);
        // 成功後：清空批號、數量；料號保留但「送出後第一次點擊才清」
        $("lot").value=""; $("qty").value="";
        localStorage.setItem(DRAFT.lot,""); localStorage.setItem(DRAFT.qty,"");
        const el=$("part");
        if (el){
          const once=()=>{ el.value=""; el.removeEventListener("focus",once); el.removeEventListener("click",once); localStorage.removeItem(DRAFT.part); };
          el.addEventListener("focus", once, {once:false});
          el.addEventListener("click",  once, {once:false});
        }
      }else{
        setStatus("寫入失敗", false);
      }
    }catch(err){
      setStatus("網路或伺服器錯誤", false);
    }finally{
      btn.disabled=false;
    }
  }, {capture:true});
});
</script>
</body>
</html>