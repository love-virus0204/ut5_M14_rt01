<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>外觀記錄表 v17.10.11</title>
<style>
/* 保留你原有的所有 CSS 內容 */
</style>
</head>
<body>
  <!-- 保留你原有的 HTML 排版、欄位、placeholder、送出按鈕、清單渲染等內容 -->
  <div id="ds"></div>
  <!-- 其他原有表單內容照舊 -->

<script>
// === 初始化：載入時 ping 一次，設定 _dsDate/_dsShift 並更新 #ds ===
async function __initDateShiftFromPingOnce(){
  try{
    const u=new URL(API_URL);u.searchParams.set("action","ping");
    const r=await fetch(u.toString(),{method:"GET",cache:"no-store"});
    const j=await r.json();
    if(j && j.server_time){
      const s=String(j.server_time);
      const d=s.split(" ")[0]||"";
      let sh="";
      if(typeof computeShiftByClockFrom==="function"){try{sh=computeShiftByClockFrom(s)||"";}catch(_){}}
      window._dsDate=d;
      if(sh) window._dsShift=sh;
      try{
        const mmdd=(d && d.length>=10)?(d.slice(5,7)+"/"+d.slice(8,10)):"";
        const dsEl=document.getElementById("ds");
        if(dsEl && mmdd){
          const curShift=(window._dsShift||"").toString().trim();
          dsEl.textContent = curShift ? (mmdd+" - "+curShift) : (mmdd+" - ");
        }
      }catch(__e){}
    }
  }catch(e){}
}
document.addEventListener("DOMContentLoaded",()=>{__initDateShiftFromPingOnce();});

// === 保留你原有的所有初始化、驗證、草稿、渲染、送出函式 ===

// 修改 payload，優先使用 _dsDate/_dsShift
function buildPayload(){
  const payload = {
    date:(window._dsDate||date),
    shift:(window._dsShift||shift),
    part_no: part_no,
    lot: lot,
    qty: qty,
    inspector: inspector,
    key: key,
    key2: key2
  };
  return payload;
}
</script>
</body>
</html>