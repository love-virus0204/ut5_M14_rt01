<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GAS 連線/寫入 測試（單鍵）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial,"PingFang TC","Heiti TC",sans-serif;margin:20px}
    button{font-size:18px;padding:12px 20px}
    #log{white-space:pre-wrap;background:#111;color:#0f0;padding:12px;border-radius:8px;margin-top:16px;min-height:160px}
    .muted{color:#888}
  </style>
</head>
<body>
  <h2>GAS 連線 / 寫入測試</h2>
  <p class="muted">按下會先 <b>ping</b>，再以 <b>GET</b> 寫入一筆固定測試資料。</p>
  <button id="btn">開始測試</button>
  <div id="log"></div>

<script>
/* === 你的 GAS 端點（寫死） === */
const API_URL = "https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec";

/* === 修正：回傳 yyyy/MM/dd（不含 年/月/日 中文） === */
function todayTaipei(){
  const d = new Date();
  const tzOffset = -480; // Asia/Taipei = UTC+8 → 分鐘數 +480；為了簡單，用本地時間即可
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}/${m}/${day}`;
}

/* 測試資料（固定值，避免任何自動判斷） */
const TEST = {
  date: todayTaipei(),  // yyyy/MM/dd
  shift: "C",
  part_no: "A12B345",
  lot: "TEST-001",
  qty: "1",
  inspector: "TESTER"
};
TEST.key  = `${TEST.part_no}@${TEST.date}`;
TEST.key2 = `${TEST.part_no}@${TEST.lot}`;

/* Log UI */
function log(s){ document.getElementById('log').textContent += s + "\n"; }
function clearLog(){ document.getElementById('log').textContent = ""; }

/* 單鍵流程：PING -> SUBMIT(GET) */
document.getElementById('btn').addEventListener('click', runOnce);

async function runOnce(){
  clearLog();
  log(`[STEP] 開始測試…`);

  // 1) PING
  const pingUrl = `${API_URL}?action=ping&t=${Date.now()}`;
  log(`[PING]\n${pingUrl}`);
  try{
    const r = await fetch(pingUrl, {method:'GET',cache:'no-cache'});
    const t = await r.text();
    log(`[PING_HTTP] ${r.status}\n[PING_RESP]\n${t}`);
  }catch(e){
    log(`[PING_ERR] ${e.name}: ${e.message}`);
  }

  // 2) SUBMIT（GET）
  const enc = encodeURIComponent;
  const submitUrl =
    `${API_URL}?action=submit`
    + `&date=${enc(TEST.date)}&shift=${enc(TEST.shift)}`
    + `&part_no=${enc(TEST.part_no)}&lot=${enc(TEST.lot)}&qty=${enc(TEST.qty)}`
    + `&inspector=${enc(TEST.inspector)}&key=${enc(TEST.key)}&key2=${enc(TEST.key2)}`
    + `&t=${Date.now()}`;

  log(`\n[SUBMIT]\n${submitUrl}`);

  try{
    let text = "", status = 0;
    try{
      const r = await fetch(submitUrl, {method:'GET',cache:'no-cache'});
      status = r.status;
      text = await r.text();
    }catch(fe){
      log(`[FETCH_ERR] ${fe.name}: ${fe.message}`);
      // Fallback：XHR
      text = await new Promise((resolve,reject)=>{
        const xhr = new XMLHttpRequest();
        xhr.open('GET', submitUrl, true);
        xhr.onreadystatechange = () => { if (xhr.readyState === 4) resolve(xhr.responseText||''); };
        xhr.onerror = () => reject(new Error('XMLHttpRequest network error'));
        xhr.send(null);
      });
    }
    log(`[SUBMIT_HTTP] ${status}\n[SUBMIT_RESP]\n${text || '(empty)'}`);

    let data={}; try{ data = text ? JSON.parse(text) : {}; }catch(_){}
    if (data.status === 'ok'){
      log(`[RESULT] ✅ 看起來可正常寫入（status=ok）`);
    }else{
      log(`[RESULT] ⚠️ 後端未回傳 ok（但可能仍已寫入，請到表單確認）`);
    }
  }catch(e){
    log(`[SUBMIT_ERR] ${e.name}: ${e.message}`);
  }
}
</script>
</body>
</html>