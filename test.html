<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GAS 連線綜合診斷工具</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;line-height:1.45;background:#fafafa}
  section{background:#fff;padding:12px 14px;margin:10px 0;border:1px solid #e5e5e5;border-radius:8px}
  h2{font-size:18px;margin:0 0 8px}
  label{display:block;margin:8px 0 4px;font-weight:600}
  input,textarea,button,select{width:100%;box-sizing:border-box;padding:10px;margin:4px 0;font-size:14px}
  textarea{height:150px;white-space:pre;overflow:auto}
  pre{background:#111;color:#0f0;padding:8px;overflow:auto;white-space:pre-wrap;word-break:break-word}
  .ok{color:#0a7} .err{color:#c00} .muted{color:#666}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  small{color:#666}
</style>
</head>
<body>
<section>
  <h2>1) 目標設定</h2>
  <label>GAS Web App URL</label>
  <input id="api" value="https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec">
  <div class="row">
    <div>
      <label>日期 yyyy/MM/dd</label>
      <input id="date" value="2025/09/23">
    </div>
    <div>
      <label>班別</label>
      <select id="shift"><option>A</option><option>B</option><option>C</option></select>
    </div>
  </div>
  <div class="row">
    <div><label>料號</label><input id="part_no" value="ABC1234"></div>
    <div><label>批號</label><input id="lot" value="LOT001"></div>
  </div>
  <div class="row">
    <div><label>數量</label><input id="qty" type="number" value="10"></div>
    <div><label>檢驗員</label><input id="inspector" value="ZX"></div>
  </div>
  <small class="muted">送出時自動補：sample_cnt=Math.min(20, qty)；z7~z13=0；remark=""；key/key2 自動組合（TRUE）。</small>
</section>

<section>
  <h2>2) 產生 payload</h2>
  <button onclick="build()">建立 payload</button>
  <textarea id="payload">(按上方建立)</textarea>
</section>

<section>
  <h2>3) 連線測試</h2>
  <div class="row">
    <button onclick="postTextPlain()">POST text/plain（無預檢）</button>
    <button onclick="postJson()">POST application/json（可能預檢）</button>
  </div>
  <div class="row">
    <button onclick="formPost()">表單 x-www-form-urlencoded</button>
    <button onclick="tryGet()">GET 可達性（應回 get_disabled）</button>
  </div>
  <button onclick="pingPost()">POST ping</button>
  <label>輸出</label>
  <pre id="out">(尚未測試)</pre>
</section>

<section>
  <h2>4) cURL 指令（複製到電腦終端機測試）</h2>
  <pre id="curlBox" class="muted">(建立 payload 後自動生成)</pre>
</section>

<script>
function $id(x){return document.getElementById(x);}
function build(){
  const date = $id('date').value.trim();
  const shift = $id('shift').value.trim();
  const part_no = $id('part_no').value.trim().toUpperCase();
  const lot = $id('lot').value.trim().toUpperCase();
  const qty = Number($id('qty').value)||0;
  const inspector = $id('inspector').value.trim().toUpperCase();
  const key = `${date}|${shift}|${part_no}|${lot}`;
  const key2 = `${date}|${shift}|${part_no}|${lot}|TRUE`;
  const p = {
    action:"submit", date, shift, part_no, lot,
    qty:String(qty), sample_cnt: Math.min(20, qty),
    z7:0,z8:0,z9:0,z10:0,z11:0,z12:0,z13:0,
    remark:"", inspector, key2, key
  };
  $id('payload').value = JSON.stringify(p, null, 2);
  $id('curlBox').textContent =
`# 無預檢建議：text/plain
curl -X POST -H "Content-Type: text/plain" \
  -d '{${{JSON.stringify(p)}}}' \
  "`+API+`"

# JSON（可能預檢）
curl -X POST -H "Content-Type: application/json" \
  -d '{${{JSON.stringify(p)}}}' \
  "`+API+`"

# ping
curl -X POST -H "Content-Type: text/plain" \
  -d '{{\"action\":\"ping\"}}' \
  "`+API+`"`;
}
function logOK(x){$id('out').className='ok';$id('out').textContent=x;}
function logERR(x){$id('out').className='err';$id('out').textContent=x;}

async function postTextPlain(){
  const api = $id('api').value.trim();
  const body = $id('payload').value.trim();
  if(!body) return logERR('請先按「建立 payload」');
  try{
    const resp = await fetch(api, {method:'POST', headers:{'Content-Type':'text/plain'}, cache:'no-store', body});
    const text = await resp.text();
    logOK(`HTTP ${resp.status}\n`+text);
  }catch(e){ logERR('連線失敗: '+e); }
}
async function postJson(){
  const api = $id('api').value.trim();
  const body = $id('payload').value.trim();
  if(!body) return logERR('請先按「建立 payload」');
  try{
    const resp = await fetch(api, {method:'POST', headers:{'Content-Type':'application/json'}, cache:'no-store', body});
    const text = await resp.text();
    logOK(`HTTP ${resp.status}\n`+text);
  }catch(e){ logERR('連線失敗: '+e); }
}
async function formPost(){
  const api = $id('api').value.trim();
  const p = JSON.parse($id('payload').value||'{}');
  const form = new URLSearchParams();
  for (const k in p) form.append(k, p[k]);
  try{
    const resp = await fetch(api, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form.toString()});
    const text = await resp.text();
    logOK(`HTTP ${resp.status}\n`+text);
  }catch(e){ logERR('連線失敗: '+e); }
}
async function tryGet(){
  const api = $id('api').value.trim();
  try{
    const resp = await fetch(api+'?action=ping', {method:'GET', cache:'no-store'});
    const text = await resp.text();
    logOK(`HTTP ${resp.status}\n`+text+`\n(提示: 你的 doGet 已禁用，正常應為 get_disabled 或 405)`);
  }catch(e){ logERR('GET 失敗: '+e); }
}
async function pingPost(){
  const api = $id('api').value.trim();
  try{
    const resp = await fetch(api, {method:'POST', headers:{'Content-Type':'text/plain'}, cache:'no-store', body: JSON.stringify({action:'ping'})});
    const text = await resp.text();
    logOK(`HTTP ${resp.status}\n`+text);
  }catch(e){ logERR('連線失敗: '+e); }
}
</script>
</body>
</html>
