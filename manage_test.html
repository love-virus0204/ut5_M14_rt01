<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>管理入口｜QR 驗證測試</title>
<script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
<style>
 body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,sans-serif;margin:0;background:#f7f7f7}
 header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#fff;border-bottom:1px solid #e5e5e5}
 main{max-width:680px;margin:20px auto;padding:0 16px}
 .btn{padding:10px 14px;border-radius:10px;border:1px solid #1677ff;background:#1677ff;color:#fff}
 .btn2{padding:10px 14px;border-radius:10px;border:1px solid #d0d0d0;background:#fff}
 #reader{width:100%;max-width:420px;margin-top:12px}
 #log{color:#c62828;white-space:pre-wrap;margin-top:8px}
 .ok{color:#0a7b33;font-weight:700}
</style></head><body>
<header>
  <h3>管理入口｜QR 驗證測試</h3>
  <button class="btn2" onclick="location.href='./index.html'">返回首頁</button>
</header>
<main>
  <button id="startBtn" class="btn">開始掃描</button>
  <button id="stopBtn" class="btn2" disabled>停止掃描</button>
  <div id="reader"></div>
  <div id="log"></div>
  <div id="ok" style="display:none" class="ok">✅ 驗證通過，將前往 manage.html …</div>
</main>

<script>
const TOKEN="f58f84dfd91a46d68f130d4a2ca2a783eaf649fe96284ef09395571e030106aab70b6258691887e3d22ce185105a943ff88b8c7f536aae149ea23d2bd83ffe3f";
const log = (m)=>document.getElementById('log').textContent = m;
let qr=null, running=false;

async function startScan(){
  if(running) return;
  try{
    // 明確要求後鏡頭，並用使用者手勢觸發
    qr = new Html5Qrcode("reader",{verbose:true});
    await qr.start(
      { facingMode: "environment" },
      { fps:10, qrbox:{width:260,height:260} },
      (txt)=>{
        if((txt||"").trim()===TOKEN){
          stopScan(); document.getElementById('ok').style.display='block';
          setTimeout(()=>location.href='./manage.html',1200);
        }else{
          log("掃到內容但不匹配。");
        }
      },
      (err)=>{} // 可忽略掃描失敗訊息
    );
    running=true; document.getElementById('startBtn').disabled=true;
    document.getElementById('stopBtn').disabled=false; log("相機啟動，請對準 QR。");
  }catch(e){
    log("啟動相機失敗：\n"+ String(e) + "\n請確認：使用 HTTPS、允許相機、非無痕/APP 內嵌、未被 iframe。");
  }
}
async function stopScan(){
  if(qr && running){ try{ await qr.stop(); await qr.clear(); }catch(_){}
    running=false; document.getElementById('startBtn').disabled=false; document.getElementById('stopBtn').disabled=true; }
}

document.getElementById('startBtn').addEventListener('click', startScan);
document.getElementById('stopBtn').addEventListener('click', stopScan);
</script>
</body></html>