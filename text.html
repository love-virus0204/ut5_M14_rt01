<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GAS POST 全欄位測試</title>
<style>
  body { font-family: ui-monospace, Menlo, Consolas, monospace; padding:16px; }
  label { display:block; margin:6px 0 2px; font-weight:600; }
  input, select { width: 320px; padding:6px; }
  .row { display:flex; flex-wrap:wrap; gap:16px; }
  .card { border:1px solid #ccc; border-radius:8px; padding:12px; margin-top:16px; }
  button { padding:8px 12px; }
  pre { white-space:pre-wrap; word-break:break-word; background:#f7f7f7; padding:10px; border-radius:6px; }
</style>
</head>
<body>
<h2>GAS POST 全欄位測試</h2>

<script>
// 改成你的 GAS Web App URL（已部署、Anyone 可存取）
const API_BASE = "https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec";

// 產生 key / key2（依你規格）
function buildKey(date, shift, part_no, lot) {
  return `${date}|${shift}|${part_no}|${lot}`;
}
function buildKey2(date, shift, part_no, lot) {
  return `${date}|${shift}|${part_no}|${lot}|TRUE`; // 第5段固定 "TRUE"
}

// 送出：x-www-form-urlencoded
async function sendFullPost() {
  // 取值
  const date = document.getElementById("date").value.trim();        // yyyy/MM/dd
  const shift = document.getElementById("shift").value.trim();      // A/B/C
  const part_no = document.getElementById("part_no").value.trim().toUpperCase();
  const lot = document.getElementById("lot").value.trim().toUpperCase();
  const qty = document.getElementById("qty").value.trim();          // 字串即可
  const inspector = document.getElementById("inspector").value.trim().toUpperCase();
  const remark = document.getElementById("remark").value;           // 允許空字串

  // 自動補：sample_cnt、z7~z13=0、key、key2
  const sample_cnt = Math.min(20, Number(qty) || 0);
  const z7=0,z8=0,z9=0,z10=0,z11=0,z12=0,z13=0;
  const key = buildKey(date, shift, part_no, lot);
  const key2 = buildKey2(date, shift, part_no, lot);

  // 組 payload（17 欄 + action）
  const params = new URLSearchParams();
  params.append("action", "submit");
  params.append("date", date);
  params.append("shift", shift);
  params.append("part_no", part_no);
  params.append("lot", lot);
  params.append("qty", qty);
  params.append("sample_cnt", String(sample_cnt));
  params.append("z7", String(z7));
  params.append("z8", String(z8));
  params.append("z9", String(z9));
  params.append("z10", String(z10));
  params.append("z11", String(z11));
  params.append("z12", String(z12));
  params.append("z13", String(z13));
  params.append("inspector", inspector);
  params.append("remark", remark);
  params.append("key2", key2);
  params.append("key", key);

  // 顯示送出內容
  document.getElementById("payload").textContent = params.toString();

  // 發送
  let status = 0, headersText = "";
  try {
    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params.toString()
    });
    status = res.status;

    // 組 headers 顯示
    const hs = [];
    res.headers.forEach((v, k) => hs.push(`${k}: ${v}`));
    headersText = hs.join("\n");
    document.getElementById("headers").textContent = `狀態: ${status}\n${headersText}`;

    // 嘗試 JSON 解析
    const raw = await res.text();
    document.getElementById("raw").textContent = raw;
    try {
      const json = JSON.parse(raw);
      document.getElementById("json").textContent = JSON.stringify(json, null, 2);
    } catch {
      document.getElementById("json").textContent = "(非 JSON 或解析失敗)";
    }
  } catch (err) {
    document.getElementById("headers").textContent = `Fetch 錯誤: ${err}`;
    document.getElementById("raw").textContent = "";
    document.getElementById("json").textContent = "";
  }
}
</script>

<div class="card">
  <div class="row">
    <div>
      <label for="date">date（yyyy/MM/dd）</label>
      <input id="date" value="">
      <script>
        // 預設今天 yyyy/MM/dd
        (function(){
          const d = new Date();
          const pad = n => String(n).padStart(2,"0");
          const v = `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}`;
          document.getElementById("date").value = v;
        })();
      </script>
    </div>
    <div>
      <label for="shift">shift</label>
      <select id="shift">
        <option>A</option><option>B</option><option>C</option>
      </select>
    </div>
    <div>
      <label for="part_no">part_no（自動轉大寫）</label>
      <input id="part_no" value="ABCD123">
    </div>
    <div>
      <label for="lot">lot（自動轉大寫）</label>
      <input id="lot" value="FA-001">
    </div>
    <div>
      <label for="qty">qty</label>
      <input id="qty" type="number" min="0" step="1" value="10">
    </div>
    <div>
      <label for="inspector">inspector（自動轉大寫）</label>
      <input id="inspector" value="U001">
    </div>
    <div style="flex-basis:100%"></div>
    <div style="flex:1 1 100%">
      <label for="remark">remark（可空）</label>
      <input id="remark" value="">
    </div>
  </div>
  <div style="margin-top:12px">
    <button type="button" id="sendBtn" onclick="sendFullPost()">送出（x-www-form-urlencoded）</button>
  </div>
</div>

<div class="card">
  <h3>送出內容（URLSearchParams）</h3>
  <pre id="payload"></pre>
</div>

<div class="card">
  <h3>回應</h3>
  <h4>狀態 + Headers</h4>
  <pre id="headers"></pre>
  <h4>原始文字</h4>
  <pre id="raw"></pre>
  <h4>JSON 解析</h4>
  <pre id="json"></pre>
</div>

</body>
</html>