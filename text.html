<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RT 外觀抽驗記錄表</title>
<style>
  :root{--maxw:560px;--labelw:92px;}
  body{margin:0;background:#f6f7f9;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;color:#222}
  .wrap{max-width:var(--maxw);margin:16px auto;padding:12px 14px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .title{font-size:18px;font-weight:700}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #d0d0d0;background:#fff;cursor:pointer}
  .row{display:flex;align-items:center;margin:8px 0}
  .label{width:var(--labelw);text-align:center;letter-spacing:.2em;font-family:"標楷體",serif}
  .label:after{content:"："}
  .row input,.row select{flex:1;max-width:100%;padding:10px;border:1px solid #dcdfe6;border-radius:10px;outline:none}
  .row.split{gap:8px}
  .row .w25{flex:0 0 25%}
  .row .w40{flex:0 0 40%}
  .actions{display:flex;justify-content:flex-end;gap:10px;margin:12px 0}
  hr{border:none;border-top:1px solid #e9e9e9;margin:12px 0}
  table{width:100%;border-collapse:collapse}
  thead th{background:#f4f6fb;color:#333;font-family:"標楷體",serif;letter-spacing:.2em;padding:8px}
  th,td{border-top:1px solid #eee;padding:8px 6px;text-align:center}
  .muted{color:#888;text-align:center;margin-top:6px}
  .err{color:#c62828;text-align:center;margin-top:6px;white-space:pre-wrap}
  .foot{margin-top:12px;font-size:12px;color:#666;text-align:center}
  /* Loading */
  .loading{position:fixed;inset:0;background:rgba(255,255,255,.7);display:none;align-items:center;justify-content:center;z-index:999}
  .spinner{width:48px;height:48px;border:6px solid #ddd;border-top-color:#0a66ff;border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">RT 外觀抽驗記錄表</div>
    <button class="btn" onclick="location.href='./index.html'">返回</button>
  </header>

  <!-- 當日當班 / 檢驗員 / 即時時間 -->
  <div class="row">
    <div class="label">當日當班</div>
    <div id="dsDisplay" style="font-weight:700"></div>
  </div>
  <div class="row">
    <div class="label">檢驗員</div>
    <input id="inspector" inputmode="latin" autocomplete="off" placeholder="請輸入工號（完成後一次送出）" />
  </div>
  <div class="row">
    <div class="label">時間戳記</div>
    <div id="nowTs"></div>
  </div>

  <!-- 料號 -->
  <div class="row">
    <div class="label">料　號</div>
    <input id="part_no" placeholder="請輸入 料號 by 7碼" />
  </div>

  <!-- 批號：左下拉 + 右輸入 -->
  <div class="row split">
    <div class="label">批　號</div>
    <select id="lot_prefix" class="w25">
      <option value=""></option>
      <option value="FA">FA</option>
    </select>
    <input id="lot_input" class="w40" placeholder="母批[3] 或 母批-子批[3-2]" />
  </div>

  <!-- 數量 -->
  <div class="row">
    <div class="label">數　量</div>
    <input id="qty" inputmode="numeric" placeholder="請輸入數量" />
  </div>

  <div class="actions">
    <button id="btnSubmit" class="btn">送出</button>
  </div>

  <hr/>

  <!-- 當班清單（改為草稿機制） -->
  <table>
    <thead><tr><th>料號</th><th>批號</th><th>數量</th></tr></thead>
    <tbody id="current-list"></tbody>
  </table>

  <div id="msg" class="muted"></div>
  <div class="foot">form v17.6.3</div>
</div>

<!-- Loading -->
<div id="loading" class="loading"><div class="spinner"></div></div>

<script>
/* ===== 基本設定 ===== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const canon = s => String(s||'').trim().toUpperCase();
const $ = sel => document.querySelector(sel);

/* 台北時區與班別 */
function toTz(d){ return new Date(d.toLocaleString('en-US',{timeZone:'Asia/Taipei'})); }
function mdOf(d){ return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',month:'2-digit',day:'2-digit'}).format(d); }
function ymdOf(d){ const f=new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit'}).format(d); return f.replace(/\//g,'-'); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function computeCurrentDS(){
  const now = toTz(new Date());
  const mins = now.getHours()*60 + now.getMinutes();
  if (mins>=40 && mins<520){ const d=addDays(now,-1); return {dateYMD: ymdOf(d), dateMD: mdOf(d), shift:'C', now}; }
  if (mins>=520 && mins<1000){ return {dateYMD: ymdOf(now), dateMD: mdOf(now), shift:'A', now}; }
  if (mins>=1000){ return {dateYMD: ymdOf(now), dateMD: mdOf(now), shift:'B', now}; }
  const d=addDays(now,-1); return {dateYMD: ymdOf(d), dateMD: mdOf(d), shift:'B', now};
}

/* ===== 草稿機制（以「當日當班」分區；成功送出才寫入） ===== */
const DRAFT_NS = 'RT_DRAFT_V1';
function dsKey(ds){ return `${DRAFT_NS}:${ds.dateYMD}|${ds.shift}`; }
function getDraft(ds){
  const raw = localStorage.getItem(dsKey(ds));
  try{ return raw? JSON.parse(raw): {ds, items:[], updated_at: Date.now()}; }
  catch{ return {ds, items:[], updated_at: Date.now()}; }
}
function saveDraft(ds, draft){
  draft.updated_at = Date.now();
  localStorage.setItem(dsKey(ds), JSON.stringify(draft));
  localStorage.setItem(`${DRAFT_NS}:LAST_DS`, `${ds.dateYMD}|${ds.shift}`);
}
function rotateDraftIfNeeded(){
  const ds = computeCurrentDS();
  const last = localStorage.getItem(`${DRAFT_NS}:LAST_DS`);
  const cur  = `${ds.dateYMD}|${ds.shift}`;
  if (last && last!==cur){
    Object.keys(localStorage).forEach(k=>{
      if (k.startsWith(`${DRAFT_NS}:`) && !k.endsWith(':LAST_DS')) localStorage.removeItem(k);
    });
  }
  localStorage.setItem(`${DRAFT_NS}:LAST_DS`, cur);
  return ds;
}
function upsertDraftAfterSubmit({part_no, lot, qty, inspector}){
  const ds = rotateDraftIfNeeded();
  const draft = getDraft(ds);
  const key = `${canon(part_no)}|${canon(lot)}`; // 當班內：料號+批號 唯一
  const now = new Date().toISOString();
  const idx = draft.items.findIndex(it => it.key === key);
  const item = { key, part_no, lot, qty, inspector, submitted_at: now };
  if (idx>=0) draft.items[idx] = item; else draft.items.unshift(item);
  if (draft.items.length>50) draft.items.length = 50;
  saveDraft(ds, draft);
  renderCurrentShiftListFromDraft();
}
function renderCurrentShiftListFromDraft(){
  const ds = rotateDraftIfNeeded();
  const draft = getDraft(ds);
  const tbody = $('#current-list');
  if (!tbody) return;
  tbody.innerHTML = '';
  if (!draft.items.length){
    tbody.innerHTML = `<tr><td colspan="3" class="muted">（當班無草稿）</td></tr>`;
    return;
  }
  draft.items.forEach(x=>{
    tbody.insertAdjacentHTML('beforeend', `<tr><td>${x.part_no}</td><td>${x.lot}</td><td>${x.qty}</td></tr>`);
  });
}

/* ===== 批號補零與驗證（母批3碼；母-子 3-2；排除 I/O） ===== */
function normalizeLot(prefix, input){
  const pre = canon(prefix);
  let s = canon(input).replace(/\s+/g,'');
  if (!s) return '';
  let mother='', child='';
  if (s.includes('-')){
    const [a,b] = s.split('-',2);
    mother = (a||'').padStart(3,'0');
    child  = (b||'').padStart(2,'0');
    if (!b) return '';
  }else{
    mother = s.padStart(3,'0');
  }
  const bad = /[IO]/;
  if (!/^[A-Z0-9]{3}$/.test(mother) || bad.test(mother)) return '';
  if (child && (!/^[A-Z0-9]{2}$/.test(child) || bad.test(child))) return '';
  const core = child ? `${mother}-${child}` : mother;
  return pre ? `${pre}-${core}` : core;
}

/* ===== 送出流程 ===== */
async function submitForm(){
  const loading   = $('#loading');
  const inspector = canon($('#inspector').value);
  const part_no   = canon($('#part_no').value);
  const qty       = Number(($('#qty').value||'').trim());
  const lotNorm   = normalizeLot($('#lot_prefix').value, $('#lot_input').value);

  if (!inspector){ return toast('請輸入「檢驗員」'); }
  if (!part_no){  return toast('請輸入「料號」'); }
  if (!lotNorm){  return toast('請正確輸入「批號」（母批3碼，或 母批3-子批2）'); }
  if (!Number.isFinite(qty) || qty<=0){ return toast('請輸入正確「數量」'); }

  const sample = Math.min(20, qty);
  const payload = { part_no, lot: lotNorm, qty, sample, inspector, remark: "", deleted: true };

  try{
    loading.style.display='flex';
    const res = await fetch(GAS_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const t = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}\n${t}`);

    // 成功→寫入草稿並刷新清單
    upsertDraftAfterSubmit({part_no, lot: lotNorm, qty, inspector});

    // 規則：保留料號；清空批號&數量；點擊料號才清空
    $('#qty').value = '';
    $('#lot_input').value = '';
    $('#part_no').addEventListener('focus', ()=>{
      if ($('#part_no').dataset.justKept !== '1'){ $('#part_no').value=''; }
    }, {once:true});
    $('#part_no').dataset.justKept = '1';

    toast('已送出');
  }catch(e){
    $('#msg').className='err';
    $('#msg').textContent = '送出失敗：\n' + (e && e.message ? e.message : e);
  }finally{
    loading.style.display='none';
  }
}

/* ===== UI / 初始化 ===== */
function toast(txt){
  const n = $('#msg');
  n.className='muted';
  n.textContent = txt;
  setTimeout(()=>{ if(n.textContent===txt) n.textContent=''; }, 2500);
}
function refreshHeader(){
  const ds = computeCurrentDS();
  $('#dsDisplay').textContent = `${ds.dateMD} - ${ds.shift}`;
  $('#nowTs').textContent = new Intl.DateTimeFormat('zh-TW',{
    timeZone:'Asia/Taipei', year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  }).format(ds.now);
}

document.addEventListener('DOMContentLoaded', ()=>{
  refreshHeader();
  rotateDraftIfNeeded();
  renderCurrentShiftListFromDraft();

  // 檢驗員：符合規則即保存
  const savedInspector = localStorage.getItem('RT_INSPECTOR')||'';
  if (savedInspector) $('#inspector').value = savedInspector;
  $('#inspector').addEventListener('change', ()=>{
    const v = canon($('#inspector').value);
    if (v) localStorage.setItem('RT_INSPECTOR', v);
  });

  // 送出
  $('#btnSubmit').addEventListener('click', submitForm);

  // 即時時間每 10 秒更新（不改班別錨定）
  setInterval(()=>{
    $('#nowTs').textContent = new Intl.DateTimeFormat('zh-TW',{
      timeZone:'Asia/Taipei', year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit'
    }).format(new Date());
  }, 10000);
});
</script>
</body>
</html>