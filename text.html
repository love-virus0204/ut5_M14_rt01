<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</title>
<style>
  :root{--maxw:520px; --labelw:92px;}
  body{margin:0;background:#f5f5f5;font-family:"Comic Sans MS",sans-serif}
  .wrap{max-width:var(--maxw);margin:8px auto;padding:10px 14px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .toolbar{display:grid;grid-template-columns:36px auto 36px;align-items:center;margin-bottom:6px}
  .tool-left{justify-self:start}
  .tool-right{justify-self:end}
  .tool-btn{background:none;border:0;font-size:18px;line-height:1;padding:2px 6px;cursor:pointer}
  .title{font-family:"æ¨™æ¥·é«”",serif;text-align:center;font-weight:700;margin:0;font-size:1.4rem}
  @media (max-width: 400px){ .title{font-size:1.2rem} }
  .ds-line{font-weight:700;margin:8px 0 10px 0; padding-left:20px;}
  .row{display:grid;grid-template-columns:var(--labelw) 1fr;align-items:center;column-gap:10px;margin:6px 0}
  .label{font-family:"æ¨™æ¥·é«”",serif;text-align:center}
  .ctrl{width:100%}
  .ctrl input,.ctrl select{width:100%;box-sizing:border-box;padding:7px;border:1px solid #ccc;border-radius:6px;font-family:"Comic Sans MS",sans-serif}
  .row.lot-type .ctrl{display:grid;grid-template-columns:25% 1fr;column-gap:8px}
  .row.lot-type select{min-width:80px}
  .field-error{display:none;color:#d93025;font-weight:700;font-size:13px;margin-top:4px}

  /* é€å‡ºåˆ—ï¼šæŒ‰éˆ•åœ¨å³å´ï¼›æç¤ºç½®ä¸­ï¼ˆå› v17.6.2 ä½ˆå±€ï¼‰ */
  .submit{position:relative;display:flex;justify-content:flex-end;align-items:center;margin-top:10px}
  .submit-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:12px}
  .btn{background:#0a66ff;color:#fff;border:0;border-radius:8px;padding:10px 18px;cursor:pointer}

  /* æˆåŠŸè¨Šæ¯èˆ‡å‚³é€ä¸­å‹•ç•« */
  .ok-msg{display:none;color:#1a7f37;font-weight:700;font-size:13px}
  .ok-msg.show{display:block;opacity:1;transition:opacity .4s}
  .ok-msg.fade{opacity:0}
  .dots{display:none;font-size:13px;color:#333}
  .dots span{opacity:0;animation:blink 1s infinite;}
  .dots span:nth-child(1){animation-delay:0s}
  .dots span:nth-child(2){animation-delay:.2s}
  .dots span:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,100%{opacity:0}50%{opacity:1}}

  hr{margin:10px 0}
  .post{width:95%;margin:0 auto}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-top:1px solid #ddd;text-align:center;padding:6px 4px}
  .bottom-info{display:grid;grid-template-columns:1fr 1fr;align-items:center;margin:6px 0}
  .ver-left{justify-self:start;font-size:12px;color:#666}
  .time-right{justify-self:end;font-size:12px;color:#333;text-align:right}

  /* èˆ‡å¾Œå°ä¸ç¬¦/è¢«åˆª â†’ åˆªé™¤ç·š */
  .tr-strike td{ color:#999; text-decoration: line-through; }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="tool-left"><button class="tool-btn" id="langBtn" title="èªè¨€">ğŸŒ</button></div>
    <h1 class="title">RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</h1>
    <div class="tool-right"><button class="tool-btn" id="backBtn" title="è¿”å›" onclick="location.href='index.html'">â†©ï¸</button></div>
  </div>

  <div id="dsView" class="ds-line"></div>

  <div class="row">
    <div class="label">æª¢ã€€é©—ï¼š</div>
    <div class="ctrl">
      <input id="inspector" maxlength="5" placeholder="è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ">
      <div id="inspectorError" class="field-error"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ–™ã€€è™Ÿï¼š</div>
    <div class="ctrl">
      <input id="partNo" maxlength="7" placeholder="è¼¸å…¥ 7ç¢¼æ–™è™Ÿ">
      <div id="partError" class="field-error"></div>
    </div>
  </div>

  <div class="row lot-type">
    <div class="label">å‹ã€€æ…‹ï¼š</div>
    <div class="ctrl">
      <select id="lotPrefix">
        <option value=""></option>
        <option value="FA">FA</option>
      </select>
      <div></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ‰¹ã€€è™Ÿï¼š</div>
    <div class="ctrl">
      <input id="lotInput" placeholder="æ¯æ‰¹(3ç¢¼) or æ¯æ‰¹-å­æ‰¹(3-2)ï¼›ç¦ I / O">
      <div id="lotError" class="field-error"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ•¸ã€€é‡ï¼š</div>
    <div class="ctrl"><input id="qty" type="number" min="1" placeholder="è¼¸å…¥ æ‰¹é‡"></div>
  </div>

  <div class="submit">
    <div class="submit-center">
      <div id="okMsg" class="ok-msg"></div>
      <div id="loadingDots" class="dots">å‚³é€ä¸­<span>.</span><span>.</span><span>.</span></div>
    </div>
    <button id="sendBtn" class="btn">é€å‡º</button>
  </div>

  <hr>

  <div class="post">
    <div class="bottom-info">
      <div id="versionTag" class="ver-left">ç‰ˆæœ¬ï¼šv17.7.1</div>
      <div id="tsView" class="time-right"></div>
    </div>
    <table>
      <thead><tr><th>æ–™ã€€è™Ÿ</th><th>æ‰¹ã€€è™Ÿ</th><th>æ•¸ã€€é‡</th></tr></thead>
      <tbody id="recordList"></tbody>
    </table>
  </div>
</div>

<script>
/* --- å¸¸æ•¸/å·¥å…· --- */
const GAS_URL="https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const API_TOKEN="MY_SECRET_123";
const INSPECTOR_KEY="inspector_id";

function fw2hw(s){return String(s||"").replace(/[\uFF01-\uFF5E]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0)).replace(/\u3000/g," ")}
function CANON(s){return fw2hw(s).trim().toUpperCase()}
function normLotKey(s){return CANON(s).replace(/^FA-/, "")}
function buildKey(date,shift,part,lotDisp){return `${CANON(date)}|${CANON(shift)}|${CANON(part)}|${normLotKey(lotDisp)}`}
function hasFA(s){ return /^FA-/.test(CANON(s)); }

function twNowStr(){return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).format(new Date())}
function mdOf(d){return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',month:'2-digit',day:'2-digit'}).format(d)}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}

/* --- ç­åˆ¥åˆ¤æ–· --- */
function computeShiftByClock(){
  const now = new Date();
  const tzNow = new Date(now.toLocaleString('en-US',{timeZone:'Asia/Taipei'}));
  const h = tzNow.getHours(), m = tzNow.getMinutes();
  const mins = h*60+m;
  let dateMD, shift;
  if (mins >= 40 && mins < 520) { dateMD = mdOf(addDays(tzNow,-1)); shift = 'C'; }
  else if (mins >= 520 && mins < 1000) { dateMD = mdOf(tzNow); shift = 'A'; }
  else if (mins >= 1000) { dateMD = mdOf(tzNow); shift = 'B'; }
  else { dateMD = mdOf(addDays(tzNow,-1)); shift = 'B'; }
  return { dateMD, shift };
}
let currentDS = computeShiftByClock();
document.getElementById('dsView').textContent = `${currentDS.dateMD} - ${currentDS.shift}`;

/* --- å·¥è™Ÿè‰ç¨¿ --- */
function saveInspector(){const v=CANON(document.getElementById('inspector').value); if(/^[A-Z0-9]{5}$/.test(v)) localStorage.setItem(INSPECTOR_KEY,v)}
function loadInspector(){const v=localStorage.getItem(INSPECTOR_KEY)||''; if(v) document.getElementById('inspector').value=v}
const inspector=document.getElementById('inspector');
const inspectorError=document.getElementById('inspectorError');
function setInspectorError(msg){
  if(!inspectorError) return;
  inspectorError.textContent = msg||''; inspectorError.style.display = msg ? 'block':'none';
}
inspector.addEventListener('input',()=>{ setInspectorError(''); saveInspector(); });
inspector.addEventListener('blur',()=>{
  const v = CANON(inspector.value);
  if (!v){ setInspectorError('å·¥è™Ÿå¿…å¡«'); return; }
  if (!/^[A-Z0-9]{5}$/.test(v)){ setInspectorError('éœ€ 5 ç¢¼è‹±æ•¸'); return; }
  setInspectorError('');
});

/* --- ç•¶ç­è‰ç¨¿ï¼ˆæ–™è™Ÿ/æ‰¹è™Ÿ/æ•¸é‡/å‰ç¶´ï¼‰ --- */
const DSK='rt_draft_ds', DP='rt_draft_';
function dsKey(){return `${currentDS.dateMD}|${currentDS.shift}`}
function draftKey(){return DP+dsKey()}
function saveDraft(){
  const d={part:partNo.value, lot:lotInput.value, qty:qty.value, prefix:lotPrefix.value};
  localStorage.setItem(draftKey(),JSON.stringify(d)); localStorage.setItem(DSK,dsKey());
}
function loadDraft(){
  loadInspector();
  const last=localStorage.getItem(DSK)||''; if(last && last!==dsKey()) localStorage.removeItem(DP+last);
  const raw=localStorage.getItem(draftKey()); if(!raw) return; const d=JSON.parse(raw);
  partNo.value=d.part||''; lotInput.value=d.lot||''; qty.value=d.qty||''; lotPrefix.value=d.prefix||'';
}

/* --- æ™‚é˜ --- */
function tick(){ document.getElementById('tsView').textContent = twNowStr(); }
setInterval(tick,1000); tick();

/* --- DOM å…ƒç´  --- */
const partNo=document.getElementById('partNo');
const partError=document.getElementById('partError');
const lotPrefix=document.getElementById('lotPrefix');
const lotInput=document.getElementById('lotInput');
const lotError=document.getElementById('lotError');
const qty=document.getElementById('qty');
const okMsg=document.getElementById('okMsg');
const loadingDots=document.getElementById('loadingDots');

/* --- è®Šæ›´å³å­˜è‰ç¨¿ --- */
['inspector','partNo','lotInput','lotPrefix','qty'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{if(id==='inspector')saveInspector(); else saveDraft();})
});
loadDraft();

/* --- æ¬„ä½éŒ¯èª¤é¡¯ç¤º --- */
function setLotError(msg){ lotError.textContent = msg||''; lotError.style.display = msg ? 'block':'none'; }
function setPartError(msg){ partError.textContent = msg||''; partError.style.display = msg ? 'block':'none'; }

/* --- æˆåŠŸ/è¼‰å…¥æç¤º --- */
let okTimer=null;
function showOk(msg){
  if(okTimer){ clearTimeout(okTimer); okTimer=null; }
  okMsg.textContent = msg||'';
  okMsg.classList.add('show'); okMsg.classList.remove('fade');
  okTimer = setTimeout(()=>{ okMsg.classList.add('fade'); }, 4600);
  setTimeout(()=>{ okMsg.classList.remove('show','fade'); okMsg.textContent=''; }, 5000);
}
function showLoading(on){ loadingDots.style.display = on ? 'inline-block' : 'none'; }

/* --- æ‰¹è™Ÿè§£æ --- */
function parseLot(input){
  const s = CANON(input).replace(/\s+/g,'');
  if (!s) return { ok:false, msg:'æ¯æ‰¹å¿…å¡«ï¼ˆ3ç¢¼ï¼‰' };
  if (s.includes('-')) {
    const [m, cRaw] = s.split('-', 2);
    if (!m || !/^[A-HJ-NP-Z0-9]{3}$/.test(m)) return { ok:false, msg:'æ¯æ‰¹éœ€æ­£å¥½ 3 ç¢¼ï¼Œä¸”ä¸å¯å« I / O' };
    if (!cRaw) return { ok:false, msg:'æœ‰é€£å­—è™Ÿæ™‚å¿…é ˆè¼¸å…¥å­æ‰¹ï¼ˆ1~2 ç¢¼ï¼‰' };
    if (!/^[A-HJ-NP-Z0-9]{1,2}$/.test(cRaw)) return { ok:false, msg:'å­æ‰¹éœ€ 1~2 ç¢¼ï¼Œä¸”ä¸å¯å« I / O' };
    return { ok:true, mother:m, child:cRaw.padStart(2,'0'), hasChild:true };
  } else {
    const m = s;
    if (!/^[A-HJ-NP-Z0-9]{3}$/.test(m)) return { ok:false, msg:'æ¯æ‰¹éœ€æ­£å¥½ 3 ç¢¼ï¼Œä¸”ä¸å¯å« I / O' };
    return { ok:true, mother:m, child:'', hasChild:false };
  }
}
lotInput.addEventListener('input', ()=> setLotError(''));
lotInput.addEventListener('blur', ()=>{
  const r = parseLot(lotInput.value);
  if (!r.ok) { setLotError(r.msg); return; }
  setLotError('');
  lotInput.value = r.mother + (r.hasChild ? '-' + r.child : '');
  saveDraft();
});

/* --- æ–™è™Ÿå³æ™‚é©—è­‰ --- */
partNo.addEventListener('input', ()=> setPartError(''));
partNo.addEventListener('blur', ()=>{
  const p = CANON(partNo.value);
  if (!p) { setPartError('æ–™è™Ÿå¿…å¡«'); return; }
  if (!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(p)) { setPartError('æ ¼å¼éŒ¯èª¤ï¼ˆå¦‚ A58K052ï¼‰'); return; }
  setPartError('');
});

/* --- è‰ç¨¿æ¸…å–®ï¼ˆä»¥æ–™è™Ÿ + æ­£è¦åŒ–æ‰¹è™Ÿæ¯”å°è¦†è“‹ï¼‰ --- */
const LIST_NS='rt_draft_list_v1';
function listDsKey(){return `${currentDS.dateMD}|${currentDS.shift}`}
function listKey(){return `${LIST_NS}:${listDsKey()}`}
function listGet(){ try{ return JSON.parse(localStorage.getItem(listKey())||'[]'); }catch{ return []; } }
function listSet(arr){
  localStorage.setItem(listKey(), JSON.stringify(arr.slice(0,50)));
  localStorage.setItem(`${LIST_NS}:LAST_DS`, listDsKey());
}
function listRotateIfNeeded(){
  const last = localStorage.getItem(`${LIST_NS}:LAST_DS`);
  const cur  = listDsKey();
  if(last && last!==cur){
    Object.keys(localStorage).forEach(k=>{
      if(k.startsWith(`${LIST_NS}:`) && !k.endsWith(':LAST_DS')) localStorage.removeItem(k);
    });
  }
  localStorage.setItem(`${LIST_NS}:LAST_DS`, cur);
}
function draftRowKey(part_no, lot){
  const norm = normLotKey(lot); // å» FA-
  return `${CANON(part_no)}|${CANON(norm)}`;
}
function renderDraftList(){
  listRotateIfNeeded();
  const tb=document.getElementById('recordList'); tb.innerHTML='';
  const rows = listGet();
  if(!rows.length){
    tb.innerHTML = `<tr><td colspan="3" style="color:#888">ï¼ˆç•¶ç­ç„¡è‰ç¨¿ï¼‰</td></tr>`;
    return;
  }
  rows.forEach(x=>{
    const tr=document.createElement('tr');
    if (x.strike) tr.classList.add('tr-strike');
    tr.innerHTML = `<td>${x.part_no||''}</td><td>${x.lot||''}</td><td>${x.qty||''}</td>`;
    tb.appendChild(tr);
  });
}
function upsertDraftList({part_no, lot, qty, inspector}){
  listRotateIfNeeded();
  const arr = listGet();
  const key = draftRowKey(part_no, lot);
  const idx = arr.findIndex(x => draftRowKey(x.part_no, x.lot) === key);
  const item = {part_no, lot, qty, inspector, submitted_at: new Date().toISOString(), strike:false};
  if(idx>=0) arr[idx]=item; else arr.unshift(item);
  listSet(arr);
  renderDraftList();
}
renderDraftList();

/* --- é€å‡ºæµç¨‹ --- */
let clearPartOnce=false;
partNo.addEventListener('focus',()=>{ 
  if(clearPartOnce){ partNo.value=''; clearPartOnce=false; saveDraft(); } 
});

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const inspectorVal=CANON(inspector.value);
  const part=CANON(partNo.value);
  const prefix=CANON(lotPrefix.value);

  const lotParsed = parseLot(lotInput.value);
  if (!lotParsed.ok){ setLotError(lotParsed.msg); lotInput.focus(); return; }
  setLotError('');
  lotInput.value = lotParsed.mother + (lotParsed.hasChild ? '-' + lotParsed.child : '');
  const lotDisp = prefix 
    ? `${prefix}-${lotInput.value}`
    : lotInput.value;

  if (!part){ setPartError('æ–™è™Ÿå¿…å¡«'); partNo.focus(); return; }
  if (!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(part)){ setPartError('æ ¼å¼éŒ¯èª¤ï¼ˆå¦‚ A58K052ï¼‰'); partNo.focus(); return; }
  setPartError('');

  const q=Number(qty.value);
  if(!(q>0)) return alert('æ•¸é‡éœ€ > 0');
  if(!/^[A-Z0-9]{5}$/.test(inspectorVal)){ setInspectorError('éœ€ 5 ç¢¼è‹±æ•¸'); inspector.focus(); return; }
  setInspectorError('');

  const key = buildKey(currentDS.dateMD, currentDS.shift, part, lotDisp);
  const payload={
    token:API_TOKEN,
    key,
    date:currentDS.dateMD, shift:currentDS.shift,
    part_no:part,
    lot_prefix:prefix,
    mother_child: lotInput.value, // "ABC" or "ABC-01"
    qty:String(q),
    inspector:inspectorVal,
    // remark/z7~z13 ç”±å¾Œç«¯å›ºå®šè™•ç†
  };

  const btn=document.getElementById('sendBtn');
  btn.disabled=true; showLoading(true);

  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
    const data=await res.json();

    if (data.status === 'deleted'){
      alert('âš ï¸ æ­¤ç­†è³‡æ–™å·²è¢«åˆªé™¤ï¼Œè«‹æ‰¾å¹¹éƒ¨è™•ç†');
      return;
    }
    if (data.status !== 'ok'){
      alert('âŒ å¾Œç«¯ï¼š'+JSON.stringify(data));
      return;
    }

    // é¡¯ç¤ºæˆåŠŸï¼ˆæ–°å¢/æ›´æ–°ï¼‰
    showOk(data.upsert==='update' ? 'âœ… å·²æ›´æ–°' : 'âœ… å·²æ–°å¢');

    // æ›´æ–°è‰ç¨¿åˆ—
    upsertDraftList({part_no:part, lot:lotDisp, qty:String(q), inspector:inspectorVal});

    // ä¾ã€Œå¾Œç«¯æ¬Šå¨å¿«ç…§ã€æ¯”å° â†’ æ±ºå®šæ˜¯å¦åŠ åˆªé™¤ç·š
    if (data.latest){
      const latest = data.latest;
      const mismatch =
        latest.deleted === true ||                       // è»Ÿåˆªé™¤
        String(latest.qty) !== String(q) ||              // æ•¸é‡ä¸ç¬¦
        CANON(latest.inspector||'') !== CANON(inspectorVal||'') || // æª¢é©—å“¡ä¸ç¬¦
        (hasFA(latest.lot) !== hasFA(lotDisp));          // FA å‰ç¶´ä¸ç¬¦

      markDraftStrike(draftRowKey(part, lotDisp), mismatch);
    }

    // æ¸…ç†è¼¸å…¥ï¼ˆä¿ç•™æ–™è™Ÿï¼‰
    lotInput.value=''; qty.value=''; saveDraft();
    clearPartOnce=true;

  }catch(err){
    alert('é€å‡ºéŒ¯èª¤ï¼š'+err.message);
  }finally{
    btn.disabled=false; showLoading(false);
  }
});

/* å°‡æŸè‰ç¨¿åˆ—æ¨™ç¤º/å–æ¶ˆåˆªé™¤ç·š */
function markDraftStrike(draftKeyForRow, strike){
  const arr = listGet();
  const idx = arr.findIndex(x => draftRowKey(x.part_no, x.lot) === draftKeyForRow);
  if (idx >= 0){
    arr[idx].strike = !!strike;
    listSet(arr);
    renderDraftList();
  }
}

/* å¤šåœ‹èªè¨€é ç•™ */
document.getElementById('langBtn').addEventListener('click',()=>alert('å¤šåœ‹èªè¨€é ç•™ï¼šæœªå•Ÿç”¨'));
</script>
</body>
</html>