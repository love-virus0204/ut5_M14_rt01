<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>外觀記錄表｜管理</title>
<style>
  :root{ --bg:#f8fafc; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --brand:#0f766e; --ok:#10b981; --err:#ef4444; }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

  .wrap{width:96%;max-width:980px;margin:12px auto}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
  .hdr{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
  .ttl{font-weight:700;color:var(--brand)}
  .back{font-size:12px;color:#64748b;text-decoration:none;border:1px solid var(--line);padding:6px 10px;border-radius:8px}
  .content{padding:0 14px 12px}
  #status{color:#475569;margin:12px 0;min-height:1.4em;text-align:center;font-weight:600}
  #status.hidden{display:none}
  .grp{margin:10px 0 6px;font-weight:700}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-top:1px solid #ddd;text-align:center;padding:6px 4px}
  thead th{background:#f3f4f6;color:#334155}
  tbody tr:nth-child(odd){background:#f9fafb}
  tbody tr:nth-child(even){background:#eef2f7}

  /* 底部三區塊 */
  .foot{padding:8px 14px;border-top:1px solid var(--line);display:flex;align-items:center;gap:12px;color:#64748b;font-size:12px}
  .foot .left{flex:0 0 auto}
  .foot .center{flex:1 1 auto;text-align:center;white-space:nowrap}
  .foot .right{flex:0 0 auto}
  .btn{background:#ef4444;color:#fff;border:0;border-radius:10px;cursor:pointer;min-width:100px;height:32px;line-height:32px;padding:0 12px}
  .btn:disabled{background:#94a3b8;cursor:not-allowed}

  /* 狀態燈 */
  .net{display:flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:50%;background:#d1d5d9;border:1px solid #cbd5e1}
  .ok{background:#10b981!important;border-color:#10b981!important}
  .err{background:#ef4444!important;border-color:#ef4444!important}

  /* 對話框 */
  dialog{margin:0;border:none;border-radius:12px;padding:0;background:#0f172a;color:#e6edf3;max-width:420px;width:calc(100% - 32px)}
  .dlg-body{padding:16px}
  .dlg-title{font-weight:700;margin-bottom:8px}
  .fld{display:flex;flex-direction:column;gap:8px}
  .fld label{font-size:12px;color:#94a3b8}
  .fld input{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e6edf3}
  .fld input:focus{border-color:#60a5fa;outline:none}
  .err{color:#ef4444;margin-top:6px;min-height:1.2em}
  .dlg-row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .btn-sec{background:#374151}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="hdr">
      <div class="ttl">管理｜當班記錄（勾選後刪除）</div>
      <a href="index.html" class="back">返回首頁</a>
    </div>
    <div class="content">
      <div id="status">載入中…</div>
      <div id="root"></div>
    </div>
    <div class="foot">
      <div class="left">
        <div class="net"><span id="net-dot" class="dot"></span><span id="net-msg">回傳</span></div>
      </div>
      <div id="footMsg" class="center">僅顯示「當日當班」且有效</div>
      <div class="right">
        <button id="submitBtn" class="btn" type="button" disabled>送出刪除</button>
      </div>
    </div>
  </div>
</div>

<!-- 確認視窗 -->
<dialog id="confirmDlg">
  <div class="dlg-body">
    <div class="dlg-title">確認刪除</div>
    <div class="fld">
      <label for="adminId">管理員代碼（5 碼）</label>
      <input id="adminId" type="text" inputmode="latin" maxlength="5" placeholder="如：AB123">
      <label for="confirmInput">確認字串</label>
      <input id="confirmInput" type="text" placeholder="輸入 admin">
      <div id="confirmErr" class="err"></div>
    </div>
    <div class="dlg-row">
      <button id="confirmCancel" class="btn btn-sec" type="button">取消</button>
      <button id="confirmOk" class="btn" type="button">確定刪除</button>
    </div>
  </div>
</dialog>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec";

/* 狀態燈 */
function setNetLight(msg){
  const dot = document.getElementById('net-dot');
  const txt = document.getElementById('net-msg');
  dot.classList.remove('ok','err');
  dot.classList.add(msg ? 'ok' : 'err');
  txt.textContent = msg ? "GMS" : "回傳";
}
const statusEl = document.getElementById('status');
const setStatus  = t=> statusEl.textContent=t;
const setFootMsg = t=> document.getElementById('footMsg').textContent=t;

/* 讀取 + 篩選（只留有效當日當班） — 省略細節，保持你原本邏輯 */

async function fetchRecentPOST(){
  const res = await fetch(API_BASE, { method:"POST", body:new URLSearchParams({action:"list_recent"}) });
  if (!res.ok) throw new Error("HTTP " + res.status);
  return await res.json();
}

/* 軟刪除：用 admin_id */
async function softDeleteWithFlag(rows, adminId){
  const body = new URLSearchParams();
  body.append("action", "soft_delete");
  body.append("admin_id", adminId);
  rows.forEach((r,i)=> body.append(`row${i+1}`, String(r)));
  const res = await fetch(API_BASE, { method:"POST", body });
  if (!res.ok) throw new Error("HTTP " + res.status);
  const data = await res.json().catch(()=> ({}));
  if (data?.status!=="ok") throw new Error(data?.msg || "後端回應非 ok");
  return data;
}

/* 共用草稿：只保 admin_id */
function loadDraft(){
  try{ return JSON.parse(localStorage.getItem("draft")||"{}"); }catch{return {}}
}
function saveDraft(patch){
  const out = Object.assign({}, loadDraft(), patch);
  localStorage.setItem("draft", JSON.stringify(out));
}

/* 對話框元素 */
const confirmDlg   = document.getElementById('confirmDlg');
const adminIdEl    = document.getElementById('adminId');
const confirmInput = document.getElementById('confirmInput');
const confirmErr   = document.getElementById('confirmErr');
let cachedPicks = [];

/* admin_id 規則 */
(function prefillAdminId(){
  const d = loadDraft();
  if (typeof d.admin_id === "string"){
    adminIdEl.value = (d.admin_id||"").toUpperCase().slice(0,5);
  }
})();
adminIdEl.addEventListener('input', ()=>{
  let v = adminIdEl.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,5);
  adminIdEl.value = v;
  saveDraft({ admin_id: v.length===5 ? v : "" });
});
adminIdEl.addEventListener('blur', ()=>{
  if (adminIdEl.value.length!==5){ adminIdEl.value=""; saveDraft({admin_id:""}); }
});

/* 確認送出 */
document.getElementById('submitBtn').addEventListener('click',ev=>{
  ev.preventDefault();
  cachedPicks=[...document.querySelectorAll('.pick:checked')].map(el=>el.value).filter(Boolean);
  if(!cachedPicks.length) return;
  confirmInput.value=""; confirmErr.textContent="";
  confirmDlg.showModal();
});
document.getElementById('confirmCancel').addEventListener('click',()=> confirmDlg.close());
confirmDlg.addEventListener('cancel', e=>{ e.preventDefault(); confirmDlg.close(); });

document.getElementById('confirmOk').addEventListener('click', async ()=>{
  const id=(adminIdEl.value||"").toUpperCase();
  const v =(confirmInput.value||"").trim();
  if(id.length!==5){ confirmErr.textContent="admin_id 需為 5 碼英數。"; return; }
  if(v!=="admin"){ confirmErr.textContent="請輸入 admin。"; confirmInput.value=""; return; }
  saveDraft({admin_id:id});
  confirmErr.textContent=""; confirmDlg.close();

  try{
    setFootMsg("送出中…");
    await softDeleteWithFlag(cachedPicks, id);
    setFootMsg("完成");
  }catch(e){
    setFootMsg("失敗："+(e?.message||e));
  }finally{
    await new Promise(r=>setTimeout(r,500));
    await loadAndRender();
  }
});

/* 載入渲染 (保持你原本的 pickTodayShift + render) */
async function loadAndRender(){
  try{
    statusEl.classList.remove('hidden');
    setStatus("載入中…");
    const data = await fetchRecentPOST();
    setNetLight("OK");
    // TODO: pickTodayShift & render(data) → 依你原本程式
    setStatus(""); statusEl.classList.add('hidden');
  }catch(e){
    setNetLight(); setStatus("載入失敗..請通知開發人員");
    statusEl.classList.remove('hidden');
  }
}
document.addEventListener('DOMContentLoaded', loadAndRender);
</script>
</body>
</html>