<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>即時備份</title>
<style>
  :root{color-scheme:light dark}
  body{
    margin:0;height:100vh;display:flex;align-items:center;justify-content:center;
    background:#f8fafc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#334155
  }
  .card{background:#fff;padding:24px 20px;border-radius:14px;box-shadow:0 6px 18px rgba(15,23,42,.1);
        width:min(92vw,360px);text-align:center;border:1px solid #e2e8f0}
  .title{font-size:18px;font-weight:600;margin-bottom:8px}
  .msg{font-size:14px;opacity:.85}
  .spinner{width:48px;height:48px;margin:16px auto;border:6px solid #e2e8f0;border-top-color:#3b82f6;border-radius:50%;
           animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .row{margin-top:12px;display:flex;gap:8px;justify-content:center}
  .btn{padding:.5rem .9rem;border-radius:8px;border:1px solid #cbd5e1;cursor:pointer;background:#f8fafc}
  .btn.primary{background:#3b82f6;color:#fff;border-color:#60a5fa}
  .hide{display:none}
</style>
</head>
<body>
  <div class="card">
    <div class="title" id="t">正在準備備份</div>
    <div class="spinner" id="sp"></div>
    <div class="msg" id="m">請稍候…</div>
    <div class="row">
      <button id="retry"  class="btn hide">重試</button>
      <button id="home"   class="btn primary hide">返回首頁</button>
    </div>
  </div>

<script>
/* === 常數 === */
const API_BASE   = "https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec";
const TIMEOUT_MS = 80000; // 80 秒
const EXPIRE_MS  = 2 * 60 * 1000;
const F_tokey    = "c7b5e18a4f3d29b6d01c84a57de239f8146bc9e2fa518a7d3c0ef492a5bdc876";

/* === 驗證授權 === */
function enforceGate(){
  const ts = parseInt(sessionStorage.getItem("ts") || "0", 10);
  const tk = sessionStorage.getItem("tokey") || "";
  const ok = (tk === F_tokey) && ts > 0 && (Date.now() - ts) <= EXPIRE_MS;
  if (!ok){
    sessionStorage.clear();
    location.replace("index.html");
  }
}
enforceGate();
document.addEventListener("visibilitychange", () => { if (!document.hidden) enforceGate(); });
window.addEventListener("focus", enforceGate);
window.addEventListener("pageshow", e => { if (e.persisted) enforceGate(); });

/* === DOM === */
const t = document.getElementById('t');
const m = document.getElementById('m');
const sp = document.getElementById('sp');
const btnRetry = document.getElementById('retry');
const btnHome  = document.getElementById('home');

/* === 導航 === */
function goHome(delay=0){
  setTimeout(() => {
    try { location.replace('index.html'); }
    catch { location.href = 'index.html'; }
  }, delay);
}
btnHome.addEventListener('click', () => goHome());
btnRetry.addEventListener('click', run);

/* === UI === */
function showLoading(msg){
  t.textContent = '執行即時備份';
  m.textContent = msg || '備份進行中…';
  sp.classList.remove('hide');
  btnRetry.classList.add('hide');
  btnHome.classList.add('hide');
}
function showSuccess(){
  sp.classList.add('hide');
  t.textContent = '備份成功';
  m.textContent = '3 秒後返回首頁…';
  btnHome.classList.remove('hide');
  goHome(3000);
}
function showError(msg){
  sp.classList.add('hide');
  t.textContent = '備份失敗';
  m.textContent = msg || '無法連線伺服器…';
  btnRetry.classList.remove('hide');
  btnHome.classList.remove('hide');
}

/* === 呼叫 API（加上 80s 逾時） === */
async function callBackup(){
  const ac  = new AbortController();
  const tid = setTimeout(() => ac.abort(), TIMEOUT_MS);
  try {
    const resp = await fetch(API_BASE, {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body: new URLSearchParams({ action: 'backup' }).toString(),
      signal: ac.signal
    });
    let data = {};
    try { data = await resp.json(); } catch(_){}
    if (resp.ok && data.status === 'ok') return true;
    throw new Error(data && data.msg ? data.msg : 'HTTP ' + resp.status);
  } catch (e) {
    if (e.name === 'AbortError') throw new Error('請求逾時(>80s)');
    throw e;
  } finally {
    clearTimeout(tid);
  }
}

/* === 流程：進頁 0.5s 後 POST，期間顯示動畫 === */
async function run(){
  showLoading('備份進行中…');
  try {
    await callBackup();
    showSuccess();
  } catch (err) {
    showError(err.message || '無法連線伺服器…');
  }
}

/* 自動觸發 */
setTimeout(run, 500);
</script>
</body>
</html>