<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rt外觀記錄表-查尋</title>
<style>
  :root{--maxw:560px;}
  body{margin:0;background:#f6f7f9;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;color:#222}
  .wrap{max-width:var(--maxw);margin:16px auto;padding:12px 14px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.06);border-radius:12px}
  header{position:relative;margin-bottom:6px;text-align:center}
  header h1{margin:0;font-size:18px}
  header .btn{position:absolute;right:0;top:0;margin:4px 8px;padding:8px 12px;border-radius:10px;border:1px solid #d0d0d0;background:#fff;cursor:pointer}
  .sub{font-size:14px;text-align:center;color:#444;margin:0 0 10px 0;font-weight:700}
  .dsbar{font-weight:700;text-align:center;color:#0a66ff;margin:10px 0}
  table{width:95%;margin:0 auto;border-collapse:collapse}
  thead th{background:#f4f6fb;color:#333;font-family:"標楷體",serif;letter-spacing:.2em}
  th,td{border-top:1px solid #eee;text-align:center;padding:8px 6px}
  .group{font-weight:700;color:#0a66ff;text-align:center;border-top:1px solid #ddd;padding:6px 0;background:#fafcff}
  .muted{color:#888;text-align:center;margin-top:6px}
  .err{color:#c62828;text-align:center;margin-top:6px;white-space:pre-wrap}
  .foot{margin-top:12px;font-size:12px;color:#666;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Rt外觀記錄表-查尋</h1>
    <button class="btn" onclick="location.href='./index.html'">返回</button>
  </header>

  <p id="range" class="sub">起迄班別：—</p>
  <div id="dsbar" class="dsbar">最近三個班：—</div>

  <table>
    <thead><tr><th>料號</th><th>批號</th><th>數量</th></tr></thead>
    <tbody id="list"></tbody>
  </table>

  <div id="msg" class="muted"></div>
  <div class="foot">last3shift v0.9</div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const canon = s => String(s||'').trim().toUpperCase();

/* 台北時區工具與格式 */
function toTz(d){ return new Date(d.toLocaleString('en-US',{timeZone:'Asia/Taipei'})); }
function mdOf(d){ return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',month:'2-digit',day:'2-digit'}).format(d); } // MM/DD
function ymdOf(d){
  const f = new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit'}).format(d);
  return f.replace(/\//g,'-'); // yyyy-MM-dd
}
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

/* 00:40/08:40/16:40；C 班顯示前一日，00:00–00:39 = 前一日 B */
function computeCurrentDS(){
  const now = toTz(new Date());
  const h = now.getHours(), m = now.getMinutes(), mins = h*60+m;
  if (mins >= 40 && mins < 520) { const d=addDays(now,-1); return { dateYMD: ymdOf(d), dateMD: mdOf(d), shift:'C', now }; }
  if (mins >= 520 && mins < 1000){ return { dateYMD: ymdOf(now), dateMD: mdOf(now), shift:'A', now }; }
  if (mins >= 1000){ return { dateYMD: ymdOf(now), dateMD: mdOf(now), shift:'B', now }; }
  const d=addDays(now,-1); return { dateYMD: ymdOf(d), dateMD: mdOf(d), shift:'B', now };
}

/* 最近三班（最新→較新→最舊），同時保留查詢用 YMD 與顯示用 MD */
function last3DS(cur){
  const ymd = cur.dateYMD, md = cur.dateMD, s = cur.shift;
  const prev = addDays(cur.now,-1), prevYMD = ymdOf(prev), prevMD = mdOf(prev);
  if (s==='B') return [
    {dateYMD: ymd,    dateMD: md,    shift:'B'},
    {dateYMD: ymd,    dateMD: md,    shift:'A'},
    {dateYMD: prevYMD,dateMD: prevMD,shift:'C'}
  ];
  if (s==='A') return [
    {dateYMD: ymd,    dateMD: md,    shift:'A'},
    {dateYMD: prevYMD,dateMD: prevMD,shift:'C'},
    {dateYMD: prevYMD,dateMD: prevMD,shift:'B'}
  ];
  return [
    {dateYMD: ymd, dateMD: md, shift:'C'},
    {dateYMD: ymd, dateMD: md, shift:'B'},
    {dateYMD: ymd, dateMD: md, shift:'A'}
  ];
}

/* —— ➊ 後端 date 轉為 MM/DD 比對（兼容 ISO / yyyy-MM-dd / MM/DD） —— */
function rowMD(dateVal){
  const s = String(dateVal||'').trim();
  const d1 = new Date(s);
  if (!isNaN(d1)) return mdOf(toTz(d1));              // ISO 或可被 Date 解析
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)){                 // yyyy-MM-dd
    const [y,m,d] = s.split('-').map(Number);
    return mdOf(toTz(new Date(y, m-1, d)));
  }
  if (/^\d{2}\/\d{2}$/.test(s)) return s;             // 已是 MM/DD
  return s;                                           // 其他格式：原樣
}

/* 依三個 (dateYMD,shift) 個別查詢（GAS 支援 shift 篩選） */
async function fetchByTriples(ds3){
  const reqs = ds3.map(d => {
    const u = `${GAS_URL}?scope=all&date=${encodeURIComponent(d.dateYMD)}&shift=${encodeURIComponent(d.shift)}`;
    return fetch(u).then(async r=>{
      const t = await r.text();
      if(!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}\nURL: ${u}\nBODY: ${t}`);
      try{ const j = JSON.parse(t); if(!Array.isArray(j)) throw 0; return j; }
      catch{ throw new Error(`非陣列回應\nURL: ${u}\nBODY: ${t}`); }
    });
  });
  const arr = await Promise.all(reqs);
  return arr.flat();
}

/* —— ➋ 前端用 date(MM/DD)+shift 嚴格比對，並去重 —— */
function filterForDS(allRows, ds3){
  const filtered = allRows.filter(r =>
    r.deleted === true &&
    ds3.some(t => rowMD(r.date) === t.dateMD && canon(r.shift) === t.shift)
  );
  const uniq = new Map();
  for (const r of filtered){
    const k = `${rowMD(r.date)}|${canon(r.shift)}|${canon(r.part_no)}|${canon(r.lot)}`;
    uniq.set(k, r);
  }
  return [...uniq.values()];
}

/* —— ➌ 渲染（單表頭＋分組列，以 MM/DD 顯示） —— */
function renderGrouped(tbodyId, ds3, rows){
  const tb = document.getElementById(tbodyId);
  tb.innerHTML = '';
  ds3.forEach(({dateMD,shift})=>{
    tb.insertAdjacentHTML('beforeend', `<tr><td class="group" colspan="3">${dateMD} ${shift}</td></tr>`);
    const part = rows.filter(r => rowMD(r.date) === dateMD && canon(r.shift) === shift);
    if(!part.length){
      tb.insertAdjacentHTML('beforeend','<tr><td colspan="3" class="muted">（無資料）</td></tr>');
    }else{
      part.forEach(x=>{
        tb.insertAdjacentHTML('beforeend', `<tr><td>${x.part_no||''}</td><td>${x.lot||''}</td><td>${x.qty||''}</td></tr>`);
      });
    }
  });
}

/* 主流程 */
(async function(){
  try{
    const cur = computeCurrentDS();
    const ds3 = last3DS(cur);
    const start = ds3[2], end = ds3[0];

    document.getElementById('dsbar').textContent =
      `最近三個班：${ds3.map(d=>`${d.dateMD}${d.shift}`).join('，')}`;
    document.getElementById('range').textContent =
      `起迄班別：${start.dateMD} ${start.shift} ~ ${end.dateMD} ${end.shift}`;

    const all = await fetchByTriples(ds3);
    const rows = filterForDS(all, ds3);
    renderGrouped('list', ds3, rows);
  }catch(e){
    const m = document.getElementById('msg');
    m.className='err';
    m.textContent = '讀取失敗：\n' + String(e && e.message ? e.message : e);
  }
})();
</script>
</body>
</html>