<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rt外觀記錄表-查尋</title>
<style>
  :root{--maxw:560px;}
  body{margin:0;background:#f6f7f9;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;color:#222}
  .wrap{max-width:var(--maxw);margin:16px auto;padding:12px 14px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.06);border-radius:12px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  h1{font-size:18px;margin:0;text-align:left}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #d0d0d0;background:#fff;cursor:pointer}
  .sub{font-size:14px;text-align:center;color:#444;margin:0 0 10px 0;font-weight:700}
  .dsbar{font-weight:700;text-align:center;color:#0a66ff;margin:10px 0}
  table{width:95%;margin:0 auto;border-collapse:collapse}
  thead th{background:#f4f6fb;color:#333;font-family:"標楷體",serif;letter-spacing:.2em}
  th,td{border-top:1px solid #eee;text-align:center;padding:8px 6px}
  .group{font-weight:700;color:#0a66ff;text-align:center;border-top:1px solid #ddd;padding:6px 0;background:#fafcff}
  .muted{color:#888;text-align:center;margin-top:6px}
  .err{color:#c62828;text-align:center;margin-top:6px}
  .foot{margin-top:12px;font-size:12px;color:#666;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Rt外觀記錄表-查尋</h1>
    <button class="btn" onclick="location.href='./index.html'">返回</button>
  </header>

  <p id="range" class="sub">起迄班別：—</p>
  <div id="dsbar" class="dsbar">最近三個班：—</div>

  <table>
    <thead><tr><th>料號</th><th>批號</th><th>數量</th></tr></thead>
    <tbody id="list"></tbody>
  </table>

  <div id="msg" class="muted"></div>
  <div class="foot">last3shift v0.6</div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const canon = s => String(s||'').trim().toUpperCase();

function mdOf(d){ return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',month:'2-digit',day:'2-digit'}).format(d); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

function computeCurrentDS(){
  const now = new Date();
  const tzNow = new Date(now.toLocaleString('en-US',{timeZone:'Asia/Taipei'}));
  const h = tzNow.getHours(), m = tzNow.getMinutes(), mins = h*60+m;
  if (mins >= 40 && mins < 520) return { dateMD: mdOf(addDays(tzNow,-1)), shift:'C', tzNow };
  if (mins >= 520 && mins < 1000) return { dateMD: mdOf(tzNow),          shift:'A', tzNow };
  if (mins >= 1000)               return { dateMD: mdOf(tzNow),          shift:'B', tzNow };
  return { dateMD: mdOf(addDays(tzNow,-1)), shift:'B', tzNow };
}

function last3DS(cur){
  const d = cur.dateMD, s = cur.shift;
  const prev = mdOf(addDays(cur.tzNow,-1));
  if (s==='B') return [{date:d,shift:'B'},{date:d,shift:'A'},{date:prev,shift:'C'}];
  if (s==='A') return [{date:d,shift:'A'},{date:prev,shift:'C'},{date:prev,shift:'B'}];
  return [{date:d,shift:'C'},{date:d,shift:'B'},{date:d,shift:'A'}];
}

async function fetchByTriples(ds3){
  const arr = await Promise.all(ds3.map(d =>
    fetch(`${GAS_URL}?scope=all&date=${encodeURIComponent(d.date)}&shift=${encodeURIComponent(d.shift)}`)
      .then(r=>r.json())
  ));
  return arr.flat();
}

function filterForDS(allRows, ds3){
  const want = new Set(ds3.map(d => `${canon(d.date)}|${canon(d.shift)}`));
  const filtered = allRows.filter(r =>
    r.deleted===true && want.has(`${canon(r.date)}|${canon(r.shift)}`)
  );
  const uniq = new Map();
  for (const r of filtered){
    const k = r.key || `${canon(r.date)}|${canon(r.shift)}|${canon(r.part_no)}|${canon(r.lot)}`;
    uniq.set(k, r);
  }
  return [...uniq.values()];
}

function renderGrouped(tbodyId, ds3, rows){
  const tb = document.getElementById(tbodyId);
  tb.innerHTML = '';
  ds3.forEach(({date,shift})=>{
    tb.insertAdjacentHTML('beforeend', `<tr><td class="group" colspan="3">${date} ${shift}</td></tr>`);
    const part = rows.filter(r => canon(r.date)===canon(date) && canon(r.shift)===canon(shift));
    if(!part.length){
      tb.insertAdjacentHTML('beforeend','<tr><td colspan="3" class="muted">（無資料）</td></tr>');
    }else{
      part.forEach(x=>{
        tb.insertAdjacentHTML('beforeend', `<tr><td>${x.part_no||''}</td><td>${x.lot||''}</td><td>${x.qty||''}</td></tr>`);
      });
    }
  });
}

(async function(){
  try{
    const cur = computeCurrentDS();
    const ds3 = last3DS(cur);
    const start = ds3[2], end = ds3[0];

    document.getElementById('dsbar').textContent =
      `最近三個班：${ds3.map(d=>`${d.date}${d.shift}`).join('，')}`;
    document.getElementById('range').textContent =
      `起迄班別：${start.date} ${start.shift} ~ ${end.date} ${end.shift}`;

    const all = await fetchByTriples(ds3);
    const rows = filterForDS(all, ds3);
    renderGrouped('list', ds3, rows);
  }catch(e){
    const m = document.getElementById('msg');
    m.className='err'; m.textContent='讀取失敗：'+ String(e);
  }
})();
</script>
</body>
</html>