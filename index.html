<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RT外觀抽驗記錄表 | Index</title>
<style>
  :root{
    --ok:#10b981;
    --err:#ef4444;   
    --bg:#f8fafc;
    --brand:#0f766e;
    --btn1:#ecfeff;
    --btn2:#f1f5f9;
    --btn3:#fff7ed;
    --btn4:#eff6ff;
    --btn5:#faf5ff;}

  html,body{height:100%}
  body{margin:0;
  font-family:system-ui,
  -apple-system,
  Segoe UI,
  Roboto,
  Helvetica,
  Arial;
  background:var(--bg);
  color:#0f172a}

  .wrap{width:100%; margin:22px auto 32px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
  .hdr{padding:16px 18px 10px;border-bottom:1px solid #e5e7eb;text-align:center}
  .title{font-size:22px;font-weight:700;color:var(--brand);letter-spacing:0.25em}
  .sub{color:#475569;font-size:12px;margin-top:4px}
  .content{padding:14px}

  .grid-wrap{width:75%; margin:10px auto 0;}
  .grid{display:grid;grid-template-columns:1fr;gap:20px}

  .btn{
    display:flex;align-items:center;justify-content:center;
    padding:12px;border-radius:12px;border:1px solid #e5e7eb;
    color:#0f172a;font-weight:600;text-decoration:none;
    font-family:"DFKai-SB","標楷體","PMingLiU",serif;
    font-size:16px;line-height:1.2;text-align:center;
    letter-spacing:.35em;
  }
  .btn1{background:var(--btn1); border-color:#cffafe;}
  .btn2{background:var(--btn2); border-color:#e2e8f0;}
  .btn3{background:var(--btn3); border-color:#fed7aa;}
  .btn4{background:var(--btn4); border-color:#bfdbfe;}
  .btn5{background:var(--btn5); border-color:#e9d5ff;}

  .status-row{margin-top:28px;display:flex;align-items:center;justify-content:center;gap:22px;flex-wrap:wrap}
  .item{display:flex;align-items:center;gap:8px}
  .item.gas .label{font-family:"Comic Sans MS","Comic Sans",cursive}
  .dot{width:12px;height:12px;border-radius:50%;background:#d1d5d9;border:1px solid #cbd5e1}
  .ok{background:var(--ok)!important;border-color:var(--ok)!important}
  .err{background:var(--err)!important;border-color:var(--err)!important}

  /* 著作列與版本列像段落換行一樣的距離 */
  .footline{margin:0 14px 2px;display:flex;align-items:center;justify-content:space-between;
    color:#475569;font-size:12px;line-height:1.4}
  .foot{margin:0 14px 8px;display:flex;align-items:center;justify-content:space-between;
   color:#475569;font-size:12px;line-height:1.4}

.modal{display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,.4); z-index:1000;}
.modal.show{display:flex;}
.modal-content{background:#fff; padding:20px; border-radius:8px; min-width:200px; text-align:center;}
.spinner{margin:10px auto; width:32px; height:32px; border:4px solid #ddd; border-top-color:#4f46e5; border-radius:50%; animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div class="wrap card">
    <div class="hdr">
      <div class="title">RT外觀抽驗記錄表</div>
      <div class="sub">入口導航</div>
    </div>

    <div class="content">
      <div class="grid-wrap">
        <div class="grid">
          <a class="btn btn1" href="browse.html">每日記錄表</a>
          <a class="btn btn2" href="form.html">外觀記錄表</a>
          <a class="btn btn3" href="formPro.html">外觀記錄表</a>
          <a class="btn btn4" href="auth.html">安全管理員</a>
          <button id="btnBackup" class="btn btn5" type="button">即時　備份</button>
<div id="backupModal" class="modal">
  <div class="modal-content">
    <div class="spinner"></div>
    <div id="backupMsg">處理中…</div>
  </div>
</div>
        </div>
      </div>

      <div class="status-row">
        <div class="item gas"><span id="dot-alive" class="dot"></span><span class="label">GAS</span></div>
        <div class="item"><span id="dot-file" class="dot"></span><span class="label">檔案</span></div>
        <div class="item"><span id="dot-sheet" class="dot"></span><span class="label">表名</span></div>
      </div>
    </div>

    <div class="footline">
      <div>著作 by 16F51</div>
      <div></div>
    </div>
    <div class="foot">
      <div>版本 <span id="ver"></span></div>
      <div id="now"></div>
    </div>
  </div>

<script>
const CFG = {
  version: "v0.4.8-index-ui",
  apiBase: "https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec",
  targetParam: "check",
  firstDelayMs: 250,
  nextDelayMs: 59000
};
document.getElementById('ver').textContent = CFG.version;

// 台北時間
function tick(){
  const tz = "Asia/Taipei";
  const now = new Date();
  const opt = {timeZone:tz, year:'numeric', month:'2-digit', day:'2-digit',
               hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false};
  document.getElementById('now').textContent =
    new Intl.DateTimeFormat('zh-TW', opt).format(now);
}
tick(); setInterval(tick, 1000);

const elAlive=document.getElementById('dot-alive'),
      elFile=document.getElementById('dot-file'),
      elSheet=document.getElementById('dot-sheet');
function setDot(el,state){
  el.classList.remove('ok','err');
  if(state==='ok')el.classList.add('ok');
  else if(state==='err')el.classList.add('err');
}
const sleep=ms=>new Promise(r=>setTimeout(r,ms));

async function getStatus(){
  try{
    const url=CFG.apiBase+"?target="+encodeURIComponent(CFG.targetParam)+"&_="+Date.now();
    const res=await fetch(url,{method:"GET",cache:"no-store"});
    const aliveState=res.ok?'ok':'err';

    let data=null; try{data=await res.json();}catch(_){}

    setDot(elAlive,aliveState);
    setDot(elFile, data&&data.fileExists===true?'ok':null);
    setDot(elSheet,data&&data.sheetExists===true?'ok':null);
  }catch(e){
    setDot(elAlive,'err'); setDot(elFile,null); setDot(elSheet,null);
  }
}

(async function loop(){
  while(true){
    await sleep(CFG.firstDelayMs);
    await getStatus();
    await sleep(CFG.nextDelayMs);
  }
})()
// 放在 loop() 後面；不要在其他地方呼叫 openModal()
const modal = document.getElementById('backupModal');
const msgEl = document.getElementById('backupMsg');
const btnBackup = document.getElementById('btnBackup');
const BACKUP_COOLDOWN_MS = 5*60*1000;
const BACKUP_KEY = 'backup_last_ts';

function openModal(text){ if(modal){ modal.classList.add('show'); if(msgEl) msgEl.textContent = text || '處理中…'; } }
function closeModal(delay=2000){ setTimeout(()=> modal && modal.classList.remove('show'), delay); }

if (btnBackup && modal && msgEl){
  btnBackup.addEventListener('click', async ()=>{
    const now = Date.now();
    const last = Number(localStorage.getItem(BACKUP_KEY) || 0);
    if (now - last < BACKUP_COOLDOWN_MS){
      const remain = Math.ceil((BACKUP_COOLDOWN_MS - (now - last))/1000);
      alert(`5 分鐘內僅能執行一次，請 ${remain} 秒後再試。`);
      return;
    }

    openModal('處理中…');

    try{
      const res = await fetch(CFG.apiBase, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:'backup'})
      });
      const data = await res.json().catch(()=>({}));
      if (res.ok && data.status === 'ok'){
        localStorage.setItem(BACKUP_KEY, String(now));
        msgEl.textContent = '備份完成';
      }else{
        msgEl.textContent = '備份失敗：' + (data.msg || `HTTP ${res.status}`);
      }
    }catch(err){
      msgEl.textContent = '錯誤：' + (err?.message || String(err));
    }finally{
      closeModal(2000);
    }
  });
}
</body>
</html>