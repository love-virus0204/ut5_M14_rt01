<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>僅瀏覽（最近三班）</title>
<style>
  :root{ --bg:#f8fafc; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --brand:#0f766e; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{width:96%;max-width:980px;margin:18px auto}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
  .hdr{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
  .ttl{font-weight:700;color:var(--brand)}
  .back{font-size:12px;color:var(--muted);text-decoration:none;border:1px solid var(--line);padding:6px 10px;border-radius:8px}
  .content{padding:14px 16px}
  .muted{color:var(--muted)}
  .grp{margin:12px 0 6px;font-weight:700}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;font-size:14px}
  th{color:#334155;background:#f9fafb}
  .pill{display:inline-block;border:1px solid #cbd5e1;border-radius:999px;padding:2px 8px;font-size:12px}
  .foot{padding:10px 16px;border-top:1px solid var(--line);display:flex;justify-content:space-between;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap card">
  <div class="hdr">
    <div class="ttl">僅瀏覽｜最近三班有效紀錄</div>
    <a href="index.html" class="back">返回入口</a>
  </div>
  <div class="content">
    <div id="status" class="muted">載入中…</div>
    <div id="root" style="display:none"></div>
  </div>
  <div class="foot">
    <div>版本 <span id="ver"></span></div>
    <div id="now"></div>
  </div>
</div>

<script>
const CFG = {
  version: "browse v1.4.0",
  api: "https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec"
};
document.getElementById('ver').textContent = CFG.version;

// 即時時鐘
(function tick(){
  const el = document.getElementById('now');
  const tz = "Asia/Taipei";
  const opt = { timeZone:tz, year:'numeric', month:'2-digit', day:'2-digit',
                hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false };
  el.textContent = new Intl.DateTimeFormat('zh-TW', opt).format(new Date());
  setTimeout(tick, 1000);
})();

// 取資料 (POST, action=list_recent)
async function fetchRecent(){
  const form = new URLSearchParams({ action:"list_recent" });
  const res = await fetch(CFG.api, {
    method: "POST",
    body: form
  });
  if (!res.ok) throw new Error("http_"+res.status);
  let data = null;
  try { data = await res.json(); } catch(_) { throw new Error("bad_json"); }
  return Array.isArray(data) ? data : Array.isArray(data.data) ? data.data : [];
}

// 找最近三個「日期+班別」
function pickRecentThree(rows){
  const list = rows.map(r=>({
    ymd: String(r.date),
    sh:  String(r.shift)
  }));
  const seen = new Set();
  const pairs = [];
  for (const it of list){
    const k = `${it.ymd}|${it.sh}`;
    if (seen.has(k)) continue;
    seen.add(k);
    pairs.push(it);
    if (pairs.length>=3) break;
  }
  return pairs;
}

// 渲染
function render(groups){
  const root = document.getElementById('root');
  root.innerHTML = "";
  for (const g of groups){
    const sec = document.createElement('section');
    const hdr = document.createElement('div');
    hdr.className = "grp";
    hdr.innerHTML = `日期 <span class="pill">${g.ymd}</span>　班別 <span class="pill">${g.sh}</span>`;
    sec.appendChild(hdr);

    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr>
          <th>料號</th><th>批號</th><th>抽樣數</th><th>不良數</th><th>檢驗員</th><th>備註</th>
        </tr>
      </thead>
      <tbody></tbody>`;
    const tb = table.querySelector('tbody');

    for (const r of g.rows){
      const tr = document.createElement('tr');
      const get = (x,def="") => (x===undefined||x===null) ? def : x;
      tr.innerHTML = `
        <td>${get(r.part_no)}</td>
        <td>${get(r.lot)}</td>
        <td>${get(r.sample_cnt)}</td>
        <td>${get(r.z7)}</td>
        <td>${get(r.inspector)}</td>
        <td>${get(r.remark)}</td>`;
      tb.appendChild(tr);
    }
    sec.appendChild(table);
    root.appendChild(sec);
  }
  root.style.display = "";
}

// 主流程
(async function main(){
  const elStat = document.getElementById('status');
  try{
    const raw = await fetchRecent();

    // 僅顯示有效
    const validRows = raw.filter(r=>String(r.deleted).toUpperCase()==="TRUE");

    if (validRows.length === 0){
      elStat.textContent = "無有效資料";
      return;
    }

    // 最近三個日期+班別
    const last3 = pickRecentThree(validRows);

    // 分組
    const groups = last3.map(({ymd,sh})=>{
      const rows = validRows.filter(r=>String(r.date)===ymd && String(r.shift)===sh);
      return {ymd, sh, rows};
    }).filter(g=>g.rows.length>0);

    if (groups.length===0){
      elStat.textContent = "無符合條件資料";
      return;
    }

    elStat.textContent = "";
    render(groups);

  }catch(err){
    document.getElementById('status').textContent = "讀取失敗";
  }
})();
</script>
</body>
</html>