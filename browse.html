<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>僅瀏覽（最近三班）</title>
<style>
  :root{ --bg:#f8fafc; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --brand:#0f766e; --ok:#10b981; --err:#ef4444; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{width:96%;max-width:980px;margin:18px auto}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
  .hdr{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
  .ttl{font-weight:700;color:var(--brand)}
  .back{font-size:12px;color:var(--muted);text-decoration:none;border:1px solid var(--line);padding:6px 10px;border-radius:8px}
  .content{padding:14px 16px}
  .muted{color:var(--muted)}
  .grp{margin:12px 0 6px;font-weight:700}
  .range{margin:8px 0 8px;color:#334155;font-size:13px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;font-size:14px}
  th{color:#334155;background:#f9fafb}
  .foot{padding:10px 16px;border-top:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
  .net{display:flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:50%;background:#d1d5d9;border:1px solid #cbd5e1}
  .ok{background:var(--ok)!important;border-color:var(--ok)!important}
  .err{background:var(--err)!important;border-color:var(--err)!important}
  .dbg{margin-top:10px;font-size:12px;color:#475569;white-space:pre-wrap;background:#f8fafc;border:1px dashed #cbd5e1;border-radius:8px;padding:8px;display:none}
</style>
</head>
<body>
<div class="wrap card">
  <div class="hdr">
    <div class="ttl">僅瀏覽｜最近三班有效紀錄</div>
    <a href="index.html" class="back">返回入口</a>
  </div>
  <div class="content">
    <div id="status" class="muted">載入中…</div>
    <div id="range" class="range" style="display:none"></div>
    <div id="root" style="display:none"></div>
    <div id="dbg" class="dbg"></div>
  </div>
  <div class="foot">
    <div class="net"><span id="net-dot" class="dot"></span><span id="net-msg">回傳</span></div>
    <div>版本 <span id="ver"></span>　|　<span id="now"></span></div>
  </div>
</div>

<script>
const CFG = {
  version: "browse v1.7.2",
  api: "https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec"
};
document.getElementById('ver').textContent = CFG.version;

// 時鐘
(function tick(){
  const el = document.getElementById('now');
  const tz = "Asia/Taipei";
  const opt = { timeZone:tz, year:'numeric', month:'2-digit', day:'2-digit',
                hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false };
  el.textContent = new Intl.DateTimeFormat('zh-TW', opt).format(new Date());
  setTimeout(tick, 1000);
})();

// 燈號
function setNetLight(ok, msg){
  const dot = document.getElementById('net-dot');
  const txt = document.getElementById('net-msg');
  dot.classList.remove('ok','err');
  dot.classList.add(ok ? 'ok' : 'err');
  txt.textContent = msg || "回傳";
}

// 取資料
async function fetchRecent(){
  const form = new URLSearchParams({ action:"list_recent" });
  const dbg = document.getElementById('dbg');
  try{
    const res = await fetch(CFG.api, { method:"POST", body: form });
    if (!res.ok){ setNetLight(false, "HTTP錯誤"); return { ok:false, rows:[] }; }
    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); }catch(_){ setNetLight(false,"非JSON"); return { ok:false, rows:[] }; }
    const okFlag = Array.isArray(data) || (data && data.status === "ok");
    setNetLight(okFlag, okFlag ? "回傳OK" : "旗標錯誤");
    const rows = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
    return { ok: okFlag, rows };
  }catch{ setNetLight(false,"網路錯誤"); return { ok:false, rows:[] }; }
}

// mm/dd 輸出
function toMMDD(s){
  if (s == null) return "";
  if (typeof s === "number") {
    const base = Date.UTC(1899,11,30);
    const dt = new Date(base + s*86400000);
    const mm = String(dt.getUTCMonth()+1).padStart(2,"0");
    const dd = String(dt.getUTCDate()).padStart(2,"0");
    return `${mm}/${dd}`;
  }
  const t = String(s).trim();
  const pure = t.split("T")[0].split(" ")[0];
  // yyyy-mm-dd / yyyy/mm/dd
  let m = pure.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if (m) return `${m[2].padStart(2,"0")}/${m[3].padStart(2,"0")}`;
  // mm-dd / mm/dd
  m = pure.match(/^(\d{1,2})[\/\-](\d{1,2})$/);
  if (m) return `${m[1].padStart(2,"0")}/${m[2].padStart(2,"0")}`;
  return t;
}

// 最近三班
function pickRecentThree(rows){
  const pairs=[], seen=new Set();
  for(const r of rows){
    const ymd=String(r.date), sh=String(r.shift), k=ymd+"|"+sh;
    if(seen.has(k)) continue;
    seen.add(k); pairs.push({ymd,sh});
    if(pairs.length>=3) break;
  }
  return pairs;
}

// 顯示「有效資料:?筆」
function renderCount(totalCount){
  const box=document.getElementById('range');
  box.textContent=`有效資料：${totalCount} 筆`;
  box.style.display="";
}

// 渲染表格
function render(groups){
  const root=document.getElementById('root'); root.innerHTML="";
  for(const g of groups){
    const sec=document.createElement('section');
    const hdr=document.createElement('div');
    hdr.className="grp";
    hdr.textContent=`班別/日期：${toMMDD(g.ymd)} - ${g.sh}`;
    sec.appendChild(hdr);

    const table=document.createElement('table');
    table.innerHTML=`
      <thead>
        <tr><th>料號</th><th>批號</th><th>數量</th></tr>
      </thead><tbody></tbody>`;
    const tb=table.querySelector('tbody');

    for(const r of g.rows){
      const tr=document.createElement('tr');
      const get=(x,def="")=>(x==null?def:x);
      tr.innerHTML=`
        <td>${get(r.part_no)}</td>
        <td>${get(r.lot)}</td>
        <td>${get(r.sample_cnt)}</td>`;
      tb.appendChild(tr);
    }
    sec.appendChild(table);
    root.appendChild(sec);
  }
  root.style.display="";
}

// 主流程
(async function main(){
  const elStat=document.getElementById('status');
  const {ok,rows}=await fetchRecent();
  if(!ok){ elStat.textContent="讀取失敗或旗標錯誤"; return; }
  const valid=rows.filter(isValid);
  if(valid.length===0){ elStat.textContent="無有效資料"; renderCount(0); return; }

  const last3=pickRecentThree(valid);
  const groups=last3.map(({ymd,sh})=>{
    const rs=valid.filter(r=>String(r.date)===ymd && String(r.shift)===sh);
    return {ymd,sh,rows:rs};
  }).filter(g=>g.rows.length>0);

  const totalCount=groups.reduce((acc,g)=>acc+g.rows.length,0);
  renderCount(totalCount);

  if(groups.length===0){ elStat.textContent="無符合條件資料"; return; }
  elStat.textContent=""; render(groups);
})();
</script>
</body>
</html>