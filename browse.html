<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>外觀記錄表｜瀏覽</title>
<style>
  :root{ --bg:#f8fafc; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --brand:#0f766e; --ok:#10b981; --err:#ef4444; }
  html,body{height:100%}
  body{margin:0;background:#f8fafc;color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{width:96%;max-width:980px;margin:2px auto}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
  .hdr{padding:14px 16px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between}
  .ttl{font-weight:700;color:#0f766e}
  .back{font-size:12px;color:#64748b;text-decoration:none;border:1px solid #e5e7eb;padding:6px 10px;border-radius:8px}
  .content{padding:14px 16px}
  #status{color:#475569;margin:18px 0;min-height:1.6em;text-align:center;font-weight:600}
  #dbg{display:none;white-space:pre-wrap;background:#f8fafc;border:1px dashed #cbd5e1;border-radius:8px;padding:8px;margin-top:8px;color:#334155}
  .grp{margin:12px 0 6px;font-weight:700}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-top:1px solid #ddd;text-align:center;padding:6px 4px}
  thead th{background:#f3f4f6;color:#334155}
  table.t1 tbody tr:nth-child(odd){background:#f5f3ff}
  table.t1 tbody tr:nth-child(even){background:#ede9fe}
  table.t2 tbody tr:nth-child(odd){background:#f9fafb}
  table.t2 tbody tr:nth-child(even){background:#e5e7eb}
  table.t3 tbody tr:nth-child(odd){background:#fff7ed}
  table.t3 tbody tr:nth-child(even){background:#ffedd5}
  #root table tbody tr:hover{background:#e0f2fe}
  .foot{padding:10px 16px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;color:#64748b;font-size:12px}
  .net{display:flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:50%;background:#d1d5d9;border:1px solid #cbd5e1}
  .ok{background:#10b981!important;border-color:#10b981!important}
  .err{background:#ef4444!important;border-color:#ef4444!important}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="hdr">
      <div class="ttl">僅瀏覽｜最近三班有效紀錄</div>
      <a href="index.html" class="back">返回入口</a>
    </div>
    <div class="content">
      <div id="status">努力加載中... 60s</div>
      <div id="root" style="display:none"></div>
      <div id="dbg"></div>
    </div>
    <div class="foot">
      <div class="net"><span id="net-dot" class="dot"></span><span id="net-msg">回傳</span></div>
      <div>版本 <span id="ver"></span></div>
    </div>
  </div>
</div>

<script>
/* API URL */
const API_BASE = "https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec";

const PAGE_VERSION = "browse v3.1.1";
document.getElementById('ver').textContent = PAGE_VERSION;

const baseUTC = Date.UTC(1899,11,30);

/* 指示燈 */
function setNetLight(ok, msg){
  const dot = document.getElementById('net-dot');
  const txt = document.getElementById('net-msg');
  dot.classList.remove('ok','err');
  if (ok === true) dot.classList.add('ok');
  else if (ok === false) dot.classList.add('err');
  txt.textContent = msg || (ok===true ? "OK" : ok===false ? "ERROR" : "回傳");
}

/* TRUE 判定 */
function isAlive(v){ return String(v).toUpperCase() === "TRUE"; }

/* timeout fetch */
function fetchWithTimeout(url, options, timeout){
  return Promise.race([
    fetch(url, options),
    new Promise((_, rej)=>setTimeout(()=>rej(new Error("Timeout "+timeout+"ms")), timeout))
  ]);
}

/* 倒數 */
function startCountdown(sec){
  const status = document.getElementById('status');
  let left = sec;
  status.textContent = "努力加載中... " + left + "s";
  const t = setInterval(()=>{
    left--;
    status.textContent = "努力加載中... " + left + "s";
    if (left <= 0){
      clearInterval(t);
      if (!window.__renderDone__){
        status.textContent = "載入失敗..請通知開發人員";
      }
    }
  }, 1000);
  return { stop(){ clearInterval(t); } };
}

/* 先 GET 檢查 */
async function pingGET(){
  try{
    const res = await fetchWithTimeout(API_BASE + "?action=list_recent", {method:"GET"}, 5000);
    if (!res.ok) throw new Error("HTTP " + res.status);
    setNetLight(true, "OK"); // GET 成功 → 綠燈
    return true;
  }catch(e){
    setNetLight(false, "失敗"); // GET 失敗 → 紅燈
    document.getElementById('status').textContent = "載入失敗..請通知開發人員";
    return false;
  }
}

/* POST 取資料 */
async function fetchRecentPOST(){
  const res = await fetch(API_BASE, { method:"POST", body:new URLSearchParams({action:"list_recent"}) });
  if (!res.ok) throw new Error("HTTP " + res.status + " " + res.statusText);
  const data = await res.json();
  if (data?.status !== "ok" || !Array.isArray(data.fields) || !Array.isArray(data.values)){
    throw new Error("需 {status:'ok', fields[], values[]}");
  }
  const F = Object.fromEntries(data.fields.map((k,i)=>[k,i]));
  return data.values.map(a => ({
    date:a[F.date], shift:a[F.shift], part_no:a[F.part_no], lot:a[F.lot], qty:a[F.qty],
    sample_cnt:a[F.sample_cnt], z07:a[F.z07], z08:a[F.z08], z09:a[F.z09], z10:a[F.z10],
    z11:a[F.z11], z12:a[F.z12], z13:a[F.z13], inspector:a[F.inspector], remark:a[F.remark],
    submitted_at:a[F.submitted_at], key2:a[F.key2], key:a[F.key], deleted:a[F.deleted],
    row:a[F.row]
  }));
}

/* 分組：依 date + shift，不排序，只取前三組 */
function groupForRender(rows){
  const alive = rows.filter(r => isAlive(r.deleted));
  const map = new Map();
  for (const r of alive){
    const serial = Number(r.date);
    const sh = r.shift;
    const key = serial + '|' + sh;
    if (!map.has(key)) map.set(key, { serial, sh, rows: [] });
    map.get(key).rows.push({
      part_no: r.part_no ?? "",
      lot: r.lot ?? "",
      qty: r.qty ?? ""
    });
  }
  return Array.from(map.values()).slice(0,3);
}

/* 日期序號 → mm/dd */
function serialToMMDD(n){
  const days = Math.floor(Number(n));
  const dt = new Date(baseUTC + days*86400000);
  const mm = String(dt.getUTCMonth()+1).padStart(2,"0");
  const dd = String(dt.getUTCDate()).padStart(2,"0");
  return mm + "/" + dd;
}

/* 渲染 欄位 */
function render(groups){
  const root = document.getElementById('root');
  root.innerHTML = "";
  groups.forEach((g, idx) => {
    const sec = document.createElement('section');

    const hdr = document.createElement('div');
    hdr.className = "grp";
    hdr.textContent = "日期：" + serialToMMDD(g.serial) + " 班別：" + g.sh;
    sec.appendChild(hdr);

    const table = document.createElement('table');
    table.classList.add("t" + ((idx % 3) + 1));
    table.innerHTML = '<thead><tr><th>料號</th><th>批號</th><th>數量</th></tr></thead><tbody></tbody>';
    const tb = table.querySelector('tbody');

    for (const r of g.rows){
      const tr = document.createElement('tr');
      tr.innerHTML = "<td>"+r.part_no+"</td><td>"+r.lot+"</td><td>"+r.qty+"</td>";
      tb.appendChild(tr);
    }
    sec.appendChild(table);
    root.appendChild(sec);
  });
}

/* 主流程：倒數→GET→POST→渲染 */
async function loadAndRender(){
  window.__renderDone__ = false;
  const status = document.getElementById('status');
  const root = document.getElementById('root');
  const dbg = document.getElementById('dbg');
  root.style.display = "none"; dbg.style.display = "none";

  const cd = startCountdown(60);

  const ok = await pingGET();
  if (!ok){ cd.stop(); return; }

  try{
    const rows = await fetchRecentPOST();
    const groups = groupForRender(rows);
    render(groups);
    status.textContent = "";
    status.style.margin = "2px 0";
    root.style.display = "";
    window.__renderDone__ = true;
    cd.stop();
  }catch(e){
    status.textContent = "載入失敗..請通知開發人員";
    dbg.style.display = "block";
    dbg.textContent = (e && e.message) ? e.message : String(e);
    // 維持綠燈，表 GET 成功但 POST/解析失敗
  }
}

document.addEventListener('DOMContentLoaded', loadAndRender);
</script>
</body>
</html>