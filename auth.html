<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth</title>
  <style>
    body{background:#0f172a;color:#e2e8f0;font-family:sans-serif;text-align:center;padding:20px}
    #view-wrap{position:relative;display:inline-block}
    #cam{width:100%;max-width:360px;border-radius:8px}
    #status{margin-top:10px;font-size:14px;color:#38bdf8}
    .row{margin-top:12px}
    button{padding:8px 16px;border:none;border-radius:6px;cursor:pointer}
    #startBtn{background:#22c55e;color:#fff}
    #stopBtn{background:#ef4444;color:#fff}
    #manualBtn{background:#3b82f6;color:#fff}
    dialog{border:none;border-radius:12px;padding:0;background:#1e293b;color:#e2e8f0;width:min(92vw,380px)}
    .dlg-body{padding:14px}
    .dlg-row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    input{width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#e2e8f0}
    .err{font-size:13px;margin-top:6px;color:#22d3ee}
  </style>
</head>
<body>
  <h2>管理驗證</h2>
  <div id="view-wrap">
    <video id="cam" autoplay muted playsinline></video>
  </div>
  <div id="status">初始化中...</div>
  <div class="row">
    <button id="startBtn">啟動相機</button>
    <button id="stopBtn">停用相機</button>
    <button id="manualBtn">手動輸入代碼</button>
  </div>

  <dialog id="manualDlg">
    <div class="dlg-body">
      <h3>輸入驗證代碼</h3>
      <input id="manualInput" placeholder="請輸入代碼">
      <div id="manualErr" class="err"></div>
      <div class="dlg-row">
        <button id="manualCancel">取消</button>
        <button id="manualOk">確認</button>
      </div>
    </div>
  </dialog>

  <script src="js/QRScanner.js"></script>
  <script>
    const admin_URL   = "admin.html";
    const fixed_key   = "f58f84dfd91a46d68f130d4a2ca2a783eaf649fe96284ef09395571e030106aab70b6258691887e3d22ce185105a943ff88b8c7f536aae149ea23d2bd83ffe3f";
    const fixed_tokey = "c7b5e18a4f3d29b6d01c84a57de239f8146bc9e2fa518a7d3c0ef492a5bdc876";
    const expire_ms   = 2 * 60 * 1000; // 2 分鐘

    // session 驗證檢查
    (function checkSession(){
      const ts = sessionStorage.getItem("ts");
      const tk = sessionStorage.getItem("tokey");
      if(ts && tk){
        if(Date.now() - Number(ts) < expire_ms && tk === fixed_tokey){
          location.replace(admin_URL);
        } else {
          sessionStorage.clear();
        }
      }
    })();

    // 初始化 QRScanner
    QRScanner.mount({
      videoEl:   "#cam",
      wrapEl:    "#view-wrap",
      statusEl:  "#status",
      startBtn:  "#startBtn",
      stopBtn:   "#stopBtn",
      manual: {
        openBtn:   "#manualBtn",
        dlg:       "#manualDlg",
        input:     "#manualInput",
        err:       "#manualErr",
        okBtn:     "#manualOk",
        cancelBtn: "#manualCancel",
        fixedKey:  fixed_key
      },
      isValid: (txt) => txt === fixed_key,
      onOk: () => {
        sessionStorage.setItem("ts", String(Date.now()));
        sessionStorage.setItem("tokey", fixed_tokey);
        location.replace(admin_URL);
      }
    }).then(() => {
      // 頁面載入後自動開相機一次
      QRScanner.start();
    });
  </script>
</body>
</html>