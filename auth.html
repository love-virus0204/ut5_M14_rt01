<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="view-wrap">
    <video id="cam" autoplay muted playsinline></video>
    <div id="status">初始化中...</div>
  </div>

  <div class="btn-row">
    <button id="startBtn">啟動相機</button>
    <button id="stopBtn">停止相機</button>
    <button id="manualBtn">手動輸入</button>
  </div>

  <dialog id="manualDlg">
    <div class="dlg-body">
      <label for="manualInput">輸入代碼：</label>
      <input id="manualInput" type="text" placeholder="請輸入 128 位代碼">
      <div id="manualErr" class="err-msg"></div>
      <div class="dlg-row">
        <button id="manualOk">確定</button>
        <button id="manualCancel">取消</button>
      </div>
    </div>
  </dialog>

  <script type="module">
    import { QRScanner } from './js/QRScanner.js';

    const admin_URL   = "admin.html";
    const fixed_key   = "f58f84dfd91a46d68f130d4a2ca2a783eaf649fe96284ef09395571e030106aab70b6258691887e3d22ce185105a943ff88b8c7f536aae149ea23d2bd83ffe3f";
    const fixed_tokey = "c7b5e18a4f3d29b6d01c84a57de239f8146bc9e2fa518a7d3c0ef492a5bdc876";

    // 掛載 QRScanner
    const ok = QRScanner.mount({
      videoEl: "#cam",
      wrapEl: "#view-wrap",
      statusEl: "#status",
      startBtn: "#startBtn",
      stopBtn: "#stopBtn",
      manual: {
        openBtn: "#manualBtn",
        dlg: "#manualDlg",
        input: "#manualInput",
        err: "#manualErr",
        okBtn: "#manualOk",
        cancelBtn: "#manualCancel",
        fixedKey: fixed_key
      },
      formats: ["qr"],
      mode: "stop-on-valid",
      isValid: txt => txt === fixed_key,
      onOk: () => {
        sessionStorage.setItem("ts", String(Date.now()));
        sessionStorage.setItem("tokey", fixed_tokey);
        location.replace(admin_URL);
      },
      onError: err => console.log("QR err:", err)
    });

    // 進入頁面自動開相機一次
    requestAnimationFrame(()=>{
      if(ok) QRScanner.start();
    });

    // 綁定開始/停止相機按鈕（可反覆控制）
    document.getElementById("startBtn").addEventListener("click", ()=>{
      QRScanner.start();
    });
    document.getElementById("stopBtn").addEventListener("click", ()=>{
      QRScanner.stop();
    });

    // 手動輸入框對話框事件
    const dlg = document.getElementById("manualDlg");
    document.getElementById("manualBtn").addEventListener("click", ()=> dlg.showModal());
    document.getElementById("manualCancel").addEventListener("click", ()=> dlg.close());
    document.getElementById("manualOk").addEventListener("click", ()=>{
      const val = document.getElementById("manualInput").value.trim();
      if(val === fixed_key){
        sessionStorage.setItem("ts", String(Date.now()));
        sessionStorage.setItem("tokey", fixed_tokey);
        location.replace(admin_URL);
      }else{
        document.getElementById("manualErr").textContent = "代碼錯誤";
      }
    });
  </script>
</body>
</html>