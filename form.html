<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RT 外觀抽驗記錄表</title>
<!-- v17.11.6（基於 .5；只改行為與頁面版號，禁止任何未要求的自動判斷與排版變更） -->
<style>
  html,body{margin:0;padding:0;background:#fff;color:#111;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif}
  .wrap{max-width:960px;margin:0 auto;padding:16px 14px 48px}
  header{display:flex;align-items:center;gap:10px}
  header h1{font-size:34px;letter-spacing:2px;margin:16px 0}
  .ver{font-size:14px;color:#666;margin-left:8px}
  .head-row{display:flex;align-items:baseline;gap:16px;margin:4px 0 10px}
  .head-date{font-size:22px;letter-spacing:2px}
  .row{display:flex;align-items:center;gap:12px;margin:12px 0}
  .label{flex:0 0 72px;letter-spacing:8px;text-align:right}
  .ctrl{flex:1}
  input,button{font-size:18px}
  input{width:100%;box-sizing:border-box;border:1px solid #c8c8c8;border-radius:6px;padding:12px 14px;outline:none}
  input:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
  .btn{display:inline-block;border:none;background:#1162ff;color:#fff;border-radius:10px;padding:14px 26px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .muted{color:#666;font-size:14px}
  .foot{display:flex;justify-content:space-between;align-items:center;margin-top:16px;color:#666;font-size:14px}
  table{width:100%;border-collapse:collapse;margin-top:18px}
  th,td{border-bottom:1px solid #e7e7e7;padding:14px 6px;text-align:center}
  .none{padding:18px 0;color:#666;text-align:center}
  /* 草稿B 字體色（僅字色，不改背景） */
  .ins-row.ok  { color:#03a66d; font-weight:700; }
  .ins-row.upd { color:#ff4da6; font-weight:700; }
  /* 簡易吐司 */
  .toast{position:fixed;left:50%;bottom:28px;transform:translateX(-50%);max-width:92vw;background:#333;color:#fff;border-radius:10px;padding:14px 16px;font-size:18px;box-shadow:0 8px 30px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .2s}
  .toast.show{opacity:1}
</style>
</head>

<body>
<div class="wrap">

  <header>
    <h1>RT 外觀抽驗記錄表</h1>
    <span class="ver" id="ver">v17.11.6</span>
  </header>

  <div class="head-row">
    <div class="head-date" id="headShift">MM/DD - S</div>
  </div>

  <!-- 表單骨架（沿用 .5：檢驗員、料號、批號、數量） -->
  <div class="row">
    <div class="label">檢　驗：</div>
    <div class="ctrl"><input id="inspector" type="text" placeholder="請輸入檢驗員" autocomplete="off"></div>
  </div>

  <div class="row">
    <div class="label">料　號：</div>
    <div class="ctrl"><input id="part_no" type="text" placeholder="如 A12B345" autocomplete="off"></div>
  </div>

  <div class="row">
    <div class="label">批　號：</div>
    <div class="ctrl"><input id="lot" type="text" placeholder="批號" autocomplete="off"></div>
  </div>

  <div class="row">
    <div class="label">數　量：</div>
    <div class="ctrl"><input id="qty" type="text" placeholder="正整數" inputmode="numeric" autocomplete="off"></div>
  </div>

  <div class="row" style="margin-top:10px">
    <div class="label"></div>
    <div class="ctrl">
      <button id="btnSend" class="btn">送出</button>
    </div>
  </div>

  <div class="foot">
    <div class="muted">對齊 GAS v1.4.6；送出以 GET 並分送 date + shift。</div>
    <div class="muted" id="nowTick">0000/00/00 00:00:00</div>
  </div>

  <table>
    <thead>
      <tr>
        <th>料　號</th>
        <th>批　號</th>
        <th>數　量</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td class="none" colspan="3">（當班無草稿）</td></tr>
    </tbody>
  </table>

</div>

<div id="toast" class="toast"></div>

<script>
/* v17.11.6 行為補丁（僅 JS；禁止未要求的自動判斷） */
const API_URL = "https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec";
const PING_MS = 300000;

/* DOM（沿用 .5） */
const $ = s => document.querySelector(s);
const elInsp = $("#inspector");
const elPart = $("#part_no");
const elLot  = $("#lot");
const elQty  = $("#qty");
const elBtn  = $("#btnSend");
const elBody = $("#tbody");

/* 工具 */
const pad=n=>String(n).padStart(2,"0");
function nowTPE(){
  const d=new Date();
  const y=d.getFullYear(), m=pad(d.getMonth()+1), dd=pad(d.getDate());
  const hh=pad(d.getHours()), mm=pad(d.getMinutes()), ss=pad(d.getSeconds());
  return {y,m,dd,hh,mm,ss, ymd:`${y}/${m}/${dd}`, md:`${m}/${dd}`, hms:`${hh}:${mm}:${ss}`};
}
function guessShift(h){ if(h>=6&&h<=13)return"A"; if(h>=14&&h<=21)return"B"; return"C"; }
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1600); }

/* 草稿B（五欄）；換班清空 */
const K_INFO="rt_day_shift", K_B="rt_draft_b";
const LS={g(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, s(k,v){localStorage.setItem(k,JSON.stringify(v))}};
function ensureScope(){
  const n=nowTPE(), cur={date:n.ymd, shift:guessShift(+n.hh)};
  const prev=LS.g(K_INFO,null);
  if(!prev || prev.date!==cur.date || prev.shift!==cur.shift){ LS.s(K_B,[]); LS.s(K_INFO,cur); }
  return cur;
}
function renderB(){
  const arr=(LS.g(K_B,[])).slice().sort((a,b)=>(b.ts||0)-(a.ts||0));
  if(!elBody) return;
  if(!arr.length){ elBody.innerHTML=`<tr><td class="none" colspan="3">（當班無草稿）</td></tr>`; return; }
  elBody.innerHTML=arr.map(x=>{
    const cls = x.status==="update" ? 'class="ins-row upd"' : 'class="ins-row ok"';
    return `<tr ${cls}><td>${x.part_no||""}</td><td>${x.lot||""}</td><td>${x.qty||""}</td></tr>`;
  }).join("");
}

/* 驗證（沿用 .5 規則） */
function validate(){
  const inspector=(elInsp?.value||"").trim();
  const part=(elPart?.value||"").trim().toUpperCase();
  const lot =(elLot ?.value||"").trim().toUpperCase();
  const qty =(elQty ?.value||"").trim();
  if(!inspector) return "請輸入檢驗員";
  if(!/^[A-Za-z0-9]{5,}$/.test(part)) return "料號格式錯誤";
  if(!lot) return "請輸入批號";
  if(!/^[1-9]\\d*$/.test(qty)) return "數量需為正整數";
  return {inspector,part,lot,qty};
}

/* 送出（GET；分送 date/shift） */
function key(date, sh, part, lot){ return `${date.slice(5)}|${sh}|${part}|${lot}`; }
function key2(date, sh, insp, qty){ return `${date.slice(5)}|${sh}|${insp}|${qty}|TRUE`; }

async function submitGET(){
  const v=validate(); if(typeof v==="string"){ toast(v); return; }
  const t=nowTPE(), date=t.ymd, sh=guessShift(+t.hh);

  const u=new URL(API_URL);
  u.searchParams.set("action","submit");
  u.searchParams.set("date", date);
  u.searchParams.set("shift", sh);
  u.searchParams.set("part_no", v.part);
  u.searchParams.set("lot", v.lot);
  u.searchParams.set("qty", v.qty);
  u.searchParams.set("inspector", v.inspector);
  u.searchParams.set("key",  key(date, sh, v.part, v.lot));
  u.searchParams.set("key2", key2(date, sh, v.inspector, v.qty));

  elBtn && (elBtn.disabled=true);
  try{
    const r=await fetch(u.toString(),{method:"GET",cache:"no-store"});
    const j=await r.json().catch(()=>({status:"error"}));
    if(!r.ok || j.status!=="ok"){ toast("❌ 後端："+(j.msg||"failed")); return; }

    const list=LS.g(K_B,[]);
    const existed=list.some(x=>x.part_no===v.part && x.lot===v.lot);
    list.unshift({part_no:v.part, lot:v.lot, qty:v.qty, ts:Date.now(), status:existed?"update":"insert"});
    LS.s(K_B, list.slice(0,100));
    renderB();

    elLot && (elLot.value="");
    elQty && (elQty.value="");
    toast(existed? "✔ 已更新" : "✔ 已新增");
  }catch(e){
    toast("❌ 連線失敗");
  }finally{
    elBtn && (elBtn.disabled=false);
  }
}

/* 初始化（不改版面；只更新顯示文字與保溫） */
(function init(){
  const n=nowTPE();
  const head=$("#headShift"); if(head) head.textContent = `${n.md} - ${guessShift(+n.hh)}`;
  const tick=$("#nowTick"); if(tick) tick.textContent = `${n.ymd} ${n.hms}`;
  ensureScope(); renderB();
  setInterval(()=>{ const t=nowTPE(); if(tick) tick.textContent = `${t.ymd} ${t.hms}`; },1000);
  setInterval(()=>{ const p=new URL(API_URL); p.searchParams.set("action","ping"); p.searchParams.set("t",Date.now()); fetch(p).catch(()=>{}); }, PING_MS);
  const vEl=$("#ver"); if(vEl) vEl.textContent="v17.11.6";
  elBtn && elBtn.addEventListener("click", submitGET);
})();
</script>
</body>
</html>