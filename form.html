<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RT 外觀抽驗記錄表</title>
<style>
  :root { --fg:#111; --muted:#666; --ok:#0a0; --upd:#e91e63; }
  body{font-family:system-ui,-apple-system,"PingFang TC","Noto Sans TC",Arial,sans-serif;margin:0;padding:16px;color:var(--fg)}
  h1{font-size:28px;margin:0 0 12px}
  .ver{font-size:12px;color:var(--muted)}
  .row{display:grid;grid-template-columns:70px 1fr;gap:10px;align-items:center;margin:10px 0}
  input,select,button{font-size:18px;padding:10px;border:1px solid #bbb;border-radius:6px;width:100%;box-sizing:border-box}
  button{background:#0b63ff;color:#fff;border:none}
  button[disabled]{opacity:.6}
  .hint{font-size:12px;color:var(--muted);margin:8px 0 0}
  .bar{display:flex;align-items:baseline;gap:10px;margin:6px 0 14px}
  .right{margin-left:auto;color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:collapse;margin-top:16px}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  .c-ok{color:var(--ok)}
  .c-upd{color:var(--upd)}
</style>
</head>
<body>
  <div class="bar">
    <h1>RT 外觀抽驗記錄表</h1>
    <span class="right">版本：<span id="ver">v17.11.1</span></span>
  </div>

  <div id="ymdShift" class="hint"></div>

  <div class="row"><label>檢驗員：</label><input id="inspector" autocomplete="off"></div>
  <div class="row"><label>料　號：</label><input id="part_no" autocomplete="off"></div>
  <div class="row"><label>批　號：</label><input id="lot" autocomplete="off"></div>
  <div class="row"><label>數　量：</label><input id="qty" inputmode="numeric" autocomplete="off"></div>
  <div class="row"><label></label><button id="btnSend">送出</button></div>

  <div class="hint">已對齊 GAS v1.4.6；送出使用 date + shift（GET）。</div>

  <table id="list">
    <thead>
      <tr><th>日　期</th><th>班別</th><th>料號</th><th>批號</th><th>數量</th><th>檢驗員</th></tr>
    </thead>
    <tbody id="tbody"><tr><td colspan="6" style="color:#888;text-align:center">(當班無草稿)</td></tr></tbody>
  </table>

<script>
/* ===== 固定參數（寫死，不做自動補丁） ===== */
const VERSION_TEXT = "v17.11.1";
const GAS_DEPLOY_ID = "AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei";
const API_URL = `https://script.google.com/macros/s/${GAS_DEPLOY_ID}/exec`;

/* ===== 工具 ===== */
const tz = "Asia/Taipei";
const $ = (sel)=>document.querySelector(sel);
const LS = {
  get(key, d){ try{ return JSON.parse(localStorage.getItem(key)) ?? d }catch{ return d } },
  set(key, v){ localStorage.setItem(key, JSON.stringify(v)) }
};
function pad(n){ return String(n).padStart(2,"0"); }
function fmtYMD(d){ return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}`; }
function fmtMD(d){ return `${pad(d.getMonth()+1)}/${pad(d.getDate())}`; }
function nowTW(){ return new Date(new Date().toLocaleString("en-US",{timeZone:tz})); }
function currentShift(d){
  const h = d.getHours();
  if (h>=6 && h<=13) return "A";
  if (h>=14 && h<=21) return "B";
  return "C";
}
function ymdForDisplay(d){
  // C 班 00:00~05:59 視為「前一日」
  if (currentShift(d)==="C" && d.getHours()<=5){
    const p = new Date(d); p.setDate(p.getDate()-1); return fmtYMD(p);
  }
  return fmtYMD(d);
}

/* ===== 畫面初始 ===== */
$("#ver").textContent = VERSION_TEXT;

const elInsp = $("#inspector");
const elPart = $("#part_no");
const elLot  = $("#lot");
const elQty  = $("#qty");
const elBtn  = $("#btnSend");
const elBody = $("#tbody");
const elBanner = $("#ymdShift");

const KEY_INSP  = "rt_form_inspector";
const KEY_DRAFT = "rt_form_draftB"; // [{part_no,lot,qty,ts,status:'new'|'upd'}]
const KEY_DAY   = "rt_form_dayShift"; // {ymd,shift}

function refreshBanner(){
  const n = nowTW();
  const ymd = ymdForDisplay(n);
  const shift = currentShift(n);
  elBanner.textContent = `${ymd} - ${shift}`;
  LS.set(KEY_DAY, { ymd, shift });
}
refreshBanner();

/* 檢驗員保溫 */
elInsp.value = LS.get(KEY_INSP,"") || "";
elInsp.addEventListener("change", ()=> LS.set(KEY_INSP, elInsp.value.trim()) );

/* 草稿渲染（字體顏色：新增=綠，新近更新=粉） */
function renderDraft(){
  const day = LS.get(KEY_DAY,{ymd:"",shift:""});
  const list = (LS.get(KEY_DRAFT,[])).filter(x=>x && x.day===day.ymd && x.shift===day.shift);
  list.sort((a,b)=>b.ts-a.ts);
  if(!list.length){ elBody.innerHTML = `<tr><td colspan="6" style="color:#888;text-align:center">(當班無草稿)</td></tr>`; return; }
  elBody.innerHTML = list.map(x=>{
    const cls = x.status==="upd" ? "c-upd" : "c-ok";
    return `<tr class="${cls}">
      <td>${x.day}</td><td>${x.shift}</td>
      <td>${x.part_no}</td><td>${x.lot}</td><td>${x.qty}</td><td>${x.inspector||""}</td>
    </tr>`;
  }).join("");
}
renderDraft();

/* 換班檢查：重載時計算，如換班則清空「當班」草稿（保留其它日班資料） */
(function rotateByShift(){
  const day = LS.get(KEY_DAY,null);
  const cur = { ymd: ymdForDisplay(nowTW()), shift: currentShift(nowTW()) };
  if (!day || day.ymd!==cur.ymd || day.shift!==cur.shift){
    // 僅移除非當班資料以外的噪音，實務：只保留不同日班的歷史也可，但你指定：換班清草稿B
    LS.set(KEY_DRAFT, []);
    LS.set(KEY_DAY, cur);
  }
})();

/* 驗證（沿用你的規則，簡潔版） */
function validate(){
  const insp = elInsp.value.trim();
  const part = elPart.value.trim().toUpperCase();
  const lot  = elLot.value.trim().toUpperCase();
  const qty  = elQty.value.trim();
  if(!insp || insp.length!==5) return ["檢驗員格式錯誤"];
  if(!/^[A-Z0-9]{7}$/.test(part)) return ["料號格式錯誤"];
  if(!/^([A-Z0-9]{3}|[A-Z0-9]{3}-[0-9]{1,2})$/.test(lot)) return ["批號格式錯誤"];
  if(!/^[1-9][0-9]*$/.test(qty)) return ["數量需為正整數"];
  return null;
}

/* 送出（GET），僅用 date + shift。送出後：清空批號/數量，下拉回預設（此頁無下拉，規則仍保留） */
async function submitGET(){
  const err = validate();
  if (err){ toast("❌ " + err[0]); return; }

  const n = nowTW();
  const ymd = ymdForDisplay(n);
  const shift = currentShift(n);

  const inspector = elInsp.value.trim().toUpperCase();
  const part_no   = elPart.value.trim().toUpperCase();
  const lot       = elLot.value.trim().toUpperCase();
  const qty       = elQty.value.trim();

  // key / key2（依你既有定義）
  const key  = `${fmtMD(new Date(ymd))}|${shift}|${part_no}|${lot}`;
  const key2 = `${fmtMD(new Date(ymd))}|${shift}|${inspector}|${qty}|TRUE`;

  const url = new URL(API_URL);
  url.searchParams.set("action","submit");
  url.searchParams.set("date", ymd);
  url.searchParams.set("shift", shift);
  url.searchParams.set("part_no", part_no);
  url.searchParams.set("lot", lot);
  url.searchParams.set("qty", qty);
  url.searchParams.set("inspector", inspector);
  url.searchParams.set("key", key);
  url.searchParams.set("key2", key2);

  elBtn.disabled = true;
  try{
    const r = await fetch(url.toString(), { method:"GET", mode:"cors" });
    const j = await r.json().catch(()=>({status:"error"}));

    if(j && j.status==="ok"){
      // 草稿B：{料號, 批號, 數量, 時間, 狀態(new|upd)}，同時記錄當班以供渲染
      const draft = LS.get(KEY_DRAFT,[]);
      draft.unshift({
        day: ymd, shift, part_no, lot, qty, inspector,
        ts: Date.now(),
        status: (j.updated===true ? "upd" : "new")
      });
      LS.set(KEY_DRAFT, draft);
      renderDraft();

      // 成功後：清空批號/數量
      elLot.value = "";
      elQty.value = "";

      toast("✅ 送出成功");
    }else{
      toast("❌ 後端：" + (j && j.msg ? j.msg : "unknown"));
    }
  }catch(e){
    toast("❌ 連線失敗：" + e.message);
  }finally{
    elBtn.disabled = false;
  }
}
$("#btnSend").addEventListener("click", submitGET);

/* 5 分鐘 ping（喚醒 GAS） */
setInterval(()=> {
  const url = new URL(API_URL);
  url.searchParams.set("action","ping");
  url.searchParams.set("t", Date.now());
  fetch(url.toString()).catch(()=>{});
}, 5*60*1000);

/* 極簡吐司 */
let tid=0;
function toast(t){
  clearTimeout(tid);
  let el = document.getElementById("toast");
  if(!el){
    el = document.createElement("div");
    el.id = "toast";
    el.style.position="fixed";
    el.style.left="50%";
    el.style.bottom="24px";
    el.style.transform="translateX(-50%)";
    el.style.background="#333";
    el.style.color="#fff";
    el.style.padding="10px 14px";
    el.style.borderRadius="10px";
    el.style.boxShadow="0 6px 20px rgba(0,0,0,.25)";
    el.style.zIndex="9999";
    document.body.appendChild(el);
  }
  el.textContent = t;
  el.style.opacity="1";
  tid=setTimeout(()=>el.style.opacity="0", 2400);
}
</script>
</body>
</html>