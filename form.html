<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RTå¤–è§€æŠ½é©—è¨˜éŒ„è¡¨ Â· v13.fix</title>
<style>
  :root{--pad:12px;--label:92px;}
  body{background:#f7f7f7;margin:0;padding:var(--pad);font-family:"Comic Sans MS","Comic Neue","Noto Sans TC",sans-serif;}
  /* top */
  .topbar{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:.5rem;padding-bottom:.5rem;border-bottom:1px solid #d9d9d9;margin-bottom:.75rem}
  .icon{background:transparent;border:none;font-size:1.35rem;line-height:1;cursor:pointer;padding:.35rem;border-radius:8px}
  .icon:active{background:#ececec}
  header{font-family:"DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif;font-weight:700;text-align:center}
  /* rows */
  .row{display:flex;align-items:center;gap:.75rem;margin:.55rem 0}
  .label{flex:0 0 var(--label);text-align:center;font-weight:700;color:#333;
         font-family:"DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif}
  .value{flex:1}
  input,select,textarea{width:100%;box-sizing:border-box;padding:.5rem;font-size:1rem;border:1px solid #cfcfcf;border-radius:8px;background:#fff}
  textarea{min-height:68px;resize:vertical;font-family:"DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif}
  #remark[readonly]{background:#f0f0f0;color:#666}
  /* first line (æ™‚é–“æˆ³èˆ‡ç­åˆ¥é¡¯ç¤º) */
  .status{display:flex;gap:.75rem;align-items:center}
  .status .ts{min-width:130px}
  .status .ds{font-weight:700}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  /* æ‰¹è™Ÿä¸‰æ¡† */
  .triple{display:grid;grid-template-columns:.55fr 16px 1.6fr 16px .9fr;gap:.5rem;align-items:center}
  .sep{text-align:center;color:#666}
  /* æ‰¹è™Ÿçµ„åˆé¡¯ç¤º */
  .lot-box{background:#eef2f6;color:#222;border-radius:8px;padding:.3rem .5rem;display:inline-flex;min-height:2rem;align-items:center}
  /* actions */
  .actions{justify-content:flex-end}
  .btn{border:none;background:#007bff;color:#fff;padding:.75rem 1.1rem;border-radius:10px;font-weight:700;min-width:40%}
  /* list */
  hr{border:none;border-top:1px solid #d9d9d9;margin:.75rem 0}
  .tbl-head{display:flex;gap:.5rem;font-weight:700;color:#555;
            font-family:"DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif}
  .tbl-head .c{flex:1;text-align:center}
  .rec{display:flex;gap:.5rem;padding:.35rem .25rem;border-bottom:1px dashed #e5e5e5;align-items:center}
  .rec .c{flex:1;display:flex;justify-content:center}
  .rec .qty{justify-content:center}
  .note{font-size:.82rem;color:#777;margin:.2rem .25rem .5rem}
  /* å·¦æ¨™é¡Œæ›´é å·¦ï¼ˆèˆ‡æœ€å³åŒé‚Šç•Œï¼‰*/
  @media(min-width:340px){:root{--label:94px}}
</style>
</head>
<body>

<div class="topbar">
  <button class="icon" id="langBtn" title="æ›´æ”¹èªè¨€">ğŸŒ</button>
  <header>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</header>
  <button class="icon" id="backBtn" title="è¿”å›ä¸Šä¸€é ">â†©ï¸</button>
</div>

<!-- ç‹€æ…‹åˆ—ï¼šé¡¯ç¤º NOW() - {æ—¥æœŸ/ç­åˆ¥} -->
<div class="row">
  <div class="label">ã€€</div>
  <div class="value status mono">
    <span class="ts" id="tsView">--/-- --:--</span>
    <span> - </span>
    <span class="ds" id="dsView">--/-- - -</span>
  </div>
</div>

<!-- æŠ½é©—è€… -->
<div class="row">
  <div class="label">æŠ½ã€€é©—ï¼š</div>
  <div class="value"><input id="inspector" placeholder="è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ"></div>
</div>

<!-- æ–™è™Ÿ -->
<div class="row">
  <div class="label">æ–™ã€€è™Ÿï¼š</div>
  <div class="value"><input id="part_no" placeholder="è«‹è¼¸å…¥ æ–™è™Ÿ by 7ç¢¼"></div>
</div>

<!-- æ‰¹è™Ÿä¸‰æ¡†ï¼ˆæ¨™é¡Œç¨åˆ—ï¼›ä¸‰æ¡†åŒåˆ—ï¼‰ -->
<div class="row">
  <div class="label">æ‰¹ã€€è™Ÿï¼š</div>
  <div class="value">
    <div class="triple">
      <select id="lot_prefix">
        <option value=""></option><option value="FA">FA</option><option value="CM">CM</option><option value="LN">LN</option>
      </select>
      <div class="sep">-</div>
      <input id="lot_mid"  maxlength="3" placeholder="æ¯æ‰¹">
      <div class="sep">-</div>
      <input id="lot_tail" maxlength="2" placeholder="å­æ‰¹" inputmode="numeric">
    </div>
  </div>
</div>

<!-- çµ„åˆå¾Œæ‰¹è™Ÿé¡¯ç¤ºï¼ˆåè‰²ç¸®å°ï¼‰ -->
<div class="row">
  <div class="label">ã€€</div>
  <div class="value"><span class="lot-box mono" id="lot_full"> </span></div>
</div>

<!-- æ•¸é‡ -->
<div class="row">
  <div class="label">æ•¸ã€€é‡ï¼š</div>
  <div class="value"><input id="qty" type="number" min="0" placeholder="è¼¸å…¥æ‰¹é‡ï¼ˆ>0ï¼‰" inputmode="numeric"></div>
</div>

<!-- å‚™è¨»ï¼ˆå”¯è®€ï¼Œä¿ç•™æ¬„ä½ï¼‰ -->
<div class="row">
  <div class="label">å‚™ã€€è¨»ï¼š</div>
  <div class="value"><textarea id="remark" placeholder="ï¼ˆæš«ä¸é–‹æ”¾è¼¸å…¥ï¼‰" readonly></textarea></div>
</div>

<!-- é€å‡º -->
<div class="row actions">
  <div class="label">ã€€</div>
  <div class="value" style="display:flex;justify-content:flex-end">
    <button class="btn" id="submitBtn">é€å‡º</button>
  </div>
</div>

<hr>
<div class="tbl-head">
  <div class="c">æ–™ã€€è™Ÿ</div>
  <div class="c">æ‰¹ã€€è™Ÿ</div>
  <div class="c">æ•¸ã€€é‡</div>
</div>
<hr>
<div class="note">é¡¯ç¤ºè¦å‰‡ï¼šç•¶æ—¥ç•¶ç­ï¼‹åŒå·¥è™Ÿï¼›å€’åºï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰ï¼Œæœ€å¤š 50 ç­†ã€‚</div>
<div id="list"></div>

<script>
/* ====== å¸¸é‡ ====== */
const GAS_URL  = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const API_TOKEN= "MY_SECRET_123";

/* ====== UI åŸºæœ¬ ====== */
document.getElementById('backBtn').onclick=()=>{ if(history.length>1) history.back(); };
document.getElementById('langBtn').onclick=()=>{ /* å¤šèªç«¯å£é ç•™ */ };

/* ====== æ‰¹è™Ÿå³æ™‚çµ„åˆ ====== */
const $p=document.getElementById('lot_prefix');
const $m=document.getElementById('lot_mid');
const $t=document.getElementById('lot_tail');
const $f=document.getElementById('lot_full');
function composeLot(){
  const parts=[($p.value||'').trim(),($m.value||'').trim(),($t.value||'').trim()].filter(Boolean);
  $f.textContent = parts.join('-') || ' ';
}
['input','change'].forEach(ev=>{$p.addEventListener(ev,composeLot);$m.addEventListener(ev,composeLot);$t.addEventListener(ev,composeLot);});
composeLot();

/* ====== ç­åˆ¥èˆ‡æ—¥æœŸï¼ˆä¾ç­èµ·æ—¥ï¼›å« 80 åˆ†é˜å¯¬é™ï¼‰ ====== */
const TZ='Asia/Taipei';
const dsView=document.getElementById('dsView');
const tsView=document.getElementById('tsView');
function twNow(){ return new Date(new Date().toLocaleString('en-US',{timeZone:TZ})); }
function fmtMD(d){ const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${mm}/${dd}`; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function setHM(base,h,m){ const d=new Date(base); d.setHours(h,m,0,0); return d; }
function calcShiftAnchor(now){
  // ç­èµ·é»ï¼šC=00:40, A=08:40, B=16:40ï¼›00:00â€“00:39 ä»å±¬å‰ä¸€æ—¥ Bï¼ˆæ—¥æœŸè¦ -1ï¼‰
  const mins=now.getHours()*60+now.getMinutes();
  if (mins>=8*60+40 && mins<16*60+40) { // A
    return {date:fmtMD(now), shift:'A', next:setHM(now,16,40)};
  } else if (mins>=16*60+40) { // B è‡³ 23:59
    return {date:fmtMD(now), shift:'B', next:setHM(addDays(now,1),0,40)};
  } else if (mins<40) { // 00:00â€“00:39 â†’ å‰ä¸€æ—¥ B
    const y=addDays(now,-1);
    return {date:fmtMD(y), shift:'B', next:setHM(now,0,40)};
  } else { // 00:40â€“08:39 â†’ C
    return {date:fmtMD(now), shift:'C', next:setHM(now,8,40)};
  }
}
function anchorIfNeeded(){
  const now=twNow();
  const store=JSON.parse(localStorage.getItem('ds_anchor')||'{}');
  if(!store.until || now.getTime()>store.until){
    const a=calcShiftAnchor(now);
    const until=a.next.getTime()+80*60000; // å¯¬é™ 80 åˆ†
    localStorage.setItem('ds_anchor', JSON.stringify({date:a.date,shift:a.shift,until}));
    return {date:a.date, shift:a.shift, until};
  }
  return store;
}
function tick(){
  const now=twNow();
  const ds=anchorIfNeeded();
  tsView.textContent = `${fmtMD(now)} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  dsView.textContent = `${ds.date} - ${ds.shift}`;
}
tick(); setInterval(tick, 30000); document.addEventListener('visibilitychange',()=>{ if(!document.hidden) tick(); });

/* ====== è‰ç¨¿ï¼šç•¶æ—¥ç•¶ç­ä¸è®Šâ†’ä¿ç•™æ–™è™Ÿ/æ‰¹è™Ÿ/æ•¸é‡ï¼›è®Šæ›´â†’æ¸…ç©ºï¼ˆä¿ç•™å·¥è™Ÿï¼‰ ====== */
const $ins=document.getElementById('inspector');
const $part=document.getElementById('part_no');
const $qty=document.getElementById('qty');
function loadDraft(){
  const d=JSON.parse(localStorage.getItem('draft')||'{}');
  const ds=JSON.parse(localStorage.getItem('ds_anchor')||'{}');
  if(d.ds && ds.date===d.ds.date && ds.shift===d.ds.shift){
    $part.value=d.part||''; $p.value=d.lp||''; $m.value=d.lm||''; $t.value=d.lt||''; $qty.value=d.qty||'';
    composeLot();
  } else {
    $p.value=''; $m.value=''; $t.value=''; $part.value=''; $qty.value=''; composeLot();
  }
  // å·¥è™Ÿå¸¸é§ï¼ˆè¼¸å…¥ç¬¦åˆæ‰æ›´æ–°ï¼‰
  const u=localStorage.getItem('inspector')||'';
  if(u) $ins.value=u;
}
function saveDraft(){
  const ds=JSON.parse(localStorage.getItem('ds_anchor')||'{}');
  const d={ds, part:$part.value, lp:$p.value, lm:$m.value, lt:$t.value, qty:$qty.value};
  localStorage.setItem('draft', JSON.stringify(d));
}
['input','change'].forEach(ev=>[$part,$p,$m,$t,$qty].forEach(el=>el.addEventListener(ev,saveDraft)));
$ins.addEventListener('change',()=>{ if(/^[A-Za-z0-9]{5}$/.test($ins.value||'')) localStorage.setItem('inspector',$ins.value.trim()); });
loadDraft();

/* ====== åˆ—è¡¨ï¼šåªé¡¯ç¤ºç•¶æ—¥ç•¶ç­ + åŒå·¥è™Ÿï¼›å€’åºï¼›æœ€å¤š 50 ====== */
async function refreshList(){
  const list=document.getElementById('list'); list.innerHTML='';
  try{
    const res=await fetch(`${GAS_URL}?limit=50`);
    const data=await res.json();
    const ds=JSON.parse(localStorage.getItem('ds_anchor')||'{}');
    const me=($ins.value||'').trim();
    const wanted=`${ds.date}-${ds.shift}`;
    const rows=(Array.isArray(data)?data:[]).filter(r=>r.date_shift===wanted && (!me || r.inspector===me));
    // å€’åºï¼ˆGAS å·²å¤§è‡´ä¾ ts å€’åºï¼Œé€™è£¡å†ä¿éšªä¸€æ¬¡ï¼‰
    rows.sort((a,b)=>String(b.ts).localeCompare(String(a.ts)));
    for(const r of rows.slice(0,50)){
      const row=document.createElement('div'); row.className='rec';
      const c1=document.createElement('div'); c1.className='c'; c1.textContent=r.part_no||'';
      const c2=document.createElement('div'); c2.className='c mono'; c2.textContent=r.lot_full||'';
      const c3=document.createElement('div'); c3.className='c qty mono'; c3.textContent=r.qty||'';
      row.appendChild(c1); row.appendChild(c2); row.appendChild(c3);
      list.appendChild(row);
    }
  }catch(e){ console.error(e); }
}
refreshList();

/* ====== é€å‡º ====== */
document.getElementById('submitBtn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const ds=JSON.parse(localStorage.getItem('ds_anchor')||'{}');
  const payload={
    token:API_TOKEN,
    ts:new Date().toISOString(),
    date_shift:`${ds.date}-${ds.shift}`,
    inspector:($ins.value||'').trim(),
    part_no:($part.value||'').trim(),
    lot_prefix:($p.value||'').trim(),
    lot_mid:($m.value||'').trim(),
    lot_tail:($t.value||'').trim(),
    qty:($qty.value||'').trim(),
    remark:""
  };
  if(!payload.date_shift||!payload.inspector||!payload.part_no||!payload.qty){ alert('è«‹ç¢ºèªï¼šç­åˆ¥/æŠ½é©—è€…/æ–™è™Ÿ/æ•¸é‡'); return; }

  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const data=await res.json();
    if(data.status==='ok'){
      // æˆåŠŸï¼šè‹¥ç•¶æ—¥ç•¶ç­æœªè®Š â†’ ä¿ç•™æ–™è™Ÿï¼›å¦å‰‡æ¸…ç©º
      const cur=JSON.parse(localStorage.getItem('ds_anchor')||'{}');
      const d=JSON.parse(localStorage.getItem('draft')||'{}');
      if(d.ds && d.ds.date===cur.date && d.ds.shift===cur.shift){
        // æ¸…ç©ºæ‰¹è™Ÿèˆ‡æ•¸é‡ï¼ˆä¿ç•™æ–™è™Ÿï¼‰
        $p.value='';$m.value='';$t.value='';$qty.value='';composeLot();
        saveDraft();
      }else{
        $part.value='';$p.value='';$m.value='';$t.value='';$qty.value='';composeLot();
        saveDraft();
      }
      refreshList();
      alert('âœ… å·²é€å‡º');
    }else if(data.error==='conflict_other_inspector'){
      alert('âš ï¸ åŒæ—¥åŒç­åŒæ–™è™Ÿï¼‹æ‰¹è™Ÿå·²ç”±å…¶ä»–æŠ½é©—è€…å»ºç«‹ï¼Œè«‹ç¢ºèªã€‚');
    }else if(data.error==='unauthorized'){
      alert('ğŸš« é©—è­‰å¤±æ•—ï¼ˆtokenï¼‰ã€‚');
    }else{
      alert('âŒ é€å‡ºå¤±æ•—ï¼š'+JSON.stringify(data));
    }
  }catch(err){
    alert('âŒ é€å‡ºéŒ¯èª¤ï¼š'+err.message);
  }
});
</script>
</body>
</html>