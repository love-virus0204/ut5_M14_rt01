<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>RT 外觀抽驗記錄表</title>
<style>
  :root { --fg:#111; --muted:#666; --ok:#0a0; --edit:#d2187a; }
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Noto Sans TC",Arial;
       margin:0;color:var(--fg);background:#fff;}
  .wrap{max-width:940px;margin:0 auto;padding:20px;}
  header{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
  header h1{font-weight:800;font-size:28px;margin:0}
  header .ver{margin-left:8px;font-size:12px;color:var(--muted)}
  .row{display:grid;grid-template-columns:86px 1fr;align-items:center;gap:10px;margin:12px 0;}
  label{font-size:18px;letter-spacing:.2em}
  input,select,button{font-size:18px;padding:12px;border:1px solid #bbb;border-radius:6px;outline:none}
  input:focus,select:focus{border-color:#333}
  button{cursor:pointer;background:#0b63f6;color:#fff;border:none}
  button:disabled{opacity:.5;cursor:not-allowed}
  .hint{color:var(--muted);font-size:12px;margin-top:4px}
  footer{display:flex;justify-content:space-between;align-items:center;margin:16px 0 10px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin:10px 0 24px}
  th,td{padding:14px 6px;border-bottom:1px solid #eee;text-align:center}
  .badge{font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid #ccc;color:#444}
  .c-ok{color:var(--ok);font-weight:700}
  .c-edit{color:var(--edit);font-weight:700}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
         background:#333;color:#fff;padding:12px 16px;border-radius:10px;opacity:.98;z-index:99}
  @media (max-width:560px){ .row{grid-template-columns:72px 1fr} label{font-size:16px} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>RT 外觀抽驗記錄表</h1>
    <span class="ver">v17.11.3</span>
  </header>

  <!-- 顯示「MM/DD - 班別」 -->
  <div class="row" style="margin-top:4px;">
    <label id="todayShiftLabel" style="grid-column:1/3;font-weight:700"></label>
  </div>

  <!-- 表單骨架（沿用 v17.10.5：檢驗員、料號、型態、批號、數量） -->
  <div class="row">
    <label for="inspector">檢驗員：</label>
    <input id="inspector" type="text" inputmode="latin" autocomplete="off" placeholder="請輸入檢驗員" />
  </div>

  <div class="row">
    <label for="part_no">料　號：</label>
    <input id="part_no" type="text" inputmode="latin" autocomplete="off" placeholder="如 A12B345" />
  </div>

  <div class="row">
    <label for="type">型　態：</label>
    <select id="type">
      <option value="" selected>請選擇</option>
      <option value="OK">OK</option>
      <option value="NG">NG</option>
    </select>
  </div>

  <div class="row">
    <label for="lot">批　號：</label>
    <input id="lot" type="text" inputmode="latin" autocomplete="off" placeholder="批號" />
  </div>

  <div class="row">
    <label for="qty">數　量：</label>
    <input id="qty" type="text" inputmode="numeric" autocomplete="off" placeholder="正整數" />
  </div>

  <div class="row" style="margin-top:8px;">
    <span></span>
    <button id="btnSend">送出</button>
  </div>

  <footer>
    <div id="verNote" class="hint">已對齊 GAS v1.4.6，送出分送 date + shift。</div>
    <div id="nowTs" class="hint"></div>
  </footer>

  <table>
    <thead>
    <tr>
      <th>料　號</th>
      <th>批　號</th>
      <th>數　量</th>
    </tr>
    </thead>
    <tbody id="draftTbody">
      <tr><td colspan="3" class="hint" style="text-align:center">(當班無草稿)</td></tr>
    </tbody>
  </table>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
/* ===== 常數：寫死你的 GAS URL（GET）===== */
const API_BASE = "https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec";

/* ===== 版本 ===== */
const FORM_VER = "v17.11.3";

/* ===== 工具 ===== */
const $ = (id)=>document.getElementById(id);
const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1800); };
const pad2 = n => String(n).padStart(2,"0");

/* ===== 取得台北時間（裝置為主，格式 yyyy/MM/dd 與 MM/DD 與 HH）===== */
function nowTaipei() {
  // 以裝置時間為準，僅格式化為台北
  const d = new Date();
  const y = d.getFullYear(), m = d.getMonth()+1, day = d.getDate();
  const hh = d.getHours(), mm = d.getMinutes(), ss = d.getSeconds();
  return {
    y, m, day, hh, mm, ss,
    ymd: `${y}/${pad2(m)}/${pad2(day)}`,
    md: `${pad2(m)}/${pad2(day)}`,
    hms: `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`
  };
}

/* ===== 班別推導（沿用你舊規則）===== */
function guessShift(h){
  if (h>=6 && h<=13) return "A";
  if (h>=14 && h<=21) return "B";
  return "C";
}

/* ===== 草稿（當班）與 草稿B（列表用）===== */
const LS_INSPECTOR = "rt.inspector";           // 檢驗員「保溫」
const LS_DRAFT = "rt.draft";                   // 當班草稿（含欄位快填）
const LS_DRAFT_B = "rt.draftB";                // 列表：{part_no,lot,qty,time,status}
const LS_SHIFT_KEY = "rt.shift.key";           // 當班識別 "yyyy/MM/dd|Shift"

/* 當班 key */
function todayShiftKey() {
  const n = nowTaipei(); const s = guessShift(n.hh);
  return `${n.ymd}|${s}`;
}

/* 切班則清草稿 */
function ensureDraftForShift() {
  const key = todayShiftKey();
  const saved = localStorage.getItem(LS_SHIFT_KEY);
  if (saved !== key) {
    // 換班：清除「當班草稿」與 DraftB，保留「檢驗員」
    localStorage.setItem(LS_SHIFT_KEY, key);
    localStorage.removeItem(LS_DRAFT);
    localStorage.removeItem(LS_DRAFT_B);
  }
}

/* 渲染當班日期+班別（MM/DD - S） */
function renderTodayShift() {
  const n = nowTaipei();
  const s = guessShift(n.hh);
  $("todayShiftLabel").textContent = `${n.md} - ${s}`;
  $("nowTs").textContent = `${n.ymd} ${n.hms}`;
}

/* 載入保溫與草稿 */
function loadDraft() {
  const ins = localStorage.getItem(LS_INSPECTOR) || "";
  $("inspector").value = ins;

  const d = JSON.parse(localStorage.getItem(LS_DRAFT) || "{}");
  if (d.part_no) $("part_no").value = d.part_no;
  if (d.type) $("type").value = d.type;
  if (d.lot) $("lot").value = d.lot;
  if (d.qty) $("qty").value = d.qty;
}

/* 保存當班草稿 */
function saveDraft() {
  const d = {
    part_no: $("part_no").value.trim(),
    type: $("type").value,
    lot: $("lot").value.trim(),
    qty: $("qty").value.trim()
  };
  localStorage.setItem(LS_DRAFT, JSON.stringify(d));
}

/* 草稿B：只保留 {part_no, lot, qty, time, status}，時間用降冪排序 */
function pushDraftB(entry){
  const arr = JSON.parse(localStorage.getItem(LS_DRAFT_B) || "[]");
  arr.unshift(entry);
  arr.sort((a,b)=> (b.time||"") > (a.time||"") ? 1 : -1);
  localStorage.setItem(LS_DRAFT_B, JSON.stringify(arr));
}

function renderDraftB(){
  const arr = JSON.parse(localStorage.getItem(LS_DRAFT_B) || "[]");
  const tb = $("draftTbody");
  tb.innerHTML = "";
  if (!arr.length) {
    const tr = document.createElement("tr");
    const td = document.createElement("td"); td.colSpan=3; td.className="hint"; td.style.textAlign="center"; td.textContent="(當班無草稿)";
    tr.appendChild(td); tb.appendChild(tr); return;
  }
  for (const it of arr){
    const tr = document.createElement("tr");
    const td1 = document.createElement("td"); const td2 = document.createElement("td"); const td3 = document.createElement("td");
    td1.textContent = it.part_no || "";
    td2.textContent = it.lot || "";
    td3.textContent = it.qty || "";
    const cls = it.status === "update" ? "c-edit" : "c-ok";
    td1.className = cls; td2.className = cls; td3.className = cls;
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tb.appendChild(tr);
  }
}

/* ===== 5 分鐘保溫（ping）===== */
function keepAlive(){
  const url = `${API_BASE}?action=ping&t=${Date.now()}`;
  fetch(url).catch(()=>{ /* 靜默 */ });
}
setInterval(keepAlive, 5*60*1000);

/* ===== 送出（GET）===== */
function buildKey(ymd, shift, part_no, lot){
  // 你既有定義：key = 當日|當班|料號|批號
  const md = ymd.slice(5); // yyyy/MM/dd -> MM/dd
  return `${md}|${shift}|${part_no}|${lot}`;
}
function buildKey2(ymd, shift, inspector, qty){
  const md = ymd.slice(5);
  return `${md}|${shift}|${inspector}|${qty}|TRUE`;
}

async function submitGET(){
  const inspector = $("inspector").value.trim().toUpperCase();
  const part_no   = $("part_no").value.trim().toUpperCase();
  const type      = $("type").value; // 沿用但不上傳
  const lot       = $("lot").value.trim().toUpperCase();
  const qtyStr    = $("qty").value.trim();

  // 欄位驗證（沿用你既有規則，簡潔化）
  if (!inspector){ toast("檢驗員必填"); return; }
  if (!part_no){ toast("料號必填"); return; }
  if (!lot){ toast("批號必填"); return; }
  if (!/^[1-9]\d*$/.test(qtyStr)){ toast("數量需為正整數"); return; }
  const qty = parseInt(qtyStr,10);

  // 時間與班別
  const n = nowTaipei();
  const ymd = n.ymd;
  const shift = guessShift(n.hh);

  // 構造 keys
  const key  = buildKey(ymd, shift, part_no, lot);
  const key2 = buildKey2(ymd, shift, inspector, qty);

  // 檢查 DraftB 是否已有同 key 來標記狀態
  const b = JSON.parse(localStorage.getItem(LS_DRAFT_B) || "[]");
  const existed = b.some(x => (x.part_no===part_no && x.lot===lot));
  const statusTag = existed ? "update" : "new";

  // GET 參數（不傳 type、不傳 remark）
  const params = new URLSearchParams({
    action: "submit",
    date: ymd,
    shift,
    part_no,
    lot,
    qty: String(qty),
    inspector,
    key,
    key2
  });
  const url = `${API_BASE}?${params.toString()}`;

  $("btnSend").disabled = true;
  try{
    const resp = await fetch(url, { method:"GET" });
    if (!resp.ok){ throw new Error(`HTTP ${resp.status}`); }
    let data = null;
    try { data = await resp.json(); } catch { /* 有些發佈為 text 成功字樣 */ }
    if (data && data.status && data.status!=="ok") {
      throw new Error(data.msg || "server_error");
    }

    // 成功：寫入保溫、草稿、草稿B
    localStorage.setItem(LS_INSPECTOR, inspector);
    saveDraft(); // 更新當班內容的其餘欄位
    pushDraftB({ part_no, lot, qty, time:`${ymd} ${n.hms}`, status: statusTag });
    renderDraftB();

    // 成功後：清空「批號、數量」，料號保留；下拉恢復預設
    $("lot").value = "";
    $("qty").value = "";
    $("type").value = "";

    toast("✅ 已送出");
  }catch(err){
    toast(`❌ 連線失敗：${err.message || err}`);
  }finally{
    $("btnSend").disabled = false;
  }
}

/* ===== 綁定事件 ===== */
function bind(){
  $("btnSend").addEventListener("click", submitGET);
  $("inspector").addEventListener("change", ()=>localStorage.setItem(LS_INSPECTOR, $("inspector").value.trim().toUpperCase()));
  ["part_no","type","lot","qty"].forEach(id=>{
    $(id).addEventListener("input", saveDraft);
  });
}

/* ===== 啟動 ===== */
(function init(){
  ensureDraftForShift();
  renderTodayShift();
  loadDraft();
  renderDraftB();
  bind();
  keepAlive();
  // 時鐘角落刷新
  setInterval(()=>{ $("nowTs").textContent = `${nowTaipei().ymd} ${nowTaipei().hms}`; }, 1000);
})();
</script>
</body>
</html>