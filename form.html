<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</title>
<style>
  :root{--maxw:520px; --labelw:92px;}
  body{margin:0;background:#f5f5f5;font-family:"Comic Sans MS",sans-serif}
  .wrap{max-width:var(--maxw);margin:8px auto;padding:10px 14px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .toolbar{display:grid;grid-template-columns:36px auto 36px;align-items:center;margin-bottom:6px}
  .tool-left{justify-self:start}
  .tool-right{justify-self:end}
  .tool-btn{background:none;border:0;font-size:18px;line-height:1;padding:2px 6px;cursor:pointer}
  .title{font-family:"æ¨™æ¥·é«”",serif;text-align:center;font-weight:700;margin:0;font-size:1.4rem}
  @media (max-width: 400px){ .title{font-size:1.2rem} }

  .ds-line{font-weight:700;margin:8px 0 10px 0; padding-left:20px;}

  .row{display:grid;grid-template-columns:var(--labelw) 1fr;align-items:center;column-gap:10px;margin:6px 0}
  .label{font-family:"æ¨™æ¥·é«”",serif;text-align:center}
  .ctrl{width:100%}
  .ctrl input,.ctrl select{width:100%;box-sizing:border-box;padding:7px;border:1px solid #ccc;border-radius:6px;font-family:"Comic Sans MS",sans-serif}
  .row.lot-type .ctrl{display:grid;grid-template-columns:25% 1fr;column-gap:8px}
  .row.lot-type select{min-width:80px}

  .field-error{display:none;color:#d93025;font-weight:700;font-size:13px;margin-top:4px}
  .input-error{ border-color:#d93025 !important; }

  .submit{position:relative;display:flex;justify-content:flex-end;align-items:center;margin-top:10px}
  .submit-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:12px}
  .btn{background:#0a66ff;color:#fff;border:0;border-radius:8px;padding:10px 18px;cursor:pointer}

  .ok-msg{display:none;color:#1a7f37;font-weight:700;font-size:13px}
  .ok-msg.show{display:block;opacity:1;transition:opacity .4s}
  .ok-msg.fade{opacity:0}
  .dots{display:none;font-size:13px;color:#333}
  .dots span{opacity:0;animation:blink 1s infinite;}
  .dots span:nth-child(1){animation-delay:0s}
  .dots span:nth-child(2){animation-delay:.2s}
  .dots span:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,100%{opacity:0}50%{opacity:1}}

  hr{margin:10px 0}
  .post{width:95%;margin:0 auto}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-top:1px solid #ddd;text-align:center;padding:6px 4px}
  .bottom-info{display:grid;grid-template-columns:1fr 1fr;align-items:center;margin:6px 0}
  .ver-left{justify-self:start;font-size:12px;color:#666}
  .time-right{justify-self:end;font-size:12px;color:#333;text-align:right}

  .tr-strike td{ color:#999; text-decoration: line-through; }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="tool-left"><button class="tool-btn" id="langBtn" title="èªè¨€">ğŸŒ</button></div>
    <h1 class="title">RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</h1>
    <div class="tool-right"><button class="tool-btn" id="backBtn" title="è¿”å›" onclick="location.href='index.html'">â†©ï¸</button></div>
  </div>

  <div id="dsView" class="ds-line"></div>

  <div class="row">
    <div class="label">æª¢ã€€é©—ï¼š</div>
    <div class="ctrl">
      <input id="inspector" maxlength="5" placeholder="è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ">
      <div id="inspectorError" class="field-error"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ–™ã€€è™Ÿï¼š</div>
    <div class="ctrl">
      <input id="partNo" maxlength="7" placeholder="è¼¸å…¥ 7ç¢¼æ–™è™Ÿ">
      <div id="partError" class="field-error"></div>
    </div>
  </div>

  <div class="row lot-type">
    <div class="label">å‹ã€€æ…‹ï¼š</div>
    <div class="ctrl">
      <select id="lotPrefix">
        <option value=""></option>
        <option value="FA">FA</option>
      </select>
      <div></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ‰¹ã€€è™Ÿï¼š</div>
    <div class="ctrl">
      <input id="lotInput" placeholder="æ¯æ‰¹(3ç¢¼) or æ¯æ‰¹-å­æ‰¹(3-2)ï¼›ç¦ I / O">
      <div id="lotError" class="field-error"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ•¸ã€€é‡ï¼š</div>
    <div class="ctrl"><input id="qty" type="number" min="1" placeholder="è¼¸å…¥ æ‰¹é‡"></div>
  </div>

  <div class="submit" id="submit-row">
    <div class="submit-center">
      <div id="okMsg" class="ok-msg"></div>
      <div id="loadingDots" class="dots">å‚³é€ä¸­<span>.</span><span>.</span><span>.</span></div>
    </div>
    <button id="sendBtn" class="btn">é€å‡º</button>
  </div>

  <hr>

  <div class="post">
    <div class="bottom-info">
      <div id="versionTag" class="ver-left">ç‰ˆæœ¬ï¼šv17.7.6</div>
      <div id="tsView" class="time-right"></div>
    </div>
    <table>
      <thead><tr><th>æ–™ã€€è™Ÿ</th><th>æ‰¹ã€€è™Ÿ</th><th>æ•¸ã€€é‡</th></tr></thead>
      <tbody id="recordList"></tbody>
    </table>
  </div>
</div>



<script>
/* å¤–è§€è¨˜éŒ„è¡¨ â€” å‰ç«¯æœ€å°é‡å¯« v19.1 (GET-only, auto URL)
   ä¿ç•™åŸæ’ç‰ˆèˆ‡è¼¸å…¥æ¬„ä½ã€‚åªæ›´æ›è¡Œç‚ºï¼šå³æ™‚é©—è­‰ + ç•¶æ—¥ç•¶ç­ + GET å‚³éï¼ˆno-cors â†’ <img> å¾Œå‚™ï¼‰ã€‚
*/
const API_URL = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const SEND_KEYS = { action:"upsert", inspector:"inspector", part:"part_no", lot:"lot", qty:"qty", date:"date", shift:"shift" };
const MIN_INSPECTOR_LEN = 1;
const $ = (s,ctx=document)=>ctx.querySelector(s);

function computeDS(){
  const now = new Date();
  const minutes = now.getHours()*60 + now.getMinutes();
  let shift = "A";
  if (minutes >= 520 && minutes <= 999) shift = "A";
  else if (minutes >= 1000 || minutes <= 39) shift = "B";
  else if (minutes >= 40 && minutes <= 519)  shift = "C";
  const d = new Date(now);
  if (shift === "C") d.setDate(d.getDate() - 1);
  const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  return { shift, ymd:`${y}/${m}/${dd}` };
}
function setDS(){
  const ds = computeDS();
  const dEl = document.getElementById("date"), sEl = document.getElementById("shift");
  if (dEl) dEl.value = ds.ymd;
  if (sEl) sEl.value = ds.shift;

  // Find existing display node or create one at top of .wrap
  let el = document.getElementById("ds-line")
        || document.querySelector(".ds-line")
        || document.querySelector("[data-ds-line]");
  if (!el) {
    const wrap = document.querySelector(".wrap") || document.body;
    el = document.createElement("div");
    el.id = "ds-line";
    el.className = "ds-line";
    el.style.fontWeight = "700";
    el.style.margin = "8px 0 10px 0";
    el.style.paddingLeft = "20px";
    wrap.insertBefore(el, wrap.firstChild);
  }
  el.textContent = `æ—¥æœŸï¼š${ds.ymd}ã€€ç­åˆ¥ï¼š${ds.shift}`;
  return ds;
}
ç­åˆ¥ï¼š${ds.shift}`;
  return ds;
}

function ensureErrNode(input){
  let host = input.closest(".row") || input.parentElement || input;
  let box = host.querySelector(".field-error");
  if (!box) { box = document.createElement("div"); box.className = "field-error"; host.appendChild(box); }
  return box;
}
function showError(input, msg){
  const box = ensureErrNode(input);
  box.textContent = msg || "";
  box.style.display = msg ? "block" : "none";
  input.classList.toggle("input-error", !!msg);
}
function vInspector(s){ return (!s || s.trim().length < MIN_INSPECTOR_LEN) ? "è«‹è¼¸å…¥æª¢é©—å“¡" : ""; }
function vPart(p){
  if (typeof p !== "string") return "æ–™è™Ÿéœ€æ–‡å­—";
  p = p.trim();
  if (p.length !== 7) return "æ–™è™Ÿéœ€ 7 ç¢¼";
  const L=c=>/[A-Za-z]/.test(c), D=s=>/^\d+$/.test(s);
  if (!L(p[0])) return "ç¬¬1ç¢¼éœ€è‹±æ–‡";
  if (!L(p[3])) return "ç¬¬4ç¢¼éœ€è‹±æ–‡";
  if (!D(p.slice(1,3)+p.slice(4))) return "å…¶é¤˜éœ€æ•¸å­—";
  return "";
}
function vLot(s){ return (!s || !s.trim()) ? "æ‰¹è™Ÿä¸å¯ç©ºç™½" : ""; }
function vQty(q){
  if (q===""||q===null||q===undefined) return "æ•¸é‡ä¸å¯ç©ºç™½";
  const n = Number(q);
  if (!Number.isFinite(n) || n<=0) return "æ•¸é‡éœ€ç‚ºæ­£æ•¸";
  if (!Number.isInteger(n)) return "éœ€ç‚ºæ•´æ•¸";
  return "";
}
function wireRealtime(){
  const ins=$("#inspector"), part=$("#part"), lot=$("#lot"), qty=$("#qty");
  if (ins)  ins.addEventListener("input", ()=>showError(ins,  vInspector(ins.value)));
  if (part) part.addEventListener("input", ()=>showError(part, vPart(part.value)));
  if (lot)  lot.addEventListener("input",  ()=>showError(lot,  vLot(lot.value)));
  if (qty)  qty.addEventListener("input",  ()=>showError(qty,  vQty(qty.value)));
}

async function fetchNoCors(url, params){
  try{
    const full = url.replace(/^http:\/\//i,'https://') + "?" + params.toString();
    await fetch(full, { method:"GET", mode:"no-cors", cache:"no-store" });
    return true;
  }catch{ return false; }
}
async function imgFireAndForget(url, params){
  return new Promise(resolve=>{
    try{
      params.set("_", Date.now().toString());
      const u = url.replace(/^http:\/\//i,'https://') + "?" + params.toString();
      const img = new Image(); let done=false;
      const fin=()=>{ if(!done){ done=true; resolve(true); } };
      img.onload = fin; img.onerror = fin; setTimeout(fin, 6000);
      img.src = u;
    }catch{ resolve(false); }
  });
}
async function sendData(values){
  const ds = setDS();
  const params = new URLSearchParams();
  params.set("action", SEND_KEYS.action);
  params.set(SEND_KEYS.inspector, values.inspector);
  params.set(SEND_KEYS.part,      values.part);
  params.set(SEND_KEYS.lot,       values.lot);
  params.set(SEND_KEYS.qty,       String(values.qty));
  params.set(SEND_KEYS.date,      ds.ymd);
  params.set(SEND_KEYS.shift,     ds.shift);

  if (await fetchNoCors(API_URL, params))    return true;
  if (await imgFireAndForget(API_URL, params)) return true;
  return false;
}
function readVals(){
  return {
    inspector: $("#inspector")?.value?.trim() || "",
    part:      $("#part")?.value?.trim() || "",
    lot:       $("#lot")?.value?.trim() || "",
    qty:       $("#qty")?.value?.trim() || ""
  };
}
function validateAll(v){
  const ins=$("#inspector"), part=$("#part"), lot=$("#lot"), qty=$("#qty");
  const e1=vInspector(v.inspector); showError(ins,e1);
  const e2=vPart(v.part);           showError(part,e2);
  const e3=vLot(v.lot);             showError(l,e3);
  const e4=vQty(v.qty);             showError(qty,e4);
  return !(e1||e2||e3||e4);
}
document.addEventListener("DOMContentLoaded", ()=>{
  setDS();
  wireRealtime();
  const form = $("#form"); if (!form) return;
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const v = readVals();
    if (!validateAll(v)) return;
    const ok = await sendData(v);
    if (ok) { ["part","lot","qty"].forEach(id=>{ const el=$("#"+id); if(el) el.value=""; }); }
    else alert("å‚³é€å¤±æ•—ï¼šæª¢æŸ¥ API_URL æˆ–ç¶²è·¯");
  }, { capture:true });
});
</script>


<script>
(function(){
  "use strict";
  function runDS(){ try{ if (typeof window.setDS === "function") window.setDS(); }catch(e){} }
  document.addEventListener("DOMContentLoaded", runDS);
  window.addEventListener("load", runDS);
})();
</script>

</body>
</html>