<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</title>
<style>
  :root{--maxw:520px; --labelw:72px;}
  body{margin:0;background:#f5f5f5;font-family:"Comic Sans MS",sans-serif}
  .wrap{max-width:var(--maxw);margin:8px auto;padding:10px 14px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  /* é ‚åˆ—ï¼šä¸‰æ¬„ Gridï¼ˆå·¦èªè¨€ï¼ä¸­æ¨™é¡Œï¼å³è¿”å›ï¼‰ */
  .toolbar{
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center; margin-bottom:6px
  }
  .tool-left{justify-self:start}
  .tool-right{justify-self:end}
  .tool-btn{background:none;border:0;font-size:18px;line-height:1;padding:2px 6px}
  .title{font-family:"æ¨™æ¥·é«”",serif;text-align:center;font-weight:700;margin:0}

  /* ç•¶æ—¥ç•¶ç­ï¼šå–®ç¨ä¸€è¡Œã€è¦–è¦ºå…§ç¸®åˆ°è¼¸å…¥åˆ—å·¦é‚Šç•Œ */
  .ds-line{font-weight:700;margin:8px 0 10px 0; padding-left:var(--labelw);}

  /* è¡¨å–®åˆ—ï¼šå…©æ¬„ Gridï¼ˆå·¦å›ºå®šã€å³å½ˆæ€§ï¼‰ */
  .row{display:grid;grid-template-columns:var(--labelw) 1fr;align-items:center;column-gap:10px;margin:6px 0}
  .label{font-family:"æ¨™æ¥·é«”",serif;text-align:center}
  .ctrl{width:100%}
  .ctrl input,.ctrl select,.ctrl textarea{width:100%;box-sizing:border-box;padding:7px;border:1px solid #ccc;border-radius:6px;font-family:"Comic Sans MS",sans-serif}
  .row.lot-type .ctrl{display:grid;grid-template-columns:25% 1fr;column-gap:8px}
  .row.lot-type select{min-width:80px}
  textarea[readonly]{background:#f2f2f2;color:#555}

  .submit{display:flex;justify-content:flex-end;margin-top:10px}
  .btn{background:#0a66ff;color:#fff;border:0;border-radius:8px;padding:10px 18px}

  hr{margin:10px 0}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-top:1px solid #ddd;text-align:center;padding:6px 4px}

  /* åº•éƒ¨è³‡è¨Šåˆ—ï¼šå·¦=ç‰ˆæœ¬ã€ä¸­=æ™‚é–“ã€å³ç•™ç™½ */
  .bottom-info{display:grid;grid-template-columns:1fr 1fr 1fr;align-items:center;margin:6px 0}
  .ver-left{justify-self:start;font-size:12px;color:#666}
  .time-center{justify-self:center;font-size:12px;color:#333}
</style>
</head>
<body>
<div class="wrap">
  <!-- é ‚åˆ—ï¼šå·¦èªè¨€ / ä¸­æ¨™é¡Œ / å³è¿”å› -->
  <div class="toolbar">
    <div class="tool-left"><button class="tool-btn" id="langBtn" title="èªè¨€">ğŸŒ</button></div>
    <h1 class="title">RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</h1>
    <div class="tool-right"><button class="tool-btn" id="backBtn" title="è¿”å›" onclick="history.back()">â†©ï¸</button></div>
  </div>

  <!-- ç•¶æ—¥ç•¶ç­ï¼ˆå–®ç¨ä¸€è¡Œã€å…§ç¸®å°é½Šè¼¸å…¥åˆ—ï¼‰ -->
  <div id="dsView" class="ds-line"></div>

  <!-- è¡¨å–®å€ -->
  <div class="row">
    <div class="label">æª¢é©—å“¡ï¼š</div>
    <div class="ctrl"><input id="inspector" maxlength="5" placeholder="è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ"></div>
  </div>

  <div class="row">
    <div class="label">æ–™ã€€è™Ÿï¼š</div>
    <div class="ctrl"><input id="partNo" maxlength="7" placeholder="è«‹è¼¸å…¥ æ–™è™Ÿ by 7ç¢¼"></div>
  </div>

  <div class="row lot-type">
    <div class="label">å‹ã€€æ…‹ï¼š</div>
    <div class="ctrl">
      <select id="lotPrefix">
        <option value=""></option>
        <option value="FA">FA</option>
      </select>
      <div></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ‰¹ã€€è™Ÿï¼š</div>
    <div class="ctrl"><input id="lotInput" placeholder="æ¯æ‰¹[-å­æ‰¹]ï¼ˆæ¯æ‰¹3ç¢¼è‹±æ•¸ç¦ O/Iï¼‰"></div>
  </div>

  <div class="row">
    <div class="label">æ•¸ã€€é‡ï¼š</div>
    <div class="ctrl"><input id="qty" type="number" min="1" placeholder="è¼¸å…¥æ‰¹é‡"></div>
  </div>

  <div class="row">
    <div class="label">å‚™ã€€è¨»ï¼š</div>
    <div class="ctrl"><textarea id="remark" readonly>ç›®å‰ä¸é–‹æ”¾è¼¸å…¥</textarea></div>
  </div>

  <div class="submit"><button id="sendBtn" class="btn">é€å‡º</button></div>

  <hr>

  <!-- åº•éƒ¨è³‡è¨Šåˆ—ï¼šå·¦=ç‰ˆæœ¬è™Ÿ(é å·¦)ï¼›ä¸­=å³æ™‚æ™‚é–“(ç½®ä¸­)ï¼›å³ç•™ç™½ -->
  <div class="bottom-info">
    <div id="versionTag" class="ver-left">ç‰ˆæœ¬ï¼šv17.4+</div>
    <div id="tsView" class="time-center"></div>
    <div></div>
  </div>

  <!-- æ¸…å–®ï¼ˆå€’åºï¼Œæœ€å¤š50ç­†ï¼‰ -->
  <table>
    <thead><tr><th>æ–™ã€€è™Ÿ</th><th>æ‰¹ã€€è™Ÿ</th><th>æ•¸ã€€é‡</th></tr></thead>
    <tbody id="recordList"></tbody>
  </table>
</div>

<script>
/* === å¸¸æ•¸èˆ‡å·¥å…·ï¼ˆLOCKEDï¼‰ === */
const GAS_URL="https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const API_TOKEN="MY_SECRET_123";
const INSPECTOR_KEY="inspector_id";
function fw2hw(s){return String(s||"").replace(/[\uFF01-\uFF5E]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0)).replace(/\u3000/g," ")}
function CANON(s){return fw2hw(s).trim().toUpperCase()}
function normLotKey(s){return CANON(s).replace(/^FA-/, "")}
function buildKey(date,shift,part,lotDisp){return `${CANON(date)}|${CANON(shift)}|${CANON(part)}|${normLotKey(lotDisp)}`}

function twNowStr(){return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).format(new Date())}
function mdOf(d){return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',month:'2-digit',day:'2-digit'}).format(d)}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}

/* === v17.4ï¼šç­åˆ¥è¦å‰‡ 00:40 / 08:40 / 16:40ï¼›é é¢åˆ·æ–°æ™‚è¨ˆç®—ä¸€æ¬¡ === */
function computeShiftByClock(){
  const now = new Date();
  const tzNow = new Date(now.toLocaleString('en-US',{timeZone:'Asia/Taipei'}));
  const h = tzNow.getHours(), m = tzNow.getMinutes();
  const mins = h*60+m;
  let dateMD, shift;
  if (mins >= 40 && mins < 520) { dateMD = mdOf(tzNow); shift = 'C'; }
  else if (mins >= 520 && mins < 1000) { dateMD = mdOf(tzNow); shift = 'A'; }
  else if (mins >= 1000) { dateMD = mdOf(tzNow); shift = 'B'; }
  else { dateMD = mdOf(addDays(tzNow,-1)); shift = 'B'; } // 00:00-00:39 ç®—å‰ä¸€æ—¥ B
  return { dateMD, shift };
}
let currentDS = computeShiftByClock();
document.getElementById('dsView').textContent = `${currentDS.dateMD} - ${currentDS.shift}`;

/* === å·¥è™Ÿå¸¸é§ & è‰ç¨¿ï¼ˆä¾ç•¶å‰ DSï¼‰ === */
function saveInspector(){const v=CANON(document.getElementById('inspector').value); if(/^[A-Z0-9]{5}$/.test(v)) localStorage.setItem(INSPECTOR_KEY,v)}
function loadInspector(){const v=localStorage.getItem(INSPECTOR_KEY)||''; if(v) document.getElementById('inspector').value=v}
const DSK='rt_draft_ds', DP='rt_draft_';
function dsKey(){return `${currentDS.dateMD}|${currentDS.shift}`}
function draftKey(){return DP+dsKey()}
function saveDraft(){
  const d={part:partNo.value, lot:lotInput.value, qty:qty.value, prefix:lotPrefix.value};
  localStorage.setItem(draftKey(),JSON.stringify(d)); localStorage.setItem(DSK,dsKey());
}
function loadDraft(){
  loadInspector();
  const last=localStorage.getItem(DSK)||''; if(last && last!==dsKey()) localStorage.removeItem(DP+last);
  const raw=localStorage.getItem(draftKey()); if(!raw) return; const d=JSON.parse(raw);
  partNo.value=d.part||''; lotInput.value=d.lot||''; qty.value=d.qty||''; lotPrefix.value=d.prefix||'';
}
const inspector=document.getElementById('inspector');
const partNo=document.getElementById('partNo');
const lotPrefix=document.getElementById('lotPrefix');
const lotInput=document.getElementById('lotInput');
const qty=document.getElementById('qty');
['inspector','partNo','lotInput','lotPrefix','qty'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{if(id==='inspector')saveInspector(); else saveDraft();})
});
loadDraft();

/* === å‰ç«¯è£œé›¶ï¼šblur èˆ‡é€å‡ºå‰éƒ½æœƒæ­£è¦åŒ– === */
function normalizeLotInputText(txt){
  txt = CANON(txt);
  let mother='', child='';
  const parts = txt.split('-');
  mother = parts[0] || '';
  child  = parts[1] || '';

  // ç¦ O/Iï¼ˆæ¯æ‰¹ï¼‰
  if (/[OI]/.test(mother)) return null;

  // è£œé›¶
  if (mother) mother = mother.padStart(3,'0');
  if (child)  child  = child.padStart(2,'0');

  return child ? `${mother}-${child}` : mother;
}
lotInput.addEventListener('blur', ()=>{
  const v = normalizeLotInputText(lotInput.value);
  if (v===null) { alert('æ¯æ‰¹ä¸å¯å« O / I'); lotInput.focus(); return; }
  if (v!==undefined && v!==null) { lotInput.value = v; saveDraft(); }
});

/* === åº•éƒ¨æ™‚é–“ï¼šæ¯ç§’æ›´æ–°ï¼ˆå°åŒ—ï¼‰ === */
function tick(){ document.getElementById('tsView').textContent = twNowStr(); }
setInterval(tick,1000); tick();

/* === æ¸…å–® === */
async function refreshList(){
  const tb=document.getElementById('recordList'); tb.innerHTML='';
  try{
    const r=await fetch(GAS_URL); const data=await r.json();
    const rows=(Array.isArray(data)?data:[]).filter(x=>x.deleted===true);
    rows.sort((a,b)=>String(b.submitted_at||'').localeCompare(String(a.submitted_at||'')));
    for(const x of rows.slice(0,50)){
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.part_no||''}</td><td>${x.lot||''}</td><td>${x.qty||''}</td>`; tb.appendChild(tr)
    }
  }catch(e){console.error(e)}
}
refreshList();

/* === é€å‡º === */
let clearPartOnce=false;
partNo.addEventListener('focus',()=>{ if(clearPartOnce){ partNo.value=''; clearPartOnce=false; saveDraft(); } });

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const inspectorVal=CANON(inspector.value);
  const part=CANON(partNo.value);
  const prefix=CANON(lotPrefix.value);

  // å…ˆåšè£œé›¶æ­£è¦åŒ–
  const lotNorm = normalizeLotInputText(lotInput.value);
  if (lotNorm===null) return alert('æ¯æ‰¹ä¸å¯å« O / I');
  if (!lotNorm) return alert('æ‰¹è™Ÿå¿…å¡«');
  lotInput.value = lotNorm; // å›å¯«é¡¯ç¤º
  const lotDisp = prefix ? `${prefix}-${lotNorm}` : lotNorm;

  const q=Number(qty.value);

  if(!/^[A-Z0-9]{5}$/.test(inspectorVal)) return alert('è«‹è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ');
  if(!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(part)) return alert('æ–™è™Ÿæ ¼å¼éŒ¯èª¤ï¼ˆå¦‚ A58K052ï¼‰');
  if(!(q>0)) return alert('æ•¸é‡éœ€ > 0');

  const key = buildKey(currentDS.dateMD, currentDS.shift, part, lotDisp);
  const payload={
    token:API_TOKEN,
    key,
    date:currentDS.dateMD, shift:currentDS.shift,
    part_no:part,
    lot_prefix:prefix, mother_child:lotNorm,
    qty:String(q),
    inspector:inspectorVal,
    remark:""
  };

  const btn=document.getElementById('sendBtn'); btn.disabled=true;
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
    const data=await res.json();
    if(data.status==='ok'){
      alert(data.upsert==='update'?'âœ… å·²æ›´æ–°':'âœ… å·²æ–°å¢');
      lotInput.value=''; qty.value=''; saveDraft();
      clearPartOnce=true;
      refreshList();
    }else{
      alert('âŒ å¾Œç«¯ï¼š'+JSON.stringify(data));
    }
  }catch(err){ alert('é€å‡ºéŒ¯èª¤ï¼š'+err.message); }
  finally{ btn.disabled=false; }
});

/* èªè¨€éˆå­ï¼ˆä¿ç•™ï¼Œä¸å¯¦ä½œåˆ‡æ›ï¼‰ */
document.getElementById('langBtn').addEventListener('click',()=>alert('å¤šåœ‹èªè¨€é ç•™ï¼šæœªå•Ÿç”¨'));
</script>
</body>
</html>