<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RT 外觀抽驗記錄表</title>
<style>
  :root{--maxw:520px; --labelw:92px;}
  body{margin:0;background:#f5f5f5;font-family:"Comic Sans MS",sans-serif}
  .wrap{max-width:var(--maxw);margin:8px auto;padding:10px 14px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .toolbar{display:grid;grid-template-columns:36px auto 36px;align-items:center;margin-bottom:6px}
  .tool-left{justify-self:start}
  .tool-right{justify-self:end}
  .tool-btn{background:none;border:0;font-size:18px;line-height:1;padding:2px 6px;cursor:pointer}
  .title{font-family:"標楷體",serif;text-align:center;font-weight:700;margin:0;font-size:1.4rem}
  @media (max-width: 400px){ .title{font-size:1.2rem} }

  .ds-line{font-weight:700;margin:8px 0 10px 0; padding-left:20px;}

  .row{display:grid;grid-template-columns:var(--labelw) 1fr;align-items:center;column-gap:10px;margin:6px 0}
  .label{font-family:"標楷體",serif;text-align:center}
  .ctrl{width:100%}
  .ctrl input,.ctrl select{width:100%;box-sizing:border-box;padding:7px;border:1px solid #ccc;border-radius:6px;font-family:"Comic Sans MS",sans-serif}
  .row.lot-type .ctrl{display:grid;grid-template-columns:25% 1fr;column-gap:8px}
  .row.lot-type select{min-width:80px}

  .field-error{display:none;color:#d93025;font-weight:700;font-size:13px;margin-top:4px}
  .input-error{ border-color:#d93025 !important; }

  .submit{position:relative;display:flex;justify-content:flex-end;align-items:center;margin-top:10px}
  .submit-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:12px}
  .btn{background:#0a66ff;color:#fff;border:0;border-radius:8px;padding:10px 18px;cursor:pointer}

  .ok-msg{display:none;color:#1a7f37;font-weight:700;font-size:13px}
  .ok-msg.show{display:block;opacity:1;transition:opacity .4s}
  .ok-msg.fade{opacity:0}

  hr{margin:10px 0}
  .post{width:95%;margin:0 auto}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-top:1px solid #ddd;text-align:center;padding:6px 4px}
  .bottom-info{display:grid;grid-template-columns:1fr 1fr;align-items:center;margin:6px 0}
  .ver-left{justify-self:start;font-size:12px;color:#666}
  .time-right{justify-self:end;font-size:12px;color:#333;text-align:right}

  .tr-strike td{ color:#999; text-decoration: line-through; }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="tool-left"><button class="tool-btn" id="langBtn" title="語言">🌐</button></div>
    <h1 class="title">RT 外觀抽驗記錄表</h1>
    <div class="tool-right"><button class="tool-btn" id="backBtn" title="返回" onclick="location.href='index.html'">↩️</button></div>
  </div>

  <div id="dsView" class="ds-line"></div>

  <div class="row">
    <div class="label">檢　驗：</div>
    <div class="ctrl">
      <input id="inspector" maxlength="5" placeholder="輸入 5 碼工號">
      <div id="inspectorError" class="field-error"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">料　號：</div>
    <div class="ctrl">
      <input id="partNo" maxlength="7" placeholder="輸入 7碼料號">
      <div id="partError" class="field-error"></div>
    </div>
  </div>

  <div class="row lot-type">
    <div class="label">型　態：</div>
    <div class="ctrl">
      <select id="lotPrefix">
        <option value=""></option>
        <option value="FA">FA</option>
      </select>
      <div></div>
    </div>
  </div>

  <div class="row">
    <div class="label">批　號：</div>
    <div class="ctrl">
      <input id="lotInput" placeholder="母批(3碼) or 母批-子批(3-2)；禁 I / O">
      <div id="lotError" class="field-error"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">數　量：</div>
    <div class="ctrl"><input id="qty" type="number" min="1" placeholder="輸入 批量"></div>
  </div>

  <div class="submit" id="submit-row">
    <div class="submit-center">
      <div id="okMsg" class="ok-msg"></div>
    </div>
    <button id="sendBtn" class="btn">送出</button>
  </div>

  <hr>

  <div class="post">
    <div class="bottom-info">
      <div id="versionTag" class="ver-left">版本：v17.8.2</div>
      <div id="tsView" class="time-right"></div>
    </div>
    <table>
      <thead><tr><th>料　號</th><th>批　號</th><th>數　量</th></tr></thead>
      <tbody id="recordList"></tbody>
    </table>
  </div>
</div>

<script>
/* ===== 常數 ===== */
const FORM_VERSION="v17.8.2";
const API_BASE="https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";

/* ===== 工具 ===== */
const $=s=>document.querySelector(s);
function fw2hw(s){return String(s||"").replace(/[\uFF01-\uFF5E]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0)).replace(/\u3000/g," ")}
function CANON(s){return fw2hw(s).trim().toUpperCase()}
function twNowStr(){return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).format(new Date())}
function mdOf(d){return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',month:'2-digit',day:'2-digit'}).format(d)}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}

/* ===== API 單一入口 ===== */
function apiGet(paramsObj){
  const params=new URLSearchParams();
  Object.entries(paramsObj).forEach(([k,v])=>{ if(v!==undefined&&v!==null) params.append(k,String(v)); });
  params.append("t",Date.now());
  const url=`${API_BASE}?${params.toString()}`;
  return fetch(url,{method:"GET",mode:"cors",cache:"no-store"}).then(r=>r.json());
}
function submitData(p){ return apiGet({action:"submit",date:p.date,shift:p.shift,part_no:p.part_no,lot:p.lot,qty:p.qty,inspector:p.inspector,remark:""}); }
function ping(){ return apiGet({action:"ping"}); }

/* ===== 班別錨定（0040/0840/1640）===== */
function computeShiftByClock(){
  const tzNow=new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Taipei'}));
  const h=tzNow.getHours(), m=tzNow.getMinutes(), mins=h*60+m;
  let dateMD,shift;
  if(mins>=40 && mins<520){ dateMD=mdOf(addDays(tzNow,-1)); shift='C'; }
  else if(mins>=520 && mins<1000){ dateMD=mdOf(tzNow); shift='A'; }
  else if(mins>=1000){ dateMD=mdOf(tzNow); shift='B'; }
  else { dateMD=mdOf(addDays(tzNow,-1)); shift='B'; }
  return {dateMD,shift};
}
let currentDS=computeShiftByClock();
$('#dsView').textContent=`${currentDS.dateMD} - ${currentDS.shift}`;
function ymdFromCurrentDS(){ const [mm,dd]=currentDS.dateMD.split('/'); const y=new Date().toLocaleString('en-US',{timeZone:'Asia/Taipei',year:'numeric'}); return `${y}/${mm}/${dd}`; }

/* ===== 即時時鐘 ===== */
function tick(){ $('#tsView').textContent=twNowStr(); }
setInterval(tick,1000); tick();

/* ===== DOM ===== */
const inspector=$('#inspector'), inspectorError=$('#inspectorError');
const partNo=$('#partNo'), partError=$('#partError');
const lotPrefix=$('#lotPrefix'), lotInput=$('#lotInput'), lotError=$('#lotError');
const qty=$('#qty'), okMsg=$('#okMsg');

/* ===== 欄位驗證集中 ===== */
function setFieldError(inputEl,hintEl,msg){
  if(!inputEl||!hintEl) return;
  if(msg){ inputEl.classList.add('input-error'); hintEl.textContent=msg; hintEl.style.display='block'; }
  else { inputEl.classList.remove('input-error'); hintEl.textContent=''; hintEl.style.display='none'; }
}
inspector.addEventListener('input',()=> setFieldError(inspector,inspectorError,''));
inspector.addEventListener('blur',()=>{
  const v=CANON(inspector.value);
  if(!v) return setFieldError(inspector,inspectorError,'工號必填');
  if(!/^[A-Z0-9]{5}$/.test(v)) return setFieldError(inspector,inspectorError,'需 5 碼英數');
  setFieldError(inspector,inspectorError,'');
});
partNo.addEventListener('input',()=> setFieldError(partNo,partError,''));
partNo.addEventListener('blur',()=>{
  const p=CANON(partNo.value);
  if(!p) return setFieldError(partNo,partError,'料號必填');
  if(!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(p)) return setFieldError(partNo,partError,'格式錯誤（如 A58K052）');
  setFieldError(partNo,partError,'');
});
function parseLot(input){
  const s=CANON(input).replace(/\s+/g,'');
  if(!s) return {ok:false,msg:'母批必填（3碼）'};
  if(s.includes('-')){
    const [m,cRaw]=s.split('-',2);
    if(!m || !/^[A-HJ-NP-Z0-9]{3}$/.test(m)) return {ok:false,msg:'母批需正好 3 碼，且不可含 I / O'};
    if(!cRaw) return {ok:false,msg:'有連字號時必須輸入子批（1~2 碼）'};
    if(!/^[0-9]{1,2}$/.test(cRaw)) return {ok:false,msg:'子批需 1~2 位數字'};
    return {ok:true,mother:m,child:cRaw.padStart(2,'0'),hasChild:true};
  }else{
    const m=s;
    if(!/^[A-HJ-NP-Z0-9]{3}$/.test(m)) return {ok:false,msg:'母批需正好 3 碼，且不可含 I / O'};
    return {ok:true,mother:m,child:'',hasChild:false};
  }
}
lotInput.addEventListener('input',()=> setFieldError(lotInput,lotError,''));
lotInput.addEventListener('blur',()=>{
  const r=parseLot(lotInput.value);
  if(!r.ok) return setFieldError(lotInput,lotError,r.msg);
  setFieldError(lotInput,lotError,'');
  lotInput.value=r.mother+(r.hasChild?('-'+r.child):'');
});

/* ===== 草稿（當班清單：只存當班；不做舊版遷移） ===== */
const LIST_NS='rt_draft_list_v2_key2';
function listDsKey(){ return `${currentDS.dateMD}|${currentDS.shift}` }
function listKey(){ return `${LIST_NS}:${listDsKey()}` }
function listGet(){ try{ return JSON.parse(localStorage.getItem(listKey())||'[]'); }catch{return []} }
function listSet(arr){ localStorage.setItem(listKey(), JSON.stringify(arr.slice(0,50))); localStorage.setItem(`${LIST_NS}:LAST_DS`, listDsKey()); }
function renderDraftList(){
  const tb=$('#recordList'); tb.innerHTML='';
  const rows=listGet();
  if(!rows.length){ tb.innerHTML=`<tr><td colspan="3" style="color:#888">（當班無草稿）</td></tr>`; return; }
  rows.forEach(x=>{
    const tr=document.createElement('tr');
    if(x.strike) tr.classList.add('tr-strike');
    tr.innerHTML=`<td>${x.part_no||''}</td><td>${x.lot||''}</td><td>${x.qty||''}</td>`;
    tb.appendChild(tr);
  });
}
renderDraftList();
function upsertDraftListK2({part_no,lot,qty,key2}){
  const arr=listGet();
  const idx=arr.findIndex(x=>String(x.key2||'').toUpperCase()===String(key2||'').toUpperCase());
  const item={part_no,lot,qty,key2,strike:false,ts:new Date().toISOString()};
  if(idx>=0) arr[idx]=item; else arr.unshift(item);
  listSet(arr); renderDraftList();
}

/* ===== 中央浮層 / 成功訊息 ===== */
function ensureCenterBox(){
  let box=$("#center-status");
  if(!box){
    box=document.createElement("div");
    box.id="center-status";
    box.style.cssText=`position:fixed;left:50%;top:40%;transform:translate(-50%,-50%);z-index:9999;background:rgba(0,0,0,.7);color:#fff;padding:10px 16px;border-radius:10px;font-size:16px;display:none;`;
    document.body.appendChild(box);
  }
  return box;
}
function showCenter(text){ const b=ensureCenterBox(); b.textContent=text; b.style.display='block'; }
function hideCenter(){ const b=$("#center-status"); if(b) b.style.display='none'; }
let okTimer=null;
function showOk(msg){
  if(okTimer){clearTimeout(okTimer);okTimer=null;}
  okMsg.textContent=msg||''; okMsg.classList.add('show'); okMsg.classList.remove('fade');
  okTimer=setTimeout(()=>{ okMsg.classList.add('fade'); },4600);
  setTimeout(()=>{ okMsg.classList.remove('show','fade'); okMsg.textContent=''; },5000);
}

/* ===== 送出 ===== */
function buildLotDisp(prefix,motherChild){ return prefix ? `${prefix}-${motherChild}` : motherChild; }
function buildKey2(dateMD,shift,part,lotDisp,qty,deletedTrue){ const sFlag=deletedTrue?'T':'F'; return `${dateMD}|${shift}|${part}|${lotDisp}|${qty}|${sFlag}` }

let clearPartOnce=false;
partNo.addEventListener('focus',()=>{ if(clearPartOnce){ partNo.value=''; clearPartOnce=false; } });

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const inspectorVal=CANON(inspector.value);
  const part=CANON(partNo.value);
  const prefix=CANON(lotPrefix.value);

  if(!/^[A-Z0-9]{5}$/.test(inspectorVal)){ setFieldError(inspector,inspectorError,'需 5 碼英數'); inspector.focus(); return; }
  setFieldError(inspector,inspectorError,'');

  if(!part){ setFieldError(partNo,partError,'料號必填'); partNo.focus(); return; }
  if(!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(part)){ setFieldError(partNo,partError,'格式錯誤（如 A58K052）'); partNo.focus(); return; }
  setFieldError(partNo,partError,'');

  const r=parseLot(lotInput.value);
  if(!r.ok){ setFieldError(lotInput,lotError,r.msg); lotInput.focus(); return; }
  setFieldError(lotInput,lotError,'');
  const motherChild=r.mother+(r.hasChild?('-'+r.child):'');
  lotInput.value=motherChild;

  const q=Number(qty.value);
  if(!(q>0)){ alert('數量需 > 0'); return; }

  const lotDisp=buildLotDisp(prefix,motherChild);
  const ymd=ymdFromCurrentDS();
  const key2=buildKey2(currentDS.dateMD,currentDS.shift,part,lotDisp,String(q),true);

  const payload={date:ymd,shift:currentDS.shift,part_no:part,lot:lotDisp,qty:String(q),inspector:inspectorVal};

  const btn=$('#sendBtn'); btn.disabled=true; showCenter('資料傳送中…');
  try{
    const data=await submitData(payload);
    if(data.status!=='ok'){
      hideCenter(); showCenter('❌ 後端：'+(data.msg||'unknown')); setTimeout(hideCenter,1500); return;
    }
    hideCenter(); showOk(data.mode==='update'?'✅ 已更新':'✅ 已新增');
    upsertDraftListK2({part_no:part,lot:lotDisp,qty:String(q),key2});
    lotInput.value=''; qty.value=''; clearPartOnce=true;
  }catch(err){
    hideCenter(); showCenter('❌ 連線失敗：'+String(err)); setTimeout(hideCenter,1500);
  }finally{
    btn.disabled=false;
  }
});

/* ===== 初始化 ===== */
$('#versionTag').textContent=`版本：${FORM_VERSION}`;
function tickDs(){ /* 保持顯示用，不重算當班錨定 */ $('#dsView').textContent=`${currentDS.dateMD} - ${currentDS.shift}`; }
tickDs();
</script>
</body>
</html>