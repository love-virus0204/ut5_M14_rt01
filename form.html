<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RT 外觀抽驗記錄表</title>
<style>
:root{--maxw:520px;--labelw:92px;}
body{margin:0;background:#f5f5f5;font-family:"Comic Sans MS",sans-serif}
.wrap{max-width:var(--maxw);margin:8px auto;padding:10px 14px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.toolbar{display:grid;grid-template-columns:36px auto 36px;align-items:center;margin-bottom:6px}
.tool-left{justify-self:start}
.tool-right{justify-self:end}
.tool-btn{background:none;border:0;font-size:18px;line-height:1;padding:2px 6px;cursor:pointer}
.title{font-family:"標楷體",serif;text-align:center;font-weight:700;margin:0;font-size:1.35rem}
@media(max-width:400px){.title{font-size:1.18rem}}
.ds-line{font-weight:700;margin:8px 0 10px 0;padding-left:20px;}
.row{display:grid;grid-template-columns:var(--labelw) 1fr;align-items:center;column-gap:10px;margin:6px 0}
.label{font-family:"標楷體",serif;text-align:center}
.ctrl{width:100%}
.ctrl input,.ctrl select{width:100%;box-sizing:border-box;padding:7px;border:1px solid #ccc;border-radius:10px;background:#fff;font-size:16px}
.ctrl input::placeholder{color:#b9b9b9}
.submit-wrap{display:flex;justify-content:center;margin-top:8px}
.btn{border:0;background:#0a57ff;color:#fff;padding:10px 16px;border-radius:10px;font-weight:700;letter-spacing:.3em}
.btn:active{transform:translateY(1px)}
.note{font-size:12px;color:#666;margin:10px 2px}
.bar{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#666;margin:8px 2px}
table{width:100%;border-collapse:collapse;margin-top:6px}
th,td{border-bottom:1px solid #eee;padding:10px 6px;text-align:center}
th{font-weight:800}
.none{color:#9aa0a6}
.strike{text-decoration:line-through;color:#999}
.ver{font-size:11px;color:#777}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="tool-left"><button class="tool-btn" id="btnMenu">☰</button></div>
    <h1 class="title">RT 外觀抽驗記錄表</h1>
    <div class="tool-right"><span class="ver" id="ver">v17.10.10</span></div>
  </div>

  <div class="ds-line" id="ds">09/21 - B</div>

  <div class="row">
    <div class="label">檢 驗 員</div>
    <div class="ctrl"><input id="inspector" placeholder="請輸入檢驗員" autocomplete="off"></div>
  </div>

  <div class="row">
    <div class="label">料　　號</div>
    <div class="ctrl">
      <input id="part_no" placeholder="A58K033 / A58K033-M 子批" autocomplete="off">
      <div class="note">提示：母、子批一致時只輸入一次；不同時用<strong>母/子</strong> 兩欄。</div>
    </div>
  </div>

  <div class="row">
    <div class="label">型　　態</div>
    <div class="ctrl">
      <select id="model">
        <option value="" selected>請選擇</option>
        <option value="OK">OK</option>
        <option value="NG">NG</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="label">批　　號</div>
    <div class="ctrl"><input id="lot" placeholder="批號" autocomplete="off"></div>
  </div>

  <div class="row">
    <div class="label">數　　量</div>
    <div class="ctrl"><input id="qty" placeholder="正整數" inputmode="numeric" autocomplete="off"></div>
  </div>

  <div class="submit-wrap"><button class="btn" id="btnSend">送出</button></div>

  <div class="bar"><span id="srv">伺服器：—</span><span id="now">—</span></div>

  <table>
    <thead><tr><th>料　號</th><th>批　號</th><th>數　量</th></tr></thead>
    <tbody id="list"><tr><td class="none" colspan="3">(當班無草稿)</td></tr></tbody>
  </table>

<script>
/* ===== 版本與 API ===== */
const FORM_VERSION="v17.10.10";
const API_URL="https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec";

/* ===== 草稿 B（維持結構；成功後寫五欄並以 time 降冪） ===== */
const K_B="rt_draft_B";
function renderB(){
  const arr=JSON.parse(localStorage.getItem(K_B)||"[]");
  if(!arr.length){
    document.getElementById("list").innerHTML=`<tr><td class="none" colspan="3">(當班無草稿)</td></tr>`;
    return;
  }
  const html=arr.slice().sort((a,b)=>String(b.time||"").localeCompare(String(a.time||""))).map(r=>{
    // 只用字色或樣式請自行既有 CSS；此處不改 class
    return `<tr><td>${r.part_no||""}</td><td>${r.lot||""}</td><td>${r.qty||""}</td></tr>`;
  }).join("");
  document.getElementById("list").innerHTML=html;
}

/* ===== 送出：分送 date/shift，來源只讀現有顯示，不新增計算 ===== */
document.getElementById("btnSend").addEventListener("click", async()=>{
  const inspector=document.getElementById("inspector").value.trim();
  const part=document.getElementById("part_no").value.trim();
  const lot=document.getElementById("lot").value.trim();
  const qty=document.getElementById("qty").value.trim();

  // 從現有顯示取「當日當班」，格式假定沿用：MM/DD - X
  const dsText=(document.getElementById("ds")?.textContent||"").trim(); // 例：09/21 - B
  let dsDate="", dsShift="";
  // 嚴禁新邏輯：只做字串拆分，不推斷、不換算年分
  const m = dsText.match(/^(\d{2}\/\d{2})\s*-\s*([ABC])$/i);
  if(m){ dsDate=m[1]; dsShift=m[2].toUpperCase(); }

  // 原本仍送出 date_shift（保持相容），另外分送 date/shift
  const u=new URL(API_URL);
  u.searchParams.set("action","submit");
  u.searchParams.set("date_shift", dsDate && dsShift ? `${dsDate}|${dsShift}` : ""); // 保留原參數
  u.searchParams.set("date",  dsDate); // 新增，僅傳現有顯示值
  u.searchParams.set("shift", dsShift); // 新增，僅傳現有顯示值
  u.searchParams.set("inspector",inspector);
  u.searchParams.set("part_no",part);
  u.searchParams.set("lot",lot);
  u.searchParams.set("qty",qty);

  try{
    const r=await fetch(u.toString(),{method:"GET",cache:"no-store"});
    const j=await r.json();

    if(j.status==="ok"){
      // 只在成功時寫入草稿B：{part_no, lot, qty, time, status}
      const status=(j.mode==="update"||j.updated===true)?"updated":"inserted";
      const arr=JSON.parse(localStorage.getItem(K_B)||"[]");
      arr.push({part_no:part, lot:lot, qty:qty, time:new Date().toISOString(), status});
      arr.sort((a,b)=>String(b.time||"").localeCompare(String(a.time||"")));
      localStorage.setItem(K_B,JSON.stringify(arr));
      renderB();

      // 成功後：保留料號/檢驗員；僅清批號/數量；型態下拉回預設
      document.getElementById("lot").value="";
      document.getElementById("qty").value="";
      const sel=document.getElementById("model"); if(sel) sel.selectedIndex=0;
    }else{
      alert("送出失敗");
    }
  }catch(e){
    alert("連線錯誤");
  }
});

/* ===== 初始化渲染（不動你既有的時間顯示機制） ===== */
document.addEventListener("DOMContentLoaded",renderB);
</script>
</div>
</body>
</html>