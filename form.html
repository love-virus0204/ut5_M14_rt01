<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RT 外觀抽驗記錄表</title>
  <style>
    body { font-family: "Comic Sans MS", sans-serif; padding: 10px; }
    h1 { font-family: "標楷體"; text-align: center; }
    label { display: flex; justify-content: space-between; margin: 5px 0; font-family: "標楷體"; }
    input, select { width: 60%; font-family: "Comic Sans MS"; }
    textarea { width: 100%; font-family: "標楷體"; }
    .btn-container { text-align: right; margin-top: 10px; }
    button { padding: 8px 16px; font-size: 16px; }
    hr { margin-top: 15px; }
    .records { font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>RT 外觀抽驗記錄表</h1>

  <form id="recordForm">
    <!-- 顯示時間戳記 & 當日班別 -->
    <label>
      <span id="timestamp"></span>
      <span id="dateShift"></span>
    </label>

    <!-- 抽驗者 -->
    <label>抽驗者：
      <input type="text" id="inspector" placeholder="請輸入工號">
    </label>

    <!-- 料號 -->
    <label>料　號：
      <input type="text" id="partNo" placeholder="請輸入料號 by 7碼">
    </label>

    <!-- 批號 -->
    <label>批　號：</label>
    <div style="display:flex; gap:5px;">
      <select id="lotPrefix">
        <option value="">　</option>
        <option value="FA">FA</option>
        <option value="CM">CM</option>
        <option value="LN">LN</option>
      </select>
      <input type="text" id="lotMid" maxlength="3" placeholder="母批">
      <input type="text" id="lotTail" maxlength="2" placeholder="子批">
    </div>

    <!-- 數量 -->
    <label>數　量：
      <input type="number" id="qty" min="0">
    </label>

    <!-- 備註 (唯讀) -->
    <label>備　註：</label>
    <textarea id="remark" readonly></textarea>

    <!-- 送出按鈕 -->
    <div class="btn-container">
      <button type="submit">送出</button>
    </div>
  </form>

  <hr>
  <div class="records" id="recordsList">
    <!-- 已輸入資料將顯示在此 -->
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const API_TOKEN = "MY_SECRET_123"; // 必須與 GAS 端設定一致

// 即時更新時間與班別
function updateTimestamp() {
  const now = new Date();
  const hhmm = now.getHours() * 100 + now.getMinutes();
  let shift = "C";
  if (hhmm >= 840 && hhmm < 1640) shift = "A";
  else if (hhmm >= 1640 || hhmm < 40) shift = "B";
  document.getElementById("timestamp").textContent = now.toLocaleString("zh-TW");
  document.getElementById("dateShift").textContent = 
    `${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} - ${shift}`;
}
setInterval(updateTimestamp, 60000);
updateTimestamp();

// 載入最新資料
async function loadRecords() {
  try {
    const res = await fetch(`${GAS_URL}?limit=50`);
    const data = await res.json();
    const container = document.getElementById("recordsList");
    container.innerHTML = data.length === 0 ? "<i>目前無資料</i>" : "";
    data.forEach(r => {
      const div = document.createElement("div");
      div.textContent = `${r.date_shift} | ${r.inspector} | ${r.part_no} | ${r.lot_full} | 數量:${r.qty}`;
      container.appendChild(div);
    });
  } catch (err) {
    console.error("讀取資料失敗", err);
  }
}
loadRecords();

// 送出表單
document.getElementById("recordForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const payload = {
    token: API_TOKEN,
    ts: new Date().toISOString(),
    date_shift: document.getElementById("dateShift").textContent,
    inspector: document.getElementById("inspector").value,
    part_no: document.getElementById("partNo").value,
    lot_prefix: document.getElementById("lotPrefix").value,
    lot_mid: document.getElementById("lotMid").value,
    lot_tail: document.getElementById("lotTail").value,
    qty: document.getElementById("qty").value,
    remark: "" // 備註目前預設空
  };

  try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.status === "ok") {
      alert("✅ 已成功寫入 Google 試算表！");
      loadRecords();
    } else if (data.error === "conflict_other_inspector") {
      alert("⚠️ 發現不同檢驗者的重複紀錄，請再次確認");
    } else if (data.error === "unauthorized") {
      alert("🚫 驗證失敗，請檢查 token 是否一致");
    } else {
      alert("❌ 發生錯誤：" + JSON.stringify(data));
    }
  } catch (err) {
    alert("網路或伺服器錯誤：" + err);
  }
});
</script>
</body>
</html>