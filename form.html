<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</title>
<style>
  body{font-family:"Comic Sans MS",sans-serif;margin:10px;}
  h1{display:flex;justify-content:space-between;align-items:center;margin:0 0 10px 0}
  h1 span{font-family:"æ¨™æ¥·é«”",serif;font-weight:bold}
  .top-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;margin-bottom:10px}
  .top-left{justify-self:start;font-size:14px}
  .top-center{justify-self:center;font-size:16px;font-weight:bold}
  .row{display:flex;align-items:center;margin-bottom:8px}
  .label{font-family:"æ¨™æ¥·é«”",serif;min-width:72px;text-align:center;margin-right:8px}
  .ctrl{flex:1}
  input,select,textarea{width:100%;padding:6px;font-family:"Comic Sans MS",sans-serif}
  select.narrow{flex:0 0 25%;max-width:160px}  /* å‹æ…‹ä¸‹æ‹‰å›ºå®š 25% */
  textarea[readonly]{background:#f2f2f2;color:#555}
  #sendBtn{display:block;margin-left:auto;margin-top:10px;padding:8px 20px;background:#007bff;color:#fff;border:none;border-radius:6px}
  .version-line{font-size:12px;color:#666;margin-top:6px}
  hr{margin:10px 0 15px 0}
  table{width:100%;border-collapse:collapse;text-align:center;font-size:14px}
  th,td{border-top:1px solid #ddd;padding:6px}
</style>
</head>
<body>
  <h1>
    <span>ğŸŒ</span>
    <span>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</span>
    <button id="backBtn" style="background:none;border:none;font-size:18px">â†©ï¸</button>
  </h1>

  <div class="top-row">
    <div id="tsView" class="top-left"></div>
    <div id="dsView" class="top-center"></div>
    <div></div>
  </div>

  <div class="row">
    <div class="label">æª¢é©—å“¡ï¼š</div>
    <div class="ctrl"><input id="inspector" type="text" placeholder="è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ"/></div>
  </div>

  <div class="row">
    <div class="label">æ–™ã€€è™Ÿï¼š</div>
    <div class="ctrl"><input id="partNo" type="text" placeholder="è«‹è¼¸å…¥ æ–™è™Ÿ by 7ç¢¼"/></div>
  </div>

  <div class="row">
    <div class="label">å‹ã€€æ…‹ï¼š</div>
    <select id="lotPrefix" class="narrow">
      <option value=""></option>
      <option value="FA">FA</option>
    </select>
  </div>

  <div class="row">
    <div class="label">æ‰¹ã€€è™Ÿï¼š</div>
    <div class="ctrl"><input id="lotInput" type="text" placeholder="æ¯æ‰¹[-å­æ‰¹]ï¼ˆæ¯æ‰¹3ç¢¼è‹±æ•¸ç¦ O/Iï¼‰"/></div>
  </div>

  <div class="row">
    <div class="label">æ•¸ã€€é‡ï¼š</div>
    <div class="ctrl"><input id="qty" type="number" placeholder="è¼¸å…¥æ‰¹é‡"/></div>
  </div>

  <div class="row">
    <div class="label">å‚™ã€€è¨»ï¼š</div>
    <div class="ctrl"><textarea id="remark" readonly>ç›®å‰ä¸é–‹æ”¾è¼¸å…¥</textarea></div>
  </div>

  <button id="sendBtn">é€å‡º</button>
  <div class="version-line" id="verLine">valï¼š17.1</div>

  <hr/>
  <table>
    <thead><tr><th>æ–™ã€€è™Ÿ</th><th>æ‰¹ã€€è™Ÿ</th><th>æ•¸ã€€é‡</th></tr></thead>
    <tbody id="recordList"></tbody>
  </table>

<script>
const GAS_URL   = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const API_TOKEN = "MY_SECRET_123";

/* ===== å·¥å…· ===== */
const $ = id => document.getElementById(id);
function fw2hw(s){return String(s||"").replace(/[\uFF01-\uFF5E]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0)).replace(/\u3000/g," ")}
function canon(s){return fw2hw(s).trim().toUpperCase()}
function normLotKey(s){return canon(s).replace(/^FA-/, "")}
function buildKey(date,shift,part,lot){return `${canon(date)}|${canon(shift)}|${canon(part)}|${normLotKey(lot)}`}

/* ===== ç­åˆ¥éŒ¨å®šèˆ‡æ™‚é–“ ===== */
function mdOf(d){return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`}
function computeDS(now){
  const m=now.getHours()*60+now.getMinutes(); let dateMD,shift,next;
  if(m>=520 && m<1000){dateMD=mdOf(now);shift='A';next=new Date(now.getFullYear(),now.getMonth(),now.getDate(),16,40)}
  else if(m>=1000){dateMD=mdOf(now);shift='B';next=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,40)}
  else if(m<40){dateMD=mdOf(new Date(now.getFullYear(),now.getMonth(),now.getDate()-1));shift='B';next=new Date(now.getFullYear(),now.getMonth(),now.getDate(),8,40)}
  else{dateMD=mdOf(new Date(now.getFullYear(),now.getMonth(),now.getDate()-1));shift='C';next=new Date(now.getFullYear(),now.getMonth(),now.getDate(),8,40)}
  return {dateMD,shift,until: next.getTime()+80*60000}
}
function anchorDS(){
  const k='ds_anchor', now=Date.now(); let a; try{a=JSON.parse(localStorage.getItem(k)||'{}')}catch{a={}}
  if(!a.dateMD || now>a.until){const c=computeDS(new Date());a={dateMD:c.dateMD,shift:c.shift,until:c.until};localStorage.setItem(k,JSON.stringify(a))}
  return a;
}
function tick(){
  const n=new Date(), a=anchorDS();
  $('tsView').textContent=n.toLocaleString('zh-TW');
  $('dsView').textContent=`${a.dateMD} - ${a.shift}`;
}
tick(); setInterval(tick,30000);

/* ===== è‰ç¨¿/å·¥è™Ÿ ===== */
const INSPECTOR_KEY='inspector_id';           // æ°¸ä¹…ä¿å­˜å·¥è™Ÿ
const DSKEY_KEY='rt_draft_dskey';
const DRAFT_PREFIX='rt_draft_';
function dsKeyOf(a){return `${a.dateMD}|${a.shift}`}
function draftKey(){return DRAFT_PREFIX+dsKeyOf(anchorDS())}
function loadInspector(){ const v=localStorage.getItem(INSPECTOR_KEY)||''; if(v) $('inspector').value=v; }
function saveInspector(){ const v=canon($('inspector').value); if(/^[A-Z0-9]{5}$/.test(v)){ $('inspector').value=v; localStorage.setItem(INSPECTOR_KEY,v); } }
$('inspector').addEventListener('change',saveInspector);
$('inspector').addEventListener('input',e=>{ if(e.target.value.length===5) saveInspector(); });

function saveDraft(){
  const d={part:$('partNo').value, lot:$('lotInput').value, qty:$('qty').value, prefix:$('