<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RT外觀抽驗記錄表 · form.html (v13.3 + AJAX · PROD)</title>
<style>
  :root{ --pad-side:1rem; --label-w:80px; }
  body{ font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans TC", "PingFang TC", sans-serif; background:#f7f7f7; margin:0; padding:var(--pad-side); box-sizing:border-box; }
  .topbar{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:.5rem; margin-bottom:1rem; padding-bottom:.5rem; border-bottom:1px solid #ccc; }
  .icon-btn{ background:transparent; border:none; font-size:1.4rem; cursor:pointer; line-height:1; padding:.35rem; border-radius:8px; }
  .icon-btn:active{ background:#e8e8e8; }
  header{ text-align:center; font-size:1.3rem; font-weight:bold; font-family: "DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif; }
  .row{ display:flex; align-items:center; justify-content:space-between; margin-bottom:.8rem; }
  .row.actions{ justify-content:flex-end; }
  .label{ flex:0 0 var(--label-w); text-align:center; color:#333; font-weight:600; margin-right:.75rem; font-family: "DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif; }
  .value{ flex:1; margin-right:.5rem; }
  input, select, textarea{ padding:.45rem; font-size:1rem; width:100%; box-sizing:border-box; font-family:"Comic Sans MS","Comic Sans","Comic Neue","Noto Sans TC",cursive; }
  input, select{ height:2.6rem; }
  #remark{ font-family:"DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif; min-height:60px; resize:vertical; }
  #remark[readonly]{ background:#f0f0f0; color:#666; }
  .readonly{ background:#e9ecef; padding:.25rem .45rem; border-radius:.5rem; font-family:"Comic Sans MS","Comic Sans","Comic Neue","Noto Sans TC",cursive; min-height:2.0rem; display:flex; align-items:center; font-size:.95rem; }
  .triple{ display:grid; grid-template-columns: .6fr 16px 1.6fr 16px .8fr; gap:.5rem; align-items:center; }
  .sep{ text-align:center; color:#666; }
  .status{ font-size:.95rem; color:#222; text-align:left; margin-left:.2rem; }
  hr{ border:none; border-top:1px solid #ccc; margin:1rem 0 .5rem 0; }
  .table-header{ display:flex; gap:.5rem; padding:0 .5rem; font-size:.95rem; font-weight:700; color:#555; font-family:"DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif; text-align:center; }
  .table-header .col{ flex:1; display:flex; align-items:center; justify-content:center; }
  .toast{ display:none; padding:.6rem .8rem; border-radius:.5rem; margin:.5rem 0; }
  .toast.ok{ background:#e7f6ee; color:#136c3c; }
  .toast.warn{ background:#fff4e5; color:#8a4b00; }
  .toast.err{ background:#fdecec; color:#8a0012; }
  .submit-btn{ min-width:40%; max-width:60%; padding:.8rem 1rem; font-size:1.05rem; font-weight:700; background:#007bff; color:#fff; border:none; border-radius:8px; }
</style>
</head>
<body>

<div class="topbar">
  <button class="icon-btn" title="更改語言" id="langBtn" data-action="open-lang-menu" aria-label="更改語言">🌐</button>
  <header>RT外觀抽驗記錄表</header>
  <button class="icon-btn" title="返回上一頁" id="backBtn" aria-label="返回上一頁">↩️</button>
</div>

<div id="toast" class="toast"></div>

<form id="recordForm" method="post" action="https://ut5-m14-rt01-api.onrender.com/api/records">
  <input type="hidden" name="ts" id="ts" value="">
  <input type="hidden" name="date_shift" id="date_shift" value="">

  <div class="row">
    <div class="status" id="statusText">09/18 15:32 - 09/18-A</div>
  </div>

  <div class="row">
    <div class="label">抽驗者：</div>
    <div class="value"><input type="text" id="inspector" name="inspector" placeholder="輸入 5 碼工號" autocomplete="off"></div>
  </div>

  <div class="row">
    <div class="label">料　號：</div>
    <div class="value"><input type="text" id="part_no" name="part_no" placeholder="請輸入料號 by 7碼" autocomplete="off"></div>
  </div>

  <div class="row">
    <div class="label">&nbsp;</div>
    <div class="value">
      <div class="triple">
        <select title="批號（左）" id="lot_prefix" name="lot_prefix">
          <option value=""></option>
          <option value="FA">FA</option>
        </select>
        <div class="sep">-</div>
        <input type="text" title="批號（中）" id="lot_mid" name="lot_mid" placeholder="母批" autocomplete="off">
        <div class="sep">-</div>
        <input type="text" title="批號（右）" id="lot_tail" name="lot_tail" placeholder="子批" autocomplete="off">
      </div>
    </div>
  </div>

  <div class="row batch-display">
    <div class="label">批　號：</div>
    <div class="value readonly" id="lot_full"> </div>
  </div>

  <div class="row">
    <div class="label">數　量：</div>
    <div class="value"><input type="number" id="qty" name="qty" placeholder="輸入批量（>0）" inputmode="numeric"></div>
  </div>

  <div class="row">
    <div class="label">備　註：</div>
    <div class="value"><textarea id="remark" name="remark" placeholder="（暫不開放輸入）" readonly></textarea></div>
  </div>

  <div class="row actions">
    <button type="submit" class="submit-btn">送出</button>
  </div>
</form>

<hr>
<div class="table-header">
  <div class="col">料　號</div>
  <div class="col">批　號</div>
  <div class="col">數　量</div>
</div>
<hr>
<div class="list-note" style="font-size:.8rem; color:#777; padding:0 .5rem .4rem;">顯示規則：倒序（最新在最上），最多 50 筆；常規 3–10 筆。</div>

<div id="record-list"></div>

<script>
  function showToast(type, msg){
    const el = document.getElementById('toast');
    el.className = 'toast ' + type;
    el.textContent = msg;
    el.style.display = 'block';
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>{ el.style.display='none'; }, 3000);
  }

  document.getElementById('backBtn').addEventListener('click', function () {
    if (history.length > 1) history.back();
  });
  document.getElementById('langBtn').addEventListener('click', function () {
    /* data-action=open-lang-menu */
  });
  document.getElementById('recordForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    document.getElementById('remark').value = '';

    const payload = {
      ts: document.getElementById('ts').value,
      date_shift: document.getElementById('date_shift').value,
      inspector: document.getElementById('inspector').value.trim(),
      part_no: document.getElementById('part_no').value.trim(),
      lot_prefix: document.getElementById('lot_prefix').value.trim(),
      lot_mid: document.getElementById('lot_mid').value.trim(),
      lot_tail: document.getElementById('lot_tail').value.trim(),
      lot_full: document.getElementById('lot_full').textContent.trim(),
      qty: document.getElementById('qty').value.trim(),
      remark: ""
    };

    if(!payload.date_shift || !payload.inspector || !payload.part_no || !payload.qty){
      showToast('warn', '請確認：班別/抽驗者/料號/數量。');
      return;
    }

    const url = e.target.action;
    try {
      let res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if(res.status === 201){
        showToast('ok', '✅ 送出成功');
        document.getElementById('lot_prefix').value = '';
        document.getElementById('lot_mid').value = '';
        document.getElementById('lot_tail').value = '';
        document.getElementById('qty').value = '';
        document.getElementById('remark').value = '';
        document.getElementById('inspector').value = document.getElementById('inspector').value;
        composeLot();
        return;
      }

      if(res.status === 409){
        const c1 = confirm('⚠️ 發現同日同班同料號+批號，但抽驗者不同。要送出嗎？');
        if(!c1) return;
        const c2 = confirm('真的要強制寫入嗎？');
        if(!c2) return;

        res = await fetch(url + '?force=1', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if(res.status === 201){
          showToast('ok', '✅ 已強制寫入');
          document.getElementById('lot_prefix').value = '';
          document.getElementById('lot_mid').value = '';
          document.getElementById('lot_tail').value = '';
          document.getElementById('qty').value = '';
          document.getElementById('remark').value = '';
          composeLot();
          return;
        } else {
          showToast('err', '❌ 強制寫入失敗：' + res.status);
          return;
        }
      }

      showToast('err', '❌ 送出失敗，狀態碼：' + res.status);
    } catch(err){
      showToast('err', '❌ 送出錯誤：' + err.message);
    }
  });

  const $prefix = document.getElementById('lot_prefix');
  const $mid    = document.getElementById('lot_mid');
  const $tail   = document.getElementById('lot_tail');
  const $full   = document.getElementById('lot_full');
  function composeLot() {
    const p = ($prefix.value || '').trim();
    const m = ($mid.value || '').trim();
    const t = ($tail.value || '').trim();
    let parts = [];
    if (p) parts.push(p);
    if (m) parts.push(m);
    if (t) parts.push(t);
    $full.textContent = parts.join('-');
  }
  ['change','input'].forEach(ev => {
    $prefix.addEventListener(ev, composeLot);
    $mid.addEventListener(ev, composeLot);
    $tail.addEventListener(ev, composeLot);
  });
  composeLot();
</script>

</body>
</html>
<script>
const TZ='Asia/Taipei';
const statusEl=document.getElementById('statusText');
const tsInput=document.getElementById('ts');
const dsInput=document.getElementById('date_shift');

function twNow(){ return new Date(new Date().toLocaleString('en-US',{timeZone:TZ})); }
function fmtDate(d){ const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${mm}/${dd}`;}
function fmtTime(d){ const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${hh}:${mi}`;}
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function setHM(base,h,m){ const d=new Date(base); d.setHours(h,m,0,0); return d; }

function calcShift(d){
  const mins=d.getHours()*60+d.getMinutes();
  const t0040=40, t0840=8*60+40, t1640=16*60+40;
  if(mins>=t0840 && mins<t1640) return {shift:'A', start:setHM(d,8,40),  next:setHM(d,16,40)};
  if(mins>=t1640)                return {shift:'B', start:setHM(d,16,40), next:setHM(addDays(d,1),0,40)};
  if(mins<t0040)                 return {shift:'B', start:setHM(addDays(d,-1),16,40), next:setHM(d,0,40)};
  return {shift:'C', start:setHM(d,0,40), next:setHM(d,8,40)};
}

function anchorIfNeeded(){
  const now=twNow();
  const store=JSON.parse(localStorage.getItem('ds_anchor')||'{}');
  if(!store.until || now.getTime()>store.until){
    const s=calcShift(now);
    const anchor={ date:fmtDate(now), shift:s.shift, until:s.next.getTime()+80*60000 };
    localStorage.setItem('ds_anchor', JSON.stringify(anchor));
    dsInput.value = `${anchor.date}-${anchor.shift}`;
  }else{
    dsInput.value = `${store.date}-${store.shift}`;
  }
}

function tick(){
  const now=twNow();
  const store=JSON.parse(localStorage.getItem('ds_anchor')||'{}');
  const datePart=store.date || fmtDate(now);
  const shiftPart=store.shift || calcShift(now).shift;
  statusEl.textContent = `${fmtDate(now)} ${fmtTime(now)} - ${datePart}-${shiftPart}`;
  tsInput.value = now.toISOString();
  if(store.until && now.getTime()>store.until) anchorIfNeeded();
}

anchorIfNeeded();
tick();
setInterval(tick, 30000);
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ anchorIfNeeded(); tick(); }});
</script>