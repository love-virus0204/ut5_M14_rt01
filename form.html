<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</title>
<style>
  :root{--maxw:520px; --labelw:92px;}
  body{margin:0;background:#f5f5f5;font-family:"Comic Sans MS",sans-serif}
  .wrap{max-width:var(--maxw);margin:8px auto;padding:10px 14px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .toolbar{display:grid;grid-template-columns:36px auto 36px;align-items:center;margin-bottom:6px}
  .tool-left{justify-self:start}
  .tool-right{justify-self:end}
  .tool-btn{background:none;border:0;font-size:18px;line-height:1;padding:2px 6px;cursor:pointer}
  .title{font-family:"æ¨™æ¥·é«”",serif;text-align:center;font-weight:700;margin:0;font-size:1.4rem}
  @media (max-width: 400px){ .title{font-size:1.2rem} }
  .meta{display:grid;grid-template-columns:1fr 1fr 1fr;align-items:center;margin:6px 0}
  .meta .left{text-align:left;font-size:.9rem}
  .meta .mid{text-align:center;font-size:.9rem}
  .meta .right{text-align:right;font-size:.9rem}
  .ds-line{font-weight:700;margin:8px 0 10px 0;padding-left:20px}
  .row{display:flex;align-items:center;margin:6px 0}
  .row label{width:var(--labelw);text-align:center;font-family:"æ¨™æ¥·é«”",serif}
  .row input,.row select{flex:1;padding:8px 10px;font-size:16px;font-family:"Comic Sans MS",sans-serif}
  .row .lot-preview{margin-left:8px;padding:6px 8px;background:#222;color:#fff;border-radius:6px;font-size:.85rem}
  .hint{min-height:18px;color:#c00;font-weight:700;margin:2px 0 4px 0;padding-left:calc(var(--labelw) + 6px)}
  .actions{margin-top:8px}
  .btn-submit{float:right;background:#0a6efd;color:#fff;border:0;border-radius:8px;padding:10px 16px;font-size:16px;cursor:pointer}
  .status{clear:both;text-align:center;margin:6px 0;font-weight:700}
  .status.green{color:#2a8a2a}
  .status.red{color:#c00}
  .loading{text-align:center;display:none;margin:8px 0}
  hr{margin:14px 0}
  .list-head{display:grid;grid-template-columns:1fr 1fr 1fr;font-weight:700;text-align:center}
  .draft{margin-top:6px}
  .item{display:grid;grid-template-columns:1fr 1fr 1fr;text-align:center;padding:6px 0;border-bottom:1px dashed #ddd}
  .item.deleted{color:#888;text-decoration:line-through}
</style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="tool-left"><button class="tool-btn" onclick="location.href='index.html'">âŸµ</button></div>
      <h1 class="title">RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</h1>
      <div class="tool-right"><button class="tool-btn">ğŸŒ</button></div>
    </div>

    <div class="meta">
      <div class="left"  id="dsLine">ç•¶æ—¥ç•¶ç­ï¼š</div>
      <div class="mid"   id="nowStr">--:--:--</div>
      <div class="right" id="verStr">v17.6</div>
    </div>

    <div class="ds-line">ç•¶æ—¥ç•¶ç­ï¼šMM/DD ç­</div>

    <div class="row">
      <label>æª¢ã€€é©—ï¼š</label>
      <input id="inspector" type="text" placeholder="è«‹è¼¸å…¥å·¥è™Ÿ"/>
    </div>
    <div class="row">
      <label>æ–™ã€€è™Ÿï¼š</label>
      <input id="partNo" type="text" placeholder="è¼¸å…¥ 7ç¢¼æ–™è™Ÿ"/>
    </div>
    <div class="hint" id="partHint"></div>

    <div class="row">
      <label>æ‰¹ã€€è™Ÿï¼š</label>
      <input id="lot" type="text" placeholder="FA-001 or 001-01"/>
      <div class="lot-preview" id="lotShow">â€”</div>
    </div>
    <div class="hint" id="lotHint"></div>

    <div class="row">
      <label>æ‰¹ã€€é‡ï¼š</label>
      <input id="qty" type="number" placeholder="è¼¸å…¥ æ‰¹é‡"/>
    </div>

    <div class="actions">
      <button id="submitBtn" class="btn-submit">é€å‡º</button>
    </div>
    <div id="statusMsg" class="status"></div>
    <div id="loading" class="loading">å‚³é€ä¸­...</div>

    <hr>
    <div class="list-head"><div>æ–™è™Ÿ</div><div>æ‰¹è™Ÿ</div><div>æ•¸é‡</div></div>
    <div id="draftList" class="draft"></div>
  </div>

<script>
// v17.11 (JS-only on v17.6 template) â€” GET submit, key2 draft, 15s cache, HOT TTL
const API_BASE="https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";

// ===== helpers =====
const $ = (s)=>document.querySelector(s);
const insp = $("#inspector");
const part = $("#partNo");
const lot  = $("#lot");
const qty  = $("#qty");
const statusMsg = $("#statusMsg");
const okMsg = null;
const loading = $("#loading");

// DS rule 0040/0840/1640
function shiftOf(d){
  const hm=d.getHours()*100+d.getMinutes();
  if(hm>=840 && hm<1640) return "A";
  if(hm>=1640 || hm<40) return "B";
  return "C";
}
function mmdd(d){ return `${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`; }
function currentDS(){ const now=new Date(); return `${mmdd(now)}|${shiftOf(now)}`; }

// UI: clock & DS line
(function tick(){
  const ns = document.getElementById("nowStr");
  const ds = document.getElementById("dsLine");
  const now=new Date();
  if(ns){ ns.textContent = `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}:${String(now.getSeconds()).padStart(2,"0")}`; }
  if(ds){ ds.textContent = `ç•¶æ—¥ç•¶ç­ï¼š${currentDS().replace("|"," ")}`; }
  setTimeout(tick,1000);
})();

// ===== validation =====
const partHint = $("#partHint");
const lotHint  = $("#lotHint");
function validInspector(v){ return /^[0-9A-Z]{4,6}$/.test((v||"").toUpperCase()); }
function validPart(v){ return /^[0-9A-Z]{7}$/.test((v||"").toUpperCase()); }
function sanitizeLot(v){
  v=(v||"").trim().toUpperCase();
  if(!v) return {ok:false,msg:"æ‰¹è™Ÿå¿…å¡«"};
  let a=v, b="";
  if(v.includes("-")){ [a,b]=v.split("-"); } else { a=v; }
  if(!/^[0-9A-HJ-NP-Z]{3}$/.test(a)) return {ok:false,msg:"æ¯æ‰¹é ˆç‚º3ç¢¼ï¼Œä¸”ä¸å¯å« I/O"};
  if(b){
    if(!/^[0-9A-Z]{1,2}$/.test(b)) return {ok:false,msg:"å­æ‰¹é™ 1~2 ç¢¼è‹±æ•¸"};
    b=b.padStart(2,"0");
    return {ok:true, lot:`${a}-${b}`};
  }
  return {ok:true, lot:a};
}
function hint(el,msg){ if(el) el.textContent = msg||""; }

if(part){ part.addEventListener("input",()=>{ const v=(part.value||"").trim().toUpperCase(); hint(partHint, v? (validPart(v)?"":"æ–™è™Ÿéœ€ç‚º 7 ç¢¼è‹±æ•¸") : ""); }); }
if(lot){
  lot.addEventListener("input",()=>{
    const v=lot.value;
    const s=sanitizeLot(v);
    const show=$("#lotShow");
    if(show) show.textContent= s.ok ? s.lot : "â€”";
    hint(lotHint, s.ok?"":s.msg);
  });
}
if(insp){
  const saved = localStorage.getItem("inspector_mem");
  if(saved) insp.value = saved;
  insp.addEventListener("change",()=>{ const v=(insp.value||"").trim().toUpperCase(); if(validInspector(v)) localStorage.setItem("inspector_mem",v); });
}

// ===== key / key2 =====
function composeKey(ds, p, l){ return `${ds}|${p}|${l}`; }
function composeKey2(ds, l, q){ return `${ds}|${l}|${q}|TRUE`; }

// ===== drafts (per-DS bucket) =====
function bucketName(){ return `draft_${currentDS()}`; }
function loadDraft(){ try{ const raw=localStorage.getItem(bucketName()); return raw?JSON.parse(raw):[]; }catch(_){ return []; } }
function saveDraft(list){ localStorage.setItem(bucketName(), JSON.stringify(list)); }
function renderDraft(){
  const box = document.getElementById("draftList"); if(!box) return;
  const list = loadDraft().sort((a,b)=>b.ts-a.ts);
  box.innerHTML = list.length
    ? list.map(d=>`<div class="item${d.deleted?" deleted":""}"><div>${d.part_no}</div><div>${d.lot}</div><div>${d.qty}</div></div>`).join("")
    : `<div style="text-align:center;color:#888;">ï¼ˆç„¡è‰ç¨¿ï¼‰</div>`;
}

// ===== backend key2 cache (for strike) =====
let key2Cache = { t:0, set:new Set(), hot:new Set() };
const CACHE_MS=15000, HOT_TTL_MS=8000;

async function refreshKey2(){
  try{
    const r = await fetch(`${API_BASE}?action=list_recent`);
    const j = await r.json();
    key2Cache.set = new Set(j.map(x=>String(x.key2||"")));
    key2Cache.t = Date.now();
    reconcileDraft();
  }catch(e){/* ignore */}
}
function reconcileDraft(){
  const now=Date.now();
  const list = loadDraft();
  let changed=false;
  for(const d of list){
    if(d.hotAt && now-d.hotAt < HOT_TTL_MS){ // protect freshly sent
      if(d.deleted){ d.deleted=false; changed=true; }
      continue;
    }
    const exists = key2Cache.set.has(d.key2);
    const wantDel = !exists;
    if(!!d.deleted !== wantDel){ d.deleted = wantDel; changed=true; }
  }
  if(changed){ saveDraft(list); renderDraft(); }
}
setInterval(refreshKey2, CACHE_MS);
refreshKey2();

// ===== submit (GET) =====
function showStatus(msg, bad){
  const s = document.getElementById("statusMsg");
  if(!s) return;
  s.className = "status " + (bad?"red":"green");
  s.textContent = msg||"";
  if(!bad) setTimeout(()=>{ s.textContent=""; }, 5000);
}

async function submitData(){
  const iv=(insp?.value||"").trim().toUpperCase();
  const pv=(part?.value||"").trim().toUpperCase();
  const qv=String(qty?.value||"").trim();
  if(!validInspector(iv)){ showStatus("å·¥è™Ÿæ ¼å¼ä¸æ­£ç¢º", true); return; }
  if(!validPart(pv))     { showStatus("æ–™è™Ÿéœ€ç‚º 7 ç¢¼è‹±æ•¸", true); return; }
  const ls = sanitizeLot(lot?.value);
  if(!ls.ok){ hint(lotHint, ls.msg); return; } else { hint(lotHint,""); }
  if(!qv || isNaN(Number(qv))){ showStatus("è«‹è¼¸å…¥æ•¸é‡", true); return; }

  const ds = currentDS();
  const key  = composeKey(ds, pv, ls.lot);
  const key2 = composeKey2(ds, ls.lot, qv);

  // optimistic draft + HOT mark
  const now = Date.now();
  (function upsert(){
    const list = loadDraft();
    const i = list.findIndex(x=>x.key===key);
    const base = {part_no:pv, lot:ls.lot, qty:qv, key, key2, ts:now, deleted:false, hotAt:now};
    if(i>=0) list[i] = {...list[i], ...base};
    else     list.push(base);
    saveDraft(list); renderDraft();
  })();

  if(loading) loading.style.display="block"; showStatus("", false);
  try{
    const qs = new URLSearchParams({
      action:"submit", date_shift:ds, part_no:pv, lot:ls.lot, qty:qv, inspector:iv, key, key2
    }).toString();
    const r = await fetch(`${API_BASE}?${qs}`);
    const j = await r.json();
    if(!j || j.status!=="ok") throw new Error("submit_fail");
    showStatus("é€å‡ºæˆåŠŸ", false);
    if(lot) lot.value="";
    if(qty) qty.value="";
  }catch(e){
    showStatus("é€å‡ºå¤±æ•—", true);
  }finally{
    if(loading) loading.style.display="none";
    setTimeout(reconcileDraft, HOT_TTL_MS+200);
  }
}

document.getElementById("submitBtn")?.addEventListener("click", submitData);

// é¦–æ¬¡æ¸²æŸ“
renderDraft();
</script>
</body>
</html>