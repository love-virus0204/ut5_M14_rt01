<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RTå¤–è§€æŠ½é©—è¨˜éŒ„è¡¨ Â· v14</title>
<style>
  :root{--pad:12px;--label:92px;}
  body{background:#f7f7f7;margin:0;padding:var(--pad);font-family:"Comic Sans MS","Comic Neue","Noto Sans TC",sans-serif;}
  .topbar{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:.5rem;padding-bottom:.5rem;border-bottom:1px solid #d9d9d9;margin-bottom:.75rem}
  .icon{background:transparent;border:none;font-size:1.35rem;cursor:pointer;padding:.35rem;border-radius:8px}
  header{font-family:"DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif;font-weight:700;text-align:center}
  .row{display:flex;align-items:center;gap:.75rem;margin:.55rem 0}
  .label{flex:0 0 var(--label);text-align:center;font-weight:700;font-family:"DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif}
  .value{flex:1}
  input,select{width:100%;padding:.5rem;font-size:1rem;border:1px solid #cfcfcf;border-radius:8px}
  textarea{width:100%;min-height:68px;border:1px solid #cfcfcf;border-radius:8px;background:#f0f0f0;color:#666;resize:none}
  .lot-box{background:#eef2f6;border-radius:8px;padding:.3rem .5rem;display:inline-flex;min-height:2rem;align-items:center}
  .btn{border:none;background:#007bff;color:#fff;padding:.75rem 1.1rem;border-radius:10px;font-weight:700;min-width:40%}
  hr{border:none;border-top:1px solid #d9d9d9;margin:.75rem 0}
  .tbl-head{display:flex;gap:.5rem;font-weight:700;color:#555;font-family:"DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif}
  .tbl-head .c{flex:1;text-align:center}
  .rec{display:flex;gap:.5rem;padding:.35rem .25rem;border-bottom:1px dashed #e5e5e5}
  .rec .c{flex:1;text-align:center}
</style>
</head>
<body>

<div class="topbar">
  <button class="icon" id="langBtn" title="æ›´æ”¹èªè¨€">ğŸŒ</button>
  <header>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</header>
  <button class="icon" id="backBtn" title="è¿”å›ä¸Šä¸€é ">â†©ï¸</button>
</div>

<div class="row">
  <div class="label">ã€€</div>
  <div class="value"><span id="tsView"></span> - <span id="dsView"></span></div>
</div>

<div class="row">
  <div class="label">æŠ½ã€€é©—ï¼š</div>
  <div class="value"><input id="inspector" placeholder="è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ"></div>
</div>

<div class="row">
  <div class="label">æ–™ã€€è™Ÿï¼š</div>
  <div class="value"><input id="part_no" placeholder="è«‹è¼¸å…¥ æ–™è™Ÿ by 7ç¢¼"></div>
</div>

<div class="row">
  <div class="label">æ‰¹ã€€è™Ÿï¼š</div>
  <div class="value">
    <div style="display:grid;grid-template-columns:.6fr 1fr;gap:.5rem">
      <select id="lot_prefix">
        <option value=""></option><option value="FA">FA</option><option value="CM">CM</option><option value="LN">LN</option>
      </select>
      <input id="mother_child" placeholder="æ¯æ‰¹[-å­æ‰¹]">
    </div>
  </div>
</div>

<div class="row">
  <div class="label">ã€€</div>
  <div class="value"><span class="lot-box" id="lot_full"> </span></div>
</div>

<div class="row">
  <div class="label">æ•¸ã€€é‡ï¼š</div>
  <div class="value"><input id="qty" type="number" min="0" placeholder="è¼¸å…¥æ‰¹é‡"></div>
</div>

<div class="row">
  <div class="label">å‚™ã€€è¨»ï¼š</div>
  <div class="value"><textarea id="remark" readonly placeholder="ç›®å‰ä¸é–‹æ”¾è¼¸å…¥"></textarea></div>
</div>

<div class="row" style="justify-content:flex-end">
  <div class="value" style="text-align:right"><button class="btn" id="submitBtn">é€å‡º</button></div>
</div>

<hr>
<div class="tbl-head"><div class="c">æ–™ã€€è™Ÿ</div><div class="c">æ‰¹ã€€è™Ÿ</div><div class="c">æ•¸ã€€é‡</div></div>
<hr>
<div id="list"></div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const API_TOKEN = "MY_SECRET_123";

document.getElementById('backBtn').onclick=()=>{ if(history.length>1) history.back(); };

const $prefix=document.getElementById('lot_prefix');
const $mc=document.getElementById('mother_child');
const $lot=document.getElementById('lot_full');
function normMC(raw){
  let s=String(raw||'').trim().toUpperCase();
  if(!s) return {ok:false,msg:"æ¯æ‰¹å¿…å¡«",mother:"",child:""};
  const parts=s.split('-').map(v=>v.trim());
  let mother=parts[0];
  if(!/^[A-Z0-9]{3}$/.test(mother) || /[OI]/.test(mother)) return {ok:false,msg:"æ¯æ‰¹éœ€3ç¢¼è‹±æ•¸ä¸”ä¸å¾—å«O/I"};
  let child="";
  if(s.includes('-')){
    if(!parts[1]||!/^\d{1,2}$/.test(parts[1])) return {ok:false,msg:"å­æ‰¹éœ€1~2ç¢¼æ•¸å­—"};
    child=('0'+parts[1]).slice(-2);
  }
  return {ok:true,mother,child};
}
function renderLot(){
  const pre=$prefix.value.toUpperCase().trim();
  const mc=normMC($mc.value);
  $lot.textContent=(pre&&mc.ok)? (mc.child?`${pre}-${mc.mother}-${mc.child}`:`${pre}-${mc.mother}`):' ';
}
['input','change'].forEach(ev=>{ $prefix.addEventListener(ev,renderLot); $mc.addEventListener(ev,renderLot); });
renderLot();

function twNow(){ return new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Taipei'})); }
function fmtMD(d){return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}
function shiftInfo(){
  const n=twNow(), mins=n.getHours()*60+n.getMinutes();
  if(mins>=520&&mins<1000) return {date:fmtMD(n),shift:'A'};
  if(mins>=1000) return {date:fmtMD(n),shift:'B'};
  if(mins<40) return {date:fmtMD(addDays(n,-1)),shift:'B'};
  return {date:fmtMD(addDays(n,-1)),shift:'C'};
}
function tick(){
  const n=twNow(), ds=shiftInfo();
  document.getElementById('tsView').textContent=`${fmtMD(n)} ${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
  document.getElementById('dsView').textContent=`${ds.date} - ${ds.shift}`;
}
tick(); setInterval(tick,30000);

async function refreshList(){
  const list=document.getElementById('list'); list.innerHTML='';
  try{
    const res=await fetch(`${GAS_URL}?limit=50`); const data=await res.json();
    const rows=(Array.isArray(data)?data:[]).filter(r=>r.deleted===true);
    rows.sort((a,b)=>String(b.submitted_at||'').localeCompare(String(a.submitted_at||'')));
    for(const r of rows.slice(0,50)){
      const div=document.createElement('div');div.className='rec';
      div.innerHTML=`<div class="c">${r.part_no||''}</div><div class="c">${r.lot||''}</div><div class="c">${r.qty||''}</div>`;
      list.appendChild(div);
    }
  }catch(e){console.error(e);}
}
refreshList();

document.getElementById('submitBtn').addEventListener('click',async(e)=>{
  e.preventDefault();
  const inspector=document.getElementById('inspector').value.trim();
  const part=document.getElementById('part_no').value.trim().toUpperCase();
  if(!/^[A-Za-z0-9]{5}$/.test(inspector)) return alert("è«‹è¼¸å…¥5ç¢¼å·¥è™Ÿ");
  if(!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(part)) return alert("æ–™è™Ÿæ ¼å¼éŒ¯èª¤");
  if(!$prefix.value) return alert("è«‹é¸æ“‡æ‰¹è™Ÿå‰ç¶´");
  const mc=normMC($mc.value); if(!mc.ok) return alert(mc.msg);
  const qty=Number(document.getElementById('qty').value); if(!qty||qty<=0) return alert("æ•¸é‡éœ€å¤§æ–¼0");

  const payload={
    token:API_TOKEN,
    inspector, part_no:part,
    lot_prefix:$prefix.value,
    mother_child:`${mc.mother}${mc.child?'-'+mc.child:''}`,
    qty:String(qty), remark:""
  };

  const btn=document.getElementById('submitBtn'); btn.disabled=true;
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
    const data=await res.json();
    if(data.status==='ok'){
      alert(data.upsert==='update'?'âœ… å·²æ›´æ–°åŸè¨˜éŒ„':'âœ… å·²æ–°å¢');
      $mc.value='';document.getElementById('qty').value='';renderLot();refreshList();
    }else alert('âŒ '+JSON.stringify(data));
  }catch(err){ alert('é€å‡ºéŒ¯èª¤:'+err.message); }
  finally{ btn.disabled=false; }
});
</script>
</body>
</html>