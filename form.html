<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</title>
  <style>
    body { font-family: "Comic Sans MS", sans-serif; padding: 10px; }
    h1 { font-family: "æ¨™æ¥·é«”"; text-align: center; }
    label { display: flex; justify-content: space-between; margin: 5px 0; font-family: "æ¨™æ¥·é«”"; }
    input, select { width: 60%; font-family: "Comic Sans MS"; }
    textarea { width: 100%; font-family: "æ¨™æ¥·é«”"; }
    .btn-container { text-align: right; margin-top: 10px; }
    button { padding: 8px 16px; font-size: 16px; }
    hr { margin-top: 15px; }
    .records { font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</h1>

  <form id="recordForm">
    <!-- é¡¯ç¤ºæ™‚é–“æˆ³è¨˜ & ç•¶æ—¥ç­åˆ¥ -->
    <label>
      <span id="timestamp"></span>
      <span id="dateShift"></span>
    </label>

    <!-- æŠ½é©—è€… -->
    <label>æŠ½é©—è€…ï¼š
      <input type="text" id="inspector" placeholder="è«‹è¼¸å…¥å·¥è™Ÿ">
    </label>

    <!-- æ–™è™Ÿ -->
    <label>æ–™ã€€è™Ÿï¼š
      <input type="text" id="partNo" placeholder="è«‹è¼¸å…¥æ–™è™Ÿ by 7ç¢¼">
    </label>

    <!-- æ‰¹è™Ÿ -->
    <label>æ‰¹ã€€è™Ÿï¼š</label>
    <div style="display:flex; gap:5px;">
      <select id="lotPrefix">
        <option value="">ã€€</option>
        <option value="FA">FA</option>
        <option value="CM">CM</option>
        <option value="LN">LN</option>
      </select>
      <input type="text" id="lotMid" maxlength="3" placeholder="æ¯æ‰¹">
      <input type="text" id="lotTail" maxlength="2" placeholder="å­æ‰¹">
    </div>

    <!-- æ•¸é‡ -->
    <label>æ•¸ã€€é‡ï¼š
      <input type="number" id="qty" min="0">
    </label>

    <!-- å‚™è¨» (å”¯è®€) -->
    <label>å‚™ã€€è¨»ï¼š</label>
    <textarea id="remark" readonly></textarea>

    <!-- é€å‡ºæŒ‰éˆ• -->
    <div class="btn-container">
      <button type="submit">é€å‡º</button>
    </div>
  </form>

  <hr>
  <div class="records" id="recordsList">
    <!-- å·²è¼¸å…¥è³‡æ–™å°‡é¡¯ç¤ºåœ¨æ­¤ -->
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const API_TOKEN = "MY_SECRET_123"; // å¿…é ˆèˆ‡ GAS ç«¯è¨­å®šä¸€è‡´

// å³æ™‚æ›´æ–°æ™‚é–“èˆ‡ç­åˆ¥
function updateTimestamp() {
  const now = new Date();
  const hhmm = now.getHours() * 100 + now.getMinutes();
  let shift = "C";
  if (hhmm >= 840 && hhmm < 1640) shift = "A";
  else if (hhmm >= 1640 || hhmm < 40) shift = "B";
  document.getElementById("timestamp").textContent = now.toLocaleString("zh-TW");
  document.getElementById("dateShift").textContent = 
    `${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} - ${shift}`;
}
setInterval(updateTimestamp, 60000);
updateTimestamp();

// è¼‰å…¥æœ€æ–°è³‡æ–™
async function loadRecords() {
  try {
    const res = await fetch(`${GAS_URL}?limit=50`);
    const data = await res.json();
    const container = document.getElementById("recordsList");
    container.innerHTML = data.length === 0 ? "<i>ç›®å‰ç„¡è³‡æ–™</i>" : "";
    data.forEach(r => {
      const div = document.createElement("div");
      div.textContent = `${r.date_shift} | ${r.inspector} | ${r.part_no} | ${r.lot_full} | æ•¸é‡:${r.qty}`;
      container.appendChild(div);
    });
  } catch (err) {
    console.error("è®€å–è³‡æ–™å¤±æ•—", err);
  }
}
loadRecords();

// é€å‡ºè¡¨å–®
document.getElementById("recordForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const payload = {
    token: API_TOKEN,
    ts: new Date().toISOString(),
    date_shift: document.getElementById("dateShift").textContent,
    inspector: document.getElementById("inspector").value,
    part_no: document.getElementById("partNo").value,
    lot_prefix: document.getElementById("lotPrefix").value,
    lot_mid: document.getElementById("lotMid").value,
    lot_tail: document.getElementById("lotTail").value,
    qty: document.getElementById("qty").value,
    remark: "" // å‚™è¨»ç›®å‰é è¨­ç©º
  };

  try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.status === "ok") {
      alert("âœ… å·²æˆåŠŸå¯«å…¥ Google è©¦ç®—è¡¨ï¼");
      loadRecords();
    } else if (data.error === "conflict_other_inspector") {
      alert("âš ï¸ ç™¼ç¾ä¸åŒæª¢é©—è€…çš„é‡è¤‡ç´€éŒ„ï¼Œè«‹å†æ¬¡ç¢ºèª");
    } else if (data.error === "unauthorized") {
      alert("ğŸš« é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ token æ˜¯å¦ä¸€è‡´");
    } else {
      alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + JSON.stringify(data));
    }
  } catch (err) {
    alert("ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤ï¼š" + err);
  }
});
</script>
</body>
</html>