<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</title>
<style>
  :root{--maxw:520px; --labelw:92px;}
  body{margin:0;background:#f5f5f5;font-family:"Comic Sans MS",sans-serif}
  .wrap{max-width:var(--maxw);margin:8px auto;padding:10px 14px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .toolbar{display:grid;grid-template-columns:36px auto 36px;align-items:center;margin-bottom:6px}
  .tool-left{justify-self:start}
  .tool-right{justify-self:end}
  .tool-btn{background:none;border:0;font-size:18px;line-height:1;padding:2px 6px;cursor:pointer}
  .title{font-family:"æ¨™æ¥·é«”",serif;text-align:center;font-weight:700;margin:0;font-size:1.35rem}
  @media (max-width: 400px){ .title{font-size:1.18rem} }

  /* ç•¶æ—¥ç•¶ç­ï¼šå–®ç¨ä¸€è¡Œã€è¦–è¦ºå…§ç¸®åˆ°è¼¸å…¥åˆ—å·¦é‚Šç•Œ */
  .ds-line{font-weight:700;margin:8px 0 10px 0; padding-left:20px;}

  .row{display:grid;grid-template-columns:var(--labelw) 1fr;align-items:center;column-gap:10px;margin:6px 0}
  .label{font-family:"æ¨™æ¥·é«”",serif;text-align:center}
  .ctrl{width:100%}
  .ctrl input,.ctrl select{width:100%;box-sizing:border-box;padding:7px;border:1px solid #ccc;border-radius:6px;font-family:"Comic Sans MS",sans-serif}
  .row.lot-type .ctrl{display:grid;grid-template-columns:25% 1fr;column-gap:8px}
  .row.lot-type select{min-width:80px}

  .field-error{display:none;color:#d93025;font-weight:700;font-size:13px;margin-top:4px}
  .input-error{ border-color:#d93025 !important; }

  .submit{position:relative;display:flex;justify-content:flex-end;align-items:center;margin-top:10px}
  .submit-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:12px}
  .btn{background:#0a66ff;color:#fff;border:0;border-radius:8px;padding:10px 18px;cursor:pointer}

  .ok-msg{display:none;color:#1a7f37;font-weight:700;font-size:13px}
  .ok-msg.show{display:block;opacity:1;transition:opacity .4s}
  .ok-msg.fade{opacity:0}

  hr{margin:10px 0}
  .bottom-info{display:grid;grid-template-columns:1fr 1fr;align-items:center;margin:6px 0}
  .ver-left{justify-self:start;font-size:12px;color:#666}
  .time-right{justify-self:end;font-size:12px;color:#333;text-align:right}
  .post{width:95%;margin:0 auto}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-top:1px solid #ddd;text-align:center;padding:6px 4px}

  .strike td{ text-decoration: line-through; color:#888; }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="tool-left"><button class="tool-btn" id="langBtn" title="èªè¨€">ğŸŒ</button></div>
    <h1 class="title">RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</h1>
    <div class="tool-right"><button class="tool-btn" id="backBtn" title="è¿”å›" onclick="location.href='index.html'">â†©ï¸</button></div>
  </div>

  <div id="dsView" class="ds-line"></div>

  <div class="row">
    <div class="label">æª¢é©—å“¡ï¼š</div>
    <div class="ctrl">
      <input id="inspector" maxlength="5" placeholder="è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ">
      <div id="inspectorError" class="field-error"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ–™ã€€è™Ÿï¼š</div>
    <div class="ctrl">
      <input id="partNo" maxlength="7" placeholder="è¼¸å…¥ 7ç¢¼æ–™è™Ÿ">
      <div id="partError" class="field-error"></div>
    </div>
  </div>

  <div class="row lot-type">
    <div class="label">å‹ã€€æ…‹ï¼š</div>
    <div class="ctrl">
      <select id="lotPrefix">
        <option value=""></option>
        <option value="FA">FA</option>
      </select>
      <div></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ‰¹ã€€è™Ÿï¼š</div>
    <div class="ctrl">
      <input id="lotInput" placeholder="æ¯æ‰¹(3ç¢¼) or æ¯æ‰¹-å­æ‰¹(3-2)ï¼›ç¦ I / O">
      <div id="lotError" class="field-error"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ•¸ã€€é‡ï¼š</div>
    <div class="ctrl"><input id="qty" type="number" min="1" placeholder="è¼¸å…¥ æ‰¹é‡"></div>
  </div>

  <div class="submit" id="submit-row">
    <div class="submit-center"><div id="okMsg" class="ok-msg"></div></div>
    <button id="sendBtn" class="btn">é€å‡º</button>
  </div>

  <hr>

  <div class="bottom-info">
    <div id="versionTag" class="ver-left">ç‰ˆæœ¬ï¼šv17.10.5</div>
    <div id="tsView" class="time-right"></div>
  </div>

  <div class="post">
    <table>
      <thead><tr><th>æ–™ã€€è™Ÿ</th><th>æ‰¹ã€€è™Ÿ</th><th>æ•¸ã€€é‡</th></tr></thead>
      <tbody id="recordList"><tr><td colspan="3" style="color:#888">ï¼ˆç•¶ç­ç„¡è‰ç¨¿ï¼‰</td></tr></tbody>
    </table>
  </div>
</div>

<script>
// === å°åŒ—æ™‚å€æ ¡æ™‚ï¼ˆéå°åŒ—â†’ç”¨ä¼ºæœå™¨æ™‚é–“æ ¡æ­£ä¸€æ¬¡ï¼Œä¿å­˜ deltaï¼‰ ===
function __isTaipeiTZ(){ try{ return Intl.DateTimeFormat().resolvedOptions().timeZone==="Asia/Taipei"; }catch(_){ return false; } }
function __loadDelta(){ try{ return Number(localStorage.getItem("rt_tz_delta_ms")||"0"); }catch(_){ return 0; } }
function __saveDelta(ms){ try{ localStorage.setItem("rt_tz_delta_ms", String(ms)); }catch(_){} }
function __nowTaipei(){ return new Date(Date.now() + __loadDelta()); }
async function __initTaipeiTimeOnce(){
  try{
    if(__isTaipeiTZ()){
      const d=new Date();
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
      window._dsDate=`${y}/${m}/${dd}`;
      if(typeof computeShiftByClockFrom==="function"){
        window._dsShift=computeShiftByClockFrom(`${y}/${m}/${dd} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:00`)||"";
      }
    }else{
      const u=new URL(API_BASE); u.searchParams.set("action","ping");
      const r=await fetch(u.toString(),{method:"GET",cache:"no-store"});
      const j=await r.json();
      if(j && j.server_time){
        const s=String(j.server_time);
        const parts=s.split(" ");
        const serverMs=Date.parse(parts[0]+" "+(parts[1]||"00:00:00"));
        __saveDelta(serverMs - Date.now());
        const d2=__nowTaipei();
        const y2=d2.getFullYear(), m2=String(d2.getMonth()+1).padStart(2,"0"), dd2=String(d2.getDate()).padStart(2,"0");
        window._dsDate=`${y2}/${m2}/${dd2}`;
        if(typeof computeShiftByClockFrom==="function"){
          window._dsShift=computeShiftByClockFrom(`${y2}/${m2}/${dd2} ${String(d2.getHours()).padStart(2,"0")}:${String(d2.getMinutes()).padStart(2,"0")}:00`)||"";
        }
      }
    }
    try{
      const el=document.getElementById("ds");
      if(el && window._dsDate){
        const dShow=window._dsDate.slice(5,7)+"/"+window._dsDate.slice(8,10);
        el.textContent = window._dsShift ? `${dShow} - ${window._dsShift}` : `${dShow} - `;
      }
    }catch(__e){}
  }catch(__e){}
}
document.addEventListener("DOMContentLoaded", function(){ try{__initTaipeiTimeOnce();}catch(_){}});

/* ===== ç‰ˆæœ¬èˆ‡ API ===== */
const FORM_VERSION="v17.10.13";
const API_BASE="https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";

/* ===== å¯èª¿åƒæ•¸ ===== */
const ENABLE_RECENT_KEY2_PROTECT = true;
const RECENT_KEY2_TTL_MS = 5000;     // å‰›é€å‡ºçš„è‰ç¨¿åœ¨ 5s å…§ä¸€å¾‹ä¸åŠƒç·š
const POLL_INTERVAL_MS    = 15000;   // æ¯ 15s æŠ“å¿«å–ä¸¦é‡æ¯”å°
const PING_INTERVAL_MS    = 240000;  // æ¯ 4 åˆ†é˜ ping ä¸€æ¬¡ä¿æº«

/* ===== å°å·¥å…· ===== */
const $=s=>document.querySelector(s);
function fw2hw(s){return String(s||"").replace(/[\uFF01-\uFF5E]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0)).replace(/\u3000/g," ")}
function CANON(s){return fw2hw(s).trim().toUpperCase()}
function pad2(n){return String(n).padStart(2,'0')}
function fmtYMDslash(d){return d.getFullYear()+"/"+pad2(d.getMonth()+1)+"/"+pad2(d.getDate())}
function fmtMD(d){return pad2(d.getMonth()+1)+"/"+pad2(d.getDate())}
function fmtTW(d){return d.getFullYear()+"/"+pad2(d.getMonth()+1)+"/"+pad2(d.getDate())+" "+pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds())}

/* ===== æ™‚é–“ï¼ˆå‰ç«¯ä¸»å°ï¼Œå¿…è¦æ™‚ä»¥ GAS ping æ ¡æ­£ï¼›ä¸€å¾‹æ–œç·šï¼‰ ===== */
let offsetMs=0;
function isTaiwanTZ(){ try{ return Intl.DateTimeFormat().resolvedOptions().timeZone==='Asia/Taipei'; }catch{ return false; } }
async function pingNow(){
  // æ¥µç°¡å›å‚³ï¼šå¯èƒ½æ˜¯ "yyyy/MM/dd HH:mm:ss" æˆ– {"status":"ok","ts":...}
  try{
    const r=await fetch(`${API_BASE}?action=ping&t=${Date.now()}`,{cache:'no-store'});
    const txt=await r.text();
    // å„ªå…ˆè§£æå­—ä¸²æ™‚é–“
    const m = txt.match(/^(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2}):(\d{2})$/);
    if(m){
      const srv = new Date(+m[1],+m[2]-1,+m[3],+m[4],+m[5],+m[6]).getTime();
      return srv;
    }
    // å…¼å®¹ JSON
    try{ const j=JSON.parse(txt); if(j && j.ts) return Number(j.ts); }catch{}
  }catch(e){}
  return null;
}
async function initClockOffsetSmart(){
  if(isTaiwanTZ()){ offsetMs=0; return; }
  const t0=Date.now();
  const srvMs=await pingNow();
  const t1=Date.now();
  if(srvMs){
    const est = srvMs + Math.round((t1-t0)/2);
    const off = est - t1;
    offsetMs=(Math.abs(off)<=120000)?0:off;
  }else{
    offsetMs=0;
  }
}
function nowCorrected(){ return new Date(Date.now()+offsetMs); }

/* ===== ç­åˆ¥ï¼ˆ0040/0840/1640ï¼‰ ===== */
function computeShiftByClockFrom(d){
  const h=d.getHours(), m=d.getMinutes(), mins=h*60+m;
  if(mins>=40 && mins<520){ const y=new Date(d); y.setDate(d.getDate()-1); return {baseDate:y,mmdd:fmtMD(y),ymdSlash:fmtYMDslash(y),shift:'C'}; }
  if(mins>=520 && mins<1000){ return {baseDate:d,mmdd:fmtMD(d),ymdSlash:fmtYMDslash(d),shift:'A'}; }
  if(mins>=1000){ return {baseDate:d,mmdd:fmtMD(d),ymdSlash:fmtYMDslash(d),shift:'B'}; }
  const y=new Date(d); y.setDate(d.getDate()-1); return {baseDate:y,mmdd:fmtMD(y),ymdSlash:fmtYMDslash(y),shift:'B'};
}
let currentDS=null;
function refreshDisplays(){
  const now=nowCorrected();
  currentDS=computeShiftByClockFrom(now);
  $('#dsView').textContent=`${currentDS.mmdd} - ${currentDS.shift}`;
  $('#tsView').textContent=fmtTW(now);
}

/* ===== æ¬„ä½èˆ‡é©—è­‰ ===== */
const INSPECTOR_STORE='inspector_id_v1';
const inspector=$('#inspector'), inspectorError=$('#inspectorError');
const partNo=$('#partNo'), partError=$('#partError');
const lotPrefix=$('#lotPrefix'), lotInput=$('#lotInput'), lotError=$('#lotError');
const qty=$('#qty'), okMsg=$('#okMsg');

function setFieldError(inputEl,hintEl,msg){
  if(!inputEl||!hintEl) return;
  if(msg){ inputEl.classList.add('input-error'); hintEl.textContent=msg; hintEl.style.display='block'; }
  else { inputEl.classList.remove('input-error'); hintEl.textContent=''; hintEl.style.display='none'; }
}
function persistInspectorIfValid(v){
  const id=CANON(v);
  if(/^[A-Z0-9]{5}$/.test(id)){ localStorage.setItem(INSPECTOR_STORE,id); setFieldError(inspector,inspectorError,''); return true; }
  return false;
}
inspector.addEventListener('input',()=>{ setFieldError(inspector,inspectorError,''); });
inspector.addEventListener('blur',()=>{
  const v=CANON(inspector.value);
  if(!v) return setFieldError(inspector,inspectorError,'å·¥è™Ÿå¿…å¡«');
  if(!/^[A-Z0-9]{5}$/.test(v)) return setFieldError(inspector,inspectorError,'éœ€ 5 ç¢¼è‹±æ•¸');
  persistInspectorIfValid(v);
});
partNo.addEventListener('input',()=> setFieldError(partNo,partError,''));
partNo.addEventListener('blur',()=>{
  const p=CANON(partNo.value);
  if(!p) return setFieldError(partNo,partError,'æ–™è™Ÿå¿…å¡«');
  if(!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(p)) return setFieldError(partNo,partError,'æ ¼å¼éŒ¯èª¤ï¼ˆå¦‚ A58K052ï¼‰');
  setFieldError(partNo,partError,'');
});
function parseLot(input){
  const s=CANON(input).replace(/\s+/g,'');
  if(!s) return {ok:false,msg:'æ¯æ‰¹å¿…å¡«ï¼ˆ3ç¢¼ï¼‰'};
  if(s.includes('-')){
    const [m,cRaw]=s.split('-',2);
    if(!m || !/^[A-HJ-NP-Z0-9]{3}$/.test(m)) return {ok:false,msg:'æ¯æ‰¹éœ€æ­£å¥½ 3 ç¢¼ï¼Œä¸”ä¸å¯å« I / O'};
    if(!cRaw) return {ok:false,msg:'æœ‰é€£å­—è™Ÿæ™‚å¿…é ˆè¼¸å…¥å­æ‰¹ï¼ˆ1~2 ç¢¼ï¼‰'};
    if(!/^[0-9]{1,2}$/.test(cRaw)) return {ok:false,msg:'å­æ‰¹éœ€ 1~2 ä½æ•¸å­—'};
    return {ok:true,mother:m,child:cRaw.padStart(2,'0'),hasChild:true};
  }else{
    const m=s;
    if(!/^[A-HJ-NP-Z0-9]{3}$/.test(m)) return {ok:false,msg:'æ¯æ‰¹éœ€æ­£å¥½ 3 ç¢¼ï¼Œä¸”ä¸å¯å« I / O'};
    return {ok:true,mother:m,child:'',hasChild:false};
  }
}
lotInput.addEventListener('input',()=> setFieldError(lotInput,lotError,''));
lotInput.addEventListener('blur',()=>{
  const r=parseLot(lotInput.value);
  if(!r.ok) return setFieldError(lotInput,lotError,r.msg);
  setFieldError(lotInput,lotError,'');
  lotInput.value=r.mother+(r.hasChild?('-'+r.child):'');
});

/* ä¸­å¤®æç¤º */
function ensureCenterBox(){
  let box=$("#center-status");
  if(!box){
    box=document.createElement("div");
    box.id="center-status";
    box.style.cssText=`position:fixed;left:50%;top:40%;transform:translate(-50%,-50%);z-index:9999;background:rgba(0,0,0,.7);color:#fff;padding:10px 16px;border-radius:10px;font-size:16px;display:none;`;
    document.body.appendChild(box);
  }
  return box;
}
function showCenter(text){ const b=ensureCenterBox(); b.textContent=text; b.style.display='block'; }
function hideCenter(){ const b=$("#center-status"); if(b) b.style.display='none'; }
let okTimer=null;
function showOk(msg){
  if(okTimer){clearTimeout(okTimer);okTimer=null;}
  okMsg.textContent=msg||''; okMsg.classList.add('show'); okMsg.classList.remove('fade');
  okTimer=setTimeout(()=>{ okMsg.classList.add('fade'); },4600);
  setTimeout(()=>{ okMsg.classList.remove('show','fade'); okMsg.textContent=''; },5000);
}

/* ===== APIï¼ˆGETï¼›ç›¸å®¹æ¥µç°¡å›å‚³ï¼‰ ===== */
function apiGet(paramsObj){
  const params=new URLSearchParams();
  Object.entries(paramsObj).forEach(([k,v])=>{ if(v!==undefined&&v!==null) params.append(k,String(v)); });
  params.append("t",Date.now());
  const url=`${API_BASE}?${params.toString()}`;
  return fetch(url,{method:"GET",mode:"cors",cache:"no-store"})
    .then(async r=>{
      const txt=await r.text();
      try{ return JSON.parse(txt); }catch{ return txt; }
    });
}
function submitData(p){ return apiGet({action:"submit",...p}); }
function listRecent(){ return apiGet({action:'list_recent'}); }

/* ===== è‰ç¨¿å„²å­˜ ===== */
function dsStorageKey(ds){ return `draft_${ds.ymdSlash}_${ds.shift}`; }
function getDraftList(ds){ try{ return JSON.parse(localStorage.getItem(dsStorageKey(ds))||'[]'); }catch{ return []; } }
function saveDraftList(ds,list){ localStorage.setItem(dsStorageKey(ds), JSON.stringify(list||[])); }
function makeKey(mmdd,shift,part,lot){ return `${mmdd}|${shift}|${part}|${lot}`; }
function makeKey2(mmdd,shift,lot,qty){ return `${mmdd}|${shift}|${lot}|${qty}|TRUE`; }

/* ===== key2 å¿«å–ï¼ˆSessionStorageï¼‰===== */
function readKey2Cache(ds){
  try{
    const raw=sessionStorage.getItem(`key2set_${ds.ymdSlash}_${ds.shift}`);
    if(!raw) return null;
    const obj=JSON.parse(raw);
    if(!obj||!obj.ts||!Array.isArray(obj.list)) return null;
    return obj; // {ts,list}
  }catch{ return null; }
}
function writeKey2Cache(ds,set){
  sessionStorage.setItem(`key2set_${ds.ymdSlash}_${ds.shift}`, JSON.stringify({ts:Date.now(), list:[...set]}));
}

/* åªç”¨æœ¬åœ°å¿«å–ï¼ˆä¸æ‰“ç¶²è·¯ï¼‰å– key2 é›† */
function getKey2SetFromCacheOnly(ds){
  const cached = readKey2Cache(ds);
  if (!cached || !Array.isArray(cached.list)) return new Set();
  return new Set(cached.list); // è¶…æ™‚ä¹Ÿæ²¿ç”¨
}

/* æ¸²æŸ“åªçœ‹ item.strike */
function renderRows(list){
  const body=$('#recordList');
  body.innerHTML='';
  if(!list.length){
    body.innerHTML='<tr><td colspan="3" style="color:#888">ï¼ˆç•¶ç­ç„¡è‰ç¨¿ï¼‰</td></tr>';
    return;
  }
  for(const it of list){
    const tr=document.createElement('tr');
    if(it.strike) tr.classList.add('strike');
    tr.dataset.key2 = it.key2 || '';
    tr.dataset.ts   = String(it.ts||Date.now());
    tr.innerHTML = `<td>${it.part_no}</td><td>${it.lot}</td><td>${it.qty}</td>`;
    body.appendChild(tr);
  }
}
async function renderDrafts(){
  const list=getDraftList(currentDS).slice().sort((a,b)=> (b.ts||0)-(a.ts||0));
  renderRows(list);
}

/* ç”¨ç¾æœ‰å¿«å–æ¨™è¨˜äº‹æœ‰è‰ç¨¿ strikeï¼›TTL æœŸé–“ä¸åŠƒç·š */
function markOldDraftsStrikeWithCache(ds){
  const set=getKey2SetFromCacheOnly(ds);
  const now=Date.now();
  const list=getDraftList(ds);
  for(const it of list){
    if(!it.key2){ it.strike=false; continue; }
    if(ENABLE_RECENT_KEY2_PROTECT && now-(it.ts||0)<RECENT_KEY2_TTL_MS){
      it.strike=false;
    }else{
      it.strike=!set.has(it.key2);
    }
  }
  saveDraftList(ds,list);
}

/* upsert è‰ç¨¿ï¼ˆæ–°ç¨¿é è¨­ strike=falseï¼‰ */
function upsertDraftAfterSubmit(payload, strike=false){
  const ds=currentDS;
  const list=getDraftList(ds);
  const key = makeKey(currentDS.mmdd, currentDS.shift, payload.part_no, payload.lot);
  const key2= makeKey2(currentDS.mmdd, currentDS.shift, payload.lot, Number(payload.qty));
  const nowTs=Date.now();
  const item={part_no:payload.part_no, lot:payload.lot, qty:Number(payload.qty), key, key2, ts:nowTs, strike};
  const idx=list.findIndex(x=>x.key===key);
  if(idx>=0) list[idx]=item; else list.push(item);
  if(list.length>50) list.splice(0, list.length-50);
  saveDraftList(ds,list);
  return {key2,nowTs};
}

/* é€å‡ºæˆåŠŸ â†’ åªæ›´æ–°è‰ç¨¿ä¸¦é‡ç¹ªï¼ˆä¸å³æ™‚æ¯”å°ï¼‰ */
async function handleSubmitSuccess(payload){
  markOldDraftsStrikeWithCache(currentDS); // ç”¨èˆŠå¿«å–æ¨™è¨˜æ—¢æœ‰è‰ç¨¿
  upsertDraftAfterSubmit(payload,false);   // æ–°ç¨¿ä¸åŠƒç·š
  await renderDrafts();                    // ç«‹å³é‡ç¹ª
}

/* å®šæ™‚ï¼šæŠ“å¾Œç«¯ list_recent â†’ æ›´æ–°å¿«å– â†’ é‡æ¨™ strike â†’ é‡ç¹ªï¼ˆç›¸å®¹æ¥µç°¡å›å‚³ï¼‰ */
let __polling=false;
async function refreshCacheAndRepaint(){
  if(__polling) return;
  __polling=true;
  try{
    const j=await listRecent();
    let arr=[];
    if(Array.isArray(j)) arr=j;
    else if(j && j.status==='ok' && Array.isArray(j.data)) arr=j.data;
    const set=new Set(arr.map(r=> String((r.key2||""))));
    writeKey2Cache(currentDS,set);
    markOldDraftsStrikeWithCache(currentDS);
    await renderDrafts();
  }catch(e){ console.warn('refreshCacheAndRepaint failed:',e); }
  finally{ __polling=false; }
}
let __pollTimer=null;
function startPolling(){
  if(__pollTimer) clearInterval(__pollTimer);
  __pollTimer=setInterval(()=>{ if(document.visibilityState==='visible') refreshCacheAndRepaint(); }, POLL_INTERVAL_MS);
}
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') refreshCacheAndRepaint(); });

/* é€å‡º */
let clearPartOnce=false;
partNo.addEventListener('focus',()=>{ if(clearPartOnce){ partNo.value=''; clearPartOnce=false; } });

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const inspectorVal=CANON(inspector.value);
  const part=CANON(partNo.value);
  const prefix=CANON(lotPrefix.value);

  if(!/^[A-Z0-9]{5}$/.test(inspectorVal)){ setFieldError(inspector,inspectorError,'éœ€ 5 ç¢¼è‹±æ•¸'); inspector.focus(); return; }
  setFieldError(inspector,inspectorError,''); persistInspectorIfValid(inspectorVal);

  if(!part){ setFieldError(partNo,partError,'æ–™è™Ÿå¿…å¡«'); partNo.focus(); return; }
  if(!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(part)){ setFieldError(partNo,partError,'æ ¼å¼éŒ¯èª¤ï¼ˆå¦‚ A58K052ï¼‰'); partNo.focus(); return; }
  setFieldError(partNo,partError,'');

  const r=parseLot(lotInput.value);
  if(!r.ok){ setFieldError(lotInput,lotError,r.msg); lotInput.focus(); return; }
  setFieldError(lotInput,lotError,'');
  const motherChild=r.mother+(r.hasChild?('-'+r.child):'');
  lotInput.value=motherChild;

  const q=Number(qty.value);
  if(!(q>0)){ alert('æ•¸é‡éœ€ > 0'); return; }

  const lotDisp = prefix ? `${prefix}-${motherChild}` : motherChild;

  const now=nowCorrected();
  const payload={
    date: currentDS.ymdSlash,          // ä¸€å¾‹æ–œç·š yyyy/MM/dd
    shift: currentDS.shift,
    part_no: part,
    lot: lotDisp,
    qty: String(q),
    inspector: inspectorVal,
    submitted_at: fmtTW(now)           // æ–œç·šå®Œæ•´æ™‚é–“
  };

  const btn=$('#sendBtn'); btn.disabled=true; showCenter('è³‡æ–™å‚³é€ä¸­â€¦');
  try{
    const data=await submitData({
      ...payload,
      // å¦‚ GAS å›å‚³æ¥µç°¡ {ok:1,mode:'add|update'} ä¹Ÿèƒ½ç›¸å®¹
    });
    const ok = (data && (data.status==='ok' || data.ok===1));
    if(!ok){
      hideCenter(); showCenter('âŒ å¾Œç«¯ï¼š'+(data && (data.msg||data.error)||'unknown')); setTimeout(hideCenter,1600); return;
    }
    await handleSubmitSuccess(payload);
    hideCenter(); showOk((data.mode==='update')?'âœ… å·²æ›´æ–°':'âœ… å·²æ–°å¢');
    lotInput.value=''; qty.value=''; clearPartOnce=true;
  }catch(err){
    hideCenter(); showCenter('âŒ é€£ç·šå¤±æ•—ï¼š'+String(err)); setTimeout(hideCenter,1600);
  }finally{
    btn.disabled=false;
  }
});

/* åˆå§‹åŒ– + ä¿æº« */
const LAST_DS_KEY='draft_last_ds_key';
$('#versionTag').textContent=`ç‰ˆæœ¬ï¼š${FORM_VERSION}`;

(async ()=>{
  await initClockOffsetSmart();
  refreshDisplays();
  setInterval(refreshDisplays,1000);

  const savedId = localStorage.getItem(INSPECTOR_STORE)||''; if(savedId) inspector.value = savedId;

  // åˆ‡æ›ç­åˆ¥æ¸…ç•¶ç­èˆŠè‰ç¨¿éµ
  const dsKey=`${currentDS.ymdSlash}|${currentDS.shift}`;
  const lastKey=localStorage.getItem(LAST_DS_KEY)||'';
  if(lastKey && lastKey!==dsKey){ localStorage.removeItem(`draft_${lastKey.replace('|','_')}`); }
  localStorage.setItem(LAST_DS_KEY, dsKey);

  await renderDrafts();          // å…ˆç”¨è‰ç¨¿æ¸²æŸ“
  startPolling();                // é–‹å§‹ 15s è¼ªè©¢
  refreshCacheAndRepaint();      // ç«‹å³åŒæ­¥ä¸€æ¬¡

  // GAS ä¿æº«ï¼ˆæ¯ 4 åˆ†é˜ pingï¼‰
  setInterval(()=>{ fetch(`${API_BASE}?action=ping&t=${Date.now()}`,{cache:'no-store'}).catch(()=>{}); }, PING_INTERVAL_MS);
})();
</script>
</body>
</html>