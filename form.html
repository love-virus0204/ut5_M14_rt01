<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RTå¤–è§€æŠ½é©—è¨˜éŒ„è¡¨ Â· v14.1</title>
<style>
  :root{--pad:12px;--label:92px;--maxw:820px;}
  body{background:#f7f7f7;margin:0;display:flex;justify-content:center}
  .wrap{width:100%;max-width:var(--maxw);padding:var(--pad);box-sizing:border-box}
  .topbar{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:.5rem;
          padding-bottom:.5rem;border-bottom:1px solid #d9d9d9;margin-bottom:.75rem}
  .icon{background:transparent;border:none;font-size:1.35rem;cursor:pointer;padding:.35rem;border-radius:8px}
  header{font-family:"DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif;
          font-weight:700;text-align:center}
  .row{display:flex;align-items:center;gap:.75rem;margin:.55rem 0}
  .label{flex:0 0 var(--label);text-align:center;font-weight:700;
         font-family:"DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif}
  .value{flex:1}
  input,select{width:100%;padding:.5rem;font-size:1rem;border:1px solid #cfcfcf;border-radius:8px;box-sizing:border-box}
  textarea{width:100%;min-height:68px;border:1px solid #cfcfcf;border-radius:8px;background:#f0f0f0;color:#666;resize:none}
  .btn{border:none;background:#007bff;color:#fff;padding:.75rem 1.1rem;border-radius:10px;font-weight:700;min-width:40%}
  hr{border:none;border-top:1px solid #d9d9d9;margin:.75rem 0}
  .tbl-head{display:flex;gap:.5rem;font-weight:700;color:#555;
            font-family:"DFKai-SB","BiauKai","PMingLiU","MingLiU","Noto Serif TC","KaiTi",serif}
  .tbl-head .c{flex:1;text-align:center}
  .rec{display:flex;gap:.5rem;padding:.35rem .25rem;border-bottom:1px dashed #e5e5e5}
  .rec .c{flex:1;text-align:center}
  /* é¦–åˆ—æ™‚é–“/ç­åˆ¥å€ */
  .status{display:grid;grid-template-columns:1fr 1fr;align-items:center}
  .status .ts{justify-self:start;font-family:ui-monospace,Menlo,Consolas,monospace}
  .status .ds{justify-self:center;font-weight:700}
</style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <button class="icon" id="langBtn" title="æ›´æ”¹èªè¨€">ğŸŒ</button>
    <header>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</header>
    <button class="icon" id="backBtn" title="è¿”å›ä¸Šä¸€é ">â†©ï¸</button>
  </div>

  <!-- é¦–åˆ—ï¼šå·¦=æ¨™æº–æ—¥æœŸï¼›ä¸­=ç•¶æ—¥ç•¶ç­ -->
  <div class="row">
    <div class="label">ã€€</div>
    <div class="value status">
      <span class="ts" id="tsView">YYYY-MM-DD HH:mm</span>
      <span class="ds" id="dsView">MM/DD - -</span>
    </div>
  </div>

  <div class="row">
    <div class="label">æŠ½ã€€é©—ï¼š</div>
    <div class="value"><input id="inspector" placeholder="è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ"></div>
  </div>

  <div class="row">
    <div class="label">æ–™ã€€è™Ÿï¼š</div>
    <div class="value"><input id="part_no" placeholder="è«‹è¼¸å…¥ æ–™è™Ÿ by 7ç¢¼"></div>
  </div>

  <!-- æ‰¹è™Ÿï¼šå·¦=FA ä¸‹æ‹‰ï¼›å³=æ¯æ‰¹[-å­æ‰¹] åŒä¸€æ ¼ -->
  <div class="row">
    <div class="label">æ‰¹ã€€è™Ÿï¼š</div>
    <div class="value">
      <div style="display:grid;grid-template-columns:.6fr 1fr;gap:.5rem">
        <select id="lot_prefix">
          <option value=""></option>
          <option value="FA">FA</option>
        </select>
        <input id="mother_child" placeholder="æ¯æ‰¹[-å­æ‰¹]ï¼ˆæ¯æ‰¹3ç¢¼è‹±æ•¸ç¦O/Iï¼›å­æ‰¹2ç¢¼æ•¸å­—ï¼‰">
      </div>
    </div>
  </div>

  <!-- ç°è‰²æ‰¹è™Ÿé¡¯ç¤ºå€ï¼šå·²å–æ¶ˆ -->

  <div class="row">
    <div class="label">æ•¸ã€€é‡ï¼š</div>
    <div class="value"><input id="qty" type="number" min="0" placeholder="è¼¸å…¥æ‰¹é‡"></div>
  </div>

  <div class="row">
    <div class="label">å‚™ã€€è¨»ï¼š</div>
    <div class="value"><textarea id="remark" readonly placeholder="ç›®å‰ä¸é–‹æ”¾è¼¸å…¥"></textarea></div>
  </div>

  <div class="row" style="justify-content:flex-end">
    <div class="value" style="text-align:right"><button class="btn" id="submitBtn">é€å‡º</button></div>
  </div>

  <hr>
  <div class="tbl-head"><div class="c">æ–™ã€€è™Ÿ</div><div class="c">æ‰¹ã€€è™Ÿ</div><div class="c">æ•¸ã€€é‡</div></div>
  <hr>
  <div id="list"></div>

</div>

<script>
const GAS_URL   = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const API_TOKEN = "MY_SECRET_123";

document.getElementById('backBtn').onclick=()=>{ if(history.length>1) history.back(); };

/* ====== æ‰¹è™Ÿæ­£è¦åŒ–ï¼ˆå…©æ ¼ï¼šFA + æ¯æ‰¹[-å­æ‰¹]ï¼‰ ====== */
const $prefix=document.getElementById('lot_prefix');
const $mc    =document.getElementById('mother_child');

function normMC(raw){
  let s=String(raw||'').trim().toUpperCase();
  if(!s) return {ok:false,msg:"æ¯æ‰¹å¿…å¡«",mother:"",child:""};
  const parts=s.split('-').map(v=>v.trim());
  let mother=parts[0];
  if(!/^[A-Z0-9]{3}$/.test(mother) || /[OI]/.test(mother)) return {ok:false,msg:"æ¯æ‰¹éœ€3ç¢¼è‹±æ•¸ä¸”ä¸å¾—å«O/I"};
  let child="";
  if(s.includes('-')){
    if(!parts[1]||!/^\d{1,2}$/.test(parts[1])) return {ok:false,msg:"å­æ‰¹éœ€1~2ç¢¼æ•¸å­—"};
    child=('0'+parts[1]).slice(-2);
  }
  return {ok:true,mother,child};
}

/* ====== ç­åˆ¥èˆ‡æ—¥æœŸï¼ˆUTC+8ã€å« 80 åˆ†å¯¬é™ï¼‰ï¼Œé¡¯ç¤ºï¼šå·¦=YYYY-MM-DD HH:mmï¼›ä¸­=MM/DD - ç­ ====== */
function nowTPE(){ const n=new Date(); return new Date(n.getTime()+(8-n.getTimezoneOffset()/60)*3600*1000); }
function fmtYMDHM(d){return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')} ${String(d.getUTCHours()).padStart(2,'0')}:${String(d.getUTCMinutes()).padStart(2,'0')}`;}
function fmtMD(d){return `${String(d.getUTCMonth()+1).padStart(2,'0')}/${String(d.getUTCDate()).padStart(2,'0')}`;}
function addDaysUTC(d,n){const x=new Date(d);x.setUTCDate(x.getUTCDate()+n);return x;}
function setUTC(h,m){const n=nowTPE();return new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),h,m,0));}

function calcShift(){
  const n=nowTPE(); const H=n.getUTCHours(), M=n.getUTCMinutes(), mins=H*60+M;
  const md=fmtMD(n);
  const prev=fmtMD(addDaysUTC(n,-1));
  if(mins>=8*60+40 && mins<16*60+40) return {dateMD:md,   shift:'A', next:setUTC(16,40)};
  if(mins>=16*60+40)                  return {dateMD:md,   shift:'B', next:addDaysUTC(setUTC(0,40),1)};
  if(mins<40)                         return {dateMD:prev, shift:'B', next:setUTC(0,40)};
  return {dateMD:prev, shift:'C', next:setUTC(8,40)};
}
function anchorIfNeeded(){
  const store=JSON.parse(localStorage.getItem('ds_anchor')||'{}');
  const nowMs=nowTPE().getTime();
  if(!store.until || nowMs>store.until){
    const a=calcShift(); const until=a.next.getTime()+80*60000;
    const obj={date:a.dateMD,shift:a.shift,until};
    localStorage.setItem('ds_anchor',JSON.stringify(obj));
    return obj;
  }
  return store;
}
function tick(){
  const n=nowTPE();
  const ds=anchorIfNeeded();
  document.getElementById('tsView').textContent=fmtYMDHM(n); // å·¦ï¼šæ¨™æº–æ—¥æœŸæ™‚é–“
  document.getElementById('dsView').textContent=`${ds.date} - ${ds.shift}`; // ä¸­ï¼šç•¶æ—¥ ç•¶ç­
}
tick(); setInterval(tick,30000); document.addEventListener('visibilitychange',()=>{ if(!document.hidden) tick(); });

/* ====== æ¸…å–®ï¼ˆåƒ…é¡¯ç¤º deleted===TRUEï¼›å€’åºï¼›æœ€å¤š 50ï¼‰ ====== */
async function refreshList(){
  const list=document.getElementById('list'); list.innerHTML='';
  try{
    const res=await fetch(`${GAS_URL}?limit=50`); const data=await res.json();
    const rows=(Array.isArray(data)?data:[]).filter(r=>r.deleted===true);
    rows.sort((a,b)=>String(b.submitted_at||'').localeCompare(String(a.submitted_at||'')));
    for(const r of rows.slice(0,50)){
      const div=document.createElement('div');div.className='rec';
      div.innerHTML=`<div class="c">${r.part_no||''}</div><div class="c">${r.lot||''}</div><div class="c">${r.qty||''}</div>`;
      list.appendChild(div);
    }
  }catch(e){ console.error(e); }
}
refreshList();

/* ====== é€å‡ºï¼ˆé©—è­‰ï¼‹é¿å…é‡è¤‡ï¼‰ ====== */
document.getElementById('submitBtn').addEventListener('click', async (e)=>{
  e.preventDefault();

  const inspector=(document.getElementById('inspector').value||'').trim();
  const part=      (document.getElementById('part_no').value||'').trim().toUpperCase();
  const prefix=    ($prefix.value||'').trim().toUpperCase();
  const mc=        normMC($mc.value);
  const qty=Number((document.getElementById('qty').value||'').trim());

  if(!/^[A-Za-z0-9]{5}$/.test(inspector)) return alert('è«‹è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ');
  if(!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(part)) return alert('æ–™è™Ÿæ ¼å¼éŒ¯èª¤ï¼ˆä¾‹ï¼šA58K052ï¼‰');
  if(!prefix) return alert('è«‹é¸æ“‡æ‰¹è™Ÿå‰ç¶´ï¼ˆåƒ… FAï¼‰');
  if(!mc.ok) return alert(mc.msg);
  if(!Number.isFinite(qty)||qty<=0) return alert('æ•¸é‡éœ€å¤§æ–¼ 0');

  const payload={
    token:API_TOKEN,
    inspector, part_no:part,
    lot_prefix:prefix,
    mother_child:`${mc.mother}${mc.child?'-'+mc.child:''}`,
    qty:String(qty),
    remark:""
  };

  const btn=document.getElementById('submitBtn'); btn.disabled=true;
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
    const data=await res.json();
    if(data.status==='ok'){
      alert(data.upsert==='update'?'âœ… å·²æ›´æ–°åŸè¨˜éŒ„':'âœ… å·²æ–°å¢');
      document.getElementById('qty').value=''; $mc.value='';
      refreshList();
    }else{
      alert('âŒ '+JSON.stringify(data));
    }
  }catch(err){ alert('é€å‡ºéŒ¯èª¤ï¼š'+err.message); }
  finally{ btn.disabled=false; }
});
</script>
</body>
</html>