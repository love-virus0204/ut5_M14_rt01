<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</title>
<style>
  body { font-family: "Comic Sans MS", sans-serif; margin: 10px; }
  h1 { display: flex; justify-content: space-between; align-items: center; margin: 0 0 10px 0; }
  h1 span { font-family: "æ¨™æ¥·é«”", serif; font-weight: bold; }
  .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .top-left { text-align: left; font-size: 14px; flex: 1; }
  .top-center { text-align: center; font-size: 16px; font-weight: bold; flex: 1; }
  .label { font-family: "æ¨™æ¥·é«”", serif; display: inline-block; width: 70px; text-align: center; }
  input, select, textarea {
    width: calc(100% - 90px);
    margin-bottom: 8px;
    padding: 5px;
    font-family: "Comic Sans MS", sans-serif;
  }
  textarea[readonly] { background-color: #f2f2f2; color: #555; }
  #sendBtn { display: block; margin-left: auto; margin-top: 10px; padding: 8px 20px; background: #007bff; color: white; border: none; border-radius: 5px; }
  hr { margin: 15px 0; }
  table { width: 100%; border-collapse: collapse; text-align: center; font-size: 14px; }
  th, td { border-top: 1px solid #ddd; padding: 5px; }
</style>
</head>
<body>
<h1>
  <span>ğŸŒ</span>
  <span>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</span>
  <button id="backBtn" style="background:none;border:none;font-size:18px;">â†©ï¸</button>
</h1>

<div class="top-row">
  <div id="tsView" class="top-left"></div>
  <div id="dsView" class="top-center"></div>
</div>

<label class="label">æŠ½ é©—ï¼š</label><input type="text" id="inspector" placeholder="è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ"><br>
<label class="label">æ–™ è™Ÿï¼š</label><input type="text" id="partNo" placeholder="è«‹è¼¸å…¥ æ–™è™Ÿ by 7ç¢¼"><br>

<!-- ç¬¬ä¸€åˆ—ï¼šä¸‹æ‹‰ -->
<div style="margin-bottom:5px;">
  <select id="lotPrefix" style="width:100px;">
    <option value=""></option>
    <option value="FA">FA</option>
  </select>
</div>
<!-- ç¬¬äºŒåˆ—ï¼šæ‰¹è™Ÿè¼¸å…¥ -->
<label class="label">æ‰¹ è™Ÿï¼š</label><input type="text" id="lotInput" placeholder="æ¯æ‰¹[-å­æ‰¹] (æ¯æ‰¹3ç¢¼è‹±æ•¸ç¦O/I)"><br>

<label class="label">æ•¸ é‡ï¼š</label><input type="number" id="qty" placeholder="è¼¸å…¥æ‰¹é‡"><br>
<label class="label">å‚™ è¨»ï¼š</label><textarea id="remark" readonly>ç›®å‰ä¸é–‹æ”¾è¼¸å…¥</textarea><br>

<button id="sendBtn">é€å‡º</button>

<hr>
<table>
  <thead>
    <tr><th>æ–™ è™Ÿ</th><th>æ‰¹ è™Ÿ</th><th>æ•¸ é‡</th></tr>
  </thead>
  <tbody id="recordList"></tbody>
</table>

<script>
const GAS_URL   = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const API_TOKEN = "MY_SECRET_123";

document.getElementById('backBtn').onclick=()=>{ if(history.length>1) history.back(); };

// --- æ™‚é–“èˆ‡ç­åˆ¥ ---
function fmtLocal(d){
  const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');
  const hh=String(d.getHours()).padStart(2,'0'),mm=String(d.getMinutes()).padStart(2,'0');
  return `${y}-${m}-${day} ${hh}:${mm}`;
}
function calcShift(){
  const now=new Date(), mins=now.getHours()*60+now.getMinutes();
  if(mins>=520 && mins<1000) return 'A';
  if(mins>=1000 || mins<40) return 'B';
  return 'C';
}
function tick(){
  const n=new Date();
  document.getElementById('tsView').textContent=fmtLocal(n);
  const md=`${String(n.getMonth()+1).padStart(2,'0')}/${String(n.getDate()).padStart(2,'0')}`;
  document.getElementById('dsView').textContent=`${md} - ${calcShift()}`;
}
tick();
setInterval(tick,30000);

// --- é©—è­‰èˆ‡é€å‡º ---
function normLot(raw){
  let s=String(raw||'').trim().toUpperCase();
  if(!s) return {ok:false,msg:"æ¯æ‰¹å¿…å¡«"};
  const parts=s.split('-');
  const mother=parts[0];
  if(!/^[A-Z0-9]{3}$/.test(mother) || /[OI]/.test(mother)) return {ok:false,msg:"æ¯æ‰¹éœ€3ç¢¼è‹±æ•¸ä¸”ä¸å¾—å«O/I"};
  let child="";
  if(parts.length>1){
    if(!/^\d{1,2}$/.test(parts[1])) return {ok:false,msg:"å­æ‰¹éœ€1~2ç¢¼æ•¸å­—"};
    child=('0'+parts[1]).slice(-2);
  }
  return {ok:true,mother,child};
}

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const inspector=document.getElementById('inspector').value.trim();
  const part=document.getElementById('partNo').value.trim().toUpperCase();
  const prefix=document.getElementById('lotPrefix').value.trim().toUpperCase();
  const lotRaw=normLot(document.getElementById('lotInput').value);
  const qty=Number(document.getElementById('qty').value);

  if(!/^[A-Za-z0-9]{5}$/.test(inspector)) return alert("è«‹è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ");
  if(!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(part)) return alert("æ–™è™Ÿæ ¼å¼éŒ¯èª¤");
  if(!prefix) return alert("è«‹é¸æ“‡æ‰¹è™Ÿå‰ç¶´");
  if(!lotRaw.ok) return alert(lotRaw.msg);
  if(!Number.isFinite(qty) || qty<=0) return alert("æ•¸é‡éœ€å¤§æ–¼0");

  const payload={
    token:API_TOKEN,
    inspector,
    part_no:part,
    lot_prefix:prefix,
    mother_child:`${lotRaw.mother}${lotRaw.child?'-'+lotRaw.child:''}`,
    qty:String(qty),
    remark:""
  };

  const btn=document.getElementById('sendBtn');
  btn.disabled=true;
  try{
    const res=await fetch(GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body:JSON.stringify(payload)
    });
    const data=await res.json();
    if(data.status==='ok'){
      alert(data.upsert==='update'?'âœ… å·²æ›´æ–°åŸè¨˜éŒ„':'âœ… å·²æ–°å¢');
      document.getElementById('lotInput').value='';
      document.getElementById('qty').value='';
      refreshList();
    }else{
      alert("âŒ "+JSON.stringify(data));
    }
  }catch(err){
    alert("é€å‡ºéŒ¯èª¤ï¼š"+err.message);
  }finally{
    btn.disabled=false;
  }
});

// --- è¼‰å…¥åˆ—è¡¨ ---
async function refreshList(){
  const tbody=document.getElementById('recordList'); tbody.innerHTML='';
  try{
    const res=await fetch(GAS_URL);
    const data=await res.json();
    const rows=(Array.isArray(data)?data:[]).filter(r=>r.deleted===true);
    rows.sort((a,b)=>String(b.submitted_at||'').localeCompare(String(a.submitted_at||'')));
    for(const r of rows.slice(0,50)){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.part_no||''}</td><td>${r.lot||''}</td><td>${r.qty||''}</td>`;
      tbody.appendChild(tr);
    }
  }catch(err){console.error(err);}
}
refreshList();
</script>
</body>
</html>