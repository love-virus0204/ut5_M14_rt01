<!doctype html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RT 外觀抽驗記錄表</title>
<style>
  :root{--maxw:520px; --labelw:92px;}
  body{margin:0;background:#f5f5f5;font-family:"Comic Sans MS",sans-serif}
  .wrap{max-width:var(--maxw);margin:8px auto;padding:10px 14px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .toolbar{display:grid;grid-template-columns:36px auto 36px;align-items:center;margin-bottom:6px}
  .tool-left{justify-self:start}
  .tool-right{justify-self:end}
  .tool-btn{background:none;border:0;font-size:18px;line-height:1;padding:2px 6px;cursor:pointer}
  .title{font-family:"標楷體",serif;text-align:center;font-weight:700;margin:0;font-size:1.35rem}
  @media (max-width: 400px){ .title{font-size:1.18rem} }.ds-line{font-weight:700;margin:8px 0 10px 0; padding-left:20px;}

.row{display:grid;grid-template-columns:var(--labelw) 1fr;align-items:center;column-gap:10px;margin:6px 0} .label{font-family:"標楷體",serif;text-align:center} .ctrl{width:100%} .ctrl input,.ctrl select{width:100%;box-sizing:border-box;padding:7px;border:1px solid #ccc;border-radius:6px;font-family:"Comic Sans MS",sans-serif} .row.lot-type .ctrl{display:grid;grid-template-columns:25% 1fr;column-gap:8px} .row.lot-type select{min-width:80px}

.field-error{display:none;color:#d93025;font-weight:700;font-size:13px;margin-top:4px} .input-error{ border-color:#d93025 !important; }

.submit{position:relative;display:flex;justify-content:flex-end;align-items:center;margin-top:10px} .submit-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:12px} .btn{background:#0a66ff;color:#fff;border:0;border-radius:8px;padding:10px 18px;cursor:pointer}

.ok-msg{display:none;color:#1a7f37;font-weight:700;font-size:13px} .ok-msg.show{display:block;opacity:1;transition:opacity .4s} .ok-msg.fade{opacity:0}

hr{margin:10px 0} .bottom-info{display:grid;grid-template-columns:1fr 1fr;align-items:center;margin:6px 0} .ver-left{justify-self:start;font-size:12px;color:#666} .time-right{justify-self:end;font-size:12px;color:#333;text-align:right} .post{width:95%;margin:0 auto} table{width:100%;border-collapse:collapse;font-size:14px} th,td{border-top:1px solid #ddd;text-align:center;padding:6px 4px} </style>

</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="tool-left"><button class="tool-btn" id="langBtn" title="語言">🌐</button></div>
    <h1 class="title">RT 外觀抽驗記錄表</h1>
    <div class="tool-right"><button class="tool-btn" id="backBtn" title="返回" onclick="location.href='index.html'">↩️</button></div>
  </div>  <div id="dsView" class="ds-line"></div>  <div class="row">
    <div class="label">檢驗員：</div>
    <div class="ctrl">
      <input id="inspector" maxlength="5" placeholder="輸入 5 碼工號">
      <div id="inspectorError" class="field-error"></div>
    </div>
  </div>  <div class="row">
    <div class="label">料　號：</div>
    <div class="ctrl">
      <input id="partNo" maxlength="7" placeholder="輸入 7碼料號">
      <div id="partError" class="field-error"></div>
    </div>
  </div>  <div class="row lot-type">
    <div class="label">型　態：</div>
    <div class="ctrl">
      <select id="lotPrefix">
        <option value=""></option>
        <option value="FA">FA</option>
      </select>
      <div></div>
    </div>
  </div>  <div class="row">
    <div class="label">批　號：</div>
    <div class="ctrl">
      <input id="lotInput" placeholder="母批(3碼) or 母批-子批(3-2)；禁 I / O">
      <div id="lotError" class="field-error"></div>
    </div>
  </div>  <div class="row">
    <div class="label">數　量：</div>
    <div class="ctrl"><input id="qty" type="number" min="1" placeholder="輸入 批量"></div>
  </div>  <div class="submit" id="submit-row">
    <div class="submit-center"><div id="okMsg" class="ok-msg"></div></div>
    <button id="sendBtn" class="btn">送出</button>
  </div>  <hr>  <div class="bottom-info">
    <div id="versionTag" class="ver-left">版本：v17.10.6</div>
    <div id="tsView" class="time-right"></div>
  </div>  <div class="post">
    <table>
      <thead><tr><th>料　號</th><th>批　號</th><th>數　量</th></tr></thead>
      <tbody id="recordList"><tr><td colspan="3" style="color:#888">（當班無草稿）</td></tr></tbody>
    </table>
  </div>
</div><script>
const FORM_VERSION="v17.10.6";
const API_BASE="https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";

const $=s=>document.querySelector(s);
function CANON(s){return String(s||"").replace(/\s+/g,"").toUpperCase()}
function pad2(n){return String(n).padStart(2,'0')}
function fmtYMDslash(d){return d.getFullYear()+"/"+pad2(d.getMonth()+1)+"/"+pad2(d.getDate())}
function fmtTW(d){return d.getFullYear()+"/"+pad2(d.getMonth()+1)+"/"+pad2(d.getDate())+" "+pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds())}

/* ===== 班別與時間：純本機時間 ===== */
function nowCorrected(){ return new Date(); }
function computeShift(d){
  const mins=d.getHours()*60+d.getMinutes();
  if(mins>=40 && mins<520){ const y=new Date(d); y.setDate(d.getDate()-1); return {baseDate:y,ymdSlash:fmtYMDslash(y),shift:'C'}; }
  if(mins>=520 && mins<1000) return {baseDate:d,ymdSlash:fmtYMDslash(d),shift:'A'};
  return {baseDate:d,ymdSlash:fmtYMDslash(d),shift:'B'};
}
let currentDS=null;
function refreshDisplays(){
  const now=nowCorrected();
  currentDS=computeShift(now);
  $('#dsView').textContent=`${currentDS.ymdSlash} - ${currentDS.shift}`;
  $('#tsView').textContent=fmtTW(now);
}

/* ===== API (GET) ===== */
function apiGet(params){
  const search=new URLSearchParams(params);
  search.append("t",Date.now());
  return fetch(`${API_BASE}?${search.toString()}`,{method:"GET",mode:"cors",cache:"no-store"}).then(r=>r.json()).catch(()=>({status:"fail"}));
}
function submitData(p){ return apiGet({action:"submit",...p}); }
function listRecent(){ return apiGet({action:"list_recent"}); }

/* ===== 草稿B：{料號,批號,數量,key,送出成功時間,狀態} ===== */
function dsStorageKey(ds){ return `draft_${ds.ymdSlash}_${ds.shift}`; }
function getDraftList(ds){ try{ return JSON.parse(localStorage.getItem(dsStorageKey(ds))||'[]'); }catch{return [];} }
function saveDraftList(ds,list){ localStorage.setItem(dsStorageKey(ds), JSON.stringify(list||[])); }
function makeKey(mmdd,shift,part,lot){ return `${mmdd}|${shift}|${part}|${lot}`; }

function renderDrafts(){
  const list=getDraftList(currentDS).slice().sort((a,b)=> (b.ts||0)-(a.ts||0));
  const body=$('#recordList');
  body.innerHTML='';
  if(!list.length){ body.innerHTML='<tr><td colspan="3" style="color:#888">（當班無草稿）</td></tr>'; return; }
  for(const it of list){
    const tr=document.createElement('tr');
    tr.style.color = (it.status==='更新')? '#ff4d94':'#1a7f37';
    tr.innerHTML=`<td>${it.part_no}</td><td>${it.lot}</td><td>${it.qty}</td>`;
    body.appendChild(tr);
  }
}

function upsertDraftAfterSubmit(payload,status){
  const list=getDraftList(currentDS);
  const key=makeKey(currentDS.ymdSlash.split('/').slice(1).join('/'), currentDS.shift, payload.part_no, payload.lot);
  const nowTs=Date.now();
  const item={part_no:payload.part_no, lot:payload.lot, qty:Number(payload.qty), key, ts:nowTs, status};
  const idx=list.findIndex(x=>x.key===key);
  if(idx>=0) list[idx]=item; else list.push(item);
  if(list.length>50) list.splice(0,list.length-50);
  saveDraftList(currentDS,list);
}

async function handleSubmitSuccess(payload,mode){
  upsertDraftAfterSubmit(payload,mode==='update'?'更新':'新增');
  renderDrafts();
}

/* ===== 送出事件 ===== */
const inspector=$('#inspector'), inspectorError=$('#inspectorError');
const partNo=$('#partNo'), partError=$('#partError');
const lotPrefix=$('#lotPrefix'), lotInput=$('#lotInput'), lotError=$('#lotError');
const qty=$('#qty'), okMsg=$('#okMsg');

function setFieldError(inputEl,hintEl,msg){
  if(!inputEl||!hintEl) return;
  if(msg){ inputEl.classList.add('input-error'); hintEl.textContent=msg; hintEl.style.display='block'; }
  else { inputEl.classList.remove('input-error'); hintEl.textContent=''; hintEl.style.display='none'; }
}

function parseLot(input){
  const s=CANON(input);
  if(!s) return {ok:false,msg:'母批必填（3碼）'};
  if(s.includes('-')){
    const [m,c]=s.split('-',2);
    if(!m||!/^[A-HJ-NP-Z0-9]{3}$/.test(m)) return {ok:false,msg:'母批需正好 3 碼'};
    if(!c||!/^[0-9]{1,2}$/.test(c)) return {ok:false,msg:'子批需 1~2 位數字'};
    return {ok:true,mother:m,child:c.padStart(2,'0'),hasChild:true};
  }
  if(!/^[A-HJ-NP-Z0-9]{3}$/.test(s)) return {ok:false,msg:'母批需正好 3 碼'};
  return {ok:true,mother:s,child:'',hasChild:false};
}

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const inspectorVal=CANON(inspector.value);
  if(!/^[A-Z0-9]{5}$/.test(inspectorVal)){ setFieldError(inspector,inspectorError,'需 5 碼英數'); return; }
  setFieldError(inspector,inspectorError,'');

  const part=CANON(partNo.value);
  if(!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(part)){ setFieldError(partNo,partError,'格式錯誤'); return; }
  setFieldError(partNo,partError,'');

  const r=parseLot(lotInput.value);
  if(!r.ok){ setFieldError(lotInput,lotError,r.msg); return; }
  setFieldError(lotInput,lotError,'');
  const motherChild=r.mother+(r.hasChild?('-'+r.child):'');
  const q=Number(qty.value);
  if(!(q>0)){ setFieldError(qty,qty,'數量需>0'); return; }

  const payload={
    date: currentDS.ymdSlash,
    shift: currentDS.shift,
    part_no: part,
    lot: motherChild,
    qty: String(q),
    inspector: inspectorVal,
    submitted_at: fmtTW(nowCorrected())
  };

  const btn=$('#sendBtn'); btn.disabled=true;
  try{
    const data=await submitData(payload);
    if(!(data && (data.status==='ok'||data.ok===1))){ btn.disabled=false; return; }
    await handleSubmitSuccess(payload,data.mode||'add');
    lotInput.value=''; qty.value='';
  }finally{ btn.disabled=false; }
});

/* ===== 初始化 ===== */
(async ()=>{
  refreshDisplays();
  setInterval(refreshDisplays,1000);
  renderDrafts();
  // 保溫：每 5 分鐘 ping 一次，但不做時間校正
  setInterval(()=>{ fetch(`${API_BASE}?action=ping&t=${Date.now()}`,{cache:'no-store'}).catch(()=>{}); }, 300000);
})();
</script></body>
</html>