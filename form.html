<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</title>
<style>
  body { font-family:"Comic Sans MS",sans-serif; margin:10px; }
  h1 { display:flex; justify-content:space-between; align-items:center; margin:0 0 10px 0; }
  h1 span { font-family:"æ¨™æ¥·é«”",serif; font-weight:bold; }
  .top-row{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; margin-bottom:10px; }
  .top-left{ justify-self:start; font-size:14px; }
  .top-center{ justify-self:center; font-size:16px; font-weight:bold; }
  .label{ font-family:"æ¨™æ¥·é«”",serif; display:inline-block; width:70px; text-align:center; }
  input,select,textarea{ width:calc(100% - 90px); margin-bottom:8px; padding:5px; font-family:"Comic Sans MS",sans-serif; }
  select.select-narrow{ width:calc((100% - 90px) * 0.25); }
  textarea[readonly]{ background:#f2f2f2; color:#555; }
  #sendBtn{ display:block; margin-left:auto; margin-top:10px; padding:8px 20px; background:#007bff; color:#fff; border:none; border-radius:5px; }
  .version-line{ font-size:12px; color:#666; text-align:left; margin-top:6px; }
  hr{ margin:10px 0 15px 0; }
  table{ width:100%; border-collapse:collapse; text-align:center; font-size:14px; }
  th,td{ border-top:1px solid #ddd; padding:5px; }
</style>
</head>
<body>
<h1>
  <span>ğŸŒ</span>
  <span>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</span>
  <button id="backBtn" style="background:none;border:none;font-size:18px;">â†©ï¸</button>
</h1>

<div class="top-row">
  <div id="tsView" class="top-left"></div>
  <div id="dsView" class="top-center"></div>
  <div></div>
</div>

<label class="label">æŠ½ã€€é©—ï¼š</label><input type="text" id="inspector" placeholder="è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ"><br/>
<label class="label">æ–™ã€€è™Ÿï¼š</label><input type="text" id="partNo" placeholder="è«‹è¼¸å…¥ æ–™è™Ÿ by 7ç¢¼"><br/>

<label class="label">å‹ã€€æ…‹ï¼š</label>
<select id="lotPrefix" class="select-narrow">
  <option value=""></option>
  <option value="FA">FA</option>
</select><br>

<label class="label">æ‰¹ã€€è™Ÿï¼š</label>
<input type="text" id="lotInput" placeholder="æ¯æ‰¹[-å­æ‰¹] (æ¯æ‰¹3ç¢¼è‹±æ•¸ç¦O/I)"><br/>

<label class="label">æ•¸ã€€é‡ï¼š</label><input type="number" id="qty" placeholder="è¼¸å…¥æ‰¹é‡"><br/>
<label class="label">å‚™ã€€è¨»ï¼š</label><textarea id="remark" readonly>ç›®å‰ä¸é–‹æ”¾è¼¸å…¥</textarea><br/>

<button id="sendBtn">é€å‡º</button>

<div class="version-line" id="verLine">valï¼š16.1</div>
<hr/>

<table>
  <thead><tr><th>æ–™ã€€è™Ÿ</th><th>æ‰¹ã€€è™Ÿ</th><th>æ•¸ã€€é‡</th></tr></thead>
  <tbody id="recordList"></tbody>
</table>

<script>
/* ===== å¸¸æ•¸ ===== */
const GAS_URL   = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const API_TOKEN = "MY_SECRET_123";
const INSPECTOR_KEY = 'inspector_id';
const DRAFT_PREFIX  = 'rt_draft_';     // + dsKey
const DSKEY_KEY     = 'rt_draft_dskey';

/* ===== è¿”å› ===== */
document.getElementById('backBtn').onclick=()=>{ if(history.length>1) history.back(); };

/* ===== ç­åˆ¥éŒ¨å®š ===== */
function fmtLocal(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0'),hh=String(d.getHours()).padStart(2,'0'),mm=String(d.getMinutes()).padStart(2,'0');return `${y}-${m}-${day} ${hh}:${mm}`;}
function mdOf(d){return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;}
function addDays(d,n){const x=new Date(d); x.setDate(x.getDate()+n); return x;}
function computeDS(now){
  const mins=now.getHours()*60+now.getMinutes();
  let dateMD,shift,next;
  if(mins>=520 && mins<1000){ dateMD=mdOf(now);            shift='A'; next=new Date(now.getFullYear(),now.getMonth(),now.getDate(),16,40,0); }
  else if(mins>=1000){        dateMD=mdOf(now);            shift='B'; next=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,40,0); }
  else if(mins<40){           dateMD=mdOf(addDays(now,-1));shift='B'; next=new Date(now.getFullYear(),now.getMonth(),now.getDate(),8,40,0); }
  else{                       dateMD=mdOf(addDays(now,-1));shift='C'; next=new Date(now.getFullYear(),now.getMonth(),now.getDate(),8,40,0); }
  return {dateMD,shift,until: next.getTime()+80*60000};
}
function anchorDS(){
  const k='ds_anchor', now=Date.now();
  let a; try{ a=JSON.parse(localStorage.getItem(k)||'{}'); }catch{ a={}; }
  const invalid=!a||typeof a!=='object'||!a.dateMD||!a.shift||!a.until||now>a.until;
  if(invalid){ const c=computeDS(new Date()); a={dateMD:c.dateMD,shift:c.shift,until:c.until}; localStorage.setItem(k,JSON.stringify(a)); }
  return a;
}
function dsKeyOf(a){ return `${a.dateMD}|${a.shift}`; }
function tick(){ const n=new Date(); const a=anchorDS(); document.getElementById('tsView').textContent=fmtLocal(n); document.getElementById('dsView').textContent=`${a.dateMD} - ${a.shift}`; }
tick(); setInterval(tick,30000); document.addEventListener('visibilitychange',()=>{ if(!document.hidden) tick(); });

/* ===== å·¥è™ŸæŒä¹…åŒ– ===== */
function loadInspector(){
  try{ const v=localStorage.getItem(INSPECTOR_KEY)||''; if(/^[A-Za-z0-9]{5}$/.test(v)) document.getElementById('inspector').value=v; }catch{}
}
function maybeSaveInspector(){
  const v=(document.getElementById('inspector').value||'').trim();
  if(/^[A-Za-z0-9]{5}$/.test(v)){ try{ localStorage.setItem(INSPECTOR_KEY,v); }catch{} }
}
document.getElementById('inspector').addEventListener('blur', maybeSaveInspector);
document.getElementById('inspector').addEventListener('input', maybeSaveInspector);
loadInspector();

/* ===== è‰ç¨¿æ©Ÿåˆ¶ï¼ˆä¾ç­æ¬¡ï¼‰ ===== */
function draftKey(){ return DRAFT_PREFIX + dsKeyOf(anchorDS()); }
function saveDraft(){
  const d={
    part: (document.getElementById('partNo').value||'').toUpperCase(),
    lot:  (document.getElementById('lotInput').value||'').toUpperCase(),
    qty:  document.getElementById('qty').value||'',
    prefix:(document.getElementById('lotPrefix').value||'').toUpperCase()
  };
  try{ localStorage.setItem(draftKey(), JSON.stringify(d)); localStorage.setItem(DSKEY_KEY, dsKeyOf(anchorDS())); }catch{}
}
function loadDraft(){
  // è‹¥è·¨ç­ï¼ˆä¸Šæ¬¡å„²å­˜ dsKey != ç›®å‰ dsKeyï¼‰ï¼Œæ¸…ç©ºè‰ç¨¿
  const curKey = dsKeyOf(anchorDS());
  let lastKey=''; try{ lastKey = localStorage.getItem(DSKEY_KEY)||''; }catch{}
  if(lastKey && lastKey!==curKey){ try{ localStorage.removeItem(DRAFT_PREFIX+lastKey); }catch{} localStorage.setItem(DSKEY_KEY, curKey); }

  try{
    const raw = localStorage.getItem(draftKey());
    if(!raw) return;
    const d = JSON.parse(raw);
    if(typeof d==='object'){
      if(d.part)   document.getElementById('partNo').value = d.part;
      if(d.lot)    document.getElementById('lotInput').value = d.lot;
      if(d.qty)    document.getElementById('qty').value = d.qty;
      if('prefix' in d) document.getElementById('lotPrefix').value = d.prefix||'';
    }
  }catch{}
}
function clearDraftKeepPart(){
  // ä¿ç•™æ–™è™Ÿï¼›æ¸…ç©ºæ‰¹è™Ÿ/æ•¸é‡ï¼›ä¿å­˜
  const part = (document.getElementById('partNo').value||'').toUpperCase();
  document.getElementById('lotInput').value='';
  document.getElementById('qty').value='';
  try{
    localStorage.setItem(draftKey(), JSON.stringify({part, lot:'', qty:'', prefix:(document.getElementById('lotPrefix').value||'').toUpperCase()}));
    localStorage.setItem(DSKEY_KEY, dsKeyOf(anchorDS()));
  }catch{}
}
function clearDraftAllExceptLangAndInspector(){
  document.getElementById('partNo').value='';
  document.getElementById('lotInput').value='';
  document.getElementById('qty').value='';
  document.getElementById('lotPrefix').value='';
  try{ localStorage.removeItem(draftKey()); localStorage.setItem(DSKEY_KEY, dsKeyOf(anchorDS())); }catch{}
}
// åˆå§‹åŒ–è¼‰å…¥è‰ç¨¿
loadDraft();

// è‰ç¨¿å³æ™‚ä¿å­˜ï¼ˆç•¶æ—¥ç•¶ç­ä¸è®Šæ™‚ï¼‰
['partNo','lotInput','qty','lotPrefix'].forEach(id=>{
  document.getElementById(id).addEventListener('input', saveDraft);
});

/* ===== æ‰¹è™Ÿæ­£è¦åŒ– ===== */
function normLotInput(raw){
  let s=String(raw||'').trim().toUpperCase();
  if(!s) return {ok:false,msg:"æ¯æ‰¹å¿…å¡«"};
  const parts=s.split('-'); const mother=parts[0];
  if(!/^[A-Z0-9]{3}$/.test(mother) || /[OI]/.test(mother)) return {ok:false,msg:"æ¯æ‰¹éœ€3ç¢¼è‹±æ•¸ä¸”ä¸å¾—å«O/I"};
  let child=""; if(parts.length>1){ if(!/^\d{1,2}$/.test(parts[1])) return {ok:false,msg:"å­æ‰¹éœ€1~2ç¢¼æ•¸å­—"}; child=('0'+parts[1]).slice(-2); }
  return {ok:true,mother,child};
}

/* ===== æ¸…å–® ===== */
async function refreshList(){
  const tbody=document.getElementById('recordList'); tbody.innerHTML='';
  try{
    const r=await fetch(GAS_URL); const data=await r.json();
    const rows=(Array.isArray(data)?data:[]).filter(x=>x.deleted===true);
    rows.sort((a,b)=>String(b.submitted_at||'').localeCompare(String(a.submitted_at||'')));
    for(const x of rows.slice(0,50)){
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.part_no||''}</td><td>${x.lot||''}</td><td>${x.qty||''}</td>`; tbody.appendChild(tr);
    }
  }catch(e){ console.error(e); }
}
refreshList();

/* ===== å‚³é€è¼”åŠ© ===== */
async function postJSON(url, payload){
  let res,text;
  try{ res=await fetch(url,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)}); }
  catch(e){ throw new Error(`ç¶²è·¯éŒ¯èª¤ï¼š${e.message}`); }
  text=await res.text();
  if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} â€” ${text.slice(0,200)}`);
  try{ return JSON.parse(text); }catch(e){ throw new Error(`å›æ‡‰é JSONï¼š${text.slice(0,200)}`); }
}

/* ===== é€å‡º ===== */
let clearPartOnce = false;
document.getElementById('partNo').addEventListener('focus', ()=>{
  if(clearPartOnce){
    document.getElementById('partNo').value='';
    clearPartOnce = false;
    saveDraft(); // åŒæ­¥è‰ç¨¿è®Šæ›´
  }
});

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const inspector=document.getElementById('inspector').value.trim();
  const part=document.getElementById('partNo').value.trim().toUpperCase();
  const prefix=document.getElementById('lotPrefix').value.trim().toUpperCase(); // "" æˆ– "FA"
  const lotChk=normLotInput(document.getElementById('lotInput').value);
  const qty=Number(document.getElementById('qty').value);
  const a=anchorDS();

  // è‹¥ç­åˆ¥éµè®Šå‹•ï¼ˆä¾‹å¦‚éŒ¨å®šéæœŸï¼‰ï¼Œä¾è¦å‰‡æ¸…å…‰ï¼ˆä¿ç•™å·¥è™Ÿï¼‰
  const stored = localStorage.getItem(DSKEY_KEY)||'';
  if(stored && stored!==dsKeyOf(a)){ clearDraftAllExceptLangAndInspector(); }

  if(!/^[A-Za-z0-9]{5}$/.test(inspector)) return alert("è«‹è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ");
  if(!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(part)) return alert("æ–™è™Ÿæ ¼å¼éŒ¯èª¤ï¼ˆå¦‚ A58K052ï¼‰");
  if(!lotChk.ok) return alert(lotChk.msg);
  if(!Number.isFinite(qty) || qty<=0) return alert("æ•¸é‡éœ€å¤§æ–¼ 0");

  const payload={
    token:API_TOKEN,
    date:a.dateMD, shift:a.shift,
    inspector,
    part_no:part,
    lot_prefix:prefix,
    mother_child:`${lotChk.mother}${lotChk.child?'-'+lotChk.child:''}`,
    qty:String(qty),
    remark:""
  };

  const btn=document.getElementById('sendBtn'); btn.disabled=true;
  try{
    const data=await postJSON(GAS_URL,payload);
    if(data.status==='ok'){
      alert(data.upsert==='update'?'âœ… å·²æ›´æ–°åŸè¨˜éŒ„':'âœ… å·²æ–°å¢');
      maybeSaveInspector();
      clearDraftKeepPart();     // ä¿ç•™æ–™è™Ÿã€æ¸…ç©ºæ‰¹è™Ÿèˆ‡æ•¸é‡ä¸¦ä¿å­˜è‰ç¨¿
      clearPartOnce = true;     // ä¸‹æ¬¡é»æ–™è™Ÿæ™‚æ¸…ç©º
      refreshList();
    }else{
      alert('âŒ å¾Œç«¯å›è¦†ï¼š'+JSON.stringify(data));
    }
  }catch(err){ alert('é€å‡ºéŒ¯èª¤ï¼š'+err.message); }
  finally{ btn.disabled=false; }
});
</script>
</body>
</html>