<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</title>
<style>
/* ====== åŸæª” CSSï¼ˆä¿ç•™ï¼‰ ====== */
:root { --fg:#111; --muted:#666; --err:#c00; --ok:#0a0; --bd:#ddd; --bg:#fff; --hint:#888; }
* { box-sizing: border-box; }
body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,PingFang TC,Microsoft JhengHei,sans-serif; color:var(--fg); background:var(--bg); margin:0; }
.wrap { max-width: 960px; margin: 0 auto; padding: 12px; }
.toolbar { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 8px; padding: 6px 0; }
.tool-left, .tool-right { display:flex; gap:8px; }
.tool-btn { border:1px solid var(--bd); background:#f8f8f8; border-radius:8px; padding:6px 10px; font-size:14px; }
.title { text-align:center; font-weight:700; font-size:18px; margin:6px 0 10px; }
.ds-line { font-weight:700; margin: 6px 0 10px; padding-left: 2px; }
.row { display:grid; grid-template-columns: 110px 1fr; align-items:center; gap:8px; padding:6px 0; border-top:1px dashed var(--bd); }
.row:first-child { border-top:none; }
.label { color:var(--muted); font-size:14px; letter-spacing:1px; }
.ctrl input[type="text"], .ctrl input[type="number"]{ width:100%; font-size:16px; padding:10px 12px; border:1px solid var(--bd); border-radius:8px; outline:none; }
.ctrl input::placeholder{ color:var(--hint); }
.field-error { display:none; grid-column: 2 / span 1; color: var(--err); font-size: 13px; }
.input-error { border-color: var(--err); }
.actions { display:flex; gap:8px; padding-top:12px; align-items:center; }
.btn { padding:10px 14px; font-size:16px; border-radius:10px; border:1px solid var(--bd); background:#f7f7f7; }
.ver-left { color:var(--muted); font-size:12px; }
.dots{ display:none; color:var(--muted); font-size:14px; }
.ok-msg{ color:var(--ok); font-size:14px; display:none; }
.list { margin-top:14px; border-top:1px solid var(--bd); }
.table { width:100%; border-collapse:collapse; }
.table th,.table td{ border-bottom:1px solid var(--bd); padding:8px 6px; font-size:14px; text-align:left; }
.table th{ background:#fafafa; font-weight:600; }
.muted{ color:var(--muted); font-size:12px; }
.draft-stale { text-decoration: line-through; }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="tool-left"><button class="tool-btn" id="langBtn" title="èªè¨€">ğŸŒ</button></div>
    <h1 class="title">RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</h1>
    <div class="tool-right"><button class="tool-btn" id="backBtn" title="è¿”å›" onclick="location.href='index.html'">â†©ï¸</button></div>
  </div>

  <div id="dsView" class="ds-line"></div>

  <div class="row">
    <div class="label">æª¢ã€€é©—ï¼š</div>
    <div class="ctrl">
      <input id="inspector" type="text" placeholder="è«‹è¼¸å…¥æª¢é©—å“¡">
      <div class="field-error" id="err-inspector"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ–™ã€€è™Ÿï¼š</div>
    <div class="ctrl">
      <input id="part" type="text" inputmode="latin" placeholder="å¦‚ A12B345">
      <div class="field-error" id="err-part"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ‰¹ã€€è™Ÿï¼š</div>
    <div class="ctrl">
      <input id="lot" type="text" placeholder="æ‰¹è™Ÿ">
      <div class="field-error" id="err-lot"></div>
    </div>
  </div>

  <div class="row">
    <div class="label">æ•¸ã€€é‡ï¼š</div>
    <div class="ctrl">
      <input id="qty" type="number" inputmode="numeric" step="1" min="1" placeholder="æ­£æ•´æ•¸">
      <div class="field-error" id="err-qty"></div>
    </div>
  </div>

  <!-- éš±è—ï¼šä¸€æ¬¡æ€§é–å®š -->
  <input id="date" type="hidden">
  <input id="shift" type="hidden">

  <div class="actions">
    <button id="sendBtn" class="btn" type="submit" form="form">é€å‡º</button>
    <div class="muted" id="status"></div>
  </div>

  <div class="list">
    <table class="table" id="recentTable">
      <thead><tr><th>æ—¥æœŸ</th><th>ç­åˆ¥</th><th>æª¢é©—å“¡</th><th>æ–™è™Ÿ</th><th>æ‰¹è™Ÿ</th><th>æ•¸é‡</th></tr></thead>
      <tbody id="recentBody"><tr><td colspan="6" class="muted">ç„¡è³‡æ–™</td></tr></tbody>
    </table>
  </div>

  <div class="post">
    <div class="bottom-info">
      <div id="versionTag" class="ver-left">ç‰ˆæœ¬ï¼šv17.7.6</div>
    </div>
  </div>
</div>

<!-- ===== åŸæª”æ‰€æœ‰æ—¢æœ‰è…³æœ¬ï¼šé©—è­‰ã€submit ç¶å®šã€æ¸…å–®æ¸²æŸ“ç­‰ï¼ˆä¿ç•™ï¼‰ ===== -->
<script>
/* é€™è£¡ä¿ç•™ä½ åŸå§‹ v17.6 çš„é©—è­‰èˆ‡é€å‡ºç­‰é‚è¼¯ã€‚è‹¥ä½ çš„æª”æ¡ˆåŸæœ¬å°±æœ‰ï¼Œè«‹ä¿ç•™ã€‚ */
</script>

<!-- ===== è¿½åŠ è£œä¸ï¼šè¡Œç‚ºå±¤ä¿®æ­£ï¼ˆä¸æ”¹æ¨™é¡Œ/æ’ç‰ˆ/æ—¢æœ‰é©—è­‰ï¼‰ ===== -->
<script>
(function(){
  "use strict";
  if (window.__patch_v201__) return; window.__patch_v201__ = true;

  const DS_KEY="ds_ymd_once", SHIFT_KEY="ds_shift_once";
  const DRAFT = { inspector:"draft_inspector", part:"draft_part", lot:"draft_lot", qty:"draft_qty" };
  const TZ_DELTA_KEY="tzTWDeltaMs";
  const API_URL = (window.API_URL || window.scriptURL || "");

  function $(id){ return document.getElementById(id); }
  function setText(id, msg){ const el=$(id); if(el){ el.textContent=msg||""; el.style.display=msg?"block":"none"; } }
  function tpeNow(){ return new Date(Date.now()+ (Number(localStorage.getItem(TZ_DELTA_KEY)||0)||0)); }
  function ymd(d){ return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`; }

  async function ensureTZ(){
    try{
      if (Intl.DateTimeFormat().resolvedOptions().timeZone==="Asia/Taipei"){
        localStorage.setItem(TZ_DELTA_KEY,"0"); return;
      }
    }catch{}
    try{
      const r = await fetch("https://worldtimeapi.org/api/timezone/Asia/Taipei",{cache:"no-store"});
      if (r.ok){
        const j=await r.json();
        localStorage.setItem(TZ_DELTA_KEY,String(j.unixtime*1000 - Date.now()));
      }
    }catch{}
  }

  function computeDS(now){
    const m=now.getHours()*60+now.getMinutes();
    let shift="A";
    if (m>=520 && m<=999) shift="A";
    else if (m>=1000 || m<=39) shift="B";
    else shift="C";
    const d=new Date(now);
    if (shift==="C") d.setDate(d.getDate()-1);
    return { ymd:ymd(d), shift, md:ymd(d).slice(5) };
  }

  async function initDS(){
    await ensureTZ();
    const ds=computeDS(tpeNow());
    localStorage.setItem(DS_KEY,ds.ymd);
    localStorage.setItem(SHIFT_KEY,ds.shift);
    if ($("date")) $("date").value=ds.ymd;
    if ($("shift")) $("shift").value=ds.shift;
    const dsline=document.getElementById("dsView") || document.getElementById("ds-line");
    if (dsline) dsline.textContent=`${ds.md}-${ds.shift}`;

    const lastDS=localStorage.getItem(DS_KEY+"_prev")||"", lastSH=localStorage.getItem(SHIFT_KEY+"_prev")||"";
    if (lastDS && (lastDS!==ds.ymd || lastSH!==ds.shift)){
      localStorage.removeItem(DRAFT.part);
      localStorage.removeItem(DRAFT.lot);
      localStorage.removeItem(DRAFT.qty);
      if ($("part")) $("part").value="";
      if ($("lot"))  $("lot").value="";
      if ($("qty"))  $("qty").value="";
    } else {
      if ($("part") && !$("part").value) $("part").value=localStorage.getItem(DRAFT.part)||"";
      if ($("lot")  && !$("lot").value) $("lot").value =localStorage.getItem(DRAFT.lot)||"";
      if ($("qty")  && !$("qty").value) $("qty").value =localStorage.getItem(DRAFT.qty)||"";
    }
    localStorage.setItem(DS_KEY+"_prev",ds.ymd);
    localStorage.setItem(SHIFT_KEY+"_prev",ds.shift);

    if ($("inspector")){
      const ins=localStorage.getItem(DRAFT.inspector)||"";
      if(!$("inspector").value&&ins) $("inspector").value=ins;
      $("inspector").addEventListener("change",function(){
        const v=this.value.trim();
        if(v) localStorage.setItem(DRAFT.inspector,v);
      });
    }
  }

  function buildParams(){
    const p=new URLSearchParams();
    const ds={ date:localStorage.getItem(DS_KEY)||$("date")?.value||"", shift:localStorage.getItem(SHIFT_KEY)||$("shift")?.value||"" };
    p.set("action","upsert");
    p.set("inspector",$("inspector")?.value?.trim()||"");
    p.set("part_no",$("part")?.value?.trim()||"");
    p.set("lot",$("lot")?.value?.trim()||"");
    p.set("qty",String($("qty")?.value||"").trim());
    p.set("date",ds.date); p.set("shift",ds.shift);
    return p;
  }

  async function sendGET(params){
    const base=String(API_URL||"").replace(/^http:\/\//i,"https://");
    if(!/^https?:\/\//i.test(base)) throw new Error("bad_api_url");
    const url=base+"?"+params.toString();
    try{
      const r=await fetch(url,{method:"GET",cache:"no-store"});
      if(!r.ok) throw new Error("http_"+r.status);
      return await r.json(); // æœŸæœ› {ok:true}
    }catch(e){ try{ new Image().src=url+"&_="+Date.now(); }catch{} throw e; }
  }

  document.addEventListener("DOMContentLoaded",function(){
    initDS().catch(()=>{});
    const form=document.getElementById("form") || document.querySelector("form");
    const btn=document.getElementById("sendBtn");
    if(!form) return;

    form.addEventListener("submit",async function(e){
      if(e.defaultPrevented) return; // è®“ä½ çš„åŸé©—è­‰å…ˆè¡Œ
      try{
        if(btn) btn.disabled=true;
        const res=await sendGET(buildParams());
        if(res&&res.ok===true){
          // æˆåŠŸå¾Œï¼šæ¸…æ‰¹è™Ÿ/æ•¸é‡ï¼Œæ–™è™Ÿä¿ç•™ä½†é€å‡ºå¾Œé¦–æ¬¡é»æ“Šæ‰æ¸…
          if($("lot")) $("lot").value="";
          if($("qty")) $("qty").value="";
          localStorage.setItem(DRAFT.lot,"");
          localStorage.setItem(DRAFT.qty,"");
          const el=$("part");
          if(el){
            const once=function(){
              el.value="";
              el.removeEventListener("focus",once);
              el.removeEventListener("click",once);
              try{localStorage.removeItem(DRAFT.part);}catch{}
            };
            el.addEventListener("focus",once,{once:false});
            el.addEventListener("click",once,{once:false});
          }
          const okMsg=document.getElementById("okMsg"); if(okMsg){ okMsg.textContent="å·²å¯«å…¥"; okMsg.style.display="block"; setTimeout(()=>okMsg.style.display="none",1500); }
        }
      }catch(_){
        const status=document.getElementById("status"); if(status){ status.textContent="ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤"; status.style.color="#c00"; }
      }finally{
        if(btn) btn.disabled=false;
      }
    },{capture:true});
  });
})();
</script>

</body>
</html>