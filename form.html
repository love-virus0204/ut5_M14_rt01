<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RT外觀抽驗記錄表</title>
<style>
  body { font-family: "Comic Sans MS", sans-serif; margin: 10px; }
  h1 { font-family: "DFKai-sb", serif; text-align: center; margin-bottom: 5px; }
  label { font-family: "DFKai-sb", serif; display: inline-block; width: 70px; text-align: center; }
  .row { display: flex; align-items: center; margin-bottom: 6px; }
  .row input, .row select { flex: 1; padding: 6px; font-family: "Comic Sans MS", sans-serif; }
  .lot-select { flex: 0 0 25%; margin-right: 5px; }
  #versionTag { font-size: 0.8em; color: gray; margin: 5px 0 0 2px; }
  #recordsTable { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.9em; }
  #recordsTable th, #recordsTable td { border-bottom: 1px solid #ddd; text-align: center; padding: 4px; }
</style>
</head>
<body>
  <div class="header">
    <h1>RT外觀抽驗記錄表</h1>
    <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
      <div id="timestamp" style="text-align:left;font-size:0.9em;"></div>
      <div id="dateShift" style="text-align:center;font-size:1em;font-weight:bold;"></div>
    </div>
  </div>

  <div class="row">
    <label>檢驗員：</label>
    <input id="inspector" maxlength="5" placeholder="輸入 5 碼工號">
  </div>

  <div class="row">
    <label>料　號：</label>
    <input id="partNo" maxlength="7" placeholder="請輸入 料號 by 7碼">
  </div>

  <div class="row">
    <label>型　態：</label>
    <select id="lotPrefix" class="lot-select">
      <option value=""> </option>
      <option value="FA">FA</option>
    </select>
    <input id="lotCombined" maxlength="7" placeholder="母批[-子批] (母批3碼英數禁O/I)">
  </div>

  <div class="row">
    <label>數　量：</label>
    <input id="qty" type="number" min="1" placeholder="輸入批量">
  </div>

  <div class="row">
    <label>備　註：</label>
    <input id="remark" value="目前不開放輸入" disabled>
  </div>

  <div class="row" style="justify-content:flex-end;">
    <button id="submitBtn" style="padding:6px 20px;">送出</button>
  </div>

  <hr>
  <div id="versionTag">版本：v17.2</div>
  <table id="recordsTable">
    <thead><tr><th>料號</th><th>批號</th><th>數量</th></tr></thead>
    <tbody id="recordsBody"></tbody>
  </table>

<script>
const STORAGE_KEY = "RT_FORM_DRAFT_v17";
const inspectorField = document.getElementById("inspector");
const partNoField = document.getElementById("partNo");
const lotPrefix = document.getElementById("lotPrefix");
const lotCombined = document.getElementById("lotCombined");
const qtyField = document.getElementById("qty");
const dateShiftEl = document.getElementById("dateShift");
const timestampEl = document.getElementById("timestamp");

// ===== 即時時間與當班判斷 =====
function updateClock() {
  const now = new Date();
  timestampEl.textContent = now.toLocaleString("zh-TW", {hour12:false});
}
setInterval(updateClock, 1000); updateClock();

function calcShift() {
  const now = new Date();
  let hour = now.getHours(), min = now.getMinutes();
  let shift = "A";
  if (hour>=8 && (hour<16 || (hour==16 && min<40))) shift="A";
  else if ((hour>16 || (hour==16&&min>=40)) || hour<0) shift="B";
  if (hour<8 || (hour==0 && min<40)) shift="C";
  const dateStr = now.toLocaleDateString("zh-TW",{month:"2-digit",day:"2-digit"});
  dateShiftEl.textContent = `${dateStr} - ${shift}`;
  return {date:dateStr,shift};
}
let currentShift = calcShift();

// ===== 草稿機制 =====
function loadDraft(){
  const d = JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
  if(d.inspector) inspectorField.value = d.inspector;
  if(d.partNo) partNoField.value = d.partNo;
  if(d.lotPrefix) lotPrefix.value = d.lotPrefix;
  if(d.lotCombined) lotCombined.value = d.lotCombined;
  if(d.qty) qtyField.value = d.qty;
}
function saveDraft(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify({
    inspector: inspectorField.value.toUpperCase(),
    partNo: partNoField.value.toUpperCase(),
    lotPrefix: lotPrefix.value,
    lotCombined: lotCombined.value.toUpperCase(),
    qty: qtyField.value
  }));
}
[inspectorField,partNoField,lotPrefix,lotCombined,qtyField].forEach(el=>{
  el.addEventListener("input",saveDraft);
});
loadDraft();

// ===== 送出處理 =====
document.getElementById("submitBtn").addEventListener("click", async ()=>{
  const inspector = inspectorField.value.trim().toUpperCase();
  const partNo = partNoField.value.trim().toUpperCase();
  const lot = lotCombined.value.trim().toUpperCase();
  const prefix = lotPrefix.value;
  if(!inspector || inspector.length!==5){ alert("請輸入5碼檢驗員工號"); return; }
  if(!partNo || partNo.length!==7){ alert("料號需7碼"); return; }
  if(!lot || lot.length<3){ alert("請輸入完整母批/子批"); return; }
  const fullLot = (prefix?prefix+"-":"")+lot;
  const qty = parseInt(qtyField.value)||0;
  if(qty<=0){ alert("數量需>0"); return; }

  const key = `${currentShift.date}|${currentShift.shift}|${partNo}|${fullLot}`;
  try {
    const res = await fetch("YOUR_GAS_DEPLOY_URL",{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ date:currentShift.date, shift:currentShift.shift,
        part_no:partNo, lot_full:fullLot, qty:qty, inspector:inspector, key:key })
    });
    if(!res.ok) throw new Error("伺服器錯誤");
    alert("✅已送出/更新");
    lotCombined.value=""; qtyField.value=""; saveDraft();
    loadRecords(); //刷新清單
  } catch(e){
    alert("❌送出失敗："+e.message);
  }
});

// ===== 模擬清單 (可改為呼叫 GAS 讀取) =====
function loadRecords(){
  const tbody = document.getElementById("recordsBody");
  tbody.innerHTML = "";
  // 假資料移除：後端成功送出後填充
}
loadRecords();
</script>
</body>
</html>