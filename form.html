<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RT 外觀抽驗記錄表 v17.10.7</title>
<style>
  :root{--labelw:88px;}
  body{font-family:"Comic Sans MS",sans-serif;margin:0;padding:0;}
  header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;}
  header h1{flex:1;text-align:center;font-family:"標楷體";margin:0;}
  label{display:inline-block;width:var(--labelw);text-align:center;font-family:"標楷體";}
  input,select{font-family:"Comic Sans MS",sans-serif;padding:6px;margin:2px;width:64%;}
  .row{display:flex;align-items:center;padding:4px 10px;}
  .btn{display:inline-block;padding:10px 16px;background:#007bff;color:#fff;border:none;border-radius:8px;cursor:pointer;float:right;}
  .bar{padding:0 10px;}
  .status{margin-top:6px;text-align:center;font-weight:700;height:22px;}
  .green{color:#0a0;}
  .red{color:#c00;}
  .loading{display:none;text-align:center;margin-top:4px;font-weight:700;}
  hr{margin:12px 0;}
  .draft-wrap{padding:0 10px 14px;}
  .draft-item{padding:4px 0;text-align:center;}
  .draft-item.deleted{color:#888;text-decoration:line-through;}
  .hint{font-size:12px;color:#c00;padding-left:calc(var(--labelw) + 12px);min-height:16px;}
  .okmsg{font-size:14px;color:green;text-align:center;height:18px;}
  .topline{font-weight:700;margin:8px 0 10px 0;padding-left:20px;}
  .head-icons{width:24px;height:24px;cursor:pointer;}
  .badge{font-family:"標楷體";font-size:12px;color:#444;text-align:center;margin:6px 0;}
</style>
</head>
<body>
  <header>
    <img src="lang.png" alt="🌐" class="head-icons" />
    <h1>RT 外觀抽驗記錄表</h1>
    <a href="index.html"><img src="back.png" alt="返回" class="head-icons"/></a>
  </header>

  <div class="bar">
    <div class="topline" id="dsLine">當日當班：</div>
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="flex:1;"></div>
      <div id="nowStr" style="font-weight:700;text-align:center;">--:--:--</div>
      <div style="flex:1;text-align:right;" class="badge">v17.10.7</div>
    </div>
  </div>

  <div class="row">
    <label>檢驗員：</label>
    <input id="inspector" type="text" placeholder="請輸入工號" autocomplete="off"/>
  </div>

  <div class="row">
    <label>料　號：</label>
    <input id="partNo" type="text" placeholder="輸入 7碼料號" autocomplete="off"/>
  </div>
  <div class="hint" id="partHint"></div>

  <div class="row">
    <label>批　號：</label>
    <input id="lot" type="text" placeholder="FA-001 or 001-01" autocomplete="off"/>
  </div>
  <div class="hint" id="lotHint"></div>

  <div class="row">
    <label>批　量：</label>
    <input id="qty" type="number" placeholder="輸入 批量" inputmode="numeric"/>
  </div>

  <div class="bar">
    <button class="btn" id="submitBtn">送出</button>
    <div class="status" id="statusMsg"></div>
    <div class="loading" id="loading">傳送中...</div>
  </div>

  <hr/>

  <div class="draft-wrap">
    <div class="okmsg" id="okMsg"></div>
    <div id="draftList"></div>
  </div>

<script>
const API_BASE="https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";

/* 時間/班別 */
function computeShift(d){const hm=d.getHours()*100+d.getMinutes();if(hm>=840&&hm<1640)return"A";if(hm>=1640||hm<40)return"B";return"C";}
function mmdd(d){const m=String(d.getMonth()+1).padStart(2,"0");const day=String(d.getDate()).padStart(2,"0");return`${m}/${day}`;}
function currentDS(){const now=new Date();return `${mmdd(now)}|${computeShift(now)}`;}
function updateUIClock(){const now=new Date();const h=String(now.getHours()).padStart(2,"0");const m=String(now.getMinutes()).padStart(2,"0");const s=String(now.getSeconds()).padStart(2,"0");document.getElementById("nowStr").textContent=`${h}:${m}:${s}`;document.getElementById("dsLine").textContent=`當日當班：${currentDS().replace("|"," ")}`;}
setInterval(updateUIClock,1000);updateUIClock();

/* 草稿 */
function draftKeyName(){return `draft_${currentDS()}`;}
function loadDraft(){const raw=localStorage.getItem(draftKeyName());return raw?JSON.parse(raw):[];}
function saveDraft(list){localStorage.setItem(draftKeyName(),JSON.stringify(list));}
function renderDraft(){const list=loadDraft().sort((a,b)=>b.ts-a.ts);const box=document.getElementById("draftList");box.innerHTML=list.map(x=>`<div class="${x.deleted?"draft-item deleted":"draft-item"}">${x.part_no} ${x.lot} ${x.qty}</div>`).join("")||`<div style="text-align:center;color:#888;">（無草稿）</div>`;}

/* 後端 key2 快取 */
let key2Cache={t:0,set:new Set(),hot:new Set()};
const CACHE_REFRESH_MS=15000, HOT_TTL_MS=8000;
async function refreshKey2Cache(){try{const r=await fetch(`${API_BASE}?action=list_recent`);const data=await r.json();key2Cache.set=new Set(data.map(x=>String(x.key2||"")));key2Cache.t=Date.now();reconcileDraftWithCache();}catch(e){}}
setInterval(refreshKey2Cache,CACHE_REFRESH_MS);refreshKey2Cache();

/* 草稿對比 */
function reconcileDraftWithCache(){const list=loadDraft();let changed=false;const now=Date.now();for(const d of list){if(key2Cache.hot.has(d.key2)&&(now-d.hotAt)<HOT_TTL_MS){if(d.deleted){d.deleted=false;changed=true;}continue;}const shouldExist=key2Cache.set.has(d.key2);const newDeleted=!shouldExist;if(newDeleted!==!!d.deleted){d.deleted=newDeleted;changed=true;}}if(changed){saveDraft(list);renderDraft();}}

/* 即時驗證 */
const $=s=>document.querySelector(s);
const inspector=$("#inspector"),partNo=$("#partNo"),lot=$("#lot"),qty=$("#qty");
const partHint=$("#partHint"),lotHint=$("#lotHint"),statusMsg=$("#statusMsg"),okMsg=$("#okMsg"),loading=$("#loading");
function validInspector(v){return /^[0-9A-Z]{4,6}$/.test(v.toUpperCase());}
function validPart(v){return /^[0-9A-Z]{7}$/.test(v.toUpperCase());}
function sanitizeLot(v){v=(v||"").trim().toUpperCase();if(!v)return{ok:false,msg:"批號必填"};let prefix="",mid="";if(v.includes("-")){[prefix,mid]=v.split("-");}else{prefix=v;}if(!/^[0-9A-HJ-NP-Z]{3}$/.test(prefix))return{ok:false,msg:"母批須為3碼，且不可含 I/O"};if(mid){if(!/^[0-9A-Z]{1,2}$/.test(mid))return{ok:false,msg:"子批限 1~2 碼英數"};mid=String(mid).padStart(2,"0");return{ok:true,lot:`${prefix}-${mid}`};}return{ok:true,lot:prefix};}
function showErr(el,msg){el.textContent=msg||"";}
function showStatus(msg,isErr){statusMsg.className="status "+(isErr?"red":"green");statusMsg.textContent=msg||"";if(!isErr)setTimeout(()=>statusMsg.textContent="",5000);}
function showOK(msg){okMsg.textContent=msg||"";setTimeout(()=>okMsg.textContent="",5000);}
partNo.addEventListener("input",()=>{const v=partNo.value.trim().toUpperCase();if(!v){showErr(partHint,"");return;}if(!validPart(v)){showErr(partHint,"料號需為 7 碼英數");}else{showErr(partHint,"");}});
inspector.addEventListener("input",()=>{const v=inspector.value.trim().toUpperCase();if(!v)return; if(!validInspector(v)){} });

/* key / key2 */
function composeKey(ds,part,lot){return `${ds}|${part}|${lot}`;}
function composeKey2(ds,lot,qty){return `${ds}|${lot}|${qty}|TRUE`;}

/* 送出（純 GET） */
async function submitData(){
  const insp=inspector.value.trim().toUpperCase();
  const part=partNo.value.trim().toUpperCase();
  const qtyVal=String(qty.value||"").trim();
  if(!validInspector(insp)){showStatus("工號格式不正確",true);return;}
  if(!validPart(part)){showStatus("料號需為 7 碼英數",true);return;}
  const lotSan=sanitizeLot(lot.value); if(!lotSan.ok){showErr(lotHint,lotSan.msg);return;} showErr(lotHint,"");
  if(!qtyVal||isNaN(Number(qtyVal))){showStatus("請輸入數量",true);return;}

  const ds=currentDS();
  const key=composeKey(ds,part,lotSan.lot);
  const key2=composeKey2(ds,lotSan.lot,qtyVal);

  // 草稿先樂觀更新＋HOT
  upsertDraft(part,lotSan.lot,qtyVal,key,key2,true);

  loading.style.display="block"; showStatus("",false);
  try{
    const qs=new URLSearchParams({
      action:"submit", date_shift:ds, part_no:part, lot:lotSan.lot, qty:qtyVal, inspector:insp, key, key2
    }).toString();
    const r=await fetch(`${API_BASE}?${qs}`);
    const j=await r.json();
    if(!j||j.status!=="ok") throw new Error("submit_fail");
    showOK("送出成功");
    lot.value=""; qty.value="";
  }catch(e){
    showStatus("送出失敗",true);
  }finally{
    loading.style.display="none";
  }
}

/* 草稿寫入/HOT */
function upsertDraft(part_no,lot,qty,key,key2,markHot){
  const list=loadDraft();const now=Date.now();
  const idx=list.findIndex(x=>x.key===key);
  const base={part_no,lot,qty,key,key2,ts:now};
  if(idx>=0){list[idx]={...list[idx],...base,deleted:false};}
  else{list.push({...base,deleted:false});}
  saveDraft(list);renderDraft();
  if(markHot){
    key2Cache.hot.add(key2);
    const list2=loadDraft();const i2=list2.findIndex(x=>x.key2===key2);
    if(i2>=0){list2[i2].hotAt=now;saveDraft(list2);}
    setTimeout(()=>{key2Cache.hot.delete(key2);reconcileDraftWithCache();},HOT_TTL_MS+200);
  }
}

/* 檢驗員常駐 */
(function initInspector(){
  const k="inspector_mem";const old=localStorage.getItem(k);if(old)inspector.value=old;
  inspector.addEventListener("change",()=>{const v=inspector.value.trim().toUpperCase();if(validInspector(v))localStorage.setItem(k,v);});
})();

/* 初始化 */
document.getElementById("submitBtn").addEventListener("click",submitData);
renderDraft();reconcileDraftWithCache();
</script>
</body>
</html>