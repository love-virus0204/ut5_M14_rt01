<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</title>
<style>
  body { font-family:"Comic Sans MS",sans-serif; margin:10px; }
  h1 { display:flex; justify-content:space-between; align-items:center; margin:0 0 10px 0; }
  h1 span { font-family:"æ¨™æ¥·é«”",serif; font-weight:bold; }
  .top-row{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; margin-bottom:10px; }
  .top-left{ justify-self:start; font-size:14px; }
  .top-center{ justify-self:center; font-size:16px; font-weight:bold; }
  .label{ font-family:"æ¨™æ¥·é«”",serif; display:inline-block; width:70px; text-align:center; }
  input,select,textarea{ width:calc(100% - 90px); margin-bottom:8px; padding:5px; font-family:"Comic Sans MS",sans-serif; }
  select.select-narrow{ width:calc((100% - 90px)*0.25); }
  textarea[readonly]{ background:#f2f2f2; color:#555; }
  #sendBtn{ display:block; margin-left:auto; margin-top:10px; padding:8px 20px; background:#007bff; color:#fff; border:none; border-radius:5px; }
  .version-line{ font-size:12px; color:#666; text-align:left; margin-top:6px; }
  hr{ margin:10px 0 15px 0; }
  table{ width:100%; border-collapse:collapse; text-align:center; font-size:14px; }
  th,td{ border-top:1px solid #ddd; padding:5px; }
</style>
</head>
<body>
<h1>
  <span>ğŸŒ</span>
  <span>RT å¤–è§€æŠ½é©—è¨˜éŒ„è¡¨</span>
  <button id="backBtn" style="background:none;border:none;font-size:18px;">â†©ï¸</button>
</h1>

<div class="top-row">
  <div id="tsView" class="top-left"></div>
  <div id="dsView" class="top-center"></div>
  <div></div>
</div>

<label class="label">æª¢é©—å“¡ï¼š</label><input type="text" id="inspector" placeholder="è¼¸å…¥ 5 ç¢¼å·¥è™Ÿ"><br/>
<label class="label">æ–™ã€€è™Ÿï¼š</label><input type="text" id="partNo" placeholder="è«‹è¼¸å…¥ æ–™è™Ÿ by 7ç¢¼"><br/>

<label class="label">å‹ã€€æ…‹ï¼š</label>
<select id="lotPrefix" class="select-narrow">
  <option value=""></option>
  <option value="FA">FA</option>
</select><br>

<label class="label">æ‰¹ã€€è™Ÿï¼š</label>
<input type="text" id="lotInput" placeholder="æ¯æ‰¹[-å­æ‰¹]"><br/>

<label class="label">æ•¸ã€€é‡ï¼š</label><input type="number" id="qty" placeholder="è¼¸å…¥æ‰¹é‡"><br/>
<label class="label">å‚™ã€€è¨»ï¼š</label><textarea id="remark" readonly>ç›®å‰ä¸é–‹æ”¾è¼¸å…¥</textarea><br/>

<button id="sendBtn">é€å‡º</button>
<div class="version-line" id="verLine">valï¼š17.0</div>
<hr/>
<table>
  <thead><tr><th>æ–™ã€€è™Ÿ</th><th>æ‰¹ã€€è™Ÿ</th><th>æ•¸ã€€é‡</th></tr></thead>
  <tbody id="recordList"></tbody>
</table>

<script>
const GAS_URL   = "https://script.google.com/macros/s/AKfycbw81dgU81h8rNAuwch_A3LrV5ZAox4RGHu-y8yHifuSzJALSOBn7AVFd9_ld0b_15LG/exec";
const API_TOKEN = "MY_SECRET_123";

/* ===== å·¥å…· ===== */
function fw2hw(s){return s.replace(/[\uFF01-\uFF5E]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/\u3000/g," ");}
function canon(s){return fw2hw(String(s||"")).trim().toUpperCase();}
function normLotKey(s){return canon(s).replace(/^FA-/, '');}
function buildKey(date,shift,part,lot){return `${canon(date)}|${canon(shift)}|${canon(part)}|${normLotKey(lot)}`;}

/* ===== ç­åˆ¥éŒ¨å®šèˆ‡æ™‚é–“é¡¯ç¤º ===== */
function mdOf(d){return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;}
function computeDS(now){
  const mins=now.getHours()*60+now.getMinutes();
  let dateMD,shift,next;
  if(mins>=520 && mins<1000){dateMD=mdOf(now);shift='A';next=new Date(now.getFullYear(),now.getMonth(),now.getDate(),16,40);}
  else if(mins>=1000){dateMD=mdOf(now);shift='B';next=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,40);}
  else if(mins<40){dateMD=mdOf(new Date(now.getFullYear(),now.getMonth(),now.getDate()-1));shift='B';next=new Date(now.getFullYear(),now.getMonth(),now.getDate(),8,40);}
  else{dateMD=mdOf(new Date(now.getFullYear(),now.getMonth(),now.getDate()-1));shift='C';next=new Date(now.getFullYear(),now.getMonth(),now.getDate(),8,40);}
  return {dateMD,shift,until: next.getTime()+80*60000};
}
function anchorDS(){
  const k='ds_anchor', now=Date.now();
  let a; try{a=JSON.parse(localStorage.getItem(k)||'{}');}catch{a={};}
  if(!a.dateMD||now>a.until){const c=computeDS(new Date());a={dateMD:c.dateMD,shift:c.shift,until:c.until};localStorage.setItem(k,JSON.stringify(a));}
  return a;
}
function tick(){
  const n=new Date(); const a=anchorDS();
  document.getElementById('tsView').textContent=n.toLocaleString('zh-TW');
  document.getElementById('dsView').textContent=`${a.dateMD} - ${a.shift}`;
}
tick();setInterval(tick,30000);

/* ===== è‰ç¨¿èˆ‡å·¥è™Ÿ ===== */
const INSPECTOR_KEY='inspector_id';const DSKEY_KEY='rt_draft_dskey';const DRAFT_PREFIX='rt_draft_';
function dsKeyOf(a){return `${a.dateMD}|${a.shift}`;}
function draftKey(){return DRAFT_PREFIX+dsKeyOf(anchorDS());}
function saveDraft(){
  const d={part:document.getElementById('partNo').value,lot:document.getElementById('lotInput').value,qty:document.getElementById('qty').value,prefix:document.getElementById('lotPrefix').value};
  localStorage.setItem(draftKey(),JSON.stringify(d));localStorage.setItem(DSKEY_KEY,dsKeyOf(anchorDS()));
}
function loadDraft(){
  const curKey=dsKeyOf(anchorDS()),lastKey=localStorage.getItem(DSKEY_KEY)||'';
  if(lastKey&&lastKey!==curKey)localStorage.removeItem(DRAFT_PREFIX+lastKey);
  const raw=localStorage.getItem(draftKey());if(!raw)return;
  const d=JSON.parse(raw);document.getElementById('partNo').value=d.part||'';document.getElementById('lotInput').value=d.lot||'';document.getElementById('qty').value=d.qty||'';document.getElementById('lotPrefix').value=d.prefix||'';
}
function clearDraftKeepPart(){
  const part=document.getElementById('partNo').value;
  localStorage.setItem(draftKey(),JSON.stringify({part,lot:'',qty:'',prefix:document.getElementById('lotPrefix').value}));
}
['partNo','lotInput','qty','lotPrefix'].forEach(id=>document.getElementById(id).addEventListener('input',saveDraft));
loadDraft();

/* ===== æ¸…å–®åˆ·æ–° ===== */
async function refreshList(){
  const tbody=document.getElementById('recordList');tbody.innerHTML='';
  try{const r=await fetch(GAS_URL);const data=await r.json();
    const rows=(Array.isArray(data)?data:[]).filter(x=>x.deleted===true);
    rows.sort((a,b)=>String(b.submitted_at||'').localeCompare(String(a.submitted_at||'')));
    for(const x of rows.slice(0,50)){
      const tr=document.createElement('tr');tr.innerHTML=`<td>${x.part_no||''}</td><td>${x.lot||''}</td><td>${x.qty||''}</td>`;tbody.appendChild(tr);
    }
  }catch(e){console.error(e);}
}
refreshList();

/* ===== é€å‡º ===== */
let clearPartOnce=false;
document.getElementById('partNo').addEventListener('focus',()=>{if(clearPartOnce){document.getElementById('partNo').value='';clearPartOnce=false;saveDraft();}});
document.getElementById('sendBtn').addEventListener('click',async()=>{
  const inspector=canon(document.getElementById('inspector').value);
  const part=canon(document.getElementById('partNo').value);
  const prefix=canon(document.getElementById('lotPrefix').value);
  const lotDisp=prefix?`${prefix}-${canon(document.getElementById('lotInput').value)}`:canon(document.getElementById('lotInput').value);
  const qty=Number(document.getElementById('qty').value); const a=anchorDS();
  if(!/^[A-Z0-9]{5}$/.test(inspector))return alert("è«‹è¼¸å…¥5ç¢¼å·¥è™Ÿ");
  if(!/^[A-Z][0-9]{2}[A-Z][0-9]{3}$/.test(part))return alert("æ–™è™Ÿæ ¼å¼éŒ¯èª¤");
  if(!lotDisp)return alert("æ‰¹è™Ÿå¿…å¡«");
  if(!(qty>0))return alert("æ•¸é‡éœ€>0");
  const key=buildKey(a.dateMD,a.shift,part,lotDisp);
  const payload={token:API_TOKEN,key,date:a.dateMD,shift:a.shift,part_no:part,lot_prefix:prefix,mother_child:document.getElementById('lotInput').value,qty:String(qty),remark:""};
  const btn=document.getElementById('sendBtn');btn.disabled=true;
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
    const data=await res.json();
    if(data.status==='ok'){alert(data.upsert==='update'?'âœ… å·²æ›´æ–°':'âœ… å·²æ–°å¢');clearDraftKeepPart();clearPartOnce=true;refreshList();}
    else alert('âŒ å¾Œç«¯ï¼š'+JSON.stringify(data));
  }catch(err){alert('é€å‡ºéŒ¯èª¤ï¼š'+err.message);}
  finally{btn.disabled=false;}
});
</script>
</body>
</html>