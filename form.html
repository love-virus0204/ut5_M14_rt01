<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RT 外觀抽驗記錄表｜表單</title>
<style>
  /* 1) 防 iOS 放大：所有可輸入元素字體 >=16px */
  input, select, textarea { font-size:16px; }

  body{margin:0;background:#f8fafc;color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:18px auto;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
  .hdr{padding:14px 16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
  .ttl{font-weight:700;color:#0f766e}
  .content{padding:16px}
  .row{display:grid;grid-template-columns:130px 1fr;gap:10px 12px;align-items:center;margin-bottom:10px}
  .row label{color:#334155}
  .btns{display:flex;gap:10px;margin-top:12px}
  button{padding:10px 16px;border-radius:10px;border:1px solid #cbd5e1;background:#0ea5e9;color:#fff;cursor:pointer}
  button.secondary{background:#fff;color:#0f172a}
  .foot{padding:10px 16px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;color:#64748b;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div class="ttl">RT 外觀抽驗記錄表</div>
    <div id="now"></div>
  </div>

  <div class="content">
    <!-- 你原本的欄位，只示意最關鍵的日期與必要欄位。其餘依你的底稿保留。 -->
    <form id="f" method="POST" action="<!-- 你的 GAS doPost URL -->" target="_self">
      <div class="row">
        <label for="date">日期</label>
        <!-- 可為 yyyy-mm-dd 或 yyyy/mm/dd；提交時轉為「日期序號整數」 -->
        <input id="date" name="date_view" type="date" required />
      </div>

      <div class="row">
        <label for="shift">班別</label>
        <select id="shift" name="shift" required>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </div>

      <div class="row">
        <label for="part_no">料號</label>
        <input id="part_no" name="part_no" type="text" />
      </div>

      <div class="row">
        <label for="lot">批號</label>
        <input id="lot" name="lot" type="text" />
      </div>

      <div class="row">
        <label for="qty">數量</label>
        <input id="qty" name="qty" type="number" inputmode="numeric" />
      </div>

      <!-- 後端需要的實際提交欄位：以「序號整數」送出 -->
      <input type="hidden" name="action" value="submit" />
      <input type="hidden" name="date" id="date_serial" value="" />

      <div class="btns">
        <button id="btnSubmit" type="submit">送出</button>
        <button class="secondary" type="button" onclick="document.getElementById('f').reset()">清除</button>
      </div>
    </form>
  </div>

  <div class="foot">
    <span>v18.x</span>
    <span>Asia/Taipei</span>
  </div>
</div>

<script>
/* 即時時鐘 */
(function tick(){
  const el = document.getElementById('now');
  const opt = { timeZone:'Asia/Taipei', year:'numeric', month:'2-digit', day:'2-digit',
                hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false };
  el.textContent = new Intl.DateTimeFormat('zh-TW', opt).format(new Date());
  setTimeout(tick, 1000);
})();

/* 2) 送出時把日期轉為「Google/Excel 日期序號（整數，無小數）」 */
function toSerialFromYMDString(dateStr){
  // 支援 yyyy-mm-dd / yyyy/mm/dd
  const m = String(dateStr||"").trim().match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
  if(!m) return "";
  const y = +m[1], mo = +m[2]-1, d = +m[3];
  const baseUTC = Date.UTC(1899,11,30);          // 1899-12-30
  const ms = Date.UTC(y, mo, d);                 // 以 UTC 避免時區偏移
  return Math.floor((ms - baseUTC) / 86400000);  // 取整數，不帶小數
}

/* 防 iOS 放大後卡住：送出時失焦並回頂 */
function postSubmitUXFix(){
  document.activeElement && document.activeElement.blur();
  window.scrollTo({ top: 0, left: 0, behavior: "instant" });
}

/* 送出掛勾：把 #date 轉為序號，寫入隱藏欄位 #date_serial 再送出 */
document.getElementById('f').addEventListener('submit', function(e){
  // 若你需要先做前端驗證，可在此加入，未過則 e.preventDefault()

  const viewVal = document.getElementById('date').value;  // yyyy-mm-dd
  const serial = toSerialFromYMDString(viewVal);
  document.getElementById('date_serial').value = serial;  // 無小數

  // 若需保留人眼可讀的日期給後端，已在 name="date_view"
  // 送出後 UX 修復
  postSubmitUXFix();
});
</script>
</body>
</html>