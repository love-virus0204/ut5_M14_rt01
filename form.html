<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>RT 外觀抽驗記錄表</title>
<style>
  :root{--fg:#111;--muted:#666;--ok:#0aa80a;--upd:#ff4da6;}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC",sans-serif;margin:0;color:var(--fg);background:#fff;}
  .wrap{max-width:980px;margin:0 auto;padding:24px 20px;}
  header{display:flex;align-items:baseline;gap:.75rem;flex-wrap:wrap}
  h1{font-size:28px;margin:0 0 4px 0;font-weight:800;letter-spacing:.02em}
  .ver{color:var(--muted);font-size:14px}
  .ds{font-size:20px;font-weight:700;letter-spacing:.15em;margin:18px 0 10px}
  .row{display:grid;grid-template-columns:88px 1fr;gap:10px 14px;align-items:center;margin:10px 0}
  .row label{font-weight:700;letter-spacing:.4em}
  input,select,button{font-size:18px}
  input,select{width:100%;box-sizing:border-box;padding:12px 14px;border:1px solid #cfd3dc;border-radius:10px;background:#fff}
  input::placeholder{color:#b9b9b9}
  button{display:block;width:180px;padding:12px 8px;border:0;border-radius:12px;background:#0a57ff;color:#fff;font-weight:700;letter-spacing:.2em}
  button:active{transform:translateY(1px)}
  .hint{color:var(--muted);font-size:14px;margin:14px 0 8px}
  .timebar{display:flex;justify-content:space-between;color:#666;font-size:14px;margin:8px 0 18px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:14px 10px;border-bottom:1px solid #eee;text-align:center}
  th{font-size:18px}
  .none{text-align:center;color:#9aa0a6;padding:24px 8px}
  .ok{color:var(--ok);font-weight:700}
  .upd{color:var(--upd);font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>RT 外觀抽驗記錄表</h1>
    <span class="ver" id="ver">v17.11.7</span>
  </header>

  <div class="ds" id="ds">09/22 - A</div>

  <div class="row"><label>檢 驗 員：</label><input id="inspector" placeholder="請輸入檢驗員" inputmode="latin" autocomplete="off"></div>
  <div class="row"><label>料　　號：</label><input id="part_no" placeholder="如 A12B345" inputmode="latin" autocomplete="off"></div>
  <div class="row"><label>型　　態：</label>
    <select id="model">
      <option value="" selected>請選擇</option>
      <option value="OK">OK</option>
      <option value="NG">NG</option>
    </select>
  </div>
  <div class="row"><label>批　　號：</label><input id="lot" placeholder="批號" inputmode="latin" autocomplete="off"></div>
  <div class="row"><label>數　　量：</label><input id="qty" placeholder="正整數" inputmode="numeric" autocomplete="off"></div>

  <div class="row" style="margin-top:8px">
    <label></label><button id="btnSend">送出</button>
  </div>

  <div class="hint">已對齊 GAS v1.4.6；送出以 GET，並分送 date + shift。</div>
  <div class="timebar"><span id="srv">—</span><span id="now">—</span></div>

  <table>
    <thead>
      <tr><th>料　號</th><th>批　號</th><th>數　量</th></tr>
    </thead>
    <tbody id="list"><tr><td class="none" colspan="3">(當班無草稿)</td></tr></tbody>
  </table>
</div>

<script>
/* ===== 固定設定（寫死部署 URL；只換這裡即可） ===== */
const GAS_BASE = "https://script.google.com/macros/s/AKfycbz02U3mY1UTzWFJP6h0EkdTn3DZYAZRg5YnDWvFTncWV9CFibK6XDVj6gIxNx7ehNei/exec";

/* ===== 公用：台北時間 ===== */
function tzNow() {
  return new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
}
function yyyyMMdd(d){const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const dd=String(d.getDate()).padStart(2,'0');return `${y}/${m}/${dd}`;}
function MMdd(d){const m=String(d.getMonth()+1).padStart(2,'0');const dd=String(d.getDate()).padStart(2,'0');return `${m}/${dd}`;}
/* 班別：A 06-13, B 14-21, C 22-05；00-05 歸前一日 */
function getShiftAndBizDateTPE() {
  const now = tzNow();
  const h = now.getHours();
  let shift = (h>=6&&h<=13) ? "A" : (h>=14&&h<=21) ? "B" : "C";
  let biz = new Date(now);
  if (h<=5) biz.setDate(biz.getDate()-1);
  return { shift, bizDate: biz };
}

/* ===== 草稿：A(基本資料) / B(清單) ===== */
const K_A = "rt_draft_A";   // { inspector }
const K_B = "rt_draft_B";   // array of { part_no, lot, qty, time, status } time=ISO for sort

function loadA(){ try{ return JSON.parse(localStorage.getItem(K_A)||"{}"); }catch{return {};}}
function saveA(obj){ localStorage.setItem(K_A, JSON.stringify(obj||{})); }
function loadB(){ try{ return JSON.parse(localStorage.getItem(K_B)||"[]"); }catch{return [];}}
function saveB(arr){ localStorage.setItem(K_B, JSON.stringify(arr||[])); }

/* 換班清草稿B（僅保留 A） */
function rotateIfShiftChanged() {
  const tagK = "rt_last_ds";
  const cur = dsTag();
  const last = localStorage.getItem(tagK);
  if (last !== cur) {
    // 清空 B；A 不動
    saveB([]);
    localStorage.setItem(tagK, cur);
  }
}
function dsTag(){
  const {shift,bizDate}=getShiftAndBizDateTPE();
  return `${MMdd(bizDate)}|${shift}`;
}

/* ===== UI: 初始化 ===== */
const $inspector = document.getElementById('inspector');
const $part = document.getElementById('part_no');
const $model = document.getElementById('model');
const $lot = document.getElementById('lot');
const $qty = document.getElementById('qty');
const $ds = document.getElementById('ds');
const $list = document.getElementById('list');
const $srv = document.getElementById('srv');
const $now = document.getElementById('now');

function paintDS(){
  const {shift,bizDate}=getShiftAndBizDateTPE();
  $ds.textContent = `${MMdd(bizDate)} - ${shift}`;
}
function paintNowBars(){
  const n = tzNow();
  $now.textContent = yyyyMMdd(n) + " " + String(n.getHours()).padStart(2,'0') + ":" + String(n.getMinutes()).padStart(2,'0') + ":" + String(n.getSeconds()).padStart(2,'0');
}
function restoreA(){
  const a = loadA();
  if (a.inspector) $inspector.value = a.inspector;
}
function pushB(item){ const arr = loadB(); arr.push(item); arr.sort((a,b)=>b.time.localeCompare(a.time)); saveB(arr); renderB(); }
function renderB(){
  const arr = loadB();
  if (!arr.length){ $list.innerHTML = `<tr><td class="none" colspan="3">(當班無草稿)</td></tr>`; return; }
  let html = "";
  for(const r of arr){
    const cls = r.status==="updated" ? "upd" : "ok";
    html += `<tr><td class="${cls}">${escapeHTML(r.part_no)}</td><td class="${cls}">${escapeHTML(r.lot)}</td><td class="${cls}">${escapeHTML(String(r.qty))}</td></tr>`;
  }
  $list.innerHTML = html;
}
function escapeHTML(s){return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));}

/* ===== 5 分鐘保溫 ping ===== */
async function ping(){
  try{
    const url = `${GAS_BASE}?action=ping&t=${Date.now()}`;
    const r = await fetch(url,{method:"GET"});
    const js = await r.json().catch(()=>({}));
    if(js.server_time){ $srv.textContent = `伺服器：${js.server_time}`; }
  }catch{ /* ignore */ }
}

/* ===== 送出（GET；分送 date/shift；成功後清空欄位/下拉預設；寫入草稿B） ===== */
function buildParams(){
  const {shift,bizDate}=getShiftAndBizDateTPE();
  const dateStr = yyyyMMdd(bizDate);
  const part_no = $part.value.trim().toUpperCase();
  const lot = $lot.value.trim().toUpperCase();
  const qty = $qty.value.trim();
  const inspector = $inspector.value.trim().toUpperCase();

  // 基本前端驗證沿用（不擴充規則）
  if(!inspector || !part_no || !lot || !qty) throw new Error("欄位不可空白");
  if(!/^\d+$/.test(qty)) throw new Error("數量需為正整數");

  // key 與 key2：沿用「當日|當班|料號|批號」
  const key = `${MMdd(bizDate)}|${shift}|${part_no}|${lot}`;
  const key2 = key; // （後端仍可用，前端不再另做快取對比）

  const q = new URLSearchParams({
    action:"submit",
    inspector, part_no, lot, qty,
    date: dateStr,
    shift,
    key, key2
  });
  return { q, part_no, lot, qty };
}

async function onSend(){
  try{
    // 保留「每次成功驗證才更新檢驗員草稿」
    const inspector = $inspector.value.trim();
    if (inspector) saveA({ inspector });

    const { q, part_no, lot, qty } = buildParams();
    const url = `${GAS_BASE}?${q.toString()}`;

    const r = await fetch(url,{ method:"GET" });
    if(!r.ok) throw new Error("連線失敗");
    const js = await r.json().catch(()=>({}));
    if(js.status!=="ok") throw new Error(js.msg||"後端錯誤");

    // 以回傳推斷新增/更新；無旗標時視為新增
    const status = (js.mode==="update" || js.updated===true) ? "updated" : "inserted";

    // 寫入草稿B（字體色區分；時間降冪）
    pushB({ part_no, lot, qty, time: new Date().toISOString(), status });

    // 成功後：清空「批號、數量」，下拉恢復預設
    $lot.value = "";
    $qty.value = "";
    $model.value = "";

  }catch(err){
    alert(err.message || err);
  }
}

/* ===== 啟動 ===== */
function boot(){
  rotateIfShiftChanged();
  paintDS(); restoreA(); renderB(); paintNowBars(); ping();
  setInterval(()=>{ paintDS(); paintNowBars(); }, 1000);
  setInterval(ping, 5*60*1000);

  document.getElementById('btnSend').addEventListener('click', onSend);
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>